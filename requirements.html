<!DOCTYPE html>
<html lang="en">
  <head>
    <title>requirements  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>


    <a title="requirements  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
           1.24.0 Docs
        </a>
         (0% documented)
      </p>
    
      <div class="header-col--secondary">
        <form role="search" action="search.json">
          <input type="text" placeholder="Search documentation" data-typeahead>
        </form>
      </div>
    
        <p class="header-col header-col--secondary">
          <a class="header-link" href="https://github.com/gematik/E-Rezept-App-iOS">
            <img class="header-icon" src="img/gh.png" alt="GitHub"/>
            View on GitHub
          </a>
        </p>
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html"> Reference</a>
      <img class="carat" src="img/carat.png" alt=""/>
      requirements  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Guides.html">Guides</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="modules.html">Modules</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="error_handling.html">error_handling</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="requirement-notes.html">requirement-notes</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="requirements.html">requirements</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions.html#/AppKit">AppKit</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content top-matter">
            
            <h1 id='requirements' class='heading'>Requirements</h1>
<h2 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-bsi-erp-epa-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html">BSI-eRp-ePA</a></h2>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-arch_1-o-arch_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Arch_1">O.Arch_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OArch_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Arch_1</td>

<td>„Security“ ist Bestandteil des Softwareentwicklungs- und Lebenszyklus.</td>

<td>„Security“ MUSS ein fester Bestandteil des Softwareentwicklungs- und Lebenszyklus‘ für die gesamte Anwendung sein (vgl. „iOS Security Framework”[iOSSF], beziehungsweise „Design for Safety“ [DfS]).</td>

<td>Der Evaluator prüft, ob der Quelltext und die Design-Dokumente auf die Verwendung aktueller „Best- Practices“ bei der Entwicklung schließen lassen.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>See external SSDLC documentation.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-arch_2-o-arch_2-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Arch_2">O.Arch_2</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OArch_2" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Arch_2</td>

<td>Berücksichtigung der Verarbeitung sensibler Daten in der Design-Phase.</td>

<td>Bereits in der Designphase der Anwendung MUSS berücksichtigt werden, dass die Anwendung in der Produktivphase sensible Daten verarbeiten wird. Die Architektur der Anwendung MUSS dafür die sichere Erhebung, Verarbeitung, Speicherung und Löschung der sensiblen Daten in einem Datenlebenszyklus gewährleisten.</td>

<td>Der Evaluator prüft Design- und Architektur-Dokumente auf die Berücksichtigung der Verarbeitung sensibler Daten inkl. des Datenlebenszyklus.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>See external Data and Security concept.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-arch_3-o-arch_3-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Arch_3">O.Arch_3</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OArch_3" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Arch_3</td>

<td>Dokumentation des Lebenszyklus von kryptographischem Material.</td>

<td>Der Lebenszyklus von kryptographischem Schlüsselmaterial MUSS einer ausgearbeiteten Richtlinie folgen, die Eigenschaften wie die Zufallszahlenquelle, detaillierte Angaben zur Aufgabentrennung von Schlüsseln, Ablauf von Schlüsselzertifikaten, Integritätssicherung durch Hash-Algorithmen etc., umfasst. Die Richtlinie SOLL auf anerkannten Standards wie [TR02102- 2] und [NIST80057] basieren.</td>

<td>Der Evaluator bewertet die ausgearbeitete Richtlinie des Herstellers und deren Berücksichtigung in der Risikobewertung.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>All cryptography is specified by gemSpec_Krypt in corporation with BSI</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-arch_4-o-arch_4-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Arch_4">O.Arch_4</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OArch_4" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Arch_4</td>

<td>Keine unverschlüsselten sensiblen Daten in Backups.</td>

<td>In Backups gespeicherte sensiblen Daten MÜSSEN gemäß dem aktuellen Stand der Technik verschlüsselt sein.</td>

<td>Der Evaluator prüft durch Quelltextanalyse und praktische Tests, ob sensible Daten unverschlüsselt in Backups vorhanden sind.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>All data is either stored encrypted within the keychain or excluded from system backup, which also excludes files from cloud backup.</p>
<h4 id='code-sources-erplocalstorage-coredatacontroller-swift-83-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataController.swift:83</code></h4>

<p>Database backup exclusion</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#4,O.Arch_4#2,O.Data_15#1] Database backup exclusion
if excludeFromBackup, let storeUrl = store.url {

</code></pre>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-21-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:21</code></h4>

<p>Implementation of data storage that is persisted via keychain</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_4#3] Implementation of data storage that is persisted via keychain
// [REQ:BSI-eRp-ePA:O.Source_7#2,O.Data_2#2,O.Auth_13#3] Implementation of data storage that is persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-arch_5-o-arch_5-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Arch_5">O.Arch_5</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OArch_5" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Arch_5</td>

<td>Verteilte Implementierung von Sicherheitsfunktionen.</td>

<td>Sicherheitsfunktionen MÜSSEN immer auf allen Außenschnittstellen und API-Endpunkten implementiert werden.</td>

<td>Der Evaluator prüft das Vorhandensein und die Güte von Sicherheitsfunktionen durch Quelltextanalyse und praktische Tests. Als Sicherheitsfunktionen sind unter anderem Authentifizierung, Autorisierung, Input-Validierung und die Verwendung von Escape- Syntaxen zu verstehen.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>CAN and PIN verification is not done within the application but on the eGK chip. Actual authentication by confirming the eGK signature and validating the eGK certificate is done by the IDP. Authorization of users is done by the FD by validating the Access-Token signature. For Input-Validation and Escaping please see <a href="#OSource_1">O.Source_1</a> and <a href="#OSource_2">O.Source_2</a>.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-arch_6-o-arch_6-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Arch_6">O.Arch_6</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OArch_6" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Arch_6</td>

<td>Authentizitäts- und Integritätsschutz der Applikation.</td>

<td>Die Anwendung MUSS die Überprüfung der Integrität durch eine digitale Signatur ermöglichen. Die Authentizität der Anwendung ist durch die Vertrauenswürdigkeit der Bezugsquelle (s. A.Source) sichergestellt.</td>

<td>Der Evaluator prüft das Vorhandensein und die Güte des eingesetzten Authentizitäts- und Integritätsschutzes durch Quelltextanalyse und praktische Tests. Hierbei ist auf die Aktualität (siehe [TR02102-1]) der eingesetzten Signaturverfahren zu achten. Die Wirksamkeit gegen eine Manipulation der Applikation (siehe T.MemoryStructures ist in der Risikobewertung zu betrachten.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Apple already implements this with a signed binary delivered to customers. An altered application can only run on a jailbroken device. If a user is using a jailbroken device, may it be known or unknown, we display a security alert so a user can make an informed decision to use or not use the application.</p>
<h4 id='code-sources-erpapp-screens-main-mainview-swift-95-code' class='heading'><code>../Sources/eRpApp/Screens/Main/MainView.swift:95</code></h4>

<p>trigger device security check</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#2,O.Resi_2#2,O.Plat_1#2] trigger device security check
store.send(.loadDeviceSecurityView)

</code></pre>
<h4 id='code-sources-erpapp-session-helper-devicesecuritymanager-swift-58-code' class='heading'><code>../Sources/eRpApp/Session/Helper/DeviceSecurityManager.swift:58</code></h4>

<p>calculate system risk for jailbreak and missing device pin</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#3,O.Resi_2#3,O.Plat_1#3] calculate system risk for jailbreak and missing device pin
var showSystemSecurityWarning: AnyPublisher&lt;DeviceSecurityWarningType, Never&gt; {

</code></pre>
<h4 id='code-sources-erpapp-session-helper-devicesecuritymanager-swift-112-code' class='heading'><code>../Sources/eRpApp/Session/Helper/DeviceSecurityManager.swift:112</code></h4>

<p>Jailbreak detection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#4,O.Resi_2#4] Jailbreak detection
func informJailbreakDetected() -&gt; Bool {

</code></pre>
<h4 id='code-sources-erpapp-screens-main-devicesecurity-devicesecurityrooteddevice-devicesecurityrooteddeviceview-swift-9-code' class='heading'><code>../Sources/eRpApp/Screens/Main/DeviceSecurity/DeviceSecurityRootedDevice/DeviceSecurityRootedDeviceView.swift:9</code></h4>

<p>Jailbreak information view</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#5,O.Resi_2#5] Jailbreak information view
struct DeviceSecurityRootedDeviceView: View {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-arch_7-o-arch_7-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Arch_7">O.Arch_7</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OArch_7" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Arch_7</td>

<td> Sichere Nutzung der Funktionen von Drittanbieter-Software.</td>

<td>Nutzt die Anwendung Drittanbieter-Software (etwa für Objektserialisierung), MUSS der Hersteller sicherstellen, dass nur solche Drittanbieter-Software zum Einsatz kommen, deren zu nutzenden Funktionen sicher genutzt werden können und dem Nutzer Informationen über den Nutzungsumfang und die eingesetzten Sicherheitsmechanismen klar darstellen. Die Anwendung MUSS diese Funktionen sicher nutzen. Der Hersteller MUSS darüber hinaus sicherstellen, dass ungenutzte Funktionen durch Dritte nicht aktiviert werden können.</td>

<td>Der Evaluator prüft, durch Quelltextanalyse und praktische Tests, dass Funktionalitäten sicher verwendet werden und ungenutzte Funktionalitäten nicht zugänglich sind. Darüber hinaus prüft er, ob der Nutzer ausreichend über die Verwendung von Drittanbieter- Software informiert wird.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>See <code>Source/eRpApp/Resources/en.lproj/FOSS.html</code> for library usage purposes. We use Swift as our programming language. We do not use reflections for calling a businesslogic. That’s why we can be sure, that library code (that we do not use) cannot be executed.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-arch_8-o-arch_8-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Arch_8">O.Arch_8</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OArch_8" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Arch_8</td>

<td>Zweckgebundener Zugriff auf verschlüsselte Speicher oder Nutzerdaten durch interpretierenden Code.</td>

<td>Interpretierter Code , der in möglichen Interaktionen mit Benutzereingaben steht (WebViews mit JavaScript), DARF KEINEN Zugriff auf verschlüsselte Speicher oder Nutzerdaten haben, sofern es für die Erfüllung des primären Zwecks der Anwendung nicht zwingend erforderlich ist.</td>

<td>Der Evaluator prüft durch Quelltextanalyse und praktische Tests, ob ein Zugriff auf verschlüsselte Speicher oder Nutzerdaten über interpretierten Code möglich ist. Falls dies der Fall ist, prüft er die Abwägungen des Herstellers zur zwingenden Notwendigkeit für die Erfüllung des primären Zwecks und die Berücksichtigung in der Risikobewertung.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-settings-termsofuse-termsofuseview-swift-12-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/TermsOfUse/TermsOfUseView.swift:12</code></h4>

<p>Webview containing local html without javascript</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_3#2] Actual view for the Terms of Use display
// [REQ:BSI-eRp-ePA:O.Arch_8#1] Webview containing local html without javascript
struct TermsOfUseView: View {

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-foss-fossview-swift-10-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/FOSS/FOSSView.swift:10</code></h4>

<p>Webview containing local html without javascript</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_8#2] Webview containing local html without javascript
struct FOSSView: View {

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-dataprivacy-dataprivacyview-swift-13-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/DataPrivacy/DataPrivacyView.swift:13</code></h4>

<p>Webview containing local html without javascript</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_1#2] Actual View driving the display of `DataPrivacy.html`
// [REQ:BSI-eRp-ePA:O.Arch_8#3] Webview containing local html without javascript
// [REQ:gemSpec_eRp_FdV:A_19980#2] Actual View driving the display of `DataPrivacy.html`
struct DataPrivacyView: View {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-arch_9-o-arch_9-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Arch_9">O.Arch_9</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OArch_9" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Arch_9</td>

<td>Barrierearme Möglichkeit zum Melden von Sicherheitsproblemen.</td>

<td>Der Hersteller MUSS dem Nutzer eine barrierearme Möglichkeit bereitstellen, um Sicherheitsprobleme zu melden. Die Kommunikation SOLL über einen verschlüsselten Kanal stattfinden.</td>

<td>Der Evaluator prüft, ob eine entsprechende Möglichkeit vorhanden ist. Falls kein verschlüsselter Kanal bereitgestellt wird, ist dies in der Risikobewertung zu berücksichtigen.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Link within DataPrivacy.html to https://www.gematik.de/datensicherheit</p>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingcontainer-swift-46-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingContainer.swift:46</code></h4>

<p>DataPrivacy display within Onboarding</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_9#2] DataPrivacy display within Onboarding
.sheet(isPresented: $store.showTermsOfPrivacy.sending(\.setShowPrivacy)) {

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingslegalinfoview-swift-28-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsLegalInfoView.swift:28</code></h4>

<p>DataPrivacy display within Settings</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_9#3,O.Purp_1#4] DataPrivacy display within Settings
NavigationLink(

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-arch_10-o-arch_10-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Arch_10">O.Arch_10</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OArch_10" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Arch_10</td>

<td>Anwendung fragt Zwangsupdates vom Hintergrundsystem ab.</td>

<td>Die Anwendung SOLL beim Start auf verfügbare sicherheitsrelevante Updates prüfen. Wenn ein sicherheitsrelevantes Update verfügbar ist, DARF die Anwendung sensible Daten NICHT mehr verarbeiten, ohne dieses Update einzuspielen. Der Nutzer MUSS über die Möglichkeit eines Updates und über ein durchgeführtes Update informiert werden.</td>

<td>Der Evaluator prüft die Güte der Implementierung der entsprechenden Funktionalität in der Anwendung. Falls diese nicht vorhanden ist, prüft er die Abwägungen des Herstellers zu den Auswirkungen auf die Sicherheit der Anwendung. Dies ist in der Risikobewertung zu berücksichtigen. Falls die Funktionalität vorhanden ist, prüft der Evaluator mit praktischen Tests, ob das Blockieren einzelner Anfragen eine weitere Nutzung der Anwendung wirksam unterbindet.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Implemented via APIKey usage against APOVZD and FD. All requests against the backends may respond with an 403 status code. The App stays usable, but only without any server connection. The user is informed, that an update is required.</p>
<h4 id='code-sources-erpapp-screens-main-mainview-swift-91-code' class='heading'><code>../Sources/eRpApp/Screens/Main/MainView.swift:91</code></h4>

<p>Trigger for the update check</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_10#2] Trigger for the update check
await store.send(.checkForForcedUpdates).finish()

</code></pre>
<h4 id='code-sources-erpapp-screens-main-maindomain-swift-227-code' class='heading'><code>../Sources/eRpApp/Screens/Main/MainDomain.swift:227</code></h4>

<p>The actual business logic for the update check</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_10#3] The actual business logic for the update check
return .run(operation: { [updateChecked = state.updateChecked] send in

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-arch_11-o-arch_11-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Arch_11">O.Arch_11</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OArch_11" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Arch_11</td>

<td>Bereitstellung von Updates über einen eigenen App-Store.</td>

<td>Der Hersteller MUSS für die Veröffentlichung der Anwendung (und ihrer Updates) eine Quelle wählen, auf der die Anwendung gegen Manipulation durch Unbefugte geschützt ist und die einen vertrauenswürdigen Kanal zum Bezug der Anwendung zur Verfügung stellt.</td>

<td>Der Evaluator prüft, ob der Hersteller einen eigenen App-Store zur Verfügung stellt. Daraus resultierende Abwägungen und Auswirkungen auf die Sicherheit sind in der Risikobewertung zu berücksichtigen.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Sole source for the app is the official Apple AppStore. Apple provides a secure ecosystem for downloading applications that incorporate signing and verification of the application. The app is only available in the AppStore and not in any other store.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-arch_12-o-arch_12-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Arch_12">O.Arch_12</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OArch_12" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Arch_12</td>

<td>Nutzung kryptographischer Maßnahmen bei alternativen Download- Quellen/Mechanismen.</td>

<td>Der Hersteller MUSS dem App-Nutzer einfach und sicher zugängliche Wege zum Bezug der Anwendung bereitstellen (z.B. in Form einer Link-Liste auf seiner Website, als individuell zugestellter QR-Code, o. Ä.).</td>

<td>Der Evaluator prüft durch Quelltextanalyse das Vorhandensein und die Güte der eingesetzten Verfahren.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Not applicable as we are only using the official Apple AppStore.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_1-o-auth_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_1">O.Auth_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_1</td>

<td>Herstellerkonzept zur Authentisierung , Autorisierung und Beenden von Anwendungssitzungen.</td>

<td>Der Hersteller MUSS ein Konzept zur Authentisierung auf angemessenem Vertrauensniveau (vgl. [TR03107-1]), zur Autorisierung (Rollenkonzept) und zum Beenden einer Anwendungssitzung dokumentieren.</td>

<td>Der Evaluator prüft das vom Hersteller bereitgestellt Konzept zur Authentisierung, Autorisierung und Beenden der Anwendungssitzung. Er bewertet die Güte der eingesetzten Verfahren Anhand des aktuellen Standes der Technik. Nach Einschätzung des BSI existieren aktuell keine Verbraucherendgeräte, die in einem unüberwachten Anwendungsszenario Biometrie zur Identifikation oder Authentisierung auf einem Vertrauensniveau „hoch“ einsetzen können.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Our authentication concept is described in the following repository: <a href="https://github.com/gematik/api-erp/blob/master/docs/authentisieren.adoc">https://github.com/gematik/api-erp/blob/master/docs/authentisieren.adoc</a>. Roles in the scope of the IDP are defined in <a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Dienst/latest/#3.1">https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Dienst/latest/#3.1</a>. As stated in O.Auth_14, we have no mechanism to invalidate tokens.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_2-o-auth_2-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_2">O.Auth_2</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_2" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_2</td>

<td>Getrennte Realisierung von Authentifizierungsmechanismen und Autorisierungsfunktionen.</td>

<td>Die Anwendung SOLL Authentisierungsmechanismen und Autorisierungsfunktionen separat realisieren. Sind für die Anwendung verschiedene Rollen notwendig, MUSS eine Autorisierung bei jedem Datenzugriff separat realisiert werden.</td>

<td>Der Evaluator prüft und bewertet  die getroffenen Maßnahmen zur Trennung von Autorisierungs- und Authentifizierungsmechanismen. Sollte keine Trennung der Mechanismen vorgenommen sein, sind die Abwägungen des Herstellers zu prüfen und in der Risikobewertung zu berücksichtigen.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>There is no client side separation of authentication and authorization.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_3-o-auth_3-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_3">O.Auth_3</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_3" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_3</td>

<td>Zwei-Faktor-Authentisierung.</td>

<td>Jeder Authentifizierungsvorgang des Nutzers MUSS in Form einer Zwei-Faktor- Authentisierung umgesetzt werden.</td>

<td>Der Evaluator prüft durch Quelltextanalyse und praktische Tests das Vorhandensein und die Güte der Zwei-Faktor- Authentisierung. Insbesondere prüft er, ob die verwendeten Faktoren aus unterschiedlichen Kategorien stammen (Wissen und Besitz) und mit dem in O.Auth_1 beschriebenem Konzept übereinstimmen.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>One way to connect to the FD is to login by using the eGK. For that login, the physical card, as well as knowledge of the PIN is required. Login via gID (Gesundheits ID) is described in O.Auth_4.</p>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-swift-182-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.swift:182</code></h4>

<p>Implementation of eGK connection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_3#2] Implementation of eGK connection
case let .signChallenge(challenge):

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_4-o-auth_4-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_4">O.Auth_4</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_4" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_4</td>

<td>Authentisierung über zusätzliche Verfahren, welche einem niedrigeren Sicherheitsniveau entsprechen.</td>

<td>Zusätzlich zu der in O.Auth_1 definierten Authentisierung auf einem angemessenen Vertrauensniveau, KANN der Hersteller dem Nutzer gemäß § 139e Abs. 10 SGB V, nach umfassender Information und Einwilligung, eine Authentisierungsmöglichkeit auf einem niedrigeren Vertrauensniveau anbieten. Dies schließt das Anbieten zusätzlicher Verfahren basierend auf den digitalen Identitäten im Gesundheitswesen gemäß § 291 Abs. 8 SGB V mit ein.</td>

<td>Der Evaluator prüft das Vorhandensein von Authentisierungsmöglichkeiten mit einem niedrigeren Sicherheitsniveau. Sollten solche Verfahren angeboten werden, prüft der Evaluator durch Quelltextanalyse und praktische Tests, ob diese eine angemessene Sicherheit bieten. Angemessene Sicherheitsanforderungen für niederschwellige Verfahren sind der jeweils aktuellen Version der

„Spezifikation Sektoraler Identity Provider“ der gematik GmbH zu entnehmen [gemSpec_IDP_Sek]. Die Abwägungen des Herstellers, zum Bereitstellen zusätzlicher Authentisierungsmöglichkeiten und der gewählten Implementierung, sind in der Risikobewertung zu berücksichtigen.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Authentication via gID (Gesundheits ID) is possible. To do that an inter-app flow is used that opens the insurance company app on the users device, and after successfull authentication there, jumps back into the E-Rezept-App.</p>
<h4 id='code-sources-erpapp-screens-cardwall-introduction-cardwallintroductionview-swift-125-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/Introduction/CardWallIntroductionView.swift:125</code></h4>

<p>Button the user may use to start login via gID</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_4#2] Button the user may use to start login via gID
Button(action: {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-introduction-cardwallintroductiondomain-swift-154-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/Introduction/CardWallIntroductionDomain.swift:154</code></h4>

<p>Present the gID flow for selecting the correct insurance company</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_4#3] Present the gID flow for selecting the correct insurance company
.extAuthTapped:

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthselectionview-swift-12-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthSelectionView.swift:12</code></h4>

<p>View containing the list of insurance companies</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_4#4] View containing the list of insurance companies
struct CardWallExtAuthSelectionView: View {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthselectionview-swift-52-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthSelectionView.swift:52</code></h4>

<p>User selection of the insurance company</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_4#5] User selection of the insurance company
Button(action: {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthselectiondomain-swift-90-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthSelectionDomain.swift:90</code></h4>

<p>Business logic of user selecting the insurance company</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_4#6] Business logic of user selecting the insurance company
// [REQ:gemSpec_IDP_Frontend:A_22294-01] Select KK
state.selectedKK = entry

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthselectiondomain-swift-93-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthSelectionDomain.swift:93</code></h4>

<p>Proceed to confirmation screen</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_4#7] Proceed to confirmation screen
case .confirmKK:

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationview-swift-10-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationView.swift:10</code></h4>

<p>Confirmation Dialog with brief explanation</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_4#8] Confirmation Dialog with brief explanation
struct CardWallExtAuthConfirmationView: View {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationview-swift-72-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationView.swift:72</code></h4>

<p>User confirms the insurance company</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_4#8] User confirms the insurance company
PrimaryTextButton(text: L10n.cdwBtnExtauthConfirmSend,

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationdomain-swift-91-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationDomain.swift:91</code></h4>

<p>Start login via gID</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22294-01] Start login via gID
// [REQ:BSI-eRp-ePA:O.Auth_4#9,O.Plat_10#2] Start login via gID
return .publisher(

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_5-o-auth_5-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_5">O.Auth_5</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_5" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_5</td>

<td>Zusätzliche Informationen bei Bewertung des Authentifizierungsvorgangs einbeziehen.</td>

<td>Für die Bewertung eines Authentisierungsvorgangs SOLLEN zusätzliche Informationen (z. B. das verwendete Endgerät, der verwendete WiFi-Zugangsknoten oder die Zeit des Zugriffs) mit einbezogen werden.</td>

<td>Der Evaluator prüft das Vorhandensein und die Güte von zusätzlichen Informationen zur Bewertung eines Authentifizierungsvorgangs. Solche Informationen können beispielsweise über die Invalidierung/Löschung von Schlüsseln bei Änderung von Merkmalen biometrischer Systeme oder eine Prüfung auf Änderung von biometrischen Metadaten umgesetzt werden. Eine Prüfung auf Konformität zum Datenschutz der erhobenen Informationen ist im Rahmen der TR nicht erforderlich, eine zusätzliche Prüfung ist daher empfehlenswert. Werden keine zusätzlichen Informationen zur Bewertung verwendet, prüft der Evaluator die Abwägungen des Herstellers. Diese sind in der Risikobewertung zu berücksichtigen.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>If the registered biometric features get changed (within system settings), private keys for alternate authentication are deleted. For privacy reasons, neither the FD nor the application gather or store user data that is not crutial, e.g. the current WiFi.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-133-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:133</code></h4>

<p>Key invalidates on changes of registered</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21586] invalidates biometry after changes
// [REQ:BSI-eRp-ePA:O.Auth_5#2] Key invalidates on changes of registered
// biometric features
.biometryCurrentSet], &amp;error) else {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_6-o-auth_6-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_6">O.Auth_6</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_6" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_6</td>

<td>Information des Benutzers über ungewöhnliche Anmeldeversuche.</td>

<td>Dem Nutzer SOLL eine Möglichkeit gegeben werden, sich über ungewöhnliche Anmeldevorgänge informieren zu lassen.</td>

<td>Der Evaluator prüft, ob dem Nutzer leicht zugänglich die Möglichkeit gegeben wird, Informationen zu Anmeldevorgängen nachzuvollziehen. Ist das nicht der Fall, sind die Abwägungen des Herstellers zu prüfen und in der Risikobewertung zu berücksichtigen.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We increment a counter whenever the application is opened and an attempt to unlock the application fails. If the counter is greater than 0, the user is informed about that in a hint on the password/unlock screen. For remote logins, an Audit Log for every FD access is available in each user profile.</p>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofileview-swift-401-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileView.swift:401</code></h4>

<p>Actual Button to open the audit events</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19177#2,A_19185#3] Actual Button to open the audit events
// [REQ:BSI-eRp-ePA:O.Auth_6#2] Actual Button to open the audit events
NavigationLink(item: $store.scope(state: \.destination?.auditEvents,

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-profiles-protocol-auditeventsview-swift-13-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Protocol/AuditEventsView.swift:13</code></h4>

<p>View displaying the audit events</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19177#1,A_19185#2] View displaying the audit events
// [REQ:BSI-eRp-ePA:O.Auth_6#3] View displaying the audit events
struct AuditEventsView: View {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_7-o-auth_7-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_7">O.Auth_7</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_7" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_7</td>

<td>Verhinderung des Ausprobierens von Login-Parametern.</td>

<td>Die Anwendung MUSS Maßnahmen umsetzen, die ein Ausprobieren von Login-Parametern (z. B. Passwörter) erschweren.</td>

<td>Der Evaluator validiert, dass ein Ausprobieren von Login- Parametern verhindert wird. Dies kann beispielsweise durch Verzögerung nachfolgender Login- Versuche oder den Einsatz von sogenannten Captchas erreicht werden.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>There are no passwords to guess for server login within our application. Only eGK login is directly available within the application. The users application password is not delayed, as any user with Device-PIN access would have access to the unencrypted file system as well.</p>
<h4 id='code-sources-erpapp-screens-appauthentication-appauthenticationpassword-appauthenticationpassworddomain-swift-8-code' class='heading'><code>../Sources/eRpApp/Screens/AppAuthentication/AppAuthenticationPassword/AppAuthenticationPasswordDomain.swift:8</code></h4>

<p>Domain handling App Authentication</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_7#2] Domain handling App Authentication
@Reducer

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_8-o-auth_8-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_8">O.Auth_8</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_8" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_8</td>

<td>Erneute Authentifizierung bei unterbrochener Anwendung.</td>

<td>Wurde die Anwendung unterbrochen (in den Hintergrundbetrieb versetzt), MUSS nach Ablauf einer angemessenen Frist (Grace Period) eine erneute Authentisierung durchgeführt werden.</td>

<td>Der Evaluator validiert, dass nach einer der Anwendung angemessenen Zeit, in der sie in den Hintergrundmodus versetzt wurde, eine erneute Authentifizierung erfolgen muss. Die Güte der geforderten Authentifizierung muss dem Vertrauensniveau angemessen sein (vgl. O.Auth_3).</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The <code>SceneDelegate</code> exchanges the active window with an authentication window, every time the app gains focus.</p>
<h4 id='code-sources-erpapp-scenedelegate-swift-179-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:179</code></h4>

<p>Present the authentication window</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_8#2] Present the authentication window
// [REQ:gemSpec_eRp_FdV:A_24857#2] Present the authentication window upon every startup
// dispatching necessary to prevents keyboard not showing on iOS 16
DispatchQueue.main.async { [weak self] in

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_9-o-auth_9-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_9">O.Auth_9</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_9" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_9</td>

<td>Erneute Authentifizierung nach angemessenen Zeit in der die Anwendung nicht aktiv verwendet wurde.</td>

<td>Die Anwendung MUSS nach einer angemessenen Zeit in der sie nicht aktiv verwendet wurde (idle time) eine erneute Authentisierung fordern.</td>

<td>Der Evaluator validiert, dass nach einer der Anwendung angemessenen Zeit, in der sie nicht aktiv verwendet wurde, eine erneute Authentifizierung erfolgen muss.

Die Güte der geforderten Authentifizierung muss dem Vertrauensniveau angemessen sein (vgl. O.Auth_3).</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>A Timer is used to measure the time a user is inactive. Every user interaction resets the timer.</p>
<h4 id='code-sources-erpapp-scenedelegate-swift-337-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:337</code></h4>

<p>The timer used to determine inactivity</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_9#2] The timer used to determine inactivity
self?.presentAppAuthenticationDomain(scene: scene)

</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-318-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:318</code></h4>

<p>The timer is reset on user interaction</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_9#3] The timer is reset on user interaction
self?.setupTimer(scene: scene)

</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-347-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:347</code></h4>

<p>User interaction is determined by using a higher order reducer watching all</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_9#4] User interaction is determined by using a higher order reducer watching all
// actions
NotificationCenter.default.post(name: .userInteractionDetected, object: nil, userInfo: nil)

</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-47-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:47</code></h4>

<p>Concat the user interaction reducer to the normal application reducer</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_9#5] Concat the user interaction reducer to the normal application reducer
reducer: AppStartDomain().analytics().notifyUserInteraction().prepareUITestsDependencies(),

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_10-o-auth_10-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_10">O.Auth_10</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_10" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_10</td>

<td>Erneute Authentifizierung nach angemessenen Zeit in der die Anwendung dauerhaft aktiv verwendet wurde.</td>

<td>Die Anwendung MUSS nach einer angemessenen Zeit in der sie aktiv verwendet wurde (active time) eine erneute Authentisierung zur Reaktivierung der Serversitzung fordern.</td>

<td>Der Evaluator validiert, dass nach einer der Anwendung angemessenen Zeit, in der sie dauerhaft aktiv verwendet wurde, eine erneute Authentifizierung erfolgen muss. Die Güte der geforderten Authentifizierung muss dem Vertrauensniveau angemessen sein (vgl. O.Auth_3).</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Token invalidation happens after 12 hours. If a user is still active, a re-authentication via eGK, Biometrics or Insurance App is necessary. Each meaning the possession and or knowledge of the needed user input.</p>
<h4 id='code-sources-idp-defaultidpsession-swift-784-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:784</code></h4>

<p>The application is also checking for Access-Token expiration</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_10#2] The application is also checking for Access-Token expiration
guard token.expires &gt; time() else {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_11-o-auth_11-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_11">O.Auth_11</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_11" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_11</td>

<td>Ausreichende Authentifizierung des Nutzers für Änderung der Authentisierungsdaten.</td>

<td>Die Authentisierungsdaten DÜRFEN NICHT ohne eine erneute Authentifizierung des Nutzers geändert werden.</td>

<td>Der Evaluator prüft, ob er ohne angemessene Authentifizierung die Authentisierungsdaten verändern kann. Dies betrifft auch einen Ablauf zum Passwort zurücksetzen. Beruht dieser Ablauf bspw. auf Sicherheitsabfragen, darf die Antwort nicht einfach zu erraten oder gar aus möglicherweise öffentlichen Informationen ermittelbar sein (z.B. Mädchenname der Mutter).</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Authentication via eGK cannot be altered, as the physical card cannot be modified without authentication (e.g. PIN change). See gemSpec_COS for details. Adding a authentication key that is secured via biometrics (labeled as “save login” within the card wall) enforces a new authentication via eGK on server side. There is no other way to change existing login “credentials”, as there is no “password”.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_12-o-auth_12-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_12">O.Auth_12</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_12" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_12</td>

<td>Authentifizierung an der Schnittstelle zwischen Anwendung und Hintergrundsystem.</td>

<td>Die Anwendung MUSS für die Anbindung eines Hintergrundsystems eine dem Stand der Technik entsprechende Authentifizierung verwenden.</td>

<td>Der Evaluator prüft, ob die Anwendung eine Authentifizierung des Hintergrundsystems unterstützt.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use TI Certificate Pinning and a Trust Store for VAU communication. See TrustStore and VAU Module for implementation.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_13-o-auth_13-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_13">O.Auth_13</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_13" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_13</td>

<td>Schutz von Authentisierungsdaten.</td>

<td>Authentisierungsdaten, wie bspw. Session- Identifier bzw. Authentisierungstoken, MÜSSEN als sensible Daten geschützt werden.</td>

<td>Der Evaluator prüft, ob Authentisierungsdaten als sensible Daten gemäß den Anforderungen der TR behandelt werden.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Session tokens and related data are stored within the keychain. We embrace a protocol specifically made for storing data that needs to be secured.</p>
<h4 id='code-sources-erpkit-secureuserdatastore-swift-15-code' class='heading'><code>../Sources/eRpKit/SecureUserDataStore.swift:15</code></h4>

<p>The protocol for storing secured data</p>
<pre class="highlight plaintext"><code>/// Interface to access user specific data that should be kept private
/// sourcery: StreamWrapped
/// [REQ:BSI-eRp-ePA:O.Auth_13#2|11] The protocol for storing secured data
public protocol SecureUserDataStore: IDPStorage, SecureEGKCertificateStorage {
    /// Set the CAN
    ///
    /// - Parameter can: the CAN to set and save
    func set(can: String?)

    /// Wipe the whole storage and delete all user information
    func wipe()
}
</code></pre>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-22-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:22</code></h4>

<p>Implementation of data storage that is persisted via keychain</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_4#3] Implementation of data storage that is persisted via keychain
// [REQ:BSI-eRp-ePA:O.Source_7#2,O.Data_2#2,O.Auth_13#3] Implementation of data storage that is persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_14-o-auth_14-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_14">O.Auth_14</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_14" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_14</td>

<td>Invalidierung von Authentisierungsdaten durch den Anwender.</td>

<td>Die Anwendung MUSS es dem Nutzer ermöglichen einen oder alle zuvor ausgestellten Session-Identifier bzw. Authentisierungstoken zu invalidieren.</td>

<td>Der Evaluator prüft, ob die Anwendung dem Nutzer ermöglicht, ein oder alle zuvor ausgestellten Authentisierungsdaten ungültig zu machen.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Our Authentication Tokens cannot be invalidated effectivley as they are stateless and no server stores active/valid tokens anywhere. Invalidating Authentication Tokens in our context means deleting them on client side. The client side invalidation can thus be done by manual logout or profile deletion. Logout is accessible within the Settings -&gt; Specific User Profile -&gt; Logout.</p>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofileview-swift-179-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileView.swift:179</code></h4>

<p>The user may use the logout button within each profile</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_14#2|5] The user may use the logout button within each profile
Button(action: {
    store.send(.delegate(.logout))
}, label: {
    Text(L10n.stgBtnEditProfileLogout)
})
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofiledomain-swift-252-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileDomain.swift:252</code></h4>

<p>The domain accepts the intent and wipes tokens and other login related data</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_14#3|6] The domain accepts the intent and wipes tokens and other login related data
case .delegate(.logout):
    state.token = nil
    // [REQ:gemSpec_IDP_Frontend:A_20499-01#1] Call the SSO_TOKEN removal upon manual logout
    return .run { [profileId = state.profileId] _ in
        try await profileSecureDataWiper.wipeSecureData(of: profileId).async()
    }
</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-43-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:43</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-01#2] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_IDP_Frontend:A_21603] Certificate
// [REQ:BSI-eRp-ePA:O.Auth_14#4] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
storage.wipe()

</code></pre>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-244-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:244</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_14#5|11] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
func wipe() {
    // [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-1#3] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
    // [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
    set(can: nil)
    set(token: nil)
    set(discovery: nil)
    // [REQ:gemSpec_IDP_Frontend:A_21603] Certificate
    set(certificate: nil)
    // `keyIdentifier` is not wiped here because it's deletion is done asynchronously
    // together with the secure enclave representative in `ProfileSecureDataWiper`
}
</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-auth_15-o-auth_15-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Auth_15">O.Auth_15</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OAuth_15" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Auth_15</td>

<td>Benachrichtigung des Hintergrundsystems über beendete Anwendungssitzungen durch die Anwendung</td>

<td>Wird eine Anwendungssitzung ordnungsgemäß beendet, MUSS die Anwendung das Hintergrundsystem darüber informieren, sodass Session-Identifier bzw. Authentisierungstoken sicher gelöscht werden. Dies gilt sowohl für das aktive Beenden durch den Benutzer (log-out), als auch für das automatische Beenden durch die Anwendung (vgl. O.Arch_9 und O.Auth_10).</td>

<td>Der Evaluator prüft, ob das Hintergrundsystem bei einer ordnungsgemäßen Beendigung der Anwendungssitzung durch die Anwendung informiert wird.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Our Authentication Tokens cannot be invalidated effectivley as they are stateless and no server stores active/valid tokens anywhere. Invalidating Authentication Tokens in our context means deleting them on client side. The client side invalidation can thus be done by manual logout or profile deletion. Logout is accessible within the Settings -&gt; Specific User Profile -&gt; Logout.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-cryp_1-o-cryp_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Cryp_1">O.Cryp_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OCryp_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Cryp_1</td>

<td>Keine fest einprogrammierten Schlüssel oder anderweitige Geheimnisse.</td>

<td>Beim Einsatz von Verschlüsselung in der Anwendung DÜRFEN KEINE fest einprogrammierten geheimen, bzw. privaten Schlüssel eingesetzt werden.</td>

<td>Der Evaluator prüft, ob fest einprogrammierte geheime, bzw. private Schlüssel eingesetzt werden. Ausgenommen sind Techniken, die den verwendeten Schlüssel stark vor Reverse Engineering nach aktuellem Stand der Technik verbergen (Stichwort: „White Box Cryptography“). Wird eine kaskadierte Verschlüsselung eingesetzt, soll mindestens eine Verschlüsselungsebene stark gegen Reverse Engineering geschützt sein und mindestens ein nicht-statischer Schlüssel eingesetzt werden.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use API-Keys for FD and APOVZD communication for legal reasons, not for security reasons. Besides that, private keys for encryption are either created and stored within the secure enclave or stored within the eGK. As encryption for Server communication is done ephemeral via ECDH-ES, no static private keys on client side are necessary. Usages of encryption include the following code pieces.</p>
<h4 id='code-sources-idp-models-signedchallenge-swift-36-code' class='heading'><code>../Sources/IDP/Models/SignedChallenge.swift:36</code></h4>

<p>Signature via ecdh ephemeral-static</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#2] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#5] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(

</code></pre>
<h4 id='code-sources-idp-models-signedauthenticationdata-swift-27-code' class='heading'><code>../Sources/IDP/Models/SignedAuthenticationData.swift:27</code></h4>

<p>Signature via ecdh ephemeral-static</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#3] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#4] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(

</code></pre>
<h4 id='code-sources-idp-models-registrationdata-swift-108-code' class='heading'><code>../Sources/IDP/Models/RegistrationData.swift:108</code></h4>

<p>Signature via ecdh ephemeral-static</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#4] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#3] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwe-encryption-swift-20-code' class='heading'><code>../Sources/IDP/internal/JWT/JWE+Encryption.swift:20</code></h4>

<p>Signature via ecdh ephemeral-static</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#5] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#6] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(

</code></pre>
<h4 id='code-sources-idp-internal-tokenpayload-swift-180-code' class='heading'><code>../Sources/IDP/internal/TokenPayload.swift:180</code></h4>

<p>Signature via ecdh ephemeral-static</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#6] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#2] one time usage for JWE ECDH-ES Encryption
guard let jweHeader = try? JWE.Header(algorithm: JWE.Algorithm.ecdh_es(keyExchangeContext),

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-cryp_2-o-cryp_2-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Cryp_2">O.Cryp_2</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OCryp_2" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Cryp_2</td>

<td>Nur bewährte Implementierungen bei kryptographischen Primitiven.</td>

<td>Die Anwendung MUSS auf bewährte Implementierungen zur Umsetzung kryptographischer Primitive und Protokolle zurückgreifen (vgl. [TR02102-2]).</td>

<td>Der Evaluator prüft die Liste der verwendeten Krypto- Implementierungen gegen den aktuellen Stand der Technik (vgl. [TR02102-2]).</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>All cryptographic requirements are defined within <code>gemSpec_Krypt</code>. The document was created together with BSI.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-cryp_3-o-cryp_3-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Cryp_3">O.Cryp_3</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OCryp_3" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Cryp_3</td>

<td>Passende Wahl der kryptographischen Primitive.</td>

<td>Die Wahl kryptographischer Primitive MUSS passend zum Anwendungsfall sein und dem aktuellen Stand der Technik (siehe [TR02102-1]) entsprechen.</td>

<td>Der Evaluator prüft die Abwägungen des Herstellers zur Wahl der kryptographischen Primitive und prüft, ob diese dem aktuellen Stand der Technik entsprechen (vgl. [TR02102-1]).</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>All cryptographic requirements are defined within <code>gemSpec_Krypt</code>. The document was created together with BSI.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-62-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:62</code></h4>

<p>Secure Enclave Key generation</p>
<pre class="highlight plaintext"><code>// Keychain Query
// [REQ:BSI-eRp-ePA:O.Cryp_3#2,O.Cryp_6#2] Secure Enclave Key generation
let query: [String: Any] = [kSecClass as String: kSecClassKey,

</code></pre>
<h4 id='code-sources-idp-internal-idpcrypto-swift-45-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:45</code></h4>

<p>Brainpool key generator</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19179#2] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:BSI-eRp-ePA:O.Cryp_3#3] Brainpool key generator
try BrainpoolP256r1.KeyExchange.generateKey()

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwe-kdf-swift-35-code' class='heading'><code>../Sources/IDP/internal/JWT/JWE+KDF.swift:35</code></h4>

<p>Brainpool key generator</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_3#4] Brainpool key generator
// [REQ:gemSpec_eRp_FdV:A_19179#4] Key pair generation delegated to OpenSSL
= { try BrainpoolP256r1.KeyExchange.generateKey() })

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-101-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:101</code></h4>

<p>Brainpool key generator</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4357] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:gemSpec_Krypt:GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:BSI-eRp-ePA:O.Cryp_3#5] Brainpool key generator
// [REQ:gemSpec_eRp_FdV:A_19179#5] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
let keyPairGenerator = { try BrainpoolP256r1.KeyExchange.generateKey() }

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-cryp_4-o-cryp_4-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Cryp_4">O.Cryp_4</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OCryp_4" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Cryp_4</td>

<td>Zweckbindung kryptographischer Schlüssel.</td>

<td>Kryptographische Schlüssel DÜRFEN NICHT für mehr als genau einen Zweck eingesetzt werden.</td>

<td>Der Evaluator prüft die verwendeten kryptographischen Schlüssel auf ihre Zweckgebundenheit. Es wird der Zweck nach Schutz durch Verschlüsselung und Authentisierung unterschieden.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>All cryptographic requirements are defined within <code>gemSpec_Krypt</code>. The document was created together with BSI.</p>
<h4 id='code-sources-idp-internal-tokenpayload-swift-181-code' class='heading'><code>../Sources/IDP/internal/TokenPayload.swift:181</code></h4>

<p>one time usage for JWE ECDH-ES Encryption</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#6] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#2] one time usage for JWE ECDH-ES Encryption
guard let jweHeader = try? JWE.Header(algorithm: JWE.Algorithm.ecdh_es(keyExchangeContext),

</code></pre>
<h4 id='code-sources-idp-models-registrationdata-swift-109-code' class='heading'><code>../Sources/IDP/Models/RegistrationData.swift:109</code></h4>

<p>one time usage for JWE ECDH-ES Encryption</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#4] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#3] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(

</code></pre>
<h4 id='code-sources-idp-models-signedauthenticationdata-swift-28-code' class='heading'><code>../Sources/IDP/Models/SignedAuthenticationData.swift:28</code></h4>

<p>one time usage for JWE ECDH-ES Encryption</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#3] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#4] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(

</code></pre>
<h4 id='code-sources-idp-models-signedchallenge-swift-37-code' class='heading'><code>../Sources/IDP/Models/SignedChallenge.swift:37</code></h4>

<p>one time usage for JWE ECDH-ES Encryption</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#2] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#5] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwe-encryption-swift-21-code' class='heading'><code>../Sources/IDP/internal/JWT/JWE+Encryption.swift:21</code></h4>

<p>one time usage for JWE ECDH-ES Encryption</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#5] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#6] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-588-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:588</code></h4>

<p>Signature creation with eGK with dedicated C.CH.AUT</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_4#7|12] Signature creation with eGK with dedicated C.CH.AUT
func sign(message: Data) -&gt; AnyPublisher&lt;Data, Swift.Error&gt; {
    // [REQ:gemSpec_IDP_Frontend:A_20700-07] perform signature with OpenHealthCardKit
    card.sign(data: message)
        .tryMap { response in
            if response.responseStatus == ResponseStatus.success, let signature = response.data {
                return signature
            } else {
                throw NFCSignatureProviderError.signingFailure(.responseStatus(response.responseStatus))
            }
        }
        .eraseToAnyPublisher()
}
</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-cryp_5-o-cryp_5-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Cryp_5">O.Cryp_5</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OCryp_5" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Cryp_5</td>

<td>Nutzung von starken kryptographischen Schlüsseln.</td>

<td>Die Stärke der kryptographischen Schlüssel MUSS dem aktuellen Stand der Technik entsprechen (siehe [TR02102-1]).</td>

<td>Der Evaluator prüft die Stärke der verwendeten Schlüssel gegen den aktuellen Stand der Technik (vgl. [TR02102-1]).</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use Brainpool256R1 and ECSECPrimeRandom 256, see usages in <a href="#OCrypt_1">O.Cryp_1</a> to <a href="#OCrypt_4">O.Cryp_4</a></p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-cryp_6-o-cryp_6-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Cryp_6">O.Cryp_6</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OCryp_6" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Cryp_6</td>

<td>Manipulationsschutz kryptographischer Schlüssel durch Umgebung.</td>

<td>Alle kryptographischen Schlüssel SOLLEN in einer vor Manipulation und Offenlegung geschützten Umgebung liegen.</td>

<td>Der Evaluator prüft die Umgebung für die Ablage kryptographischer Schlüssel. Als sichere Umgebung gelten beispielsweise Secure Enclave, embedded Secure Element, Trusted Execution Environment etc. Hierbei ist der Betrieb auf allen zugelassenen Hardware-Plattformen zu berücksichtigen. Bei Nichteinhaltung prüft der Evaluator die Abwägungen des Herstellers zu den Auswirkungen auf die Sicherheit der Anwendungen bzw. diskutiert einen fehlenden Schutz in der Risikobewertung.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Persisted cryptographic keys are created within the devices secure enclave. Temporal keys are discarded as soon as usage is no longer needed.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-62-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:62</code></h4>

<p>Secure Enclave Key generation</p>
<pre class="highlight plaintext"><code>// Keychain Query
// [REQ:BSI-eRp-ePA:O.Cryp_3#2,O.Cryp_6#2] Secure Enclave Key generation
let query: [String: Any] = [kSecClass as String: kSecClassKey,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-cryp_7-o-cryp_7-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Cryp_7">O.Cryp_7</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OCryp_7" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Cryp_7</td>

<td>Manipulationsschutz kryptographischer Operationen durch Umgebung.</td>

<td>Alle kryptographischen Operationen SOLLEN in einer vor Manipulation und Offenlegung geschützten Umgebung stattfinden.</td>

<td>Der Evaluator prüft die Umgebung für die Durchführung kryptographischer Operationen analog zu O.Cryp_6. Der Betrieb auf allen zugelassenen Hardware- Plattformen ist dabei zur berücksichtigen.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>As Brainpool256R1 is not available within secure enclave but enforced by BSI where possible, we use secure enclave encryption only for biometric authentication. Everywhere else, cryptographic operations are ephemeral or use the eGK as a secure execution environment.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-20-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:20</code></h4>

<p>Container for private key operations using secure enclave private keys</p>
<pre class="highlight plaintext"><code>/// Represents a (SecureEnclave) private key, namely `PrK_SE_AUT`, secured by iOS Biometrics.
///
/// [REQ:gemSpec_IDP_Frontend:A_21590] This is the container to represent biometric keys. Usage is limited to
/// authorization purposes
/// [REQ:BSI-eRp-ePA:O.Cryp_7#2] Container for private key operations using secure enclave private keys
public struct PrivateKeyContainer {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_1-o-data_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_1">O.Data_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_1</td>

<td>Maximale Sicherheit bei Werkseinstellung.</td>

<td>Die Werkseinstellung der Anwendung MUSS die maximale Sicherheit bieten.</td>

<td>Der Evaluator prüft die Standardeinstellungen der Anwendung bei ihrer Installation. Das umfasst unter anderem die Berechtigungen des Betriebssystems, welche die Anwendung einfordert. Die Berechtigungen müssen dem Zweck der Anwendung dienen und dürfen erst angefragt werden, sobald sie Verwendung finden.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>User preferences are asked without discrimination within the onboarding process. Application permissions are asked, whenever they are needed, e.g. location permission is only asked when the user is about to search for a pharmacy (see <a href="#OPlat_2">O.Plat_2</a>). If a user chooses to not give the permission, features are still available, if possible.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_2-o-data_2-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_2">O.Data_2</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_2" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_2</td>

<td>Verschlüsselung aller sensiblen Daten.</td>

<td>Die Anwendung MUSS sensible Daten verschlüsselt speichern. Die betriebssystemeigene Verschlüsselung des Dateisystems genügt nicht. Das Schlüsselmaterial für diese Verschlüsselung DARF NICHT unverschlüsselt persistiert werden. Dies gilt sowohl für flüchtiges Ablegen (z. B. im Arbeitsspeicher), als auch für dauerhaftes Speichern (z. B. in einer Cloud- Umgebung). Eine hardwareunterstützte Schlüsselverwaltung der Plattform SOLL bevorzugt verwendet werden.</td>

<td>Der Evaluator validiert, dass sensible Daten (s. Anhang A) von der Anwendung nur verschlüsselt gespeichert werden können. Der Evaluator prüft weiterhin, ob eine hardwaregestützte Schlüsselverwaltung des Betriebssystems für die Speicherung der hierfür notwendigen Schlüssel verwendet wird. Ist ein hinreichender Schutz der Schlüssel durch die Plattform sichergestellt (z.

B. in einem embedded Secure Element/Trusted Execution Environment), muss die Anwendung diese Schlüssel wirksam gegen Offenlegung schützen. Der Evaluator nimmt die Wirksamkeit gegenüber Reverse Engineering in die Risikobewertung auf.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use the OS Keychain to persist sensitive data. The keychain either stores or encrypts via SecureEnclave. Encrypting the database has disadvanteges that we discussed and decided to not yet implement additional database encryption. We are periodically evaluating solutions for this requirement.</p>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-22-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:22</code></h4>

<p>Implementation of data storage that is persisted via keychain</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_4#3] Implementation of data storage that is persisted via keychain
// [REQ:BSI-eRp-ePA:O.Source_7#2,O.Data_2#2,O.Auth_13#3] Implementation of data storage that is persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_3-o-data_3-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_3">O.Data_3</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_3" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_3</td>

<td>Ablage sensibler Daten.</td>

<td>Die Anwendung SOLL sensible Daten in einem vor Einsicht und Manipulation besonders geschützten Bereich ablegen.</td>

<td>Der Evaluator prüft, ob hardwaregestützte Maßnahmen (wie z.B. Trusted Execution Environment) zur Speicherung sensibler Daten verwendet werden. Sollte dies nicht der Fall sein, nimmt der Evaluator die Abwägungen der Wirksamkeit gegenüber Reverse Engineering in die Risikobewertung auf.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Currently it is not possible to store data within the secure enclave on iOS. We store all data on the encrypted application container on the device. See <code>eRpApp.entitlements</code> for <code>NSFileProtectionCompleteUnlessOpen</code> usage.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_4-o-data_4-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_4">O.Data_4</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_4" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_4</td>

<td>Zugriff auf sensible Daten durch Dritte.</td>

<td>Die Anwendung DARF Ressourcen, die einen Zugriff auf sensible Daten ermöglichen, gegenüber Dritten NICHT verfügbar machen.</td>

<td>Der Evaluator prüft, ob die Anwendung Ressourcen zur Verfügung stellt, über die Dritte Zugriff auf sensible Daten erhalten können. Dies umfasst Daten in geteilten Speicherbereichen, Dienste oder Interfaces über die sensible Daten bereitgestellt werden.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Everything we store, safe or send anywhere is both verified as in <a href="#OResi_6">O.Resi_6</a> and or encrypted, such as Keychain or the application container.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_5-o-data_5-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_5">O.Data_5</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_5" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_5</td>

<td>Löschung aller erhobenen sensiblen Daten nach Abschluss der Verwendung durch die Anwendung.</td>

<td>A Alle erhobenen sensiblen Daten DÜRFEN NICHT über die Dauer ihrer jeweiligen Verarbeitung hinaus in der Anwendung gehalten werden.</td>

<td>Der Evaluator prüft, ob Daten über den Zeitraum ihrer Verarbeitung hinaus in der Anwendung gehalten werden. Daten, die nicht mehr genutzt werden, müssen sicher gelöscht werden.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Ephemeral private keys are released as soon as they are no longer needed (see <a href="#OSource_5">O.Source_5</a>).</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_6-o-data_6-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_6">O.Data_6</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_6" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_6</td>

<td>Erhebung, Speicherung und Verarbeitung von ausschließlich für den Zweck der Anwendung notwendigen Daten.</td>

<td>Die Anwendung MUSS die Grundsätze der Datensparsamkeit und Zweckbindung berücksichtigen.</td>

<td>Der Evaluator prüft, welche Daten von der Anwendung erhoben, gespeichert und verarbeitet werden und stellt diese dem Zweck der Anwendung gegenüber.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Collected data is sparse and use case related as required.</p>
<h4 id='code-sources-erpapp-screens-cardwall-can-cardwallcanview-swift-121-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/CAN/CardWallCANView.swift:121</code></h4>

<p>CAN is used for eGK connection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#2,O.Data_6#2] CAN is used for eGK connection
CardWallCANInputView(

</code></pre>
<h4 id='code-sources-erpapp-screens-cameraview-erxtaskscannerview-swift-22-code' class='heading'><code>../Sources/eRpApp/Screens/CameraView/ErxTaskScannerView.swift:22</code></h4>

<p>Scanning tasks contains purpose related data input</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#1,O.Data_6#3] Scanning tasks contains purpose related data input
// [REQ:BSI-eRp-ePA:O.Source_1#1] Scanning tasks starts with scanner callback
store.send(.analyse(scanOutput: $0))

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-pin-cardwallpinview-swift-17-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/PIN/CardWallPINView.swift:17</code></h4>

<p>PIN is used for eGK Connection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#3,O.Data_6#4] PIN is used for eGK Connection
PINView(store: store).padding()

</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-redeem-pharmacycontactview-swift-11-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Redeem/PharmacyContactView.swift:11</code></h4>

<p>Contact information is collected when needed for redeeming</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#6,O.Data_6#5] Contact information is collected when needed for redeeming
struct PharmacyContactView: View {

</code></pre>
<h4 id='code-sources-erpapp-tracking-analyticsreducer-swift-16-code' class='heading'><code>../Sources/eRpApp/Tracking/AnalyticsReducer.swift:16</code></h4>

<p>User interaction analytics trigger …</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#4,O.Purp_4#1,O.Data_6#6] User interaction analytics trigger ...
struct AnalyticsReducer&lt;ContentReducer: Reducer&gt;: Reducer

</code></pre>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-101-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:101</code></h4>

<p>… records data only if user opt-in is given.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#5,O.Purp_4#2,O.Data_6#7] ... records data only if user opt-in is given.
if optIn {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_7-o-data_7-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_7">O.Data_7</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_7" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_7</td>

<td>Speicherung und Verarbeitung von sensiblen Daten.</td>

<td>Sofern die Anwendung an ein Hintergrundsystem angebunden ist, SOLL die Speicherung und Verarbeitung von sensiblen Daten im Hintergrundsystem erfolgen.</td>

<td>Der Evaluator prüft, welche Daten die Anwendung permanent speichert bzw. verarbeitet. Er ermittelt das Risiko, das durch eine solche Speicherung und Verarbeitung in der Anwendung entsteht und nimmt es in die Risikobewertung mit auf.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Private data is not initially created by the application. Only additional information, such as redeeming or deleting prescriptions create data. The created data is kept on the FD.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_8-o-data_8-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_8">O.Data_8</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_8" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_8</td>

<td>Entfernung von Metadaten mit Datenschutzrelevanz.</td>

<td>Bei der Verwendung von Aufnahmegeräten (z. B. Kamera) MÜSSEN sämtliche Metadaten mit Datenschutz-Relevanz, wie etwa Rückschlüsse auf die GPS-Koordinaten des Aufnahmeorts, eingesetzte Hardware etc., entfernt werden.</td>

<td>Der Evaluator prüft, ob die Anwendung Daten erheben kann, die Metadaten enthalten. In diesem Fall prüft der Evaluator, ob Metadaten mit Datenschutzrelevanz vor der Weiterverarbeitung, wie beispielsweise dem Transfer an das Hintergrundsystem, entfernt werden.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The device camera is used optional for scanning prescriptions and for setting a profile avatar. Avatar image data never leaves the device.</p>
<h4 id='code-sources-erpapp-screens-cameraview-avscannerview-swift-40-code' class='heading'><code>../Sources/eRpApp/Screens/CameraView/AVScannerView.swift:40</code></h4>

<p>This controller uses the camera as an input device. Frames are processed but never</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_8#2] This controller uses the camera as an input device. Frames are processed but never
// stored, metadata is never created here.
class AVScannerViewController: UIViewController, AVCaptureMetadataOutputObjectsDelegate {

</code></pre>
<h4 id='code-sources-erpapp-screens-main-profile-imagepicker-photopicker-swift-47-code' class='heading'><code>../Sources/eRpApp/Screens/Main/Profile/ImagePicker/PhotoPicker.swift:47</code></h4>

<p>Meta data is completely removed by converting to jpeg</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_8#3,O.Data_9#2] Meta data is completely removed by converting to jpeg
guard let data = tempImage.jpegData(compressionQuality: 0.3) else {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_9-o-data_9-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_9">O.Data_9</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_9" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_9</td>

<td>Zugriffsbeschränkung bei der Erhebung von sensiblen Daten.</td>

<td>Bei der Erhebung von sensiblen Daten durch die Verwendung von Aufnahmegeräten (z. B. Kamera), MUSS vorgebeugt werden, dass andere Anwendungen darauf Zugriff erlangen könnten, etwa über eine Mediengalerie.</td>

<td>Der Evaluator prüft, ob erhobene sensible Daten anderen Anwendungen auf dem Gerät verfügbar gemacht werden oder Daten in öffentlichen Verzeichnissen gespeichert werden.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The device camera is used for scanning prescriptions and for setting a profile avatar. Neither use-cases export data to the device photo library or export in any other way.</p>
<h4 id='code-sources-erpapp-screens-main-profile-imagepicker-photopicker-swift-47-code' class='heading'><code>../Sources/eRpApp/Screens/Main/Profile/ImagePicker/PhotoPicker.swift:47</code></h4>

<p>Meta data is completely removed by converting to jpeg</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_8#3,O.Data_9#2] Meta data is completely removed by converting to jpeg
guard let data = tempImage.jpegData(compressionQuality: 0.3) else {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_10-o-data_10-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_10">O.Data_10</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_10" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_10</td>

<td>Keine Aufzeichnungen bei der Eingabe sensibler Daten über die Tastatur.</td>

<td>Bei der Eingabe sensibler Daten über die Tastatur SOLL die Anwendung unterbinden, dass Aufzeichnungen für Dritte erkennbar werden.</td>

<td>Der Evaluator prüft, ob sensible Daten über Softwaretastaturen des Betriebssystems oder von Drittanbietern eingegeben werden können. Dies schließt insbesondere Caches, Autokorrektur- und Autovervollständigungs-verfahren, Eingabegeräte von Drittanbietern und jegliche für Dritte auswertbare Speicherung, mit ein. Ist dies der Fall, prüft der Evaluator die Abwägungen des Herstellers und berücksichtigt diese in der Risikobewertung.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Password fields are marked as such and thus disallow autocorrections. Search for <code>SecureField</code> or <code>SecureFieldWithReveal</code> for all usages.</p>
<h4 id='code-app-sources-appdelegate-swift-35-code' class='heading'><code>../App/Sources/AppDelegate.swift:35</code></h4>

<p>Keyboard extensions are disallowed</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_10#2|10] Keyboard extensions are disallowed
func application(
    _: UIApplication,
    shouldAllowExtensionPointIdentifier extensionPointIdentifier: UIApplication.ExtensionPointIdentifier
) -&gt; Bool {
    // Disallow 3rd party keyboards to prevent leaking sensitive data
    if extensionPointIdentifier == .keyboard {
        return false
    }
    return true
}
</code></pre>
<h4 id='code-sources-erpapp-components-controls-securefieldwithreveal-swift-36-code' class='heading'><code>../Sources/eRpApp/Components/Controls/SecureFieldWithReveal.swift:36</code></h4>

<p><code>SecureFields</code> are used for password input.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_10#3] `SecureFields` are used for password input.
SecureField(text: $text) {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_11-o-data_11-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_11">O.Data_11</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_11" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_11</td>

<td>Kein Export sensibler Daten in die Zwischenablage.</td>

<td>Bei der Eingabe sensibler Daten SOLL der Export in die Zwischenablage unterbunden werden. Die Anwendung KANN alternativ eine eigene Zwischenablage implementieren, welche vor dem Zugriff durch andere Anwendungen geschützt ist.</td>

<td>Falls die Anwendung einen Export sensibler Daten in die Zwischenablage des Betriebssystems erlaubt, muss der Abfluss dieser Daten in der Risikobewertung berücksichtigt werden.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use default platform behavior for password fields. Pasting into password fields is allowed, copying is denied. In general the clipboard is only filled with any data, if the user triggers it.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_12-o-data_12-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_12">O.Data_12</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_12" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_12</td>

<td>Kein Export von sensiblen Daten aus der Quelle.</td>

<td>Sensible Daten wie biometrische Daten oder private Schlüssel DÜRFEN NICHT aus der Komponente, auf der sie erzeugt wurden, exportiert werden.</td>

<td>Der Evaluator prüft ob sensible Daten, bei denen keine Notwendigkeit für einen Export besteht, trotzdem exportierbar sind. Dies umfasst unter anderem biometrische Daten oder private kryptografische Schlüssel.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>There is no API from Apple that allows extraction of biometric or private key data from the secure enclave. Non ephemeral keys are only created within the secure enclave.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_13-o-data_13-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_13">O.Data_13</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_13" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_13</td>

<td>Keine Speicherung des Bildschirminhaltes oder Zugriff Dritter bei Anzeige sensibler Daten.</td>

<td>Die Anwendung MUSS Funktionen des Betriebssystems zur Unterbindung der Anzeige sensibler Daten und des Zugriffs für Dritte und der Speicherung des Bildschirms (z. B. Screenshots und Anzeigen für das App- Switching) nutzen.</td>

<td>Der Evaluator prüft, ob die Anwendung das Erzeugen von Screenshots verbietet. Dies umfasst sowohl das aktive, als auch das passive Erzeugen von Screenshots wie es beispielsweise für die Vorschau im Task-Manager durchgeführt wird. Der Evaluator prüft außerdem, ob sensible Daten nicht länger als notwendig in der Anwendung angezeigt werden. Das Restrisiko der Anzeige sensibler Daten wird in der Risikobewertung berücksichtigt.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Suppressing Screenshots is not possible as of now.</p>
<h4 id='code-sources-erpapp-scenedelegate-swift-246-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:246</code></h4>

<p>Moving the application to the background blurs the application</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_13#2,O.Plat_9#2] Moving the application to the background blurs the application
// window.
addBlurOverlayToWindow()

</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-165-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:165</code></h4>

<p>Moving the application to the foreground removes the blur.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_13#3,O.Plat_9#3] Moving the application to the foreground removes the blur.
removeBlurOverlayFromWindow()

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_14-o-data_14-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_14">O.Data_14</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_14" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_14</td>

<td>Verschlüsselung aller sensiblen Daten im gesperrten Zustand.</td>

<td>Die Anwendung MUSS sicherstellen, dass im gesperrten Zustand des Endgeräts alle sensiblen Daten verschlüsselt sind.</td>

<td>Ältere Plattformversionen erlauben teilweise die Speicherung der Anwendung auf externen Speichermedien, die nicht der Speicherverschlüsselung unterliegen. Der Evaluator prüft, ob die Anwendung solche oder vergleichbare Vorgehensweisen untersagt.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>See <code>eRpApp.entitlements</code> for <code>NSFileProtectionCompleteUnlessOpen</code> usage.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_15-o-data_15-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_15">O.Data_15</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_15" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_15</td>

<td>Gerätebindung lokal gespeicherter Daten.</td>

<td>Die Anwendung MUSS lokal gespeicherte Daten verschlüsselt mit einer sicheren Gerätebindung versehen.</td>

<td>Der Evaluator prüft, ob Daten, die von der Anwendung gespeichert werden, auf anderen Geräten verarbeitet werden können. Von dieser Einschränkung ausgenommen sind Daten, die vom Nutzer explizit zur Verarbeitung auf anderen Geräten exportiert werden.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Biometric keys are always bound to the device and cannot leave the secure enclave. Actual user data is excluded from backups and cannot be exported.</p>
<h4 id='code-sources-erplocalstorage-coredatacontroller-swift-83-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataController.swift:83</code></h4>

<p>Database backup exclusion</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#4,O.Arch_4#2,O.Data_15#1] Database backup exclusion
if excludeFromBackup, let storeUrl = store.url {

</code></pre>
<h4 id='code-sources-idp-privatekeycontainer-swift-126-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:126</code></h4>

<p>prevents migration to other devices</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21586] prevents migration to other devices
// [REQ:BSI-eRp-ePA:O.Data_15#2] prevents migration to other devices
kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_16-o-data_16-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_16">O.Data_16</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_16" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_16</td>

<td>Enterfernen oder anderweitiges unzugänglich machen aller sensiblen Daten auf dem Endgerät bei Deinstallation der Anwendung.</td>

<td>Es MUSS vom Hersteller sichergestellt werden, dass bei der Deinstallation der Anwendung alle sensiblen Daten und anwendungsspezifischen Anmeldeinformationen auf dem Endgerät nicht mehr zugreifbar sind.</td>

<td>Der Evaluator prüft, ob nach der Deinstallation der Anwendung Daten auf dem Endgerät zurückbleiben. Ist dies der Fall, prüft der Evaluator weiterhin, ob diese Daten sensible Informationen beinhalten oder Rückschlüsse auf sensible Daten zulassen.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Deletion is completely handled by the OS. We have no means of doing anything while deinstallation is running. All sensitive keychain data is tied to the user profile id and cannot be accessed after deinstallation. though technically the information still persists for a short period of time (&lt;24h) after some kind of daily cleanup routine by the OS it will be removed. The user may choose to manually logout or delete profiles before app deletion.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_17-o-data_17-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_17">O.Data_17</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_17" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_17</td>

<td>Möglichkeit zum Löschen oder anderweitigen unzugänglich machen aller sensiblen Daten der Anwendung.</td>

<td>Die Anwendung MUSS dem Nutzer die Möglichkeit geben, dass alle sensiblen Daten und anwendungsspezifischen Anmeldeinformationen vollständig gelöscht bzw. unzugänglich gemacht werden.</td>

<td>Der Evaluator validiert, dass dem Nutzer die Möglichkeit gegeben wird alle sensiblen Daten vollständig zu löschen oder unzugänglich zu machen. Darüber hinaus prüft er die Wirksamkeit der getroffenen Maßnahmen durch praktische Tests.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Deletion is completely handled by the OS. We have no means of doing anything while deinstallation is running. All sensitive keychain data is tied to the user profile id and cannot be accessed after deinstallation. though technically the information still persists for a short period of time (&lt;24h) after some kind of daily cleanup routine by the OS it will be removed. The user may choose to manually logout or delete profiles before app deletion.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-data_18-o-data_18-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Data_18">O.Data_18</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OData_18" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Data_18</td>

<td>Sicheres Überschreiben von Nutzerdaten im Gerät, ausgelöst durch den Anwender.</td>

<td>Um dem Missbrauch von sensiblen Daten nach einem Geräteverlust entgegenzuwirken, KANN die Anwendung einen Kill-Switch realisieren, d.

h. ein absichtliches, sicheres Überschreiben von Nutzerdaten im Gerät auf Anwendungsebene, ausgelöst durch das Hintergrundsystem. Der Hersteller MUSS die Auslösung des Kill-Switches durch den Anwender über das Hintergrundsystem durch starke Authentifizierungsmechanismen vor missbräuchlicher Nutzung schützen.</td>

<td>Der Evaluator führt eine Löschung der Daten über das Hintergrundsystem durch und validiert, dass keine Nutzerdaten mehr auf dem Gerät lesbar sind.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Not applicable: no kill switch realized.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-ntwk_1-o-ntwk_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Ntwk_1">O.Ntwk_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="ONtwk_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Ntwk_1</td>

<td>Netzwerkkommunikation durchgängig mit gegenseitiger Authentisierung verschlüsselt</td>

<td>Jegliche Netzwerkkommunikation der Anwendung MUSS durchgängig mit gegenseitiger Authentisierung verschlüsselt (zum Beispiel mittels mTLS) werden.</td>

<td>Der Evaluator validiert, dass ausschließlich mit gegenseitiger Authentisierung verschlüsselte Kommunikation zwischen der Anwendung und anderen Komponenten möglich ist.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>No exceptions set in <code>NSAppTransportSecurity</code>, HTTP via TLS is enforced (see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a>); Certificate transparency ensures authenticity of the server side. User access tokens ensures client side authenticity.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-ntwk_2-o-ntwk_2-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Ntwk_2">O.Ntwk_2</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="ONtwk_2" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Ntwk_2</td>

<td>Konfiguration der verschlüsselten Verbindung gemäß aktuellem Stand der Technik.</td>

<td>Die Konfiguration der verschlüsselten Verbindungen MUSS dem aktuellen Stand der Technik entsprechen (vgl. [TR02102-2]).</td>

<td>Der Evaluator validiert, dass die in O.Ntwk_1 beschriebene Kommunikation dem Stand der Technik (siehe [TR02102-2]) entspricht.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use one wrapper around <code>NSURLSession</code> for network communication that uses an ephemeral configuration only allowing TLS 1.2 or greater. Network communication security in general is specified within <code>gemSpec_Krypt</code> and aggreed upon with BSI.</p>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-36-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:36</code></h4>

<p>URLSession is used as Network Framework</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_IDP_Frontend:A_20606#2] Setup of minimum TLS Version to use.
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework
urlSessionConfiguration.tlsMinimumSupportedProtocolVersion = .TLSv12

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-ntwk_3-o-ntwk_3-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Ntwk_3">O.Ntwk_3</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="ONtwk_3" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Ntwk_3</td>

<td>Sichere Kommunikationskanäle nur mit Betriebssystem- Funktionen oder sicherheitsüberprüfter Drittsoftware.</td>

<td>Die Anwendung MUSS sicherheitsüberprüfte Drittanbieter-Software verwenden, um sichere Kommunikationskanäle aufzubauen. Dies schließt die im Betriebssystem mitgelieferte Bibliothek mit ein.</td>

<td>Der Evaluator prüft, wie ein sicherer Kommunikationskanal aufgebaut wird. Wenn keine Betriebssystem- Funktionen verwendet werden, validiert der Evaluator, dass die Drittanbieter-Software, welche zum Verbindungsabbau verwendet wird, den in Kapitel 5.5.4 beschriebenen Anforderungen genügt. Eigene Implementierungen zum Aufbau sicherer Kommunikationskanäle sind nicht zulässig. Gemäß A.OperatingSystem werden die Funktionen zum Aufbau von sicheren Kommunikationskanäle im Betriebssystem als sicher angenommen. Sicherheitsüberprüft bedeutet, dass alle sicherheitsrelevanten Bereiche der Software durch eine weitere Partei auf ihre Sicherheitseigenschaften hinuntersucht worden sind.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use the system provided NSURLSession for network communication and no additional layer for TLS encryption. The iOS encryption is certified according to <a href="https://support.apple.com/de-de/guide/certifications/apc3fa917cb49/web">https://support.apple.com/de-de/guide/certifications/apc3fa917cb49/web</a></p>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-36-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:36</code></h4>

<p>URLSession is used as Network Framework</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_IDP_Frontend:A_20606#2] Setup of minimum TLS Version to use.
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework
urlSessionConfiguration.tlsMinimumSupportedProtocolVersion = .TLSv12

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-ntwk_4-o-ntwk_4-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Ntwk_4">O.Ntwk_4</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="ONtwk_4" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Ntwk_4</td>

<td>Unterstützung von Zertifikats- Pinning.</td>

<td>Die Anwendung MUSS Zertifikats-Pinning anwenden.</td>

<td>Der Evaluator validiert, dass die Anwendung Zertifikats-Pinning unterstützt und dieses wirksam umsetzt.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We do not pin TLS Certificates, instead we pin TI PKI Certificates for FD and IDP communication. Since we got an agreement with the BSI regarding the usage of pinning, (TI PKI Pinning is enough) we remove the TLS pinning itself, in favor of certificate transparency + our second layer of TI Certificate pinning. If accessing the APOVZD, we don’t have such pinning. However, the need for pinning is due to high protection demand of the medical data. But the APOVZD does not hold such data, thus we interpret that pinning is not necessary there at all. Furthermore, we don’t see attack vectors regarding the APOVZD. It only required an API Key, but no authentication. Redeeming prescriptions directly with pharmacies, we encrypt the payload with an encryption certificate, that again is checked to be within TI PKI.</p>
<h4 id='code-sources-erpapp-appconfiguration-swift-118-code' class='heading'><code>../Sources/eRpApp/AppConfiguration.swift:118</code></h4>

<p>Gematik Root CA 3 as a trust anchor has to be set in the program code</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] Gematik Root CA 3 as a trust anchor has to be set in the program code
// [REQ:BSI-eRp-ePA:O.Ntwk_4#2|16] Gematik Root CA 3 as a trust anchor has to be set in the program code
// swiftlint:disable:next force_try
let TRUSTANCHOR_GemRootCa3 = try! TrustAnchor(withPEM: """
MIICaTCCAg+gAwIBAgIBATAKBggqhkjOPQQDAjBtMQswCQYDVQQGEwJERTEVMBMG
A1UECgwMZ2VtYXRpayBHbWJIMTQwMgYDVQQLDCtaZW50cmFsZSBSb290LUNBIGRl
ciBUZWxlbWF0aWtpbmZyYXN0cnVrdHVyMREwDwYDVQQDDAhHRU0uUkNBMzAeFw0x
NzEwMTcwNzEzMDNaFw0yNzEwMTUwNzEzMDNaMG0xCzAJBgNVBAYTAkRFMRUwEwYD
VQQKDAxnZW1hdGlrIEdtYkgxNDAyBgNVBAsMK1plbnRyYWxlIFJvb3QtQ0EgZGVy
IFRlbGVtYXRpa2luZnJhc3RydWt0dXIxETAPBgNVBAMMCEdFTS5SQ0EzMFowFAYH
KoZIzj0CAQYJKyQDAwIIAQEHA0IABFhZKSE0xvaeHzZB0A7sRYwIphEWYk/+uFw4
kOLnBt2kbP4P7L0lFOQfp6W0a2lCcmKk+k25VHrj7PCMyV/AVdqjgZ4wgZswHQYD
VR0OBBYEFN/DvnW+JesTMjAup1CFCJ83ENDoMEIGCCsGAQUFBwEBBDYwNDAyBggr
BgEFBQcwAYYmaHR0cDovL29jc3Aucm9vdC1jYS50aS1kaWVuc3RlLmRlL29jc3Aw
DwYDVR0TAQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAQYwFQYDVR0gBA4wDDAKBggq
ghQATASBIzAKBggqhkjOPQQDAgNIADBFAiEAnOlHsQ5tQ2HPoKVngVQnbvVGteLy
MSEnNGbYegnfPFECIEUlFmjATBNklr35xvWQPZUMdIsy7SzUulwFDodpdGr/
-----END CERTIFICATE-----
""")
</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-ntwk_5-o-ntwk_5-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Ntwk_5">O.Ntwk_5</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="ONtwk_5" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Ntwk_5</td>

<td>Validierung des Server-Zertifikats des Hintergrundsystems.</td>

<td>Die Anwendung MUSS das Server-Zertifikat des Hintergrundsystems überprüfen.</td>

<td>Der Evaluator prüft, wie die Anwendung das Zertifikat des Hintergrundsystems validiert.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use <code>NSURLSession</code> as the base for all our network requests. <code>NSURLSession</code> uses ATS (App Transport Security) that enforces rules for TLS Certificates, such as authenticity. See <a href="https://support.apple.com/en-us/103214">https://support.apple.com/en-us/103214</a> and <a href="https://developer.apple.com/documentation/bundleresources/information_property_list/nsrequirescertificatetransparency#">https://developer.apple.com/documentation/bundleresources/information_property_list/nsrequirescertificatetransparency#</a> for additional information.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-ntwk_6-o-ntwk_6-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Ntwk_6">O.Ntwk_6</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="ONtwk_6" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Ntwk_6</td>

<td>Validierung der Integrität und Authentizität der Antworten des Hintergrundsystems.</td>

<td>Die Anwendung MUSS die Integrität und Authentizität der Antworten des Hintergrundsystems validieren.</td>

<td>Der Evaluator bestätigt, dass die Integrität und Authentizität der Nachrichten des Hintergrundsystems von der Anwendung validiert werden.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The server uses extended validation certificates to ensure maximum authenticity. On top of TLS we also implement message authenticity by validating checksums and signatures. For IDP Communication see <a href="#OResi_6">O.Resi_6</a>, for FD communication see the following code.</p>
<h4 id='code-sources-vauclient-vauinterceptor-swift-14-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:14</code></h4>

<p>Interceptor implementing request and response encryption.</p>
<pre class="highlight plaintext"><code>/// The VAU (trusted execution environment) http Interceptor to encrypt HTTP-Requests before sending them
/// and decrypting the received encrypted responses.
/// [REQ:BSI-eRp-ePA:O.Ntwk_6#2] Interceptor implementing request and response encryption.
class VAUInterceptor: Interceptor {

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-111-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:111</code></h4>

<p>Decrypting and verifying FD server messages</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Ntwk_6#3|21] Decrypting and verifying FD server messages
func decrypt(data: Data) throws -&gt; String {
    // Steps according to gemSpec_Krypt A_20174
    // [REQ:gemSpec_Krypt:A_20174#13] 3: Decrypt using AES symmetric key
    guard let sealed = try? AES.GCM.SealedBox(combined: data),
          let decrypted = try? AES.GCM.open(sealed, using: symmetricKey),
          let utf8 = decrypted.utf8string
    else {
        throw VAUError.responseValidation
    }

    // [REQ:gemSpec_Krypt:A_20174#14] 4+5: Verify decrypted message. Expect: "1 &lt;request id&gt; &lt;response header+body&gt;"
    let separated = utf8.split(separator: " ", maxSplits: 2).map { String($0) }
    guard separated.count == 3,
          separated[0] == "1",
          separated[1] == requestId
    else {
        throw VAUError.responseValidation
    }

    return separated[2]
}
</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-ntwk_7-o-ntwk_7-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Ntwk_7">O.Ntwk_7</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="ONtwk_7" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Ntwk_7</td>

<td>Verwendung plattformspezifischer Optionen.</td>

<td>Plattformspezifische Optionen, wie beispielsweise „Cleartext Traffic Opt-out“ und

„In-App Transport Security“ MÜSSEN verwendet werden.</td>

<td>Der Evaluator bestätigt, dass die plattformspezifischen Optionen zur Gewährleistung einer sicheren Kommunikation umgesetzt wurden.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The system enforces ATS <a href="https://developer.apple.com/documentation/bundleresources/information_property_list/nsapptransportsecurity/">App Transport Security</a> since the app uses the standard URL Loading System <code>URLSession</code> which automatically negotiate the most secure connection available from the server. Also there are no exceptions configured in the <code>eRpApp/Resources/Info.plist</code> thus insecure networt connections are disabled by default.</p>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-36-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:36</code></h4>

<p>URLSession is used as Network Framework</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_IDP_Frontend:A_20606#2] Setup of minimum TLS Version to use.
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework
urlSessionConfiguration.tlsMinimumSupportedProtocolVersion = .TLSv12

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-ntwk_8-o-ntwk_8-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Ntwk_8">O.Ntwk_8</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="ONtwk_8" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Ntwk_8</td>

<td>Vorhaltung von vollständigen Log-Dateien für alle aufgebauten Verbindungen.</td>

<td>Die Anwendung MUSS für alle Verbindungen Log-Dateien vorhalten. Diese SOLLEN an das Hintergrundsystem übermittelt werden.</td>

<td>Der Evaluator überprüft die von dem Hersteller bereitgestellten Log- Dateien und validiert, dass die HTTP-Header vollständig miterfasst sind. Wenn kein Logging sicherheitsrelevanter Ereignisse auf dem Hintergrundsystem stattfindet, muss dieser Aspekt in der Risikobewertung berücksichtigt werden.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Logging does not take place in the FdV for reasons of data minimization. Furthermore, it is not entirely clear who this log would be for. We have separate responsibilities divided between two different operators of the IDP and the specialized service, and gematik as the manufacturer of the e-prescription app. None of the backend systems have such a required endpoint. Moreover, the aforementioned questions would still arise.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-paid_1-o-paid_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Paid_1">O.Paid_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPaid_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Paid_1</td>

<td>Anzeige kostenpflichtiger Leistungen und Ressourcen.</td>

<td>Die Anwendung MUSS für den Nutzer kenntlich machen, welche kostenpflichtigen Leistungen (z.B. Zusatzfunktionalitäten oder Premiumzugriffe) und welche kostenpflichtigen Ressourcen (z.B. SMS, Telefonate, mobile Daten) von der Anwendung angeboten oder verwendet werden.</td>

<td>Der Evaluator validiert, dass alle kostenpflichtigen Leistungen und Ressourcen eindeutig als solche erkennbar sind.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app does not offer any purchases. The only paid service, that is used by the app in some extent can be mobile data. The terms of use in the app states, that costs might occur using mobile data.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-paid_2-o-paid_2-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Paid_2">O.Paid_2</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPaid_2" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Paid_2</td>

<td>Einverständnis des Nutzers vor dem Ausführen kostenpflichtiger Leistungen.</td>

<td>Die Anwendung MUSS vor der Verwendung kostenpflichtiger Leistungen das Einverständnis des Nutzers einholen.</td>

<td>Der Evaluator validiert, dass alle kostenpflichtigen Leistungen ausschließlich nach Bestätigung durch den Nutzer erbracht werden können.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app does not offer any purchases.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-paid_3-o-paid_3-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Paid_3">O.Paid_3</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPaid_3" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Paid_3</td>

<td>Einverständnis des Nutzers vor einer Zugriffsanforderung auf kostenpflichtige Ressourcen.</td>

<td>Die Anwendung MUSS vor einer Zugriffsanforderung (z. B. Android- Berechtigungen) auf kostenpflichtige Ressourcen, das Einverständnis des Nutzers einholen.</td>

<td>Der Evaluator validiert, dass die Nutzung von Diensten, die zusätzliche Kosten für den Nutzer verursachen können (z.B. das Versenden von SMS), ausschließlich nach Abgabe einer Einverständniserklärung des Nutzers möglich ist.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app does not offer any purchases.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-paid_4-o-paid_4-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Paid_4">O.Paid_4</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPaid_4" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Paid_4</td>

<td>Dauerhaftes Einverständnis des Nutzers auf häufig verwendete, kostenpflichtige Leistungen oder Ressourcen.</td>

<td>Die Anwendung KANN für den Zugriff auf häufig verwendete, kostenpflichtige Ressourcen oder kostenpflichtige Leistungen ein dauerhaftes Einverständnis des Nutzers einholen.</td>

<td>Falls die Anwendung ein dauerhaftes Einverständnis des Nutzers für den Zugriff auf kostenpflichtige Ressourcen fordert, prüft der Evaluator, ob dies für den primären Zweck der Anwendung erforderlich ist (vgl. O.Purp_1).</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app does not offer any purchases.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-paid_5-o-paid_5-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Paid_5">O.Paid_5</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPaid_5" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Paid_5</td>

<td>Entzug des Einverständnisses ermöglichen.</td>

<td>Die Anwendung MUSS den Nutzer in die Lage versetzen zuvor erteilte Einverständnisse zurückzuziehen.</td>

<td>Der Evaluator prüft, ob die Anwendung eine Liste mit allen vom Nutzer gegebenen Einverständniserklärungen anzeigt und diese nachträglich geändert werden kann.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app does not offer any purchases.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-paid_6-o-paid_6-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Paid_6">O.Paid_6</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPaid_6" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Paid_6</td>

<td>Ablage der sensiblen Transaktionshistorie im Hintergrundsystem.</td>

<td>Die Anwendung SOLL die Transaktionshistorie von kostenpflichtigen Leistungen im Hintergrundsystem ablegen. Die Transaktionshistorie, einschließlich der Metadaten, MUSS als sensibles Datum gemäß O.Purp_8 behandelt werden.</td>

<td>Der Evaluator prüft über praktische Tests und Quelltextanalyse, ob eine Transaktionshistorie in der Anwendung vorgehalten wird. Die Transaktionshistorie sollte im Hintergrundsystem sicher gespeichert werden und aus der Anwendung einsehbar sein. Wenn die Transaktionshistorie in der Anwendung selber gespeichert wird, ist in einer Risikobewertung darzustellen, inwieweit die Sicherheit der gespeicherten Daten gewährleistet werden kann.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app does not offer any purchases.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-paid_7-o-paid_7-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Paid_7">O.Paid_7</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPaid_7" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Paid_7</td>

<td>Profilbildung durch Nachverfolgung der Zahlungsströme durch Dritte.</td>

<td>Falls die Anwendung kostenpflichtige Leistungen anbietet, MUSS der Hersteller ein Konzept vorlegen, welches vorbeugt, dass Dritte die Zahlungsströme zur Nutzung von Anwendungsfunktionen zurückverfolgen können.</td>

<td>Der Evaluator prüft, ob über die Nachverfolgung von Zahlungsströmen Rückschlüsse auf die Eigenschaften oder das Verhalten des Nutzers möglich sind. Die Abwägungen des Herstellers bei potenziellen Rückschlüssen sind in der Risikobewertung zu berücksichtigen.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app does not offer any purchases.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-paid_8-o-paid_8-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Paid_8">O.Paid_8</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPaid_8" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Paid_8</td>

<td>Anzeige der Übersicht der entstandenen Kosten.</td>

<td>Die Anwendung MUSS dem Nutzer eine Übersicht der entstandenen Kosten anbieten. Falls die Kosten aufgrund einzelner Zugriffe erfolgt sind, MUSS die Anwendung einen Überblick der Zugriffe aufführen.</td>

<td>Der Evaluator prüft, ob die Anwendung dem Nutzer eine Übersicht der entstandenen Kosten anbietet. Falls die Kosten aufgrund einzelner Zugriffe erfolgt sind, prüft der Evaluator, ob die Anwendung einen Überblick der Zugriffe aufführt.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app does not offer any purchases.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-paid_9-o-paid_9-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Paid_9">O.Paid_9</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPaid_9" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Paid_9</td>

<td>Validierung von getätigten Bezahlvorgängen im Hintergrundsystem.</td>

<td>Die Validierung von getätigten Bezahlvorgängen SOLL im Hintergrundsystem vorgenommen werden.</td>

<td>Der Evaluator prüft durch Quelltextanalyse und praktische Tests, ob die Anwendung eigenständig Bezahlungen validiert und beispielsweise kostenpflichtige Funktionen freischalten kann.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app does not offer any purchases.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-paid_10-o-paid_10-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Paid_10">O.Paid_10</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPaid_10" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Paid_10</td>

<td>Anforderungen bei Zahlverfahren von Drittanbietern.</td>

<td>Zahlverfahren von Drittanbietern MÜSSEN die Anforderungen an Drittanbieter-Software erfüllen (vgl. Kapitel 5.5.4).</td>

<td>Der Evaluator prüft die Zahlverfahren durch Drittanbieter. Sowohl bei Drittanbieter-Software, als auch bei Web-Diensten wird geprüft, dass keine sensiblen Nutzerdaten an den Zahlungsdienstleister abfließen (z.B., dass der Titel der gebuchten Leistung keine sensiblen Informationen enthält).</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app does not offer any purchases.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-pass_1-o-pass_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Pass_1">O.Pass_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPass_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Pass_1</td>

<td>Durchsetzung starker Passwortrichtlinien.</td>

<td>Bei einer Authentisierung mittels Benutzername und Passwort MÜSSEN starke Passwortrichtlinien existieren. Diese SOLLEN sich am aktuellen Stand gängiger „Best- Practices“ orientieren.</td>

<td>Der Evaluator prüft, ob Passwortrichtlinien, welche dem aktuellen Stand der Technik entsprechen, eingesetzt werden. Andernfalls sind die Abwägungen des Herstellers zu prüfen und in der Risikobewertung zu berücksichtigen.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use zxcvbn-ios as a password strength indicator and enforcer for the application password.</p>
<h4 id='code-sources-erpapp-helper-passwordstrengthtester-swift-37-code' class='heading'><code>../Sources/eRpApp/Helper/PasswordStrengthTester.swift:37</code></h4>

<p>We use an additional german word list to check against common passwords</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Pass_1#2,O.Pass_2#2] We use an additional german word list to check against common passwords
private(set) lazy var wordList: [String] = {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-pass_2-o-pass_2-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Pass_2">O.Pass_2</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPass_2" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Pass_2</td>

<td>Anzeige der Stärke des verwendeten Passworts.</td>

<td>Für die Einrichtung der Authentisierung mittels Benutzername und Passwort KANN die Stärke des verwendeten Passworts dem Nutzer angezeigt werden. Informationen über die Stärke des gewählten Passworts DÜRFEN NICHT gespeichert werden.</td>

<td>Der Evaluator prüft, ob dem Nutzer die Stärke des verwendeten Passworts angezeigt wird. Ist dies der Fall, prüft er durch Quelltextanalyse und praktische Tests, ob dadurch Informationen über das Password oder dessen Güte im Anwendungsspeicher verbleiben.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use zxcvbn-ios as a password strength indicator and enforcer for the application password.</p>
<h4 id='code-sources-erpapp-helper-passwordstrengthtester-swift-37-code' class='heading'><code>../Sources/eRpApp/Helper/PasswordStrengthTester.swift:37</code></h4>

<p>We use an additional german word list to check against common passwords</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Pass_1#2,O.Pass_2#2] We use an additional german word list to check against common passwords
private(set) lazy var wordList: [String] = {

</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingregisterauthenticationview-swift-235-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingRegisterAuthenticationView.swift:235</code></h4>

<p>Password strength view within onboarding.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Pass_2#2] Password strength view within onboarding.
PasswordStrengthView(strength: store.passwordStrength,

</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-registerauthenticationdomain-swift-175-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/RegisterAuthenticationDomain.swift:175</code></h4>

<p>Testing the acutal password strength</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Pass_2#3] Testing the acutal password strength
state.passwordStrength = passwordStrengthTester.passwordStrength(for: state.passwordA)

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-appsecurity-createpasswordview-swift-80-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/AppSecurity/CreatePasswordView.swift:80</code></h4>

<p>Password strength view within settings.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Pass_2#4] Password strength view within settings.
PasswordStrengthView(strength: store.passwordStrength)

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-appsecurity-createpassworddomain-swift-91-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/AppSecurity/CreatePasswordDomain.swift:91</code></h4>

<p>Testing the actual password strength while updating within settings</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Pass_2#5] Testing the actual password strength while updating within settings
state.passwordStrength = passwordStrengthTester.passwordStrength(for: state.passwordA)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-pass_3-o-pass_3-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Pass_3">O.Pass_3</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPass_3" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Pass_3</td>

<td>Möglichkeit zur Änderung des Passwortes.</td>

<td>Der Nutzer MUSS die Möglichkeit haben, sein Passwort zu ändern.</td>

<td>Der Evaluator prüft, ob der Nutzer die Möglichkeit hat, sein Passwort zu ändern und verifiziert, dass diese Funktionalität nicht zweckentfremdet werden kann.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The user may change the app passwords within the settings.</p>
<h4 id='code-sources-erpapp-screens-settings-appsecurity-createpasswordview-swift-10-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/AppSecurity/CreatePasswordView.swift:10</code></h4>

<p>View for changing the user password</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Pass_3#2] View for changing the user password
struct CreatePasswordView: View {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-pass_4-o-pass_4-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Pass_4">O.Pass_4</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPass_4" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Pass_4</td>

<td>Protokollierung und Information über Änderungen und Zurücksetzen von Passwörtern.</td>

<td>Wird die Anwendung zusammen mit einem Hintergrundsystem genutzt, MUSS das Ändern und Zurücksetzen von Passwörtern protokolliert werden. Das Hintergrundsystem SOLL den Nutzer über das Ändern und Zurücksetzen von Passwörtern informieren, dabei MUSS ein separater Kanal genutzt werden.</td>

<td>Der Evaluator prüft das Vorhandensein und die Güte von zusätzlichen Informationen zur Protokollierung von Änderungen und dem Zurücksetzen von Passwörtern.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The application password is not used for the baackend. There is no protocol for the application password within the application, although we implement a counter for failed password attempts.</p>
<h4 id='code-sources-erpapp-screens-appauthentication-appauthenticationview-swift-25-code' class='heading'><code>../Sources/eRpApp/Screens/AppAuthentication/AppAuthenticationView.swift:25</code></h4>

<p>Display of failed login attempts counter</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Pass_4#2] Display of failed login attempts counter
if store.failedAuthenticationsCount != 0 {

</code></pre>
<h4 id='code-sources-erpapp-screens-appauthentication-appauthenticationdomain-swift-109-code' class='heading'><code>../Sources/eRpApp/Screens/AppAuthentication/AppAuthenticationDomain.swift:109</code></h4>

<p>Increase failed attempts count on failed verification</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Pass_4#3] Increase failed attempts count on failed verification
state.failedAuthenticationsCount += 1

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-pass_5-o-pass_5-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Pass_5">O.Pass_5</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPass_5" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Pass_5</td>

<td>Verwendung von kryptographisch sicheren Hashing-Algorithmen und Salts zur Speicherung der Passwörter.</td>

<td>Werden Passwörter gespeichert, MÜSSEN diese mit einer den aktuellen Sicherheitsstandards entsprechenden Hash-Funktion und unter Verwendung geeigneter Salts gehasht werden.</td>

<td>Der Evaluator prüft, ob Passwörter in der Anwendung gespeichert werden. Er verifiziert, dass die verwendeten Schutzmechanismen dem aktuellen Stand der Technik und den Anforderungen an Hash- Funktionen, Anzahl an Iterationen und Salts genügen (vgl. [TR02102-1]). In der Risikobewertung werden Maßnahmen, die Brute-Force- Angriffe verlangsamen, berücksichtigt.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use the keychain to persist the hashed app password and the corresponding salt. The salt is regenerated, whenever a new password is stored.</p>
<h4 id='code-sources-erpapp-session-helper-appsecuritymanager-swift-45-code' class='heading'><code>../Sources/eRpApp/Session/Helper/AppSecurityManager.swift:45</code></h4>

<p>The salt is regenerated, whenever a new password is stored.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Pass_5#2|4] The salt is regenerated, whenever a new password is stored.
guard let data = password.data(using: .utf8),
      let salt = try? randomGenerator(32) else {
    throw AppSecurityManagerError.savePasswordFailed
}
</code></pre>
<h4 id='code-sources-erpapp-session-helper-appsecuritymanager-swift-51-code' class='heading'><code>../Sources/eRpApp/Session/Helper/AppSecurityManager.swift:51</code></h4>

<p>Password is stored alongside hash within keychain.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Pass_5#3|8] Password is stored alongside hash within keychain.
do {
    let hashedPassword = hash(data + salt)
    guard try keychainAccess.setGenericPassword(salt, for: Self.passwordSaltIdentifier),
          try keychainAccess.setGenericPassword(hashedPassword, for: Self.passwordHashIdentifier) else {
        throw AppSecurityManagerError.savePasswordFailed
    }
    return true
} catch {
</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_1-o-plat_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_1">O.Plat_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_1</td>

<td>Geräteschutz für die Nutzung der Anwendung erforderlich.</td>

<td>Für die Nutzung der Anwendung SOLL das Endgerät über einen aktivierten Geräteschutz (Passwort, Mustersperre, o. ä.) verfügen. Im Fall eines nicht aktivierten Geräteschutzes MUSS der Hersteller den Nutzer über die damit verbundenen Risiken aufklären.</td>

<td>Der Evaluator prüft, ob der Hersteller eine Nutzung ohne aktivierten Geräteschutz zulässt. Ist das der Fall, prüft der Evaluator, ob der Nutzer angemessen über die daraus resultierenden Risiken aufgeklärt wird, und er berücksichtigt die Abwägungen des Herstellers in der Risikobewertung. Gemäß A.OperatingSystem wird insbesondere angenommen, dass das Betriebssystem über Funktionen verfügt, die es der Anwendung ermöglichen, die Einstellung des Geräteschutzes abzufragen.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We test for device pincode at startup and show a dialog if no pin is set.</p>
<h4 id='code-sources-erpapp-screens-main-mainview-swift-95-code' class='heading'><code>../Sources/eRpApp/Screens/Main/MainView.swift:95</code></h4>

<p>trigger device security check</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#2,O.Resi_2#2,O.Plat_1#2] trigger device security check
store.send(.loadDeviceSecurityView)

</code></pre>
<h4 id='code-sources-erpapp-session-helper-devicesecuritymanager-swift-58-code' class='heading'><code>../Sources/eRpApp/Session/Helper/DeviceSecurityManager.swift:58</code></h4>

<p>calculate system risk for jailbreak and missing device pin</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#3,O.Resi_2#3,O.Plat_1#3] calculate system risk for jailbreak and missing device pin
var showSystemSecurityWarning: AnyPublisher&lt;DeviceSecurityWarningType, Never&gt; {

</code></pre>
<h4 id='code-sources-erpapp-session-helper-devicesecuritymanager-swift-68-code' class='heading'><code>../Sources/eRpApp/Session/Helper/DeviceSecurityManager.swift:68</code></h4>

<p>Missing system pin detection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Plat_1#4] Missing system pin detection
var informMissingSystemPin: AnyPublisher&lt;Bool, Never&gt; {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_2-o-plat_2-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_2">O.Plat_2</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_2" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_2</td>

<td>Nur Anforderung der für den primären Zweck notwendigen Berechtigungen.</td>

<td>Die Anwendung DARF Berechtigungen, die für die Erfüllung ihres primären Zwecks nicht notwendig sind, NICHT einfordern.</td>

<td>Der Evaluator prüft die von der Anwendung geforderten Berechtigungen und bestätigt, dass diese für die Erfüllung des primären Zwecks der Anwendung (O.Purp_1) erforderlich sind.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app ony configures entitlements that are used for it’s primary purpose. All configured entitlements are configured in <code>eRpApp/Resources/Info.plist</code> and in <code>eRpApp/Resources/eRpApp.entitlements</code>.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_3-o-plat_3-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_3">O.Plat_3</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_3" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_3</td>

<td>Hinweis auf Zweck der Berechtigungen und Auswirkungen bei Nichterteilung.</td>

<td>Die Anwendung MUSS den Nutzer auf den Zweck der anzufragenden Berechtigungen und auf die Auswirkungen hinweisen, die eintreten, falls der Nutzer diese nicht gewährt.</td>

<td>Der Evaluator prüft, ob die Anwendung auf den Zweck der geforderten Berechtigungen hinweist.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The platform enforces dialogs whenever accessing private data or sensors and user permission is not already given. Localizations can be found within <code>InfoPlist.strings</code></p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_4-o-plat_4-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_4">O.Plat_4</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_4" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_4</td>

<td>Keine sensiblen Daten in Meldungen oder Benachrichtigungen.</td>

<td>Die Anwendung DARF KEINE sensiblen Daten in Meldungen oder Benachrichtigungen, die nicht vom Benutzer explizit eingeschaltet wurden (siehe O.Plat_5), schreiben.</td>

<td>Der Evaluator prüft anhand von Quelltextanalyse und generierten Log-Nachrichten, ob die Anwendung sensible Daten in diese Nachrichten schreibt. Sollten die geloggten Daten Rückschlüsse auf den Nutzer zulassen, muss dieser Datenabfluss in der Risikobewertung berücksichtigt werden.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We never show sensitive data as all errors are localized with custom descriptions (See <code>LocalizedError</code> implementations). Some errors have localized parameters such as a failed PIN counter. Some errors are sent from the server, these messages show only generic information what went wrong. See <a href="#OSource_3">O.Source_3</a> for reference.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_5-o-plat_5-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_5">O.Plat_5</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_5" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_5</td>

<td>Option zur Anzeige von Meldungen/Benachrichtigungen mit sensiblen Daten.</td>

<td>Die Anwendung KANN dem Nutzer die Optionen bieten, Meldungen und Benachrichtigungen, ggf. auch mit sensiblen Daten, anzuzeigen. Bei Werkseinstellung MUSS diese deaktiviert sein.</td>

<td>Falls die Anwendung die Möglichkeit zur Anzeige von Meldungen mit sensiblen Daten bietet, prüft der Evaluator, ob diese standardmäßig deaktiviert sind.

Weiterhin prüft er, ob der Nutzer bei Aktivierung dieser Option angemessen über die daraus resultierenden Risiken aufgeklärt wird. Die Abwägungen des Herstellers, solche Optionen anzubieten, sind in der Risikobewertung zu berücksichtigen.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Not applicable: displaying of messages not realized.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_6-o-plat_6-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_6">O.Plat_6</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_6" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_6</td>

<td>Zugriffsbeschränkungen auf sensible Daten.</td>

<td>Die Anwendung MUSS Zugriffsbeschränkungen auf sensible Daten realisieren.</td>

<td>Der Evaluator prüft, ob die Anwendung den Zugriff auf sämtliche Daten beschränkt, solange sie unter der Kontrolle der Anwendung sind. Dies schließt eine Beschränkung des Zugriffs auf vorgesehene Dateipfade zum Schutz sensibler Daten durch automatisches Speichern oder unbeabsichtigtes Speichern durch den Nutzer mit ein. Darüber hinaus ist zu validieren, dass die Anwendung keine Broadcast-Nachrichten verschicken kann, die von allen auf dem Gerät installierten Anwendungen gelesen werden können. Die Anwendung darf Nachrichten ausschließlich an autorisierte Anwendungen verschicken. Wenn die Anwendung diese Vorgabe nicht umsetzt, müssen die Abwägungen des Herstellers in die Risikobewertung mitaufgenommen werden. Gemäß A.OperatingSystem wird angenommen, dass das Betriebssystem über wirksame Funktionen verfügt, die einzelne Anwendungen untereinander und gegenüber dem Betriebssystem isolieren. Die Isolation muss durchgängig sein und mindestens

die Prozessebene,</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Implemented by the OS Sandboxing.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_7-o-plat_7-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_7">O.Plat_7</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_7" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_7</td>

<td>Nutzung von sensiblen Funktionalitäten über Interprozesskommunikation.</td>

<td>Die plattformspezifischen Mechanismen zu Interprozesskommunikation DÜRFEN NICHT zum Austausch von sensiblen Daten genutzt werden, sofern sie nicht zur Erfüllung des primären Zwecks der Anwendung erforderlich sind.</td>

<td>Bietet die Anwendung Schnittstellen an, berücksichtigt der TR-Prüfer deren Ausnutzbarkeit in der Risikoanalyse. Gemäß A.OperatingSystem wird insbesondere angenommen, dass für das Betriebssystem Funktionen zur Interprozesskommunikation bereitstehen, für die Regeln zur Isolation der Kommunikation gesetzt werden können.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The only method we use for inter process communication is universal linking. Current outgoing use-cases are limited to login with insurance company apps. No sensitive data is transferred, the actual payload is decided by the server, as the universal links are created server side.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_8-o-plat_8-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_8">O.Plat_8</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_8" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_8</td>

<td>Nutzung von Rendering Engines zum Nachladen aktiver Inhalte.</td>

<td>Verwendet die Anwendung für die Erfüllung ihres primären Zwecks eine Rendering Engine, MUSS sie diese so konfigurieren, dass aktive Inhalte nicht ausgeführt werden. Falls aktive Inhalte für die Realisierung der Anwendung unabdingbar sind, MUSS die Anwendung das Nachladen von Inhalten auf Quellen beschränken, die unter der Kontrolle des Herstellers sind oder durch den Hersteller autorisiert wurden.</td>

<td>Wenn die Anwendung Rendering Engines einsetzt, prüft der Evaluator, ob die Komponenten das Nachladen aktiver Inhalte unterbinden oder auf Quellen unter der Kontrolle des Herstellers beschränken. Die Auswahl der zugelassenen Quellen wird in der Risikoanalyse berücksichtigt.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We only use native code and do not rely on any rendering engine, besides rendering some static HTML Pages (e.g. OSS-Licenses, Data Privacy, Terms of Use) that do not contain any scripts.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_9-o-plat_9-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_9">O.Plat_9</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_9" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_9</td>

<td>Entfernung von sensiblen Daten bei Wechsel in den Hintergrundbetrieb.</td>

<td>Wechselt die Anwendung in den Hintergrundbetrieb, MUSS diese alle sensiblen Daten aus der aktuellen Ansicht („Views“ in iOS bzw. „Activities“ in Android) entfernen.</td>

<td>Der Evaluator prüft, ob die Anwendung sensible Daten aus den entsprechenden Anzeigeelementen der Anwendung entfernt.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The content window is blurred upon leaving the application to not expose content to the system multitasking switcher.</p>
<h4 id='code-sources-erpapp-scenedelegate-swift-246-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:246</code></h4>

<p>Moving the application to the background blurs the application</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_13#2,O.Plat_9#2] Moving the application to the background blurs the application
// window.
addBlurOverlayToWindow()

</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-165-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:165</code></h4>

<p>Moving the application to the foreground removes the blur.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_13#3,O.Plat_9#3] Moving the application to the foreground removes the blur.
removeBlurOverlayFromWindow()

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_10-o-plat_10-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_10">O.Plat_10</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_10" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_10</td>

<td>Deaktivierung nicht benötigter Protokoll-Handler in Rendering Engines.</td>

<td>Die Anwendung MUSS alle nicht benötigten Protokoll-Handler in Rendering-Engines deaktivieren.</td>

<td>Wenn die Anwendung Rendering Engines einsetzt, prüft der Evaluator, ob die Komponenten nicht  benötigte Protokoll-Handler deaktivieren.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Implemented using a <code>WKWebViewDelegate</code>.</p>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationdomain-swift-91-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationDomain.swift:91</code></h4>

<p>Start login via gID</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22294-01] Start login via gID
// [REQ:BSI-eRp-ePA:O.Auth_4#9,O.Plat_10#2] Start login via gID
return .publisher(

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-dataprivacytermsofusenavigationdelegate-swift-9-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/DataPrivacyTermsOfUseNavigationDelegate.swift:9</code></h4>

<p>Delegate disables unused schemes</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Plat_10#2] Delegate disables unused schemes
class DataPrivacyTermsOfUseNavigationDelegate: NSObject, WKNavigationDelegate {

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-dataprivacy-dataprivacyview-swift-23-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/DataPrivacy/DataPrivacyView.swift:23</code></h4>

<p>Usage of the delegate</p>
<pre class="highlight plaintext"><code>// swiftlint:disable:next weak_delegate
// [REQ:BSI-eRp-ePA:O.Plat_10#3] Usage of the delegate
let navigationDelegate = DataPrivacyTermsOfUseNavigationDelegate()

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationdomain-swift-106-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationDomain.swift:106</code></h4>

<p>Follow redirect</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22299-01] Follow redirect
// [REQ:BSI-eRp-ePA:O.Plat_10#3] Follow redirect
guard environment.resourceHandler.canOpenURL(url) else {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-introduction-cardwallintroductiondomain-swift-191-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/Introduction/CardWallIntroductionDomain.swift:191</code></h4>

<p>Follow redirect</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22299] Follow redirect
// [REQ:BSI-eRp-ePA:O.Plat_10#3] Follow redirect
guard resourceHandler.canOpenURL(url) else {

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-foss-fossview-swift-21-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/FOSS/FOSSView.swift:21</code></h4>

<p>Usage of the delegate</p>
<pre class="highlight plaintext"><code>// swiftlint:disable:next weak_delegate
// [REQ:BSI-eRp-ePA:O.Plat_10#4] Usage of the delegate
let navigationDelegate = DataPrivacyTermsOfUseNavigationDelegate()

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-termsofuse-termsofuseview-swift-22-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/TermsOfUse/TermsOfUseView.swift:22</code></h4>

<p>Usage of the delegate</p>
<pre class="highlight plaintext"><code>// swiftlint:disable:next weak_delegate
// [REQ:BSI-eRp-ePA:O.Plat_10#5] Usage of the delegate
let navigationDelegate = DataPrivacyTermsOfUseNavigationDelegate()

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_11-o-plat_11-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_11">O.Plat_11</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_11" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_11</td>

<td>Löschen anwendungsspezifischer Cookies beim Beenden der Anwendung.</td>

<td>Die Anwendung MUSS vor dem ordnungsgemäßen Beenden das Löschen aller anwendungsspezifischen Sitzungsdaten (bspw. Cookies) bei der genutzten Rendering Engine anfordern.</td>

<td>Wenn die Anwendung Rendering Engines oder andere Arten zur Darstellung von Webinhalten einsetzt, prüft der Evaluator, ob anwendungsspezifische Sitzungsdaten nach Beenden der Anwendung gelöscht werden.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>WebViews only display local content that is delivered together with the application. Javascript is disabled, linking and loading other content is disabled. All other links to websites open the system browser. No cookies are created within the application or any webview that the application hosts.</p>
<h4 id='code-sources-erpapp-screens-settings-dataprivacy-dataprivacyview-swift-27-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/DataPrivacy/DataPrivacyView.swift:27</code></h4>

<p>disabled javascript</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Plat_11#2] disabled javascript
wkWebView.configuration.defaultWebpagePreferences.allowsContentJavaScript = false

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-termsofuse-termsofuseview-swift-26-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/TermsOfUse/TermsOfUseView.swift:26</code></h4>

<p>disabled javascript</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Plat_11#3] disabled javascript
wkWebView.configuration.defaultWebpagePreferences.allowsContentJavaScript = false

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-foss-fossview-swift-25-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/FOSS/FOSSView.swift:25</code></h4>

<p>disabled javascript</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Plat_11#4] disabled javascript
wkWebView.configuration.defaultWebpagePreferences.allowsContentJavaScript = false

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_12-o-plat_12-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_12">O.Plat_12</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_12" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_12</td>

<td>Überschreiben aller nutzerspezifischen Daten beim Beenden der Anwendung.</td>

<td>Die Anwendung SOLL nach Beenden alle nutzerspezifischen Daten im Arbeitsspeicher sicher überschrieben haben.</td>

<td>Die Anwendung darf sich bei der Beendigung nicht rein auf das Betriebssystem und den Garbage Collector der Laufzeitumgebung verlassen. Sensible Daten müssen aktiv gelöscht bzw. überschrieben werden. Der Evaluator ermittelt die Risiken für die einzelnen betroffenen Daten und berücksichtigt diese in der Risikobewertung.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app’s memory is subject to the operating system’s memory and therefore it has no control over the used memory. There is no technique known to overwrite memory in swift in a safe way, so that value types are deleted safely. The platform promises safety at process boundaries.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_13-o-plat_13-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_13">O.Plat_13</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_13" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_13</td>

<td>Information des Nutzers über erforderliche Sicherheitsmaßnahmen zur Anwendung, Drittanbieter- Software und Plattformen.</td>

<td>Der Nutzer MUSS über Sicherheitsmaßnahmen informiert werden, sofern diese durch den Nutzer umsetzbar sind.</td>

<td>Der Evaluator prüft, ob der Nutzer über selbst durchführbare Sicherheitsmaßnahmen informiert und ggf. angeleitet wird. Der Evaluator bewertet, ob die Maßnahmen ausreichend sind, um Restrisiken zu begrenzen.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>During the onboarding process the user is forced to secure the access to the app either via a biometric trait or a strong password (or both). There is no additional security setting the user cannot set within the onbording.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-plat_14-o-plat_14-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Plat_14">O.Plat_14</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPlat_14" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Plat_14</td>

<td>Protokollierung bestimmter Sicherheitsereignisse.</td>

<td>Ein abgebrochener Start SOLL als Sicherheitsereignis protokolliert werden. Die Protokollierung SOLL im Hintergrundsystem stattfinden.</td>

<td>Der Evaluator überprüft die von dem Hersteller bereitgestellten Logdateien und validiert, dass ein abgebrochener Start und andere Sicherheitsereignisse der Anwendung protokolliert werden. Die Informationen dienen der Post- Mortem-Analyse von Sicherheitsvorfällen und sollten daher Informationen über alle ausgehenden Verbindungen enthalten, unter anderem Metainformationen über verwendete Proxys und überprüfte Server-Zertifikate.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We do not log within the application. Though, logging is in place on FD and IDP and user data related events are logged into the audit events, that can be displayed within the application.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-purp_1-o-purp_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Purp_1">O.Purp_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPurp_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Purp_1</td>

<td>Informationspflicht des Herstellers zum rechtmäßigen Zweck und Verarbeitung von personenbezogenen Daten.</td>

<td>Der Hersteller MUSS die rechtmäßigen Zwecke der Anwendung und die Verarbeitung von personenbezogenen Daten vor der Installation offenlegen (etwa in der Beschreibung des App- Stores; vgl. Anhang A) und den Nutzer mindestens bei der erstmaligen Inbetriebnahme darüber informieren.</td>

<td>Der Evaluator prüft, ob eine Beschreibung vorhanden ist und diese den rechtmäßigen Zwecken der Anwendung entspricht. Dabei werden die vom Hersteller definierten rechtmäßige Zwecke als Grundlage genutzt. Eine juristische Prüfung der Rechtmäßigkeit ist nicht erforderlich.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The purpose is displayed as part of the Onboarding and can later be viewed from the settings.</p>
<h4 id='code-sources-erpapp-screens-onboarding-onboardinglegalinfoview-swift-159-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingLegalInfoView.swift:159</code></h4>

<p>Display as part of the onboarding</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_1#1] Display as part of the onboarding
struct OnboardingPrivacyView: View {

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-dataprivacy-dataprivacyview-swift-12-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/DataPrivacy/DataPrivacyView.swift:12</code></h4>

<p>Actual View driving the display of <code>DataPrivacy.html</code></p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_1#2] Actual View driving the display of `DataPrivacy.html`
// [REQ:BSI-eRp-ePA:O.Arch_8#3] Webview containing local html without javascript
// [REQ:gemSpec_eRp_FdV:A_19980#2] Actual View driving the display of `DataPrivacy.html`
struct DataPrivacyView: View {

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingslegalinfoview-swift-28-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsLegalInfoView.swift:28</code></h4>

<p>DataPrivacy display within Settings</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_9#3,O.Purp_1#4] DataPrivacy display within Settings
NavigationLink(

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-purp_2-o-purp_2-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Purp_2">O.Purp_2</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPurp_2" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Purp_2</td>

<td>Zweckgebundene Erhebung und Verarbeitung der Daten.</td>

<td>Die Anwendung DARF KEINE Daten erheben und verarbeiten, die nicht dem rechtmäßigen Zweck der Anwendung dienen.</td>

<td>Die Nutzung von Sensordaten ist nur soweit zulässig, wie sie etwa zur Erhebung des Seeds dient. Der Evaluator prüft anhand der Permisison-Policy, welche Daten in der Anwendung verarbeitet werden und ob diese den rechtmäßigen Zwecken der Anwendung entsprechen. Dabei werden die vom Hersteller definierten rechtmäßige Zwecke als Grundlage genutzt. Eine juristische Prüfung der Rechtmäßigkeit ist nicht erforderlich.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-cameraview-erxtaskscannerview-swift-22-code' class='heading'><code>../Sources/eRpApp/Screens/CameraView/ErxTaskScannerView.swift:22</code></h4>

<p>Scanning tasks contains purpose related data input</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#1,O.Data_6#3] Scanning tasks contains purpose related data input
// [REQ:BSI-eRp-ePA:O.Source_1#1] Scanning tasks starts with scanner callback
store.send(.analyse(scanOutput: $0))

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-can-cardwallcanview-swift-121-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/CAN/CardWallCANView.swift:121</code></h4>

<p>CAN is used for eGK connection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#2,O.Data_6#2] CAN is used for eGK connection
CardWallCANInputView(

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-pin-cardwallpinview-swift-17-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/PIN/CardWallPINView.swift:17</code></h4>

<p>PIN is used for eGK Connection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#3,O.Data_6#4] PIN is used for eGK Connection
PINView(store: store).padding()

</code></pre>
<h4 id='code-sources-erpapp-tracking-analyticsreducer-swift-16-code' class='heading'><code>../Sources/eRpApp/Tracking/AnalyticsReducer.swift:16</code></h4>

<p>User interaction analytics trigger …</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#4,O.Purp_4#1,O.Data_6#6] User interaction analytics trigger ...
struct AnalyticsReducer&lt;ContentReducer: Reducer&gt;: Reducer

</code></pre>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-101-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:101</code></h4>

<p>… records data only if user opt-in is given.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#5,O.Purp_4#2,O.Data_6#7] ... records data only if user opt-in is given.
if optIn {

</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-redeem-pharmacycontactview-swift-11-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Redeem/PharmacyContactView.swift:11</code></h4>

<p>Contact information is collected when needed for redeeming</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#6,O.Data_6#5] Contact information is collected when needed for redeeming
struct PharmacyContactView: View {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-purp_3-o-purp_3-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Purp_3">O.Purp_3</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPurp_3" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Purp_3</td>

<td>Einholung einer Einwilligungserklärung des Nutzers.</td>

<td>Die Anwendung MUSS vor jeglicher Erfassung oder Verarbeitung personenbezogener Daten eine aktive und eindeutige Einwilligungserklärung des Nutzers einholen.</td>

<td>Der Evaluator prüft, ob ohne Zustimmung des Nutzers personenbezogene Daten verarbeitet werden können.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingcontainer-swift-59-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingContainer.swift:59</code></h4>

<p>Terms of Use display is part of the onboarding</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_3#1] Terms of Use display is part of the onboarding
.sheet(isPresented: $store.showTermsOfUse.sending(\.setShowUse)) {

</code></pre>

<p>Terms of Use acceptance is required as part of the Onboarding.</p>
<h4 id='code-sources-erpapp-screens-settings-termsofuse-termsofuseview-swift-11-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/TermsOfUse/TermsOfUseView.swift:11</code></h4>

<p>Actual view for the Terms of Use display</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_3#2] Actual view for the Terms of Use display
// [REQ:BSI-eRp-ePA:O.Arch_8#1] Webview containing local html without javascript
struct TermsOfUseView: View {

</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardinglegalinfoview-swift-72-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingLegalInfoView.swift:72</code></h4>

<p>User acceptance</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_3#3] User acceptance
OnboardingLegalInfoCheckmarkView(isAccepted: $isAllAccepted)

</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingcontainer-swift-39-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingContainer.swift:39</code></h4>

<p>Callback triggers tracking alert</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_3#4] Callback triggers tracking alert
store.send(.showTracking)

</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-191-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:191</code></h4>

<p>Show comply route to display analytics usage within onboarding</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19088,A_19091-01#1,A_19092-01#2] Show comply route to display analytics usage within
// onboarding
// [REQ:BSI-eRp-ePA:O.Purp_3#5] Show comply route to display analytics usage within onboarding
// [REQ:gemSpec_eRp_FdV:A_19089-01#2] Show comply route to display analytics usage within onboarding
case .showTracking:

</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-195-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:195</code></h4>

<p>Accept usage analytics</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090-01,A_19091-01#2] User confirms the opt in within settings
// [REQ:BSI-eRp-ePA:O.Purp_3#6] Accept usage analytics
case .alert(.presented(.allowTracking)):

</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-200-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:200</code></h4>

<p>Deny usage analytics</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19092-01#3] User may choose to not accept analytics, onboarding will still continue
// [REQ:BSI-eRp-ePA:O.Purp_3#7] Deny usage analytics
case .alert(.dismiss):

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-purp_4-o-purp_4-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Purp_4">O.Purp_4</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPurp_4" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Purp_4</td>

<td>Nutzung ausschließlich zugestimmter Daten.</td>

<td>Daten, deren Verarbeitung der Nutzer nicht ausdrücklich zugestimmt hat, DÜRFEN NICHT von der Anwendung oder dem Hintergrundsystem erfasst, erhalten oder genutzt werden.</td>

<td>Der Evaluator gleicht die in O.Purp_2 gewonnen Erkenntnisse mit den erteilten Zustimmungen ab.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-tracking-analyticsreducer-swift-16-code' class='heading'><code>../Sources/eRpApp/Tracking/AnalyticsReducer.swift:16</code></h4>

<p>User interaction analytics trigger …</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#4,O.Purp_4#1,O.Data_6#6] User interaction analytics trigger ...
struct AnalyticsReducer&lt;ContentReducer: Reducer&gt;: Reducer

</code></pre>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-101-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:101</code></h4>

<p>… records data only if user opt-in is given.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#5,O.Purp_4#2,O.Data_6#7] ... records data only if user opt-in is given.
if optIn {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-purp_5-o-purp_5-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Purp_5">O.Purp_5</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPurp_5" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Purp_5</td>

<td>Entzug der Einwilligung ermöglichen.</td>

<td>Die Anwendung MUSS ermöglichen, dass der Nutzer eine bereits erteilte Einwilligung wieder entziehen kann. Der Nutzer MUSS vor der Einwilligung über die Möglichkeit des Widerrufs und die sich daraus ergebenden Veränderungen im Verhalten der Anwendung informiert werden.</td>

<td>Der Evaluator prüft, ob dem Nutzer die Möglichkeit gegeben wird erteilte Einwilligungen wieder zu entziehen. Darüber hinaus validiert er, dass der Nutzer beim Entzug von Einwilligungen auf die daraus resultierenden Konsequenzen hingewiesen wird.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-159-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:159</code></h4>

<p>Toggle within Settings to enable and disable usage analytics</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19097-01#2] Toggle within Settings to enable and disable usage analytics
// [REQ:BSI-eRp-ePA:O.Purp_5#1] Toggle within Settings to enable and disable usage analytics
// [REQ:BSI-eRp-ePA:O.Purp_6#1] Current Analytics state is inspectable by the user
// [REQ:gemSpec_eRp_FdV:A_19982#4] Opt out of analytics
Toggle(isOn: $store.trackerOptIn.sending(\.toggleTrackingTapped).animation()) {

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-156-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:156</code></h4>

<p>Actual disabling of analytics</p>
<pre class="highlight plaintext"><code>// Tracking
// [REQ:gemSpec_eRp_FdV:A_19088, A_19089-01#5, A_19092-01#4, A_19097-01#1] React to later opt-in or deactivation
// of usage analytics
// [REQ:BSI-eRp-ePA:O.Purp_5#2] Actual disabling of analytics
// [REQ:gemSpec_eRp_FdV:A_19982#2] Opt out of analytics
case let .toggleTrackingTapped(optIn):

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-46-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:46</code></h4>

<p>Show comply view for settings triggered analytics enabling</p>
<pre class="highlight plaintext"><code>// Tracking comply sheet presentation
// [REQ:BSI-eRp-ePA:O.Purp_5#3] Show comply view for settings triggered analytics enabling
// [REQ:gemSpec_eRp_FdV:A_19982#3,A_19089-01#3] Show information dialog for analytics usage
Rectangle()

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-166-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:166</code></h4>

<p>User confirms the opt in within settings</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090-01,A_19091-01#4] User confirms the opt in within settings
// [REQ:BSI-eRp-ePA:O.Purp_5#4] User confirms the opt in within settings
case .confirmedOptInTracking:

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-purp_6-o-purp_6-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Purp_6">O.Purp_6</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPurp_6" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Purp_6</td>

<td>Führen eines Verzeichnisses der Nutzereinwilligungen.</td>

<td>Der Hersteller MUSS ein Verzeichnis führen, welches erkennen lässt, welche Nutzereinwilligungen vorliegen. Der nutzerspezifische Teil des Verzeichnisses MUSS für den Nutzer automatisiert einsehbar sein. Es SOLL eine Historie dieses Verzeichnisses angefordert werden können.</td>

<td>Der Evaluator prüft das Vorhandensein, die Aktualität und die Vollständigkeit des Verzeichnisses.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-160-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:160</code></h4>

<p>Current Analytics state is inspectable by the user</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19097-01#2] Toggle within Settings to enable and disable usage analytics
// [REQ:BSI-eRp-ePA:O.Purp_5#1] Toggle within Settings to enable and disable usage analytics
// [REQ:BSI-eRp-ePA:O.Purp_6#1] Current Analytics state is inspectable by the user
// [REQ:gemSpec_eRp_FdV:A_19982#4] Opt out of analytics
Toggle(isOn: $store.trackerOptIn.sending(\.toggleTrackingTapped).animation()) {

</code></pre>

<p>As most of the user decisions are client side no history is available. Only the current state can be inspected.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-purp_7-o-purp_7-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Purp_7">O.Purp_7</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPurp_7" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Purp_7</td>

<td>Nutzung nur erforderlicher Drittanbieter-Software.</td>

<td>Setzt die Anwendung Drittanbieter-Software ein, MÜSSEN alle verwendeten Funktionen für die rechtmäßigen Zwecke der Anwendung erforderlich sein. Die Anwendung SOLL anderweitige Funktionen sicher deaktivieren. Wird nur eine einzige oder sehr wenige Funktionen der Drittanbieter-Software benötigt, MUSS abgewogen werden, ob die Einbindung der gesamten Drittanbieter-Software im Verhältnis zur Vergrößerung der Angriffsoberfläche durch die verwendete Drittanbieter-Software steht.</td>

<td>Der Evaluator prüft die Abwägungen des Herstellers bei Funktionen, die nicht dem rechtmäßigen Zweck für die Anwendung dienen. So dürfte beispielsweise eine API für soziale Netzwerke nur verwendet werden, wenn dies mit dem rechtmäßigen Zweck der Anwendung vereinbar ist. Die Risikobewertung erfasst die Auswirkungen auf den Schutz der Gesundheitsdaten, beispielsweise bei dem für Dritte erkennbaren Nutzungsverhalten in Logging Frameworks.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Most libraries are self written and cover only what is needed. Dependencies are only included if really necessary. We think about including only sub packages, but as most dependencies are very small, this is hardly used. Besides that, no means of removing unused dependency functionality is available for libraries of the platform.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-purp_8-o-purp_8-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Purp_8">O.Purp_8</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPurp_8" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Purp_8</td>

<td>Weitergabe von sensiblen Daten nur für den primären oder rechtmäßigen Zweck.</td>

<td>Sofern es nicht für den vorgesehenen primären oder rechtmäßigen Zweck einer Anwendung erforderlich ist, DÜRFEN sensible Daten NICHT mit Dritten geteilt werden. Dies betrifft auch die Ablage dieser Daten in Teilen des Dateisystems, auf die auch andere Anwendungen Zugriff haben. Die Anwendung MUSS den Nutzer über die Konsequenzen einer eventuellen Weitergabe von Anwendungsdaten, die dem primären oder rechtmäßigen Zweck dienen, vollumfänglich informieren und sein Einverständnis einholen (OPT-IN).</td>

<td>Der Evaluator prüft die Abwägungen des Herstellers, ob die Weitergabe von sensiblen Daten an Dritte dem primären oder rechtmäßigen Zweck für die Anwendung dient. Darüber hinaus prüft er, ob die Weitergabe immer explizit durch den Nutzer erlaubt werden muss (Opt-In). Die Weitergabe an Dienste, deren primärer Zweck die Verarbeitung von Daten für Werbezwecke ist, ist generell verboten. Die Risikobewertung berücksichtigt, wie die Weitergabe von Daten an Dritte im Verhältnis zum Schutzbedarf der weitergeleiteten Informationen (Daten) und der daraus resultierenden Gefahr der Preisgabe von Informationen steht.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Sharing of data is only for the primary purpose of the application e.g. sending presriptions to a pharmacy or sharing a prescription with a family member. We do not store data in shared containers in any way.</p>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-21-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:21</code></h4>

<p>Implementation of data storage that is persisted via keychain</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_4#3] Implementation of data storage that is persisted via keychain
// [REQ:BSI-eRp-ePA:O.Source_7#2,O.Data_2#2,O.Auth_13#3] Implementation of data storage that is persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {

</code></pre>
<h4 id='code-sources-erplocalstorage-coredatacontrollerfactory-swift-32-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataControllerFactory.swift:32</code></h4>

<p>CoreData databases are protected</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#2] CoreData databases are protected
self.fileProtection = fileProtection

</code></pre>
<h4 id='code-sources-erplocalstorage-coredatacontroller-swift-59-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataController.swift:59</code></h4>

<p>actual protection setting on file system level</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#3|4] actual protection setting on file system level
protectedStoreDescription.setOption(
    fileProtectionType as NSObject,
    forKey: NSPersistentStoreFileProtectionKey
)
</code></pre>
<h4 id='code-sources-erplocalstorage-coredatacontroller-swift-83-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataController.swift:83</code></h4>

<p>Database backup exclusion</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#4,O.Arch_4#2,O.Data_15#1] Database backup exclusion
if excludeFromBackup, let storeUrl = store.url {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-purp_9-o-purp_9-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Purp_9">O.Purp_9</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OPurp_9" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Purp_9</td>

<td>Nur zweckgebundene Darstellung sensibler Daten auf dem Bildschirm.</td>

<td>Die Anwendung DARF sensible Daten NICHT auf dem Bildschirm darstellen, außer dies ist für den primären Zweck der Anwendung erforderlich.</td>

<td>Der Evaluator prüft die Abwägungen des Herstellers, ob die Darstellung von sensiblen Daten zum gegebenen Zeitpunkt für die Erfüllung des Zwecks der Anwendung erforderlich ist. Für die Risikobewertung ist zu berücksichtigen, wie die Anwendung den Nutzer davor schützt, sensible Daten anzuzeigen (vergleiche T.VisibleAsset).</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Sensitive data is only shown for the purpose of this application. This includes display of prescriptions, personal data and health data.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-rand_1-o-rand_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Rand_1">O.Rand_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="ORand_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Rand_1</td>

<td>Erzeugung von Zufallswerten durch sicheren Zufallszahlengenerator.</td>

<td>Alle Zufallswerte MÜSSEN über einen starken kryptographischen Zufallszahlengenerator erzeugt werden, welcher mit ausreichend Entropie geseedet wurde (vgl. [TR02102-1]).</td>

<td>Der Evaluator prüft durch Quelltextanalyse und praktische Tests die Güte des kryptographischen Zufallszahlengenerators.

Informationen zu ausreichend sicheren Zufallszahlengeneratoren sind [TR02102-1] Kapitel 10 zu entnehmen. Für die Nachbearbeitung der Zufallszahlen sind die vom BSI als ausreichend sicher angesehen Algorithmen (s.[AIS20], [TR03107-1] und

[TR03116-4]) zu verwenden.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use the platform provided secure random generator. iOS is <a href="https://csrc.nist.gov/CSRC/media/projects/cryptographic-module-validation-program/documents/security-policies/140sp3431.pdf">FIPS 140-2</a> certified. The operating system uses an entropy pool with different sources, including a <a href="https://support.apple.com/en-gb/guide/security/seca0c73a75b/web">true random number generator</a> from the secure enclave, that is present on every device. Security certifcates can be found <a href="https://support.apple.com/de-li/guide/certifications/apc3fa917cb49/web">https://support.apple.com/de-li/guide/certifications/apc3fa917cb49/web</a>, including FIPS 140-2 und Common Criteria.</p>
<h4 id='code-sources-idp-internal-seckeyrandom-swift-21-code' class='heading'><code>../Sources/IDP/internal/SecKeyRandom.swift:21</code></h4>

<p>Secure Random generator.</p>
<pre class="highlight plaintext"><code>/// Generate random Data with given length
///
/// [REQ:gemSpec_Krypt:GS-A_4367]
/// [REQ:BSI-eRp-ePA:O.Rand_1#2] Secure Random generator.
///
/// - Parameters:
///   - length: the number of bytes to generate
///   - randomizer: the randomizer to be used. Default: kSecRandomDefault
/// - Returns: the random initialized Data
/// - Throws: `IDPError`
public func generateSecureRandom(length: Int, randomizer: SecRandomRef? = kSecRandomDefault) throws -&gt; Data {

</code></pre>
<h4 id='code-sources-vauclient-internal-vaurandom-swift-22-code' class='heading'><code>../Sources/VAUClient/internal/VAURandom.swift:22</code></h4>

<p>Secure Random generator.</p>
<pre class="highlight plaintext"><code>/// Generate random Data with given length
///
/// [REQ:gemSpec_Krypt:GS-A_4367]
/// [REQ:BSI-eRp-ePA:O.Rand_1#3] Secure Random generator.
///
/// - Parameters:
///   - length: the number of bytes to generate
///   - randomizer: the randomizer to be used. Default: kSecRandomDefault
/// - Returns: the random initialized Data
/// - Throws: `VAUError`
static func generateSecureRandom(length: Int, randomizer: SecRandomRef? = kSecRandomDefault) throws -&gt; Data {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-resi_1-o-resi_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Resi_1">O.Resi_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OResi_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Resi_1</td>

<td>Informationen zum sicheren Umgang mit der Anwendung.</td>

<td>Die Anwendung MUSS dem Nutzer barrierearme Best-Practice-Empfehlungen zum sicheren Umgang mit der Anwendung und ihrer Konfiguration bereitstellen.</td>

<td>Der Evaluator prüft, ob die Anwendung „Best-Practices“ bereitstellt. Er bestätigt, dass vorhandene „Best-Practices“ dem aktuellen Stand der Technik entsprechen.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The onboarding contains defaults that are best practices, such as using biometrics for authentication. While using the Cardwall, selecting the “save login” option results in an dialog with additional information, to let the user make informed decisions. A missing device passcode results in a dialog that is recommending the setup of a device passcode.</p>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingregisterauthenticationview-swift-11-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingRegisterAuthenticationView.swift:11</code></h4>

<p>View containing onboarding authentication</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Resi_1#2] View containing onboarding authentication
struct OnboardingRegisterAuthenticationView: View, KeyboardReadable {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-login-cardwallloginoptionview-swift-95-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/Login/CardWallLoginOptionView.swift:95</code></h4>

<p>View containing information regarding the login options.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21574] Actual view
// [REQ:BSI-eRp-ePA:O.Resi_1#3] View containing information regarding the login options.
struct PrivacyWarningViewContainer: View {

</code></pre>
<h4 id='code-sources-erpapp-screens-main-devicesecurity-devicesecuritynosystempin-devicesecuritysystempinview-swift-9-code' class='heading'><code>../Sources/eRpApp/Screens/Main/DeviceSecurity/DeviceSecurityNoSystemPin/DeviceSecuritySystemPinView.swift:9</code></h4>

<p>View containing the “no system pin” message.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Resi_1#4] View containing the "no system pin" message.
struct DeviceSecuritySystemPinView: View {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-resi_2-o-resi_2-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Resi_2">O.Resi_2</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OResi_2" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Resi_2</td>

<td>Erkennung vom Betriebszustand des verwendeten Endgerätes.</td>

<td>Die Anwendung MUSS mittels Betriebssystem- Funktion abfragen, ob sich das Betriebssystem in einem Betriebszustand befindet, der den Anforderungen des Betriebssystemherstellers entspricht. Befindet sich das Betriebssystem in keinem vom Betriebssystemhersteller vorgesehenen Zustand, MUSS die Anwendung angemessen darauf reagieren. Die Anwendung MUSS dem Nutzer darstellen, welche Risiken für die Daten des Nutzers bei einer Fortsetzung der Anwendung bestehen (z. B., dass diese offengelegt werden könnten) oder die Fortsetzung unterbinden.</td>

<td>Der Evaluator überprüft durch praktische Tests die Wirksamkeit der Maßnahmen zur Erkennung, ob sich das Betriebssystem außerhalb eines Betriebszustand befindet, der den Anforderungen des Betriebssystemherstellers entspricht (z.B. Root-/Jailbreak-Erkennung).

Weiterhin prüft er, ob die Anwendung angemessen auf das Erkennen reagiert. Dies kann beispielsweise eine Terminierung der Anwendung sein (vergleiche O.Resi_5). Gemäß A.OperatingSystem wird angenommen, dass das Betriebssystem Funktionen bereitstellt, mit denen eine Anwendung die Konformität des Betriebszustandes bezüglich der Anforderungen des Betriebssystemherstellers an das Betriebssystem abfragen kann.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Jailbreak detection is done on startup of the application after the app authentication. If a jailbreak is detected, a information dialog is presented to the user.</p>
<h4 id='code-sources-erpapp-screens-main-mainview-swift-95-code' class='heading'><code>../Sources/eRpApp/Screens/Main/MainView.swift:95</code></h4>

<p>trigger device security check</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#2,O.Resi_2#2,O.Plat_1#2] trigger device security check
store.send(.loadDeviceSecurityView)

</code></pre>
<h4 id='code-sources-erpapp-session-helper-devicesecuritymanager-swift-58-code' class='heading'><code>../Sources/eRpApp/Session/Helper/DeviceSecurityManager.swift:58</code></h4>

<p>calculate system risk for jailbreak and missing device pin</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#3,O.Resi_2#3,O.Plat_1#3] calculate system risk for jailbreak and missing device pin
var showSystemSecurityWarning: AnyPublisher&lt;DeviceSecurityWarningType, Never&gt; {

</code></pre>
<h4 id='code-sources-erpapp-session-helper-devicesecuritymanager-swift-112-code' class='heading'><code>../Sources/eRpApp/Session/Helper/DeviceSecurityManager.swift:112</code></h4>

<p>Jailbreak detection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#4,O.Resi_2#4] Jailbreak detection
func informJailbreakDetected() -&gt; Bool {

</code></pre>
<h4 id='code-sources-erpapp-screens-main-devicesecurity-devicesecurityrooteddevice-devicesecurityrooteddeviceview-swift-9-code' class='heading'><code>../Sources/eRpApp/Screens/Main/DeviceSecurity/DeviceSecurityRootedDevice/DeviceSecurityRootedDeviceView.swift:9</code></h4>

<p>Jailbreak information view</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#5,O.Resi_2#5] Jailbreak information view
struct DeviceSecurityRootedDeviceView: View {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-resi_3-o-resi_3-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Resi_3">O.Resi_3</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OResi_3" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Resi_3</td>

<td>Erkennung und Unterbindung des Starts in einer Entwicklungs-

/Debug-Umgebung.</td>

<td>Die Anwendung MUSS eigene Prüfmechanismen implementieren, die beim Start der Anwendung feststellen, ob sie in einer Entwicklungs-/Debug-Umgebung ausgeführt wird. Wenn die Anwendung feststellt, dass sie in einer Entwicklungs-/Debug-Umgebung ausgeführt wird, MUSS sie sich sofort beenden.</td>

<td>Der Evaluator prüft die Wirksamkeit der Debug-Erkennung durch praktische Tests. (vergleiche O.Resi_5).</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Starting within a debug environment is only possible on rooted/jailbroken devices. If that is the case, the user sees a dialog and can choose to continue or cancel using the application. See O.Resi_2 for jailbreak detection details.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-resi_4-o-resi_4-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Resi_4">O.Resi_4</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OResi_4" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Resi_4</td>

<td>Abbruch des Starts der Anwendung bei ungewöhnlichen Benutzerrechten.</td>

<td>Die Anwendung MUSS eigene Prüfmechanismen implementieren, die beim Start der Anwendung feststellen, ob sie unter ungewöhnlichen Benutzerrechten gestartet ist. Wenn die Anwendung feststellt, dass dies der Fall ist, MUSS sie sich sofort beenden.</td>

<td>Der Evaluator prüft die Wirksamkeit der Erkennung durch praktische Tests (vergleiche O.Resi_5).</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Starting with unusal app rights is only possible on rooted/jailbroken devices. If that is the case, the user sees a dialog and can choose to continue or cancel using the application. See O.Resi_2 for jailbreak detection details.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-resi_5-o-resi_5-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Resi_5">O.Resi_5</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OResi_5" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Resi_5</td>

<td>Überprüfung der Integrität des Endgeräts vor Verarbeitung sensibler Daten.</td>

<td>Die Anwendung SOLL die Integrität des Endgeräts sicherstellen , bevor sensible Daten verarbeitet werden.</td>

<td>Der Evaluator untersucht, welche Integritätsprüfung durch die Anwendung vorgenommen wird. Wenn die Prüfung durch externe Tools durchgeführt wird, zu dem der Evaluator keinen Quelltext besitzt, führt er einen Penetrationstest durch (vergleiche O.Resi_2 bis O.Resi_4). Ein Integritätscheck muss mindestens folgende Aspekte abdecken:

•    Einsatz von „custom firmware“.

•    Aktualität der Betriebssystemversion.

•    Vorhandensein von verdächtigen Werkzeugen oder Anwendungen auf dem Gerät.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Device Integrity may only be compromised on jailbroken devices. If that is the case, the user sees a dialog and can choose to continue or cancel using the application. See O.Resi_2 for jailbreak detection details. We exclude very old and unsecure devices, by restricting the application to modern iOS Versions. That restriction is automatically restricting the range of devices it can run on. See <code>options.deploymentTarget.iOS</code> path within <code>project.yml</code> or the generated <code>IPHONEOS_DEPLOYMENT_TARGET</code> within the <code>project.pbxproj</code> file for the iOS Version restriction.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-resi_6-o-resi_6-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Resi_6">O.Resi_6</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OResi_6" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Resi_6</td>

<td>Überprüfung der Authentizität des Hintergrundsystems vor Zugriff.</td>

<td>Die Anwendung MUSS vor dem Zugriff auf das Hintergrundsystem dessen Integrität überprüfen (siehe auch O.Ntwk_4).</td>

<td>Der Evaluator prüft die Wirksamkeit der Authentizitätsprüfung (beispielsweise Zertifikats-Pinning) durch praktische Tests.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>IDP Communication is secured by using TLS with pinned Certificates as well as JWEs with keys that are pinned using a TI specific trust anchor as well as OCSP. FD Communication is secured by using TLS and VAU encryption, again with pinned Certificates for both methods. APOVZD communication uses TLS with pinned certificates. The Pinned certificates fingerprints can be found within <code>Sources/eRpApp/Resources/Info.plist</code>.</p>
<h4 id='code-sources-idp-defaultidpsession-swift-262-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:262</code></h4>

<p>Implementation of loading the discovery document for fetching signature and</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Resi_6#2] Implementation of loading the discovery document for fetching signature and
// encryption keys.
// [REQ:gemSpec_Krypt:A_21222#3] DiscoveryDocument is validated with the active trustStoreSession
private func loadDiscoveryDocument() -&gt; AnyPublisher&lt;DiscoveryDocument, IDPError&gt; {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-423-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:423</code></h4>

<p>Discovery Document signature verification</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22296-01] Signature verification
// [REQ:gemSpec_IDP_Frontend:A_23082#3] Signature verification
// [REQ:BSI-eRp-ePA:O.Resi_6#3] Discovery Document signature verification
guard try jwtContainer.verify(with: document.discKey) == true else {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-291-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:291</code></h4>

<p>Discovery Document signature verification</p>
<pre class="highlight plaintext"><code>// Validate JWT/DiscoveryDocument signature
// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02] Assure that brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4361-02] Assure that brainpoolP256r1 is used
// [REQ:BSI-eRp-ePA:O.Resi_6#4] Discovery Document signature verification
guard (try? fetchedDocument.backing.verify(with: fetchedDocument.discKey)) ?? false else {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-757-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:757</code></h4>

<p>Discovery Document signature verification</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Resi_6#5|6] Discovery Document signature verification
validate(certificate: discoveryDocument.discKey)
    // [REQ:gemSpec_IDP_Frontend:A_20625#3|4] `C.FD.SIG`-Certificate verification
    .zip(validate(certificate: discoveryDocument.signingCert))
    .map { isDiscKeyValid, isSigningCertValid -&gt; Bool in
        isDiscKeyValid &amp;&amp; isSigningCertValid
    }
</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-resi_7-o-resi_7-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Resi_7">O.Resi_7</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OResi_7" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Resi_7</td>

<td>Integration von Härtungsmaßnahmen vor Verarbeitung sensibler Daten.</td>

<td>Die Anwendung SOLL Härtungsmaßnahmen, wie etwa eine Integritätsprüfung vor jeder Verarbeitung sensibler Daten innerhalb des Programmablaufs, realisieren.</td>

<td>Der Evaluator prüft, ob die Anwendung eine Integritätsprüfung bei jedem Programmstart oder bei sensiblen Operationen durchführt. Andernfalls werden die daraus resultierenden Restrisiken in der Risikobewertung berücksichtigt.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Recent Jailbreaks force a reboot or restart of springboard. Thus the application will also be restarted in these cases. The check for hardening is done on app startup and should be sufficient.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-resi_8-o-resi_8-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Resi_8">O.Resi_8</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OResi_8" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Resi_8</td>

<td>Umsetzung von Maßnahmen gegen Reverse Engineering.</td>

<td>Die Applikation MUSS starke Maßnahmen gegen Reverse Engineering umsetzen.</td>

<td>Der Evaluator prüft, ob starke Maßnehmen gegen Reverse Engineering getroffen werden.

„Starke Maßnahmen“ müssen sämtliche Strings, Dateinamen und interne Namen von Klassen und Methoden innerhalb der Anwendung, die einem Angreifer Hinweise auf den Programmablauf geben können, verschleiern. Die Anwendung kann hierfür weitere Verschleierungsmaßnahmen, wie beispielsweise White-Box- Kryptographie oder den Einsatz von virtuellen Maschinen zurückgreifen. Der Evaluator prüft die Wirksamkeit des Schutzes vor Reverse Engineering durch praktische Tests und dokumentiert den Prozess. Der Evaluator bewertet die bestehenden Restrisiken der Implementierung unter anderem in Bezug auf T.MemoryStructures, T.InfoDisclosure und T.SensitiveData.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The application source is available on github. Any measure of preventing reverse engineering would be pointless.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-resi_9-o-resi_9-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Resi_9">O.Resi_9</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OResi_9" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Resi_9</td>

<td>Berücksichtigung von Plattformen und Versionen bei Zugriffskontrollmechanismen.</td>

<td>Die Anwendung MUSS unterschiedliche Ausprägungen einer Plattform (bspw. Android) bei unterschiedlichen Herstellern berücksichtigen. Sie muss so gebaut sein, dass solche unterschiedlichen Plattformen bzw. unterschiedliche Plattformversionen zu keinem Fehlverhalten führt. Insbesondere MUSS ein missbräuchlicher Zugriff auf Ressourcen durch unterschiedliche Ausprägungen einer Plattform ausgeschlossen werden.</td>

<td>Der Evaluator bestätigt, dass sich die Implementierung der Zugriffsmaßnahmen nicht allein auf das Betriebssystem verlässt und damit evtl. durch einen Downgrade- Angriff auf das Betriebssystem verwundbar ist.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Data is not stored while moving between platforms or devices. Private keys are stored within the secure enclave an cannot leave the device. Downgrades are prohibited by the operating system and update mechanisms.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-resi_10-o-resi_10-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Resi_10">O.Resi_10</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OResi_10" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Resi_10</td>

<td>Robustheit gegenüber Störungen.</td>

<td>Die Anwendung MUSS robust gegenüber Störungen sein.</td>

<td>Der Evaluator prüft durch Quelltextanalyse und praktischen Tests, ob Störungen (z.B. in der Stromversorgung, Internetverbindung) oder Fehlbedienung zu einem Verlust der Daten führen können.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Missing internet connection or other means of disruption use the same error mechanisms as every part of the app uses for normal errors. Data is only deleted where appropriate, e.g. invalid tokens are deleted. User Data is not deleted unless explicitly confirmed by the user.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-source_1-o-source_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Source_1">O.Source_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OSource_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Source_1</td>

<td>Prüfung von Eingaben vor Verwendung.</td>

<td>Die Anwendung MUSS alle Eingaben vor deren Verarbeitung prüfen, um potenziell bösartige Werte vor der Verarbeitung herauszufiltern.</td>

<td>Der Evaluator prüft, ob für alle Eingaben aus nicht vertrauenswürdigen Quellen Sicherheitsfunktionen gemäß O.Arch_5 vorhanden sind. Eingaben meinen jegliche Art von Daten, die in die Anwendung hineinfließen. Das sind zum Beispiel Nutzereingaben, Eingaben aus Drittanbieterkomponenten etc.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-cameraview-erxtaskscannerview-swift-23-code' class='heading'><code>../Sources/eRpApp/Screens/CameraView/ErxTaskScannerView.swift:23</code></h4>

<p>Scanning tasks starts with scanner callback</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#1,O.Data_6#3] Scanning tasks contains purpose related data input
// [REQ:BSI-eRp-ePA:O.Source_1#1] Scanning tasks starts with scanner callback
store.send(.analyse(scanOutput: $0))

</code></pre>

<p>We have two potential unknown inputs, one being the scanner, that scanns QR Codes or Data Matrix Codes. External interactions are managed through Universal Linking, with thorough validation of URL parameters to ensure only predefined variables are accepted.</p>
<h4 id='code-sources-erpapp-screens-cameraview-scannerdomain-swift-129-code' class='heading'><code>../Sources/eRpApp/Screens/CameraView/ScannerDomain.swift:129</code></h4>

<p>analyse the input</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#2] analyse the input
let result = try CodeAnalyser.analyse(scanOutput: scanOutput, with: state.acceptedTaskBatches)

</code></pre>
<h4 id='code-sources-erpapp-screens-cameraview-scannerdomain-helper-swift-16-code' class='heading'><code>../Sources/eRpApp/Screens/CameraView/ScannerDomain+Helper.swift:16</code></h4>

<p>validation</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#3] validation
static func analyse(scanOutput: [ScanOutput],

</code></pre>
<h4 id='code-sources-erpkit-scannederxtask-swift-104-code' class='heading'><code>../Sources/eRpKit/ScannedErxTask.swift:104</code></h4>

<p>actual validation by decoding into predefined structure</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19984] validate data matrix code structure
// [REQ:BSI-eRp-ePA:O.Source_1#4] actual validation by decoding into predefined structure
erxToken = try jsonDecoder.decode(ErxToken.self, from: jsonData)

</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-250-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:250</code></h4>

<p>External application calls via Universal Linking</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#5] External application calls via Universal Linking
func scene(_: UIScene, continue userActivity: NSUserActivity) {

</code></pre>
<h4 id='code-sources-erpapp-screens-appstartdomain-swift-221-code' class='heading'><code>../Sources/eRpApp/Screens/AppStartDomain.swift:221</code></h4>

<p>External application calls via Universal Linking</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#6] External application calls via Universal Linking
case let .universalLink(url):

</code></pre>
<h4 id='code-sources-erpapp-screens-main-maindomain-swift-257-code' class='heading'><code>../Sources/eRpApp/Screens/Main/MainDomain.swift:257</code></h4>

<p>redirect into correct domain</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#7] redirect into correct domain
// [REQ:gemSpec_IDP_Frontend:A_22301-01#6|3] Redirect into ExtAuthPendingDomain
return .run { send in

</code></pre>
<h4 id='code-sources-erpapp-screens-main-extauth-extauthpendingdomain-swift-156-code' class='heading'><code>../Sources/eRpApp/Screens/Main/ExtAuth/ExtAuthPendingDomain.swift:156</code></h4>

<p>Validate data by parsing url and only allowing predefined variables as String</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#8] Validate data by parsing url and only allowing predefined variables as String
// [REQ:gemSpec_IDP_Frontend:A_22301-01#7] Actual handling of the universal link, user feedback via dialogs e.g.
case let .externalLogin(url),

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-source_2-o-source_2-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Source_2">O.Source_2</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OSource_2" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Source_2</td>

<td>Nutzung einer Escape-Syntax bei strukturierten Daten.</td>

<td>Die Anwendung MUSS eingehende und ausgehende Daten maskieren beziehungsweise von potenziell schadhaften Zeichen bereinigen oder deren Verarbeitung ablehnen.</td>

<td>Der Evaluator prüft, ob eine Escape- Syntax von strukturierten Daten für alle Eingaben gemäß O.Arch_5 vorhanden ist. Schadhafte Zeichen sind kontextabhängig zu betrachten. Im Datenbank-Kontext sind beispielsweise Hochkommata oder Prozentzeichen gegebenenfalls schadhaft, während im Web/HTML Kontext eher Tag-Klammern (&lt;) schadhaft sind. Grundsätzlich muss die Input-Validierung daher kontextbezogen stattfinden. Wird eine potenziell schädliche Eingabe erkannt, muss sie entweder bereinigt/maskiert oder abgelehnt/verworfen werden. Das Verwerfen sollte dem Bereinigen vorgezogen werden. Sofern vorher maskierte oder bereinigte Eingaben weitergegeben werden, müssen diese so maskiert oder enkodiert werden, dass sie im Kontext der Weitergabe keine schädlichen Effekte haben.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Data escaping is managed by the operating system frameworks. We do not create SQL queries manually; instead, we utilize CoreData as an ORM. Queries are constructed using NSFetchRequests and NSPredicates, which automatically escape all manual input. Additionally, actual user data is transmitted via FHIR, with the escaping process handled by Apple’s provided FHIR library.</p>
<h4 id='code-sources-erplocalstorage-pharmacy-pharmacycoredatastore-swift-13-code' class='heading'><code>../Sources/eRpLocalStorage/Pharmacy/PharmacyCoreDataStore.swift:13</code></h4>

<p>CoreDataStore adapter for <code>PharmacyLocation</code>s</p>
<pre class="highlight plaintext"><code>/// Store for fetching, creating, updating or deleting `PharmacyLocation`s on the provided `CoreDataController`
/// [REQ:BSI-eRp-ePA:O.Source_2#2] CoreDataStore adapter for `PharmacyLocation`s
public class PharmacyCoreDataStore: PharmacyLocalDataStore, CoreDataCrudable {

</code></pre>
<h4 id='code-sources-erplocalstorage-prescriptions-erxtaskcoredatastore-swift-20-code' class='heading'><code>../Sources/eRpLocalStorage/Prescriptions/ErxTaskCoreDataStore.swift:20</code></h4>

<p>CoreDataStore adapter for <code>ErxTask</code>s</p>
<pre class="highlight plaintext"><code>// tag::ErxTaskCoreDataStoreDescription[]
/// Store for fetching, creating, updating or deleting `ErxTask`s and it‘s underlying types. Access to most entities is
/// tied to the given profileId.
/// [REQ:BSI-eRp-ePA:O.Source_2#3] CoreDataStore adapter for `ErxTask`s
public class DefaultErxTaskCoreDataStore: ErxTaskCoreDataStore {

</code></pre>
<h4 id='code-sources-erplocalstorage-profiles-profilecoredatastore-swift-13-code' class='heading'><code>../Sources/eRpLocalStorage/Profiles/ProfileCoreDataStore.swift:13</code></h4>

<p>CoreDataStore adapter for <code>Profile</code>s</p>
<pre class="highlight plaintext"><code>/// Store for fetching, creating, updating or deleting `Profile`s on the provided `CoreDataController`
/// [REQ:BSI-eRp-ePA:O.Source_2#4] CoreDataStore adapter for `Profile`s
public class ProfileCoreDataStore: ProfileDataStore, CoreDataCrudable {

</code></pre>
<h4 id='code-sources-erplocalstorage-shipmentinfo-shipmentinfocoredatastore-swift-13-code' class='heading'><code>../Sources/eRpLocalStorage/ShipmentInfo/ShipmentInfoCoreDataStore.swift:13</code></h4>

<p>CoreDataStore adapter for <code>ShipmentInfoEntity</code>s</p>
<pre class="highlight plaintext"><code>/// Store for fetching, creating, updating or deleting `ShipmentInfoEntity`s on the provided `CoreDataController`
/// [REQ:BSI-eRp-ePA:O.Source_2#5] CoreDataStore adapter for `ShipmentInfoEntity`s
public class ShipmentInfoCoreDataStore: ShipmentInfoDataStore, CoreDataCrudable {

</code></pre>
<h4 id='code-sources-erplocalstorage-avstransaction-avstransactioncoredatastore-swift-13-code' class='heading'><code>../Sources/eRpLocalStorage/AVSTransaction/AVSTransactionCoreDataStore.swift:13</code></h4>

<p>CoreDataStore adapter for <code>AVSTransactionEntity</code>s</p>
<pre class="highlight plaintext"><code>/// Store for fetching, creating, updating or deleting `AVSTransactionEntity`s on the provided `CoreDataController`
/// [REQ:BSI-eRp-ePA:O.Source_2#6] CoreDataStore adapter for `AVSTransactionEntity`s
public class AVSTransactionCoreDataStore: AVSTransactionDataStore, CoreDataCrudable {

</code></pre>
<h4 id='code-sources-pharmacy-modelsr4-bundle-location-swift-18-code' class='heading'><code>../Sources/Pharmacy/ModelsR4.Bundle+Location.swift:18</code></h4>

<p>Extension containing all FHIR related parsing for Pharmacies</p>
<pre class="highlight plaintext"><code>/// [REQ:BSI-eRp-ePA:O.Source_2#7] Extension containing all FHIR related parsing for Pharmacies
extension ModelsR4.Bundle {

</code></pre>

<p>See all files named <code>ModelsR4.Bundles+&lt;TypeName&gt;</code> within <code>eRpRemoteStorage</code> Package to find all references for FD related FHIR parsing. All other files within the Module are either helpers or provide support for creating FHIR objects that may be sent to the FD.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-source_3-o-source_3-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Source_3">O.Source_3</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OSource_3" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Source_3</td>

<td>Keine sensiblen Daten in Meldungen.</td>

<td>Fehlermeldungen und Log-Dateien DÜRFEN KEINE sensiblen Daten (z. B. User Identifier) enthalten.</td>

<td>Der Evaluator prüft, ob sensible Daten über Fehlermeldungen oder Benachrichtigungen einsehbar werden.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Error messages are localized using the <code>Foundation.LocalizedError</code> protocol. Search for <code>LocalizedError</code> to see all instances. Most errors are localized with static text, some errors contain server side error messages. User data is never used for error messages. Logging is only active on debug builds. See <a href="#OPlat_4">O.Plat_4</a> for reference.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-source_4-o-source_4-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Source_4">O.Source_4</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OSource_4" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Source_4</td>

<td>Kontrollierte Behandlung und Dokumentation von Ausnahmen (Exceptions).</td>

<td>Potenzielle Ausnahmen im Programmablauf (Exceptions) MÜSSEN abgefangen, kontrolliert behandelt und dokumentiert werden.

Technische Fehlerbeschreibungen (z.B. Stack Traces) DÜRFEN dem Nutzer NICHT angezeigt werden.</td>

<td>Der Evaluator prüft durch Quelltextanalyse und praktische Tests die kontrollierte Behandlung und Dokumentation von Exceptions.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Exception handling in swift uses Errors to represent the exception. We use a custom protocol <code>CodedError</code> that is autogenerated for all error messages. Together with <code>LocalizedError</code> we create error messages that contain a user readable description as well as some technical identifiers to easily identify specific error scenarios and give better support. See <code>CodedError.swift</code> and <code>CodedError.generated.swift</code> for the protocol and the autogenerated implementations of it.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-source_5-o-source_5-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Source_5">O.Source_5</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OSource_5" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Source_5</td>

<td>Abbruch des Zugriffs auf sensible Daten bei Exceptions.</td>

<td>Bei Ausnahmen im Programmablauf (Exceptions) SOLL die Anwendung Zugriffe auf sensible Daten abbrechen und diese im Speicher sicher löschen.</td>

<td>Der Evaluator prüft den Zugriff auf sensible Daten bei Ausnahmen im Programmablauf. Jeglicher identifizierte Zugriff muss in der Risikobewertung betrachtet werden.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>As exceptions and errors are kind of the same construct in swift, this aspect is hard to answer. If a server responds with 401/403 we delete tokens or other security measures, because they are no longer valid anyways. While logging in via biometrics we create temporary data containers for the user certificate and key identifier, that are deleted if the process is not completed properly and kept if the process completes.</p>
<h4 id='code-sources-idp-idpinterceptor-swift-72-code' class='heading'><code>../Sources/IDP/IDPInterceptor.swift:72</code></h4>

<p>invalidate/delete unauthorized token</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167-02#5] invalidate/delete unauthorized token
// [REQ:BSI-eRp-ePA:O.Source_5#2] invalidate/delete unauthorized token
self.session.invalidateAccessToken()

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-107-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:107</code></h4>

<p>Invalidation means deleting the token</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_5#3] Invalidation means deleting the token
storage.set(token: nil)

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-61-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:61</code></h4>

<p>Creation of the pairing session</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_5#4] Creation of the pairing session
pairingSession = try sessionProvider.signatureProvider(for: profileID).createPairingSession()

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-77-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:77</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-130-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:130</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-146-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:146</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-source_6-o-source_6-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Source_6">O.Source_6</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OSource_6" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Source_6</td>

<td>Nutzung von sicheren Funktionsalternativen beim Zugriff auf Speichersegmente.</td>

<td>Bei Programmumgebungen mit manueller Speicherverwaltung (d.h., die Anwendung kann selbst exakt festlegen, wann und wo Speicher gelesen und beschrieben wird) MUSS die Anwendung für lesende und schreibende Zugriffe auf Speichersegmente auf sichere Funktionsalternativen (z. B. printf_s statt printf) zurückgreifen.</td>

<td>Der Evaluator prüft durch Quelltextanalyse, ob die Anwendung auf unsichere Funktionen zum Zugriff auf den Speicher zurückgreift. Die Prüfung umfasst sämtlichen vom Hersteller implementierten Quelltext. Externe Drittanbieter-Software wird in den O.TrdP Testcharakteristiken behandelt.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Swift uses Automatic Reference Counting that does not require active memory management. Raw memory access is possible but only used for swift-OpenSSL dependency that wraps the c library.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-source_7-o-source_7-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Source_7">O.Source_7</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OSource_7" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Source_7</td>

<td>Sicheres Löschen von sensiblen Daten nach ihrer Verarbeitung.</td>

<td>Die Anwendung MUSS sicherstellen, dass alle sensiblen Daten unverzüglich nach der Erfüllung ihres Verarbeitungszwecks sicher gelöscht werden.</td>

<td>Der Evaluator prüft durch Quelltextanalyse und praktische Tests, ob alle sensiblen Daten, welche nicht durch O.Data_2 geschützt sind, unverzüglich nach ihrer Verarbeitung sicher gelöscht werden. „Sicheres Löschen“ erfordert ein Überschreiben der Daten im Speicher. Hier ist auch auf eventuelle Kopien der Daten zu achten. Dies beinhaltet bei Programmiersprachen ohne manuelle Speicherverwaltung unter anderem das Ersetzen von Strings durch Byte-Arrays.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>All sensitive data is handled via value types. After usage the swift runtime handles deletion of the in memory representation. There is no method known to securely overwrite value types. Security is ensured by operating system and process boundaries. Secure enclave encryption keys can never leave the secure enclave by design.</p>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-22-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:22</code></h4>

<p>Implementation of data storage that is persisted via keychain</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_4#3] Implementation of data storage that is persisted via keychain
// [REQ:BSI-eRp-ePA:O.Source_7#2,O.Data_2#2,O.Auth_13#3] Implementation of data storage that is persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-source_8-o-source_8-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Source_8">O.Source_8</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OSource_8" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Source_8</td>

<td>Vollständige Entfernung von unterstützenden Entwicklungsoptionen und Debugmechanismen in der Produktiv-Version.</td>

<td>Alle Optionen zur Unterstützung der Entwicklung (z. B. Entwickler-URLs, Testmethoden, Überreste von Debugmechanismen etc.) MÜSSEN in der Produktiv-Version vollständig entfernt sein.</td>

<td>Der Evaluator überprüft die produktive Anwendung auf Rückstände von Optionen zur Unterstützung der Entwicklung sowie Rückstände von Zeichenketten, Debugmechanismen und Debuginformationen.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use swift macros to remove development code. Configuration of server Environments is done within <code>AppConfiguration.swift</code>. A debug menu is available within settings, rooted within <code>SettingsView.swift</code>. UI-Test Scenarios are placed within the application, but exclude for production builds.</p>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-21-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:21</code></h4>

<p>Debug menu is only visible on debug builds</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_8#3] Debug menu is only visible on debug builds
#if ENABLE_DEBUG_VIEW

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-187-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:187</code></h4>

<p>DebugSectionView is only available on debug builds</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_8#4] DebugSectionView is only available on debug builds
private struct DebugSectionView: View {

</code></pre>
<h4 id='code-sources-erpapp-screens-debugview-debugview-swift-14-code' class='heading'><code>../Sources/eRpApp/Screens/DebugView/DebugView.swift:14</code></h4>

<p>DebugView is only available on debug builds</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_8#5] DebugView is only available on debug builds
struct DebugView: View {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-source_9-o-source_9-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Source_9">O.Source_9</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OSource_9" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Source_9</td>

<td>Aktivierung von modernen Sicherheitsmechanismen der Entwicklungsumgebung.</td>

<td>Für den Bau der Anwendung SOLLEN moderne Sicherheitsmechanismen, wie beispielsweise Obfuskation und Stack-Protection aktiviert werden.</td>

<td>Der Evaluator prüft, ob auf moderne Sicherheitsmechanismen der Entwicklungsumgebungen zurückgegriffen wurde. Sollten entsprechende Sicherheitsmechanismen nicht umgesetzt werden können, muss dies in der Risikobewertung betrachtet werden.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use common defaults for all compiler security related settings. See Xcode build configuration for eRpApp Target using current Xcode for actual settings.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-source_10-o-source_10-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.Source_10">O.Source_10</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OSource_10" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.Source_10</td>

<td>Verwendung von Werkzeugen zur statischen Codeanalyse.</td>

<td>Für die Entwicklung der Anwendung SOLLEN Werkzeuge zur statischen Codeanalyse eingesetzt werden.</td>

<td>Der Evaluator prüft durch Quelltextanalyse und Befragung des Herstellers, ob bei der Entwicklung Werkzeuge zur statischen Codeanalyse eingesetzt wurden.

Wurden keine Werkzeuge zur statischen Codeanalyse verwendet, muss dies in der Risikobewertung betrachtet werden.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use an external SAST and SCA tool that is run at least on every release build. See <code>Jenkinsfile_SAST</code> for technical details. There is additional integration into our merge-reqeuest tooling.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-trdp_1-o-trdp_1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.TrdP_1">O.TrdP_1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OTrdP_1" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.TrdP_1</td>

<td>Abhängigkeiten durch Drittanbieter-Software.</td>

<td>Der Anbieter MUSS eine zentrale und vollständige Liste von Abhängigkeiten durch Drittanbieter-Software führen.</td>

<td>Der Hersteller stellt eine Liste der eingesetzten Drittanbieter-Software inkl. der verwendeten Versionen bereit. Der Evaluator prüft die bereitgestellte Liste auf Vollständigkeit.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Dependencies are handled with SPM. A technical description of all dependencies can be found within <code>dependencies.yml</code>. In the future, a generated SBOM will replace the <code>Package.resolved</code> for this purpose.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-trdp_2-o-trdp_2-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.TrdP_2">O.TrdP_2</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OTrdP_2" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.TrdP_2</td>

<td>Verwendung der aktuellen Version bei Drittanbieter- Software.</td>

<td>Drittanbieter-Software MUSS in der neusten oder der ihr vorhergehenden, für die Veröffentlichung vorgesehenen Version verwendet werden</td>

<td>Der Evaluator prüft die in O.TrdP_1 bereitgestellte Liste auf Aktualität der verwendeten Drittanbieter- Software-Versionen. Diese Abwägungen zu den gewählten Versionen werden in der Risikobewertung berücksichtigt.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Dependencies are updated regulary by an organizational process. Any dependency security issues raised by automatic checking are handled immediately. A list of all compiled dependencies can be found within <code>dependencies.yml</code>.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-trdp_3-o-trdp_3-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.TrdP_3">O.TrdP_3</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OTrdP_3" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.TrdP_3</td>

<td>Herstellerprüfung  Drittanbieter- Software auf Schwachstellen.</td>

<td>Drittanbieter-Software MUSS durch den Hersteller regelmäßig (durch Auswertung öffentlich verfügbarer Informationen oder durch statische/dynamische Testmethoden) auf Schwachstellen überprüft werden. Überreste von Optionen zur Unterstützung der Entwicklung (vgl. O.Source_8) sind hierbei als Schwachstelle zu werten. Der Hersteller MUSS für alle öffentlich bekannten Schwachstellen analysieren, inwieweit die Schwachstelle die Sicherheit des Gesamtsystems beeinträchtigt.

Software, bzw. Funktionen aus Drittanbieter- Software DARF bei bekannten Schwachstellen, die die Sicherheit des Gesamtsystems betreffen NICHT eingesetzt werden.</td>

<td>Der Hersteller stellt eine Übersicht der letzten Schwachstellenanalyse der eingesetzten Drittanbieter- Softwarebereit. Diese wird vom Evaluator geprüft und in der Risikobewertung berücksichtigt. Zusätzlich prüft der Evaluator, ob der Hersteller bei Auftreten von Schwachstellen eine Mitigationsstrategie im Rahmen einer angemessenen Grace-Period bereitstellt.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>SCA Scans are part of our release pipeline, see <a href="#OSource_10">O.Source_10</a>.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-trdp_4-o-trdp_4-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.TrdP_4">O.TrdP_4</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OTrdP_4" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.TrdP_4</td>

<td>Sicherheitskonzept für zeitnahes Einspielen von Sicherheitsupdates für Drittanbieter-Software.</td>

<td>Sicherheitsupdates für Drittanbieter-Software MUSS zeitnah integriert und per Update dem Nutzer zur Verfügung gestellt werden. Der Hersteller MUSS ein Sicherheitskonzept vorlegen, das anhand der Kritikalität ausnutzbarer Schwachstellen die geduldete Weiternutzung für die Anwendung, bzw. das Hintergrundsystem festlegt. Nachdem die Übergangsfrist (Grace Period) abgelaufen ist, MUSS die Anwendung den Betrieb verweigern.</td>

<td>Der Evaluator prüft das Vorhandensein eines solchen Konzeptes. Eine inhaltliche Prüfung ist im Rahmen der TR nicht erforderlich. Zusätzlich prüft der Evaluator, ob der Hersteller eine Mitigationsstrategie bereitstellt.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Library updates are done by a manual periodic process. If any security issues arise and no fix is expected to be provided, a manual fork of external libraries is implemented. In our documentation, we define a bug bar and a grace period depending on the criticality of the vulnerability. Our bug bar is set to “Low”, see <code>scripts/sast</code>, lines including <code>severity-threshold=low</code>.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-trdp_5-o-trdp_5-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.TrdP_5">O.TrdP_5</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OTrdP_5" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.TrdP_5</td>

<td>Prüfung auf Vertrauenswürdigkeit der Quelle von Drittanbieter-Software.</td>

<td>Vor der Verwendung von Drittanbieter- Software MUSS deren Quelle auf Vertrauenswürdigkeit geprüft werden.</td>

<td>Der Evaluator prüft die Maßnahmen des Herstellers zur Verifikation der Vertrauenswürdigkeit von Drittanbietern.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Actual dependencies can be found within <code>eRp-App.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved</code>, containing pinned versions with corresponding hashes. Library updates always require manual interaction to update the <code>*.resolved</code> files. We use very few providers of libraries and try to avoid any unnecessary dependency. Each providing party/dependency is evaluated by looking at GitHub metrics like open issues, stars and activity in general.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-trdp_6-o-trdp_6-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.TrdP_6">O.TrdP_6</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OTrdP_6" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.TrdP_6</td>

<td>Keine Weitergabe von sensiblen Daten an Drittanbieter-Software.</td>

<td>Die Anwendung SOLL sensible Daten nicht an Drittanbieter-Software weitergeben.</td>

<td>Der Evaluator prüft durch eine Quelltextanalyse und praktische Tests, dass keine Weitergabe von sensiblen Daten an Drittanbieter- Software vorgenommen wird. Eine Ausnahme hierzu bietet die Weitergabe von Daten, die für den primären oder rechtmäßigen Zweck der Anwendung erforderlich ist (beispielsweise Drittanbieter- Software zur Transportverschlüsselung). Risiken, die aus einer Nichteinhaltung resultieren, sind in der Risikobewertung zu berücksichtigen.</td>

<td>EXAMINE</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We do not share sensitive data with third parties. See data usages within <a href="#OPurp_8">O.Purp_8</a> and <a href="#OArch_2">O.Arch_2</a>.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-trdp_7-o-trdp_7-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.TrdP_7">O.TrdP_7</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OTrdP_7" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.TrdP_7</td>

<td>Validierung eingehender Daten über Drittanbieter-Software.</td>

<td>Über Drittanbieter-Software eingehende Daten MÜSSEN validiert werden.</td>

<td>Der Evaluator prüft, ob eingehende Daten über Drittanbieter-Software gemäß O.Source_1 behandelt werden und Sicherheitsfunktionen gemäß O.Arch_5 vorhanden sind.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>See <a href="#OSource_1">O.Source_1</a> and <a href="#OArch_5">O.Arch_5</a>.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-bsi-erp-epa-latest-index-html-o-trdp_8-o-trdp_8-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/BSI-eRp-ePA/latest/index.html#O.TrdP_8">O.TrdP_8</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="OTrdP_8" class="target-element">
<table border="1">
<tr>

<th>Prüfaspekt</th>

<th>Kurzfassung des Prüfaspekts</th>

<th>Prüfaspekt</th>

<th>Anmerkungen für den Prüfer</th>

<th>Prüftiefe</th>

</tr>
<tr>

<td>O.TrdP_8</td>

<td>Prüfung der Wartung von verwendeter Drittanbieter- Software.</td>

<td>Drittanbieter-Software, die nicht mehr gewartet wird, DARF NICHT verwendet werden.</td>

<td>Der Evaluator prüft, ob die verwendete Drittanbieter-Software vom Hersteller aktiv gepflegt wird. Eine Software gilt als nicht mehr gewartet, sofern sicherheitskritische Verwundbarkeiten bekannt sind, jedoch nicht innerhalb einer angemessenen Frist repariert worden sind.</td>

<td>CHECK</td>

</tr>
</table>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>As most libraries are source code dependencies, these scans are part of SAST Scanning. Libraries that are not source code dependencies are the precompiled OpenSSL and OpenHealthCardKit (own library but different repository). All third party libraries are mirrored into internal repositories. If necessary we fork libraries to apply fixes.</p>
<h2 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_fd_erp-latest-index-html-gemspec_fd_erp-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_FD_eRp/latest/index.html">gemSpec_FD_eRp</a></h2>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_fd_erp-latest-index-html-a_19145-a_19145-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_FD_eRp/latest/index.html#A_19145">A_19145</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19145" severity="MUSS" class="target-element">
<p><b>A_19145 - E-Rezept-Fachdienst - Statusprüfung Apotheker löscht Rezept</b></p>
<p>Der E-Rezept-Fachdienst MUSS das Löschen eines E-Rezepts über den mittels der &lt;id&gt; adressierten <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">/Task/&lt;id&gt;/$abort</span> verhindern und die Operation mit dem HTTP-Fehlercode 403 abweisen, wenn der Status des adressierten Tasks gleich &ldquo;<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">in-progress</span>&rdquo; ist und die Rolle des aufrufenden Nutzers einer der folgenden Rollen entspricht:<br> 
</p>
<ul>
<li>oid_versicherter</li>
<li>oid_arzt</li>
<li>oid_zahnarzt</li>
<li>oid_praxis_arzt</li>
<li>oid_zahnarztpraxis</li>
<li>oid_praxis_psychotherapeut</li>
<li>oid_krankenhaus</li>
</ul>damit Nutzer außerhalb der Apotheke keine Rezepte löschen, die sich aktuell in Belieferung befinden. <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-main-prescriptionlist-model-prescription-swift-220-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionList/Model/Prescription.swift:220</code></h4>

<p>prevent deletion while task is in progress</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_FD_eRp:A_19145] prevent deletion while task is in progress
return erxTask.status != .inProgress

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_fd_erp-latest-index-html-a_21267-a_21267-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_FD_eRp/latest/index.html#A_21267">A_21267</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-main-prescriptionlist-model-prescription-swift-30-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionList/Model/Prescription.swift:30</code></h4>

<p>direct assignment</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_FD_eRp:A_21267] direct assignment
var type: PrescriptionType = .regular

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_fd_erp-latest-index-html-a_21360-a_21360-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_FD_eRp/latest/index.html#A_21360">A_21360</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-main-prescriptionlist-model-prescription-swift-176-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionList/Model/Prescription.swift:176</code></h4>

<p>no redeem informations available for flowtype 169</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_FD_eRp:A_21360] no redeem informations available for flowtype 169
guard type != .directAssignment

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_fd_erp-latest-index-html-a_22102-a_22102-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_FD_eRp/latest/index.html#A_22102">A_22102</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-main-prescriptionlist-model-prescription-swift-212-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionList/Model/Prescription.swift:212</code></h4>

<p>prevent deletion of tasks with flowtype 169 while not completed</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_FD_eRp:A_22102] prevent deletion of tasks with flowtype 169 while not completed
guard type != .directAssignment

</code></pre>
<h2 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_dienst-latest-index-html-gemspec_idp_dienst-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Dienst/latest/index.html">gemSpec_IDP_Dienst</a></h2>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_dienst-latest-index-html-a_21415-a_21415-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Dienst/latest/index.html#A_21415">A_21415</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21415" severity="MUSS" class="target-element">
<p><b>A_21415 - Registrierungsfunktion des IdP-Dienstes: Datenformate und Syntax zur Kommunikation mit dem Authenticator-Modul</b></p>
<p>Die Registrierungsfunktion des IdP-Dienstes MUSS die folgenden Datentypen zur Kommunikation mit dem Authenticator-Modul verwenden: <br> 
</p>
<ul>
<li>Device_Type</li>
<li>Device_Information</li>
<li>Pairing_Data</li>
<li>Signed_Pairing_Data</li>
<li>Registration_Data</li>
<li>Encrypted_Registration_Data.</li>
</ul> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='pairing_data-code-sources-idp-models-pairingdata-swift-12-code' class='heading'>Pairing_Data <code>../Sources/IDP/Models/PairingData.swift:12</code></h4>
<pre class="highlight plaintext"><code>/// Structure for registering a biometric key. See `SignedPairingData` for sigend representation.
/// [REQ:gemSpec_IDP_Dienst:A_21415:Pairing_Data]
public struct PairingData: Claims, Codable {

</code></pre>
<h4 id='registration_data-code-sources-idp-models-registrationdata-swift-13-code' class='heading'>Registration_Data <code>../Sources/IDP/Models/RegistrationData.swift:13</code></h4>
<pre class="highlight plaintext"><code>/// Bundles data needed for creating and verifiying a pairing.
/// [REQ:gemSpec_IDP_Dienst:A_21415:Registration_Data]
/// [REQ:gemSpec_IDP_Frontend:A_21416] Data Structure
public struct RegistrationData: Claims, Codable {

</code></pre>
<h4 id='device_information-code-sources-idp-models-registrationdata-swift-39-code' class='heading'>Device_Information <code>../Sources/IDP/Models/RegistrationData.swift:39</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Dienst:A_21415:Device_Information]
public struct DeviceInformation: Codable {

</code></pre>
<h4 id='device_type-code-sources-idp-models-registrationdata-swift-56-code' class='heading'>Device_Type <code>../Sources/IDP/Models/RegistrationData.swift:56</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Dienst:A_21415:Device_Type]
/// [REQ:gemSpec_IDP_Frontend:A_21591]
public struct DeviceType: Codable {

</code></pre>
<h4 id='encrypted_registration_data-code-sources-idp-models-registrationdata-swift-104-code' class='heading'>Encrypted_Registration_Data <code>../Sources/IDP/Models/RegistrationData.swift:104</code></h4>

<p>Returns JWE encrypted Registration_Data</p>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Dienst:A_21415:Encrypted_Registration_Data] Returns JWE encrypted Registration_Data
/// [REQ:gemSpec_IDP_Frontend:A_21416] Encryption
func encrypted(with publicKey: BrainpoolP256r1.KeyExchange.PublicKey,

</code></pre>
<h4 id='signed_pairing_data-code-sources-idp-models-signedpairingdata-swift-12-code' class='heading'>Signed_Pairing_Data <code>../Sources/IDP/Models/SignedPairingData.swift:12</code></h4>
<pre class="highlight plaintext"><code>/// Signed (with eGK) version of `PairingData`.
/// [REQ:gemSpec_IDP_Dienst:A_21415:Signed_Pairing_Data]
public struct SignedPairingData {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_dienst-latest-index-html-a_21450-a_21450-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Dienst/latest/index.html#A_21450">A_21450</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21450" severity="MUSS" class="target-element">
<p><b>A_21450 - Inspektions- und Deregistrierungsfunktion des IdP-Dienstes: Datenmodell und Syntax zur Kommunikation mit dem Authenticator-Modul</b></p>
<p>Die Inspektions- und Deregistrierungsfunktion des IdP-Dienstes MUSS die folgenden Datentypen zur Kommunikation mit dem Authenticator-Modul verwenden: <br> 
</p>
<ul>
<li>Pairing_Entry</li>
<li>Pairing_Entries.</li>
</ul> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='pairing_entry-code-sources-idp-models-pairingentry-swift-12-code' class='heading'>Pairing_Entry <code>../Sources/IDP/Models/PairingEntry.swift:12</code></h4>
<pre class="highlight plaintext"><code>/// Represents stored data within the idp.
/// [REQ:gemSpec_IDP_Dienst:A_21450:Pairing_Entry]
public struct PairingEntry: Equatable, Codable {

</code></pre>
<h2 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-gemspec_idp_frontend-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html">gemSpec_IDP_Frontend</a></h2>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_19908-01-a_19908-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_19908-01">A_19908-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19908-01" severity="MUSS" class="target-element">
<p><b>A_19908-01 - Authenticator-Modul: Prüfung der Signatur des &ldquo;CHALLENGE_TOKEN&rdquo;</b></p>
<p>Das Authenticator-Modul MUSS die Signatur des <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">CHALLENGE_TOKEN</span> gegen den aktuellen öffentlichen Schlüssel des Authorization-Endpunktes <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">PUK_AUTH</span> prüfen. Liegt dem Authenticator-Modul der öffentliche Schlüssel des Authorization-Endpunktes noch nicht vor, <span style="font-weight: normal;">MUSS</span> es diesen vom Authorization Server gemäß den Angaben der Adresse <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">PUK_URI_AUTH</span> im Discovery Document abrufen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-634-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:634</code></h4>

<p>Signature check</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_IDP_Frontend:A_19908-01] Signature check
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let verified = try? challenge.challenge.verify(with: document.authentication.cert),

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_19937-a_19937-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_19937">A_19937</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19937" severity="MUSS" class="target-element">
<p><b>A_19937 - Fehlermeldungen des Token-Endpunktes Anzeige</b></p>
<p>Das Anwendungsfrontend <span style="font-weight: normal;">MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span></span> in der Lage sein, die vom Token-Endpunkt übertragenen Fehlermeldungen anzuzeigen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-common-errorlocalization-idperror-localization-swift-23-code' class='heading'><code>../Sources/eRpApp/Common/ErrorLocalization/IDPError+Localization.swift:23</code></h4>

<p>Localized description of server errors</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937#1,A_20605,A_20085] Localized description of server errors
case let .internal(error: error): return error.localizedDescription

</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-506-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:506</code></h4>

<p>Decoding server errors</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937#2,A_20605] Decoding server errors
private static func responseError(for body: Data) -&gt; IDPError {

</code></pre>
<h4 id='code-sources-idp-models-idperror-swift-85-code' class='heading'><code>../Sources/IDP/Models/IDPError.swift:85</code></h4>

<p>Error formatting</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937#3,A_20605,A_20085] Error formatting
public var description: String {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_19938-01-a_19938-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_19938-01">A_19938-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19938-01" severity="MUSS" class="target-element">
<p><b>A_19938-01 - Annahme des ID_TOKEN</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> das vom Token-Endpunkt ausgegebene <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ID_TOKEN</span> als HTTP/1.1-Statusmeldung 200 verarbeiten und mittels &ldquo;Token-Key&rdquo; entschlüsseln. <br> Das Anwendungsfrontend MUSS das <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ID_TOKEN</span> ablehnen, wenn dieses außerhalb der mit dem Token-Endpunkt etablierten TLS-Verbindung übertragen wird oder nicht mit dem vorher übermittelten &ldquo;Token-Key&rdquo; verschlüsselt war. <br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We support the smartcard idp.</p>
<h4 id='code-sources-idp-internal-realidpclient-swift-259-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:259</code></h4>

<p>2xx HTTPCodes are treated as tokens</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19938-01#2|3] 2xx HTTPCodes are treated as tokens
if status.isSuccessful {
    return try JSONDecoder().decode(TokenPayload.self, from: body)
} else {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-204-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:204</code></h4>

<p>Decrypt, fails if wrong aes key</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19938-01#3|3,A_20283-01|3] Decrypt, fails if wrong aes key
guard let decrypted = try? token.decrypted(with: self.cryptoBox.aesKey) else {
    return Fail(error: IDPError.decryption).eraseToAnyPublisher()
}
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-227-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:227</code></h4>

<p>Usage</p>
<pre class="highlight plaintext"><code>idToken: decrypted.idToken, // [REQ:gemSpec_IDP_Frontend:A_19938-01#4] Usage
ssoToken: exchange.sso,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20068-01-a_20068-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20068-01">A_20068-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20068-01" severity="MUSS" class="target-element">
<p><b>A_20068-01 - Authenticator-Modul: Prüfung Internet-Zertifikate</b></p>
<p>Das Authenticator-Modul MUSS das Internet-seitige Zertifikat des IdP-Dienstes prüfen. Hierfür MUSS das Authenticator-Modul sowohl eine Signaturprüfung als auch eine Prüfung der zeitlichen Gültigkeit durchführen. Falls diese Prüfung negativ ausfällt, MUSS es das Zertifikat als &ldquo;ungültig&rdquo; bewerten. <br>Das Authenticator-Modul MUSS das Zertifikat anhand der Signaturprüfung auf ein CA-Zertifikat einer CA, die die &ldquo;CA/Browser Forum Baseline Requirements for the Issuance and Management of Publicly-Trusted Certificates&rdquo; (https://cabforum.org/baseline-requirements-documents/) erfüllt, zurückführen können. Ansonsten MUSS es das Zertifikat als &ldquo;ungültig&rdquo; bewerten. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>: Implemented by not deactivating ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity</code>.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20079-a_20079-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20079">A_20079</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20079" severity="MUSS" class="target-element">
<p><b>A_20079 - Ausfall der Fehlermeldung des Token-Endpunktes</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> im Falle eines Timeout selbständig eine Fehlermeldung generieren, wenn eine Fehlermeldung durch den Token-Endpunkt ausbleibt. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-internal-realidpclient-swift-267-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:267</code></h4>

<p>Network timeouts will traverse the queue as <code>HTTPError</code>s.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20079] Network timeouts will traverse the queue as `HTTPError`s.
$0.asIDPError()

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20085-a_20085-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20085">A_20085</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20085" severity="MUSS" class="target-element">
<p><b>A_20085 - Fehlermeldungen des Anwendungsfrontends</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> leicht verständliche Fehlermeldungen ausgeben. Eine exakte Form der Fehlermeldung ist nicht vorgegeben [<a href="https://tools.ietf.org/html/rfc6749#section-1.7" target="_top" class="descriptionLink">RFC6749 # section-1.7</a>]. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-models-idperror-swift-85-code' class='heading'><code>../Sources/IDP/Models/IDPError.swift:85</code></h4>

<p>Error formatting</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937#3,A_20605,A_20085] Error formatting
public var description: String {

</code></pre>
<h4 id='code-sources-erpapp-common-errorlocalization-idperror-localization-swift-13-code' class='heading'><code>../Sources/eRpApp/Common/ErrorLocalization/IDPError+Localization.swift:13</code></h4>

<p>Error localization is not done yet, this is the place to localize</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20085] Error localization is not done yet, this is the place to localize
// accordingly.
switch self {

</code></pre>
<h4 id='code-sources-erpapp-common-errorlocalization-idperror-localization-swift-23-code' class='heading'><code>../Sources/eRpApp/Common/ErrorLocalization/IDPError+Localization.swift:23</code></h4>

<p>Localized description of server errors</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937#1,A_20605,A_20085] Localized description of server errors
case let .internal(error: error): return error.localizedDescription

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20283-01-a_20283-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20283-01">A_20283-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20283-01" severity="MUSS" class="target-element">
<p><b>A_20283-01 - Annahme des &ldquo;ACCESS_TOKEN&rdquo;</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> das vom Token-Endpunkt ausgegebene <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ACCESS_TOKEN </span>in der HTTP/1.1-Statusmeldung 200 verarbeiten und mittels &ldquo;Token-Key&rdquo; entschlüsseln. <br> Das Anwendungsfrontend MUSS das <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ACCESS_TOKEN </span>ablehnen, wenn dieses außerhalb der mit dem Token-Endpunkt etablierten TLS-Verbindung übertragen wird oder nicht mit dem vorher übermittelten &ldquo;Token-Key&rdquo; verschlüsselt war. <br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-225-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:225</code></h4>

<p>Usage</p>
<pre class="highlight plaintext"><code>accessToken: decrypted.accessToken, // [REQ:gemSpec_IDP_Frontend:A_20283-01] Usage
expires: self.time().addingTimeInterval(TimeInterval(token.expiresIn)),

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20309-a_20309-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20309">A_20309</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20309" severity="MUSS" class="target-element">
<p><b>A_20309 - Bildung von &ldquo;CODE_VERIFIER&rdquo; und &ldquo;CODE_CHALLENGE&rdquo;</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> zur Laufzeit einen <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">CODE_VERIFIER</span> (Zufallswert) gemäß [<a href="https://tools.ietf.org/html/rfc7636#section-4.1" target="_top" class="descriptionLink">RFC7636 # section-4.1</a>] bilden. Der <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">CODE_VERIFIER</span> muss eine Entropie von mindestens 43 und maximal 128 Zeichen enthalten. Das Anwendungsfrontend MUSS über den <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">CODE_VERIFIER</span> einen HASH-Wert, die sogenannte <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">CODE_CHALLENGE,</span> gemäß [<a href="https://tools.ietf.org/html/rfc7636#section-4.2" target="_top" class="descriptionLink">RFC7636 # section-4.2</a>] bilden. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-612-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:612</code></h4>

<p>generation and hashing for codeChallenge</p>
<pre class="highlight plaintext"><code>// Generate a verifierCode
// [REQ:gemSpec_IDP_Frontend:A_20309] generation and hashing for codeChallenge
guard let verifierCode = try? self.cryptoBox.generateRandomVerifier(),

</code></pre>
<h4 id='code-sources-idp-internal-idpcrypto-swift-68-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:68</code></h4>

<p>verifierLength is 32 bytes, encoded to base64 this results in 43 chars</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20309] verifierLength is 32 bytes, encoded to base64 this results in 43 chars
// (32 * 4 / 3 = 42,6)
try randomGenerator(verifierLength).encodeBase64urlsafe().utf8string

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20483-a_20483-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20483">A_20483</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20483" severity="MUSS" class="target-element">
<p><b>A_20483 - Formulierung und Inhalte der Anfrage zum &ldquo;AUTHORIZATION_CODE&rdquo; für einen &ldquo;ACCESS_TOKEN&rdquo;</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> über das Authenticator-Modul den Antrag zum<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;"> AUTHORIZATION_CODE</span> für einen <span style="font-size: 11pt;font-family: 'Courier New', Courier, monospace, HanWangKanTan;line-height: 1.5;">ACCESS_TOKEN</span> via Private-Use URI Scheme Redirection  [<a href="https://tools.ietf.org/html/rfc8252#section-7.1" target="_top" class="descriptionLink">RFC8252 # section-7.1</a>] beim Authorization-Endpunkt in Form eines HTTP/1.1 GET-Request stellen und dabei die folgenden Attribute anführen: <br> 
</p>
<div style="margin-left: 2em;"> 
<ul> 
<li><span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">response_type</span></li> 
<li><span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">scope</span></li> 
<li><span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">client_id</span></li> 
<li><span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">redirect_uri</span></li> 
<li>
<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">code_challenge</span> (Hashwert des <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">code_verifier</span>) [<a href="https://tools.ietf.org/html/rfc7636#section-4.2" target="_top" class="descriptionLink">RFC7636 # section-4.2</a>]<br> </li> 
<li>
<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">code_challenge_method</span> HASH-Algorithmus (S256) [<a href="https://tools.ietf.org/html/rfc7636#section-4.3" target="_top" class="descriptionLink">RFC7636 # section-4.3</a>]</li> 
</ul> 
</div> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-620-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:620</code></h4>

<p>Requesting the challange for the session</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20483#2|8] Requesting the challange for the session
return self.client.requestChallenge(
    codeChallenge: codeChallenge,
    method: .sha256,
    state: state,
    nonce: nonce,
    using: document,
    redirect: redirect
)
</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-100-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:100</code></h4>

<p>Fill all the values into the GET Request</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20483#3|15] Fill all the values into the GET Request
let queryItems = [
    // [REQ:gemSpec_IDP_Frontend:A_20603,A_20601,A_20601-01] Transfer
    URLQueryItem(name: "client_id", value: clientConfig.clientId.urlPercentEscapedString()),
    URLQueryItem(name: "code_challenge", value: codeChallenge.urlPercentEscapedString()),
    URLQueryItem(name: "code_challenge_method", value: method.rawValue.urlPercentEscapedString()),
    URLQueryItem(name: "state", value: state.urlPercentEscapedString()),
    URLQueryItem(name: "scope", value: clientConfig.scopes.joined(separator: " ").urlPercentEscapedString()),
    URLQueryItem(name: "response_type", value: "code"),
    URLQueryItem(name: "nonce", value: nonce.urlPercentEscapedString()),
    URLQueryItem(
        // [REQ:gemSpec_IDP_Frontend:A_20740] transfer
        name: "redirect_uri",
        value: (redirect ?? clientConfig.redirectURI.absoluteString).urlPercentEscapedString()
    ),
]
</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20499-a_20499-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20499">A_20499</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Not applicable as authenticator module is within FdV, not 3rd party app.</p>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-247-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:247</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-1#3] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
set(can: nil)

</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-40-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:40</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-01#2] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_IDP_Frontend:A_21603] Certificate
// [REQ:BSI-eRp-ePA:O.Auth_14#4] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
storage.wipe()

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20499-01-a_20499-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20499-01">A_20499-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20499-01" severity="MUSS" class="target-element">
<p><b>A_20499-01 - Authenticator-Modul: aktives Löschen von &ldquo;SSO_TOKEN&rdquo;</b></p>
<p>Das Authenticator-Modul MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">SSO_TOKEN </span>löschen, wenn der Anwender einen aktiven Logout durchführt. Das Authenticator-Modul MUSS dazu dem Anwender eine auslösende Funktionalität anbieten. <br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofiledomain-swift-255-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileDomain.swift:255</code></h4>

<p>Call the SSO_TOKEN removal upon manual logout</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499-01#1] Call the SSO_TOKEN removal upon manual logout
return .run { [profileId = state.profileId] _ in

</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-40-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:40</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-01#2] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_IDP_Frontend:A_21603] Certificate
// [REQ:BSI-eRp-ePA:O.Auth_14#4] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
storage.wipe()

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20499-1-a_20499-1-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20499-1">A_20499-1</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-247-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:247</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-1#3] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
set(can: nil)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20512-a_20512-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20512">A_20512</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20512" severity="MUSS" class="target-element">
<p><b>A_20512 - Regelmäßiges Einlesen des Discovery Document</b></p>
<p>Das <span id="polarion-comment:315"></span>Anwendungsfrontend <span style="font-weight: normal;">MUSS</span> das Discovery Document [<a class="descriptionLink" target="_top" href="https://tools.ietf.org/html/rfc8414">RFC8414</a>] löschen, wenn dieses 24 Stunden alt oder älter ist. Das Anwendungsfrontend MUSS das Discovery Document neu herunterladen, einlesen und auswerten und danach die darin aufgeführten URI zu den benötigten öffentlichen Schlüsseln (PUKs) und Diensten verwenden, wenn kein aktuelles Discovery Document vorliegt. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-models-discoverydocument-swift-181-code' class='heading'><code>../Sources/IDP/Models/DiscoveryDocument.swift:181</code></h4>

<p>Validation by expiration date checking + maximum of 24h window</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20512#2|5] Validation by expiration date checking + maximum of 24h window
func isValid(on date: Date) -&gt; Bool {
    date &lt;= expiresOn &amp;&amp;
        date &gt;= createdOn &amp;&amp;
        date &lt;= createdOn.addingTimeInterval(60 * 60 * 24)
}
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-278-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:278</code></h4>

<p>Reset expired documents before loading a new one</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20512#3] Reset expired documents before loading a new one
self.storage.set(discovery: nil)

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-122-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:122</code></h4>

<p>Testing the implementation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#10] Testing the implementation
func testLoadDiscoveryDocumentFromStorageOnInitFailesWhenTrustStoreFailsValidation() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-147-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:147</code></h4>

<p>Testing the implementation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#11] Testing the implementation
func testLoadDiscoveryDocumentFromRemoteOnInitFailesWhenTrustStoreFailsValidation() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-172-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:172</code></h4>

<p>Testing the implementation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#12] Testing the implementation
func testLoadDiscoveryDocumentFromStorageOnInitFailesWhenTrustStoreThrows() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-197-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:197</code></h4>

<p>Testing the implementation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#13] Testing the implementation
func testLoadDiscoveryDocumentFromRemoteOnInitFailesWhenTrustStoreThrows() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-222-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:222</code></h4>

<p>Testing the implementation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#14] Testing the implementation
func testLoadDiscoveryDocumentFromStorageOnInit() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-246-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:246</code></h4>

<p>Testing the implementation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#15] Testing the implementation
func testLoadDiscoveryDocumentFromRemoteOnInit() {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20525-a_20525-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20525">A_20525</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20525" severity="MUSS" class="target-element">
<p><b>A_20525 - Authenticator-Modul: Anzeige des &ldquo;user_consent&rdquo; und PIN-Abfrage</b></p>
<p>Das Authenticator-Modul MUSS im Zusammenhang mit der PIN-Abfrage für die Signatur des <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">CHALLENGE_TOKEN</span> durch die Smartcard im selben Dialog die Consent-Freigabe des <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">user_consent</span> durch den Nutzer einfordern, damit dieser durch die PIN-Eingabe seine Willenserklärung abgibt und der Verwendung seiner Daten in diesen Claims zustimmt. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Not applicable as authenticator module is within FdV, not 3rd party app</p>

<p>Not applicable as authenticator module is within FdV. Consent is given by using the app.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20526-01-a_20526-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20526-01">A_20526-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20526-01" severity="MUSS" class="target-element">
<p><b>A_20526-01 - Authenticator-Modul: Response auf das &ldquo;CHALLENGE_TOKEN&rdquo; des Authorization-Endpunktes</b></p>
<p>Das Authenticator-Modul MUSS das eingereichte <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">CHALLENGE_TOKEN</span> mittels JWS (JSON Web Signature) mit der Smartcard signieren, und das Authentifizierungszertifikat der verwendeten Smartcard als x5c Parameter einbetten. Dieses Objekt mittels JWE (JSON Web Encryption) mit dem öffentlichen Schlüssel des Authorization-Endpunktes <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">PuK_IDP_ENC</span> verschlüsseln und in Form eines HTTP-POST-Requests an den Authorization-Endpunkt senden.<br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-153-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:153</code></h4>

<p>Encryption with JWE</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20526-01] Encryption with JWE
guard let jwe = try? signedChallenge.encrypt(with: document.encryptionPublicKey,

</code></pre>
<h4 id='code-sources-idp-models-idpchallengesession-swift-86-code' class='heading'><code>../Sources/IDP/Models/IDPChallengeSession.swift:86</code></h4>

<p>Embed certificate</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20526-01] Embed certificate
let header = JWT.Header(alg: alg, x5c: certificates, typ: "JWT", cty: "NJWT")

</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-147-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:147</code></h4>

<p>Building and sending the request</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20526-01] Building and sending the request
var request = URLRequest(url: document.authentication.url, cachePolicy: .reloadIgnoringCacheData)

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-profile-swift-76-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Profile.swift:76</code></h4>

<p>sign and verify with idp</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20172]
// [REQ:gemSpec_IDP_Frontend:A_20526-01] sign and verify with idp
func signChallengeWithNFCCard(

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-profile-swift-108-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Profile.swift:108</code></h4>

<p>verify with idp</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20172]
// [REQ:gemSpec_IDP_Frontend:A_20526-01] verify with idp
func verifyResultWithIDP(

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-268-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:268</code></h4>

<p>sign</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20526-01] sign
// [REQ:gemSpec_IDP_Frontend:A_20700-07] sign
func sign(

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20527-a_20527-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20527">A_20527</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20527" severity="MUSS" class="target-element">
<p><b>A_20527 - Authenticator-Modul: Übertragung des &ldquo;AUTHORIZATION_CODE&rdquo; an das Anwendungsfrontend</b></p>
<p>Das Authenticator-Modul MUSS den vom Authorization-Endpunkt empfangenen <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">AUTHORIZATION_CODE</span> an das Anwendungsfrontend übertragen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Not directly applicable as authenticator module is within FdV, not 3rd party app. AUTHORIZATION_CODE will be used directly.</p>
<h4 id='code-sources-idp-defaultidpsession-swift-166-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:166</code></h4>

<p>Returning the AUTHORIZATION_CODE</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20527] Returning the AUTHORIZATION_CODE
return Just(exchangeToken).setFailureType(to: IDPError.self).eraseToAnyPublisher()

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20529-01-a_20529-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20529-01">A_20529-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20529-01" severity="MUSS" class="target-element">
<p><b>A_20529-01 - Senden von &ldquo;AUTHORIZATION_CODE&rdquo; und &ldquo;KEY_VERIFIER&rdquo; an den Token-Endpunkt</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> den <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">KEY_VERIFIER</span> mittels JWE (<span style="font-size: 10pt;line-height: 1.5;">JSON Web Encryption (JWE) [<a href="https://tools.ietf.org/html/rfc7516#section-3" target="_top">RFC7516 # section-3</a>]) </span>und <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">PuK_IDP_ENC</span> verschlüsseln und zusammen mit dem <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">AUTHORIZATION_CODE</span> TLS-gesichert als HTTP/1.1 POST Request an den Token-Endpunkt senden.<br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We support the smartcard idp.</p>
<h4 id='code-sources-idp-defaultidpsession-swift-184-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:184</code></h4>

<p>Encrypting the <code>KEY_VERIFIER</code></p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20529-01#2|6] Encrypting the `KEY_VERIFIER`
// [REQ:gemSpec_IDP_Frontend:A_21323,A_21324#1|6] Crypto box contains `Token-Key`
guard let encryptedKeyVerifier = try? KeyVerifier(
    with: self.cryptoBox.aesKey,
    codeVerifier: challengeSession.verifierCode
).encrypted(with: document.encryptionPublicKey, using: self.cryptoBox) else {
    return Fail(error: IDPError.encryption).eraseToAnyPublisher()
}
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-192-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:192</code></h4>

<p>Sending encrypted <code>KEY_VERIFIER</code> and <code>AUTHORIZATION_CODE</code>.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20529-01#3|7] Sending encrypted `KEY_VERIFIER` and `AUTHORIZATION_CODE`.
return self.client.exchange(
    token: exchange,
    verifier: challengeSession.verifierCode,
    redirectURI: exchange.redirect,
    encryptedKeyVerifier: encryptedKeyVerifier,
    using: document
)
</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-243-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:243</code></h4>

<p>Putting all parameters into the HTTP body</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20529-01#4|10] Putting all parameters into the HTTP body
let parameters = [
    "key_verifier": keyVerifierJWEString,
    "code": token.code,
    "grant_type": "authorization_code",
    // [REQ:gemSpec_IDP_Frontend:A_20740] transfer
    "redirect_uri": redirectURI ?? clientConfig.redirectURI.absoluteString,
    "code_verifier": verifier,
    // [REQ:gemSpec_IDP_Frontend:A_20603] transfer
    "client_id": clientConfig.clientId,
]
</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-256-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:256</code></h4>

<p>Sending the Request with the default HTTPClient via TLS.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20529-01#5] Sending the Request with the default HTTPClient via TLS.
return httpClient.send(request: request)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20600-a_20600-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20600">A_20600</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20600" severity="MUSS" class="target-element">
<p><b>A_20600 - Authenticator-Modul: Annahme des &ldquo;user_consent&rdquo; und des &ldquo;CHALLENGE_TOKEN&rdquo;</b></p>
<p>Das Authenticator-Modul MUSS den <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">user_consent</span> und den <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">CHALLENGE_TOKEN</span> vom Authorization-Endpunkt des IDP-Dienstes entgegennehmen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-internal-realidpclient-swift-174-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:174</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20600]
return IDPExchangeToken(

</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-491-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:491</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20600]
return IDPExchangeToken(code: code,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20601-a_20601-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20601">A_20601</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20601" severity="MUSS" class="target-element">
<p><b>A_20601 - Authenticator-Modul: Übergabe des Authorization-Request an den Authorization-Endpunkt</b></p>
<p>Das Authenticator-Modul MUSS den Authorization-Request, welchen dieses vom Anwendungsfrontend erhalten hat, an den Authorization-Server des IdP-Dienstes schicken. Der Authorization-Request MUSS folgende Parameter enthalten: 
</p>
<ul>
<li>&ldquo;<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">response_type</span>&rdquo;</li>
<li>&ldquo;<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">scope</span>&rdquo;</li>
<li>&ldquo;<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">client_id</span>&rdquo;</li>
<li>&ldquo;<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">redirect_uri</span>&rdquo;</li>
<li>
<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">&ldquo;code_challenge&rdquo;</span> (Hashwert des <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">&ldquo;code_verifier&rdquo;</span>) [<a class="descriptionLink" target="_top" href="https://tools.ietf.org/html/rfc7636#section-4.2">RFC7636 # section-4.2</a>]<br>
</li>
<li>
<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">&ldquo;code_challenge_method&rdquo;</span> HASH-Algorithmus (S256) [<a class="descriptionLink" target="_top" href="https://tools.ietf.org/html/rfc7636#section-4.3">RFC7636 # section-4.3</a>]</li>
</ul> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-internal-realidpclient-swift-102-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:102</code></h4>

<p>Transfer</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20603,A_20601,A_20601-01] Transfer
URLQueryItem(name: "client_id", value: clientConfig.clientId.urlPercentEscapedString()),

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20601-01-a_20601-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20601-01">A_20601-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-internal-realidpclient-swift-102-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:102</code></h4>

<p>Transfer</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20603,A_20601,A_20601-01] Transfer
URLQueryItem(name: "client_id", value: clientConfig.clientId.urlPercentEscapedString()),

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20602-a_20602-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20602">A_20602</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20602" severity="MUSS" class="target-element">
<p><b>A_20602 - Einreichen des &ldquo;ACCESS_TOKEN&rdquo; beim Fachdienst</b></p>
<p>Das Anwendungsfrontend MUSS das <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ACCESS_TOKEN</span> im Rahmen des entsprechenden fachlichen Aufrufs beim Fachdienst einreichen, um Zugang zu den angeforderten Daten zu erhalten. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Authorization-Header setup of HTTP requests is done via interceptor pattern for every request.</p>
<h4 id='code-sources-idp-idpinterceptor-swift-56-code' class='heading'><code>../Sources/IDP/IDPInterceptor.swift:56</code></h4>

<p>Setup <code>Authorization-Header</code>.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20602#2,A_21325#1] Setup `Authorization-Header`.
request.setValue("\(token.tokenType) \(token.accessToken)", forHTTPHeaderField: "Authorization")

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20603-a_20603-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20603">A_20603</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-internal-realidpclient-swift-102-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:102</code></h4>

<p>Transfer</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20603,A_20601,A_20601-01] Transfer
URLQueryItem(name: "client_id", value: clientConfig.clientId.urlPercentEscapedString()),

</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-251-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:251</code></h4>

<p>transfer</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20603] transfer
"client_id": clientConfig.clientId,

</code></pre>
<h4 id='code-sources-erpapp-appconfiguration-swift-33-code' class='heading'><code>../Sources/eRpApp/AppConfiguration.swift:33</code></h4>

<p>Actual ID</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20603] Actual ID
private static let defaultClientId: String = "eRezeptApp"

</code></pre>
<h4 id='code-sources-erpapp-appconfiguration-swift-80-code' class='heading'><code>../Sources/eRpApp/AppConfiguration.swift:80</code></h4>

<p>Actual ID</p>
<pre class="highlight plaintext"><code>// clientId
// [REQ:gemSpec_IDP_Frontend:A_20603] Actual ID
let clientId: String = defaultClientId

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20605-a_20605-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20605">A_20605</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20605" severity="MUSS" class="target-element">
<p><b>A_20605 - Fehlermeldung des Token-Endpunktes Formatierung</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> den Inhalt der Fehlermeldungen sowie mögliche Hinweise zur Fehlervermeidung vom Token-Endpunkt übernehmen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-models-idperror-swift-85-code' class='heading'><code>../Sources/IDP/Models/IDPError.swift:85</code></h4>

<p>Error formatting</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937#3,A_20605,A_20085] Error formatting
public var description: String {

</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-506-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:506</code></h4>

<p>Decoding server errors</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937#2,A_20605] Decoding server errors
private static func responseError(for body: Data) -&gt; IDPError {

</code></pre>
<h4 id='code-sources-erpapp-common-errorlocalization-idperror-localization-swift-23-code' class='heading'><code>../Sources/eRpApp/Common/ErrorLocalization/IDPError+Localization.swift:23</code></h4>

<p>Localized description of server errors</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937#1,A_20605,A_20085] Localized description of server errors
case let .internal(error: error): return error.localizedDescription

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20606-a_20606-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20606">A_20606</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20606" severity="MUSS" class="target-element">
<p><b>A_20606 - Anwendungsfrontend: Kommunikation über TLS-Verbindung</b></p>
<p>Das Anwendungsfrontend MUSS mit dem IDP-Dienst über TLS kommunizieren. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>TLS is enforced by the platform for every HTTP connection. Certain domains can be excluded from this rule by listing them in a dedicated NSAppTransportSecurity exception list. This list is empty for our application.</p>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-34-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:34</code></h4>

<p>Setup of minimum TLS Version to use.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_IDP_Frontend:A_20606#2] Setup of minimum TLS Version to use.
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework
urlSessionConfiguration.tlsMinimumSupportedProtocolVersion = .TLSv12

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20607-a_20607-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20607">A_20607</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>no exceptions set in NSAppTransportSecurity, HTTP via TLS is enforced; OS will use system root certificates in combination with set pinned certificates. see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20608-01-a_20608-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20608-01">A_20608-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>: Implemented by not deactivating ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity</code>.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20609-a_20609-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20609">A_20609</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20609" severity="MUSS" class="target-element">
<p><b>A_20609 - Authenticator-Modul: Unzulässige TLS-Verbindungen ablehnen</b></p>
<p>Das Authenticator-Modul MUSS bei jedem Verbindungsaufbau den IDP-Dienst anhand seines TLS-Zertifikats authentifizieren und MUSS die Verbindung ablehnen, falls die Authentifizierung fehlschlägt. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>no exceptions set in NSAppTransportSecurity, HTTP via TLS is enforced; OS will use system root certificates in combination with set pinned certificates. see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>

<p>: Implemented by not deactivating ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity</code>.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20614-a_20614-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20614">A_20614</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20614" severity="MUSS" class="target-element">
<p><b>A_20614 - Authenticator-Modul: Prüfung der Signatur des Discovery Document</b></p>
<p><span style="font-size: 10pt;line-height: 1.5;">Das Authenticator-Modul MUSS die Signatur des Discovery Document mathematisch prüfen und auf ein zeitlich gültiges C.FD.SIG-Zertifikat mit der Rollen-OID <span style="font-style: italic;">oid_idpd</span> zurückführen können, welches von einer ihm bekannten Komponenten-PKI ausgestellt wurde.</span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-266-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:266</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623,A_20614]
.validateOrNil(with: trustStoreSession, timeProvider: time)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20617-01-a_20617-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20617-01">A_20617-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20617-01" severity="MUSS" class="target-element">
<p><b>A_20617-01 - Authenticator-Modul: Verpflichtende Zertifikatsprüfung</b></p>
<p>Das Authenticator-Modul MUSS aktiv verwendete Zertifikate (bspw. für den TLS-Verbindungsaufbau), welche auf Root-Zertifikaten aus der TSL basieren, gemäß &ldquo;TUC_PKI_018&rdquo; auf Integrität und Authentizität prüfen. Das Authenticator-Modul MUSS die von dem Zertifikat und den darin enthaltenen Attributen (bspw. öffentliche Schlüssel) abhängenden Arbeitsabläufe ablehnen, wenn die Prüfung kein positives Ergebnis (&ldquo;gültig&rdquo;) liefert. Das Authenticator-Modul MUSS alle öffentlichen Schlüssel, die es verwenden will, auf eine positiv verlaufene Zertifikatsprüfung zurückführen können. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-244-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:244</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#15] Testing the implementation
func testLoadDiscoveryDocumentFromRemoteOnInit() {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-299-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:299</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623]
.validate(with: self.trustStoreSession, timeProvider: self.time)

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-696-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:696</code></h4>
<pre class="highlight plaintext"><code>/// Returns a Publisher that validates the input streams discoveryDocument against the given trustStoreSession. If
/// the validity cannot be verified, the publisher fails with an `IDPError.trustStore` error.
///
/// [REQ:gemSpec_IDP_Frontend:A_20617-01]
/// [REQ:gemSpec_IDP_Frontend:A_20623]
///
/// - Parameter trustStoreSession: `TrustStoreSession` that is used to check the validity and trust of the
/// discoveryDocument.
/// - Returns: An AnyPublisher of `DiscoveryDocument`and `IDPError`
func validate(with trustStoreSession: TrustStoreSession,

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-728-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:728</code></h4>
<pre class="highlight plaintext"><code>/// Returns a Publisher that validates the input streams discoveryDocument and returns nil if validity cannot be
/// checked. All Errors are caught and result in an empty discoveryDocument.
///
/// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623]
///
/// - Parameters:
///   - trustStoreSession: `TrustStoreSession` that is used to check the validity and trust of the disoveryDocument.
///   - time: Time provider to check the discovery document against.
/// - Returns: An AnyPublisher of `DiscoveryDocument`and `Never`.
func validateOrNil(with trustStoreSession: TrustStoreSession,

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-120-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:120</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#10] Testing the implementation
func testLoadDiscoveryDocumentFromStorageOnInitFailesWhenTrustStoreFailsValidation() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-145-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:145</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#11] Testing the implementation
func testLoadDiscoveryDocumentFromRemoteOnInitFailesWhenTrustStoreFailsValidation() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-170-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:170</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#12] Testing the implementation
func testLoadDiscoveryDocumentFromStorageOnInitFailesWhenTrustStoreThrows() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-195-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:195</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#13] Testing the implementation
func testLoadDiscoveryDocumentFromRemoteOnInitFailesWhenTrustStoreThrows() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-220-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:220</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#14] Testing the implementation
func testLoadDiscoveryDocumentFromStorageOnInit() {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-266-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:266</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623,A_20614]
.validateOrNil(with: trustStoreSession, timeProvider: time)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20618-a_20618-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20618">A_20618</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20618" severity="MUSS" class="target-element">
<p><b>A_20618 - Authenticator-Modul: Unzulässige TLS-Verbindungen ablehnen</b></p>
<p>Das Authenticator-Modul MUSS bei jedem Verbindungsaufbau den IdP-Dienst anhand seines TLS-Zertifikats authentifizieren und MUSS die Verbindungen ablehnen, falls die Authentifizierung fehlschlägt. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>no exceptions set in NSAppTransportSecurity, HTTP via TLS is enforced; OS will use system root certificates in combination with set pinned certificates. see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>

<p>: Implemented by not deactivating ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity</code>.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20623-a_20623-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20623">A_20623</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20623" severity="MUSS" class="target-element">
<p><b>A_20623 - Anwendungsfrontend: Prüfung der Signatur des Discovery Document</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> die Signatur des Discovery Document mathematisch prüfen und auf ein zeitlich gültiges C.FD.SIG-Zertifikat mit der Rollen-OID <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">oid_idpd</span> zurückführen können, welches rückführbar ist auf ein CA-Zertifikat aus einer authentischen, integren und zeitlich gültigen TSL. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-245-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:245</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#15] Testing the implementation
func testLoadDiscoveryDocumentFromRemoteOnInit() {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-299-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:299</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623]
.validate(with: self.trustStoreSession, timeProvider: self.time)

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-697-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:697</code></h4>
<pre class="highlight plaintext"><code>/// Returns a Publisher that validates the input streams discoveryDocument against the given trustStoreSession. If
/// the validity cannot be verified, the publisher fails with an `IDPError.trustStore` error.
///
/// [REQ:gemSpec_IDP_Frontend:A_20617-01]
/// [REQ:gemSpec_IDP_Frontend:A_20623]
///
/// - Parameter trustStoreSession: `TrustStoreSession` that is used to check the validity and trust of the
/// discoveryDocument.
/// - Returns: An AnyPublisher of `DiscoveryDocument`and `IDPError`
func validate(with trustStoreSession: TrustStoreSession,

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-700-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:700</code></h4>

<p>Validation call</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20623] Validation call
return trustStoreSession.validate(discoveryDocument: document)

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-728-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:728</code></h4>
<pre class="highlight plaintext"><code>/// Returns a Publisher that validates the input streams discoveryDocument and returns nil if validity cannot be
/// checked. All Errors are caught and result in an empty discoveryDocument.
///
/// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623]
///
/// - Parameters:
///   - trustStoreSession: `TrustStoreSession` that is used to check the validity and trust of the disoveryDocument.
///   - time: Time provider to check the discovery document against.
/// - Returns: An AnyPublisher of `DiscoveryDocument`and `Never`.
func validateOrNil(with trustStoreSession: TrustStoreSession,

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-758-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:758</code></h4>

<p>Validation</p>
<pre class="highlight plaintext"><code>/// Returns a publisher that checks a discoveryDocument against the trust store. The Stream contains an output
/// boolean for the plain check or an TrustStoreError in case the TrustStoreSession sub streams failed.
///
/// [REQ:gemSpec_IDP_Frontend:A_20623] Validation
///
/// - Parameter discoveryDocument: The DiscoveryDocument that needs to be checked.
/// - Returns: A publisher that contains an output with the check value or an failure if the check failed
/// due to an underlying error.
func validate(discoveryDocument: DiscoveryDocument) -&gt; AnyPublisher&lt;Bool, TrustStoreError&gt; {

</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-179-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:179</code></h4>

<p>oid check</p>
<pre class="highlight plaintext"><code>} else if eeCert.contains(oidBytes: .oidIdpd) { // [REQ:gemSpec_IDP_Frontend:A_20623,A_20625#4] oid check
    return (vauCerts, idpCerts + [eeCert])

</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-193-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:193</code></h4>

<p>IDP oid</p>
<pre class="highlight plaintext"><code>case oidErpVau // 1.2.276.0.76.4.258 == 0x06082A8214004C048202
// [REQ:gemSpec_IDP_Frontend:A_20623] IDP oid
case oidIdpd // 1.2.276.0.76.4.260 == 0x06082A8214004C048204
}

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-121-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:121</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#10] Testing the implementation
func testLoadDiscoveryDocumentFromStorageOnInitFailesWhenTrustStoreFailsValidation() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-146-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:146</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#11] Testing the implementation
func testLoadDiscoveryDocumentFromRemoteOnInitFailesWhenTrustStoreFailsValidation() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-171-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:171</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#12] Testing the implementation
func testLoadDiscoveryDocumentFromStorageOnInitFailesWhenTrustStoreThrows() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-196-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:196</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#13] Testing the implementation
func testLoadDiscoveryDocumentFromRemoteOnInitFailesWhenTrustStoreThrows() {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-221-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:221</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01]
// [REQ:gemSpec_IDP_Frontend:A_20623]
// [REQ:gemSpec_IDP_Frontend:A_20512#14] Testing the implementation
func testLoadDiscoveryDocumentFromStorageOnInit() {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-266-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:266</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623,A_20614]
.validateOrNil(with: trustStoreSession, timeProvider: time)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20625-a_20625-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20625">A_20625</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20625" severity="MUSS" class="target-element">
<p><b>A_20625 - Anwendungsfrontend: Prüfung der Signatur des ID_TOKEN</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> die Signatur des <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ID_TOKEN </span>mathematisch prüfen und auf ein zeitlich gültiges C.FD.SIG-Zertifikat mit der Rollen-OID oid_idpd zurückführen können, welches rückführbar ist auf ein CA-Zertifikat aus einer authentischen, integren und zeitlich gültigen TSL. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>These checks are part of the <code>DefaultIDPSession</code> as part for the response parsing. If they fail, an error will be thrown.</p>
<h4 id='code-sources-idp-defaultidpsession-swift-211-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:211</code></h4>

<p>Validate <code>ID_TOKEN</code> signature with <code>C.FD.SIG</code>.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20625#2|4] Validate `ID_TOKEN` signature with `C.FD.SIG`.
guard let jwt = try? JWT(from: decrypted.idToken),
      (try? jwt.verify(with: document.signingCert)) ?? false else {
    return Fail(error: IDPError.invalidSignature("ID_TOKEN")).eraseToAnyPublisher()
}
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-759-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:759</code></h4>

<p><code>C.FD.SIG</code>-Certificate verification</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20625#3|4] `C.FD.SIG`-Certificate verification
.zip(validate(certificate: discoveryDocument.signingCert))
.map { isDiscKeyValid, isSigningCertValid -&gt; Bool in
    isDiscKeyValid &amp;&amp; isSigningCertValid
}
</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-179-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:179</code></h4>

<p>oid check</p>
<pre class="highlight plaintext"><code>} else if eeCert.contains(oidBytes: .oidIdpd) { // [REQ:gemSpec_IDP_Frontend:A_20623,A_20625#4] oid check
    return (vauCerts, idpCerts + [eeCert])

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20700-05-a_20700-05-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20700-05">A_20700-05</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-476-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:476</code></h4>

<p>sign with C.CH.AUT</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-05,A_20700-07] sign with C.CH.AUT
let signedChallenge = try await idpChallengeSigner.sign(

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-522-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:522</code></h4>

<p>sign with C.CH.AUT</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-05,A_20700-07] sign with C.CH.AUT
let signedChallenge = try await idpChallengeSigner.sign(

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20700-07-a_20700-07-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20700-07">A_20700-07</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20700-07" severity="MUSS" class="target-element">
<p><b>A_20700-07 - Authenticator-Modul: Signatur der &ldquo;CHALLENGE&rdquo;</b></p>
<p><span style="font-size: 10pt;line-height: 1.5;">Das Authenticator-Modul MUSS die vom Authorization-Endpunkt empfangene <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">CHALLENGE_TOKEN</span> mit dem Zertifikat C.CH.AUT aus der Smartcard des Nutzers signieren. Hierbei wird der über die <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">CHALLENGE_TOKEN</span> gebildete HASH-Wert zur Signatur überreicht (siehe Abschnitt <span class="polarion-rte-link" data-type="polarion" id="fake" data-custom-label="9.3.7.3 Signiervorgang" data-url="/wiki/Spezifikation/gemSpec_IDP_Frontend?selection=ML-107239"></span> in diesem Dokument).<br> </span> Im Fall der Authentisierung mit einem alternativen Authentisierungsmittel signiert das Authenticator-Modul die folgenden Daten mithilfe des PrK_SE_AUT: <br> 
</p>
<ul> 
<li><span style="font-size: 10pt;line-height: 1.5;">das vom Authorization-Endpunkt bezogene <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">CHALLENGE-TOKEN</span>,</span></li> 
<li><span style="font-size: 10pt;line-height: 1.5;">das auf dem Gerät gespeicherte Authentifizierungszertifikat C.CH.AUT,</span></li> 
<li><span style="font-size: 10pt;line-height: 1.5;">den Key-Identifier für das Schlüsselpaar PrK_SE_AUT/PuK_SE_AUT,</span></li> 
<li><span style="font-size: 10pt;line-height: 1.5;">die aktuell erhobenen Geräteinformationen,</span></li> 
<li><span style="font-size: 10pt;line-height: 1.5;">die Art des vom Nutzer verwendeten, lokalen Authentisierungsmittels zur Freischaltung der Anwendung des Schlüssels PrK_SE_AUT.</span></li> 
</ul> Es MUSS hierbei eine Datenstruktur vom Typ &ldquo;Signed_Authentication_Data&rdquo; produzieren. Der zur Signatur zu verwendende Algorithmus MUSS ECDSA mit SHA-256 sein. Das Feld <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">amr</span> MUSS hierbei wie folgt in Abhängigkeit der vom Nutzer verwendeten Methode belegt werden:<span style="font-size: 10pt;line-height: 1.5;"><span style="background-color: #FFFF33;"><br> </span><br> </span> <p class="polarion-rte-caption-paragraph" style="text-align: left;" id="polarion___1">Tabelle <span data-sequence="Tabelle" class="polarion-rte-caption">1</span>:  Belegung des <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">amr</span>-Claims durch das Authenticator-Modul</p> 
<table id="polarion_wiki macro name=table;params=width=100%|uid=739" class="polarion-Document-table" style="width: 100%;margin-left: auto;margin-right: auto;border: 1px solid #CCCCCC;empty-cells: show;border-collapse: collapse;"> 
<tbody> 
<tr> 
<th style="background-color: #F0F0F0;text-align: left;vertical-align: top;width: 365px;height: 18.1818px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Art </th> 
<th style="background-color: #F0F0F0;text-align: left;vertical-align: top;width: 366px;height: 18.1818px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Authentication-Method-Reference (&ldquo;amr&rdquo;)</th> 
</tr> 
<tr> 
<td style="vertical-align: top;width: 365px;height: 16.3636px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Biometrisch</td> 
<td style="vertical-align: top;width: 366px;height: 16.3636px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">[&ldquo;mfa&rdquo;,&ldquo;hwk&rdquo;,&ldquo;generic-biometric&rdquo;]</td> 
</tr> 
<tr> 
<td style="vertical-align: top;width: 365px;height: 20px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">PIN</td> 
<td style="vertical-align: top;width: 366px;height: 20px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">[&ldquo;mfa&rdquo;,&ldquo;hwk&rdquo;,&ldquo;kba&rdquo;]</td> 
</tr> 
<tr> 
<td style="vertical-align: top;width: 365px;height: 16.3636px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Passwort</td> 
<td style="vertical-align: top;width: 366px;height: 16.3636px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">[&ldquo;mfa&rdquo;,&ldquo;hwk&rdquo;,&ldquo;kba&rdquo;] </td> 
</tr> 
<tr> 
<td style="vertical-align: top;width: 365px;height: 16.3636px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Muster</td> 
<td style="vertical-align: top;width: 366px;height: 16.3636px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">[&ldquo;mfa&rdquo;,&ldquo;hwk&rdquo;,&ldquo;kba&rdquo;] </td> 
</tr> 
</tbody> 
</table> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-127-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:127</code></h4>

<p>Biometrics only, other modes currently not supported</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-07] Biometrics only, other modes currently not supported
amr: [

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-269-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:269</code></h4>

<p>sign</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20526-01] sign
// [REQ:gemSpec_IDP_Frontend:A_20700-07] sign
func sign(

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-476-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:476</code></h4>

<p>sign with C.CH.AUT</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-05,A_20700-07] sign with C.CH.AUT
let signedChallenge = try await idpChallengeSigner.sign(

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-522-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:522</code></h4>

<p>sign with C.CH.AUT</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-05,A_20700-07] sign with C.CH.AUT
let signedChallenge = try await idpChallengeSigner.sign(

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-590-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:590</code></h4>

<p>perform signature with OpenHealthCardKit</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-07] perform signature with OpenHealthCardKit
card.sign(data: message)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20740-a_20740-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20740">A_20740</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20740" severity="MUSS" class="target-element">
<p><b>A_20740 - Bekanntgabe der Redirect-URI des Anwendungsfrontend</b></p>
<p>Das Anwendungsfrontend MUSS, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt, beim IdP-Dienst bei der Registrierung eine <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">redirect_uri</span> hinterlegen.  <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-internal-realidpclient-swift-111-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:111</code></h4>

<p>transfer</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20740] transfer
name: "redirect_uri",

</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-248-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:248</code></h4>

<p>transfer</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20740] transfer
"redirect_uri": redirectURI ?? clientConfig.redirectURI.absoluteString,

</code></pre>
<h4 id='code-sources-erpapp-appconfiguration-swift-82-code' class='heading'><code>../Sources/eRpApp/AppConfiguration.swift:82</code></h4>

<p>Actual redirect uri</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20740] Actual redirect uri
let redirectUri = URL(string: "https://redirect.gematik.de/erezept")! // swiftlint:disable:this force_unwrapping
let extAuthRedirectUri = URL(

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_20741-a_20741-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_20741">A_20741</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20741" severity="MUSS" class="target-element">
<p><b>A_20741 - Speicherung des Downloadpunktes des Discovery Document im Anwendungsfrontend</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> den vom <span style="font-size: 10pt;line-height: 1.5;">IdP-Dienst bei der Registrierung bekanntgegebenen Downloadpunkt des Discovery Document als konfigurierbaren Parameter speichern</span>. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Configuration within <code>app-configuration.json</code>, organizational process as in A_20603</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21322-a_21322-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21322">A_21322</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21322" severity="MUSS" class="target-element">
<p><b>A_21322 - Authenticator-Modul: Sichere Speicherung des &ldquo;SSO-TOKEN&rdquo;</b></p>
<p>Das Authenticator-Modul MUSS empfangene SSO-Token gegen unberechtigten Zugriff schützen.<span id="polarion-comment:797"></span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-19-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:19</code></h4>

<p>Storage implementation uses iOS Keychain</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_4#3] Implementation of data storage that is persisted via keychain
// [REQ:BSI-eRp-ePA:O.Source_7#2,O.Data_2#2,O.Auth_13#3] Implementation of data storage that is persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21323-a_21323-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21323">A_21323</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21323" severity="MUSS" class="target-element">
<p><b>A_21323 - Erzeugung des &ldquo;Token-Key&rdquo;</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> vor dem Abrufen von <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ID_TOKEN</span> und <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ACCESS_TOKEN</span> einen zufälligen 256 Bit AES-Schlüssel (&ldquo;Token-Key“) erzeugen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-185-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:185</code></h4>

<p>Crypto box contains <code>Token-Key</code></p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20529-01#2|6] Encrypting the `KEY_VERIFIER`
// [REQ:gemSpec_IDP_Frontend:A_21323,A_21324#1|6] Crypto box contains `Token-Key`
guard let encryptedKeyVerifier = try? KeyVerifier(
    codeVerifier: challengeSession.verifierCode
).encrypted(with: document.encryptionPublicKey, using: self.cryptoBox) else {
    return Fail(error: IDPError.encryption).eraseToAnyPublisher()
}

</code></pre>
<h4 id='code-sources-idp-internal-tokenpayload-swift-169-code' class='heading'><code>../Sources/IDP/internal/TokenPayload.swift:169</code></h4>

<p>Encode into JSON object</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21323#2] Encode into JSON object
// [REQ:gemSpec_IDP_Frontend:A_21324#3] Encode into JSON object
guard let keyVerifierEncoded = try? KeyVerifier.jsonEncoder.encode(self) else {

</code></pre>
<h4 id='code-sources-idp-internal-idpcrypto-swift-57-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:57</code></h4>

<p>AES key generation via CryptoKit</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:1] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#3] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
// [REQ:gemSpec_IDP_Frontend:A_21323#4] AES key generation via CryptoKit
aesKey: SymmetricKey = SymmetricKey(size: SymmetricKeySize(bitCount: 256))

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21324-a_21324-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21324">A_21324</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21324" severity="MUSS" class="target-element">
<p><b>A_21324 - Erzeugen des &quot;KEY_VERIFIER&rdquo;</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> dem <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">KEY_VERIFIER</span> bilden, indem &ldquo;Token-Key&rdquo; und <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">CODE_VERIFIER</span> in einem JSON-Objekt kodiert werden.<br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Token-key and code-verifier are encoded into an JSON object.</p>
<h4 id='code-sources-idp-defaultidpsession-swift-185-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:185</code></h4>

<p>Crypto box contains <code>Token-Key</code></p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20529-01#2|6] Encrypting the `KEY_VERIFIER`
// [REQ:gemSpec_IDP_Frontend:A_21323,A_21324#1|6] Crypto box contains `Token-Key`
guard let encryptedKeyVerifier = try? KeyVerifier(
    codeVerifier: challengeSession.verifierCode
).encrypted(with: document.encryptionPublicKey, using: self.cryptoBox) else {
    return Fail(error: IDPError.encryption).eraseToAnyPublisher()
}

</code></pre>
<h4 id='code-sources-idp-internal-tokenpayload-swift-140-code' class='heading'><code>../Sources/IDP/internal/TokenPayload.swift:140</code></h4>

<p>Token-key and code-verifier are encoded into KeyVerifier.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21324#2] Token-key and code-verifier are encoded into KeyVerifier.
public struct KeyVerifier: Codable {

</code></pre>
<h4 id='code-sources-idp-internal-tokenpayload-swift-170-code' class='heading'><code>../Sources/IDP/internal/TokenPayload.swift:170</code></h4>

<p>Encode into JSON object</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21323#2] Encode into JSON object
// [REQ:gemSpec_IDP_Frontend:A_21324#3] Encode into JSON object
guard let keyVerifierEncoded = try? KeyVerifier.jsonEncoder.encode(self) else {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21325-a_21325-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21325">A_21325</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21325" severity="MUSS" class="target-element">
<p><b>A_21325 - Verschlüsselte Übertragung zum Fachdienst</b></p>
<p>Das Anwendungsfrontend MUSS den entschlüsselten <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ACCESS_TOKEN</span>, zusätzlich zur Übertragung mittels TLS, auf Anwendungsebene verschlüsselt zum Fachdienst übertragen.  <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>AccessToken is encyrpted for each network request to the Fachdienst via VAUClient module.</p>
<h4 id='code-sources-idp-idpinterceptor-swift-56-code' class='heading'><code>../Sources/IDP/IDPInterceptor.swift:56</code></h4>

<p>Setup <code>Authorization-Header</code>.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20602#2,A_21325#1] Setup `Authorization-Header`.
request.setValue("\(token.tokenType) \(token.accessToken)", forHTTPHeaderField: "Authorization")

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-86-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:86</code></h4>

<p>Encryption of accessToken (here bearerToken)</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21325#2] Encryption of accessToken (here bearerToken)
func encrypt() throws -&gt; Data {

</code></pre>
<h4 id='code-sources-erpapp-session-standardsessioncontainer-swift-358-code' class='heading'><code>../Sources/eRpApp/Session/StandardSessionContainer.swift:358</code></h4>

<p>Interceptor order defines what is encrypted via VAU</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21325#2] Interceptor order defines what is encrypted via VAU
let interceptors: [Interceptor] = [

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21326-a_21326-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21326">A_21326</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21326" severity="MUSS" class="target-element">
<p><b>A_21326 - Löschung von &ldquo;ACCESS_TOKEN&rdquo;</b></p>
<p>Das Anwendungsfrontend  MUSS <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ACCESS_TOKEN</span> beim Beenden sowie nach Ablauf ihrer Gültigkeit sicher löschen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>ACCESS_TOKEN information is managed by IDPToken structure. See <a href="#OPlat_12">O.Plat_12</a> regarding secure deletion.</p>
<h4 id='code-sources-idp-models-idptoken-swift-12-code' class='heading'><code>../Sources/IDP/Models/IDPToken.swift:12</code></h4>

<p>Structure holding ACCESS_TOKEN and ID_TOKEN information</p>
<pre class="highlight plaintext"><code>/// IDPToken
///
/// [REQ:gemSpec_IDP_Frontend:A_21326#2,A_21327#2] Structure holding ACCESS_TOKEN and ID_TOKEN information
public struct IDPToken: Codable {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-99-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:99</code></h4>

<p>Triggered at every app start, profile change, pull to refresh</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21326#3,A_21327#3] Triggered at every app start, profile change, pull to refresh
autoRefreshedToken.map { token in

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-775-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:775</code></h4>

<p>Triggered at every app start, profile change, pull to refresh</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21326#4,A_21327#4] Triggered at every app start, profile change, pull to refresh
func refreshIfExpired(session: DefaultIDPSession,

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-787-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:787</code></h4>

<p>Either return a refreshed IDPToken</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21326#5,A_21327#5] Either return a refreshed IDPToken
//  (or nil in case of error) to overwrite the current one
guard let session = session else {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21327-a_21327-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21327">A_21327</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21327" severity="MUSS" class="target-element">
<p><b>A_21327 - Löschung von &ldquo;ID_TOKEN&rdquo;</b></p>
<p>Das Anwendungsfrontend  MUSS <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ID_TOKEN</span> beim Beenden sowie nach Ablauf ihrer Gültigkeit sicher löschen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>ID_TOKEN information is managed by IDPToken structure. See <a href="#OPlat_12">O.Plat_12</a> regarding secure deletion.</p>
<h4 id='code-sources-idp-models-idptoken-swift-12-code' class='heading'><code>../Sources/IDP/Models/IDPToken.swift:12</code></h4>

<p>Structure holding ACCESS_TOKEN and ID_TOKEN information</p>
<pre class="highlight plaintext"><code>/// IDPToken
///
/// [REQ:gemSpec_IDP_Frontend:A_21326#2,A_21327#2] Structure holding ACCESS_TOKEN and ID_TOKEN information
public struct IDPToken: Codable {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-99-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:99</code></h4>

<p>Triggered at every app start, profile change, pull to refresh</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21326#3,A_21327#3] Triggered at every app start, profile change, pull to refresh
autoRefreshedToken.map { token in

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-775-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:775</code></h4>

<p>Triggered at every app start, profile change, pull to refresh</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21326#4,A_21327#4] Triggered at every app start, profile change, pull to refresh
func refreshIfExpired(session: DefaultIDPSession,

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-787-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:787</code></h4>

<p>Either return a refreshed IDPToken</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21326#5,A_21327#5] Either return a refreshed IDPToken
//  (or nil in case of error) to overwrite the current one
guard let session = session else {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21328-a_21328-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21328">A_21328</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21328" severity="MUSS" class="target-element">
<p><b>A_21328 - Sichere Speicherung der Token</b></p>
<p>Das Anwendungsfrontend  MUSS empfangene <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ID_TOKEN</span> und <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ACCESS_TOKEN</span> gegen unberechtigten Zugriff schützen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Keychain storage encrypts session tokens.</p>
<h4 id='code-sources-erpapp-session-standardsessioncontainer-swift-90-code' class='heading'><code>../Sources/eRpApp/Session/StandardSessionContainer.swift:90</code></h4>

<p>Keychain storage encrypts session tokens</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21328#2] Keychain storage encrypts session tokens
// [REQ:gemSpec_eRp_FdV:A_20184] Keychain storage encrypts session/ssl tokens
storage: secureUserStore,

</code></pre>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-124-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:124</code></h4>

<p>KeychainStorage implementation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20184]
// [REQ:gemSpec_IDP_Frontend:A_21328#3] KeychainStorage implementation
let success: Bool

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21414-a_21414-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21414">A_21414</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21414" severity="MUSS" class="target-element">
<p><b>A_21414 - Authenticator-Modul: Umschlüsselung des &ldquo;ACCESS_TOKEN&rdquo; für Pairing-Endpunkt</b></p>
<p>Das Authenticator-Modul MUSS das zur Autorisierung und Authentifizierung des Nutzers verwendete <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">ACCESS_TOKEN </span>mit dem öffentlichen Schlüssel <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">PuK_IDP_ENC</span> aus dem Discovery Document verschlüsseln.<br> Dazu muss es vorher unter Verwendung des &ldquo;Token-Key&rdquo;, der dem Token-Endpunkt übermittelt wurde, entschlüsselt werden.<br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-323-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:323</code></h4>

<p>Encrypt ACCESS_TOKEN when requesting the pairing endpoint</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21414] Encrypt ACCESS_TOKEN when requesting the pairing endpoint
guard let tokenJWT = try? JWT(from: token.accessToken),

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21416-a_21416-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21416">A_21416</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21416" severity="MUSS" class="target-element">
<p><b>A_21416 - Authenticator-Modul: Einleiten der Registrierung</b></p>
<p>Das Authenticator-Modul MUSS Registrierungsdaten in Form eines &ldquo;Registration_Data&rdquo;-Objekts produzieren und diese mit dem <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">PuK_IDP_ENC</span> aus dem Discovery Document verschlüsseln. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-317-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:317</code></h4>

<p>Encryption</p>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21416] Encryption
guard let jwe = try? registrationData.encrypted(with: document.encryptionPublicKey,

</code></pre>
<h4 id='code-sources-idp-models-registrationdata-swift-14-code' class='heading'><code>../Sources/IDP/Models/RegistrationData.swift:14</code></h4>

<p>Data Structure</p>
<pre class="highlight plaintext"><code>/// Bundles data needed for creating and verifiying a pairing.
/// [REQ:gemSpec_IDP_Dienst:A_21415:Registration_Data]
/// [REQ:gemSpec_IDP_Frontend:A_21416] Data Structure
public struct RegistrationData: Claims, Codable {

</code></pre>
<h4 id='code-sources-idp-models-registrationdata-swift-105-code' class='heading'><code>../Sources/IDP/Models/RegistrationData.swift:105</code></h4>

<p>Encryption</p>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Dienst:A_21415:Encrypted_Registration_Data] Returns JWE encrypted Registration_Data
/// [REQ:gemSpec_IDP_Frontend:A_21416] Encryption
func encrypted(with publicKey: BrainpoolP256r1.KeyExchange.PublicKey,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21431-a_21431-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21431">A_21431</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21431" severity="MUSS" class="target-element">
<p><b>A_21431 - Authenticator-Modul: Übermittelung von Authentifizierungsdaten zur Verwendung von alternativen Authentisierungsmitteln</b></p>
<p>Das Authenticator-Modul MUSS die produzierte Signed_Authentication_Data-Struktur mit dem <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">PuK_IDP_ENC</span> aus dem Discovery Document verschlüsseln und an den Authorization-Endpunkt als Antwort auf die vom Authorization-Endpunkt empfangene Challenge übermitteln. Der Wert des Header-Claims <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">exp</span> der hierbei produzierten &ldquo;Encrypted_Authentication_Data&rdquo;-Struktur MUSS hierbei identisch mit dem gleichnamigen Claim aus den Body-Claims des empfangenen Challenge-Token belegt werden. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-397-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:397</code></h4>

<p>Encryption</p>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21431] Encryption
guard let jwe = try? signedChallenge.encrypted(with: document.encryptionPublicKey,

</code></pre>
<h4 id='code-sources-idp-models-signedauthenticationdata-swift-35-code' class='heading'><code>../Sources/IDP/Models/SignedAuthenticationData.swift:35</code></h4>

<p>exp header</p>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21431] exp header
expiry: originalChallenge.challenge.exp,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21443-a_21443-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21443">A_21443</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21443" severity="MUSS" class="target-element">
<p><b>A_21443 - Inspektions- und Deregistrierungsfunktion des IdP-Dienstes: Verschlüsselung des ACCESS_TOKEN</b></p>
<p>Das zur Authentifizierung des Nutzers und Autorisierung des Authenticator-Moduls verwendete ACCESS_TOKEN MUSS vom Authenticator-Modul mit dem öffentlichen Schlüssel PuK_IDP_Enc aus dem Discovery Document verschlüsselt werden.<br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-348-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:348</code></h4>

<p>Encrypt ACCESS_TOKEN when requesting the unregister endpoint</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21443] Encrypt ACCESS_TOKEN when requesting the unregister endpoint
guard let tokenJWT = try? JWT(from: token.accessToken),

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-372-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:372</code></h4>

<p>Encrypt ACCESS_TOKEN when requesting the list endpoint</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21443] Encrypt ACCESS_TOKEN when requesting the list endpoint
guard let tokenJWT = try? JWT(from: token.accessToken),

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21574-a_21574-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21574">A_21574</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21574" severity="MUSS" class="target-element">
<p><b>A_21574 - Warnhinweise an den Nutzer</b></p>
<p>Das Authenticator-Modul MUSS dem Nutzer Warnhinweise geben, dass die Sicherheit des Verfahrens bei der Verwendung von Folgendem beeinträchtigt werden kann: 
</p>
<ul>
<li>Geräten, bei denen ein sog. &ldquo;Rooten&rdquo; oder ein &ldquo;Jailbreak&rdquo; vollzogen wurde.</li>
<li>Installationen, bei denen es sich um Simulationsumgebungen der eigentlichen Zielplattform handelt.</li>
<li>Geräten, die gemeinschaftlich verwendet werden.</li>
<li>Geräten, die einem Mobile-Device-Management unterliegen, z. B. bei Dienstgeräten im Rahmen von COPE (&ldquo;Corporate Owned, Personally Enabled&rdquo;)-Lösungen.</li>
<li>Installationen innerhalb von Containerlösungen auf Mobilgeräten zur Abschottung von Unternehmensanwendungen im Rahmen von BYOD (&ldquo;Bring-Your-Own-Device&rdquo;)-Lösungen.</li>
</ul>Der Nutzer MUSS diese Aussage zur Kenntnis nehmen und diesen Umstand über die Benutzeroberfläche bestätigen. Im Fall der Ablehnung durch den Nutzer DARF das Authenticator-Modul die Verwendung von alternativen Authentisierungsmitteln NICHT anbieten. Das Authenticator-Modul MUSS bei einer technischen Detektion von solchen Umständen auf das Anbieten der Verwendung von alternativen Authentisierungsmitteln verzichten. Es MUSS den Nutzer dann über die Gründe des Wegfallens der Option zur Verwendung von alternativen Authentisierungsmitteln aufklären. <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-cardwall-login-cardwallloginoptiondomain-swift-101-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/Login/CardWallLoginOptionDomain.swift:101</code></h4>

<p>Present user information</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21574] Present user information
return Effect.send(.presentSecurityWarning)

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-login-cardwallloginoptionview-swift-94-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/Login/CardWallLoginOptionView.swift:94</code></h4>

<p>Actual view</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21574] Actual view
// [REQ:BSI-eRp-ePA:O.Resi_1#3] View containing information regarding the login options.
struct PrivacyWarningViewContainer: View {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21576-a_21576-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21576">A_21576</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21576" severity="MUSS" class="target-element">
<p><b>A_21576 - Löschung bestehender alternativer Authentisierungsmittel</b></p>
<p>Sofern für das verwendete Gerät und Nutzer bereits ein alternatives Authentisierungsmittel registriert ist, MUSS das Authenticator-Modul den Nutzer zur Deregistrierung der Pairing-Daten auffordern. Der Nutzer MUSS jederzeit die Möglichkeit haben, ein von ihm registriertes alternatives Authentisierungsmittel zu erneuern. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-341-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:341</code></h4>

<p>deletion call</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21576] deletion call
public func unregisterDevice(_ keyIdentifier: String, token: IDPToken) -&gt; AnyPublisher&lt;Bool, IDPError&gt; {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21578-a_21578-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21578">A_21578</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21578" severity="MUSS" class="target-element">
<p><b>A_21578 - Sicherstellung des Vorliegens einer geeigneten Umgebung zur Speicherung von biometrischen Referenzmerkmalen</b></p>
<p>Das Authenticator-Modul SOLL prüfen, ob biometrische Referenzmerkmale oder wissensbasierte Faktoren auf dem Gerät in einer gesicherten Umgebung gespeichert werden. Hierzu MÜSSEN über Betriebssystem-APIs bereitgestellte Informationen ausgewertet werden. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>iOS only allows Biometric access via secure enclave or higher order apis.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-145-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:145</code></h4>

<p>Enforced via access attribute</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21578,A_21579,A_21580,A_21583] Enforced via access attribute
kSecAttrTokenID as String: kSecAttrTokenIDSecureEnclave,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21579-a_21579-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21579">A_21579</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21579" severity="MUSS" class="target-element">
<p><b>A_21579 - Sicherstellung des Vorliegens einer geeigneten Umgebung für Schlüsselerzeugung, Anwendung und Speicherung</b></p>
<p>Das Authenticator-Modul MUSS sicherstellen, dass die Erzeugung des Schlüsselpaares PrK_SE_AUT/PuK_SE_AUT, dessen Speicherung, Anwendung und die Löschung des PrK_SE_AUT ausschließlich durch eine gesonderte, vertrauenswürdige Ausführungsumgebung erfolgt, die 
</p>
<ul>
<li><span style="font-weight: normal;">den Zugriff auf den PrK_SE_AUT als Datenobjekt pauschal allen Anwendungen entzieht (hierbei eingeschlossen sind Geräte-Backups). </span></li>
<li><span style="font-weight: normal;">die die Anwendung des Schlüssels auf Daten zum Zweck der Signaturbildung auf das Authenticator-Modul und denjenigen am Gerät authentifizierten Nutzer beschränkt, der den Schlüssel PrK_SE_AUT erzeugt hat.</span></li>
</ul>
<span style="font-weight: normal;">Das Authenticator-Modul MUSS bei Verfügbarkeit einer auf Hardware-Ebene realisierten Absonderung der oben genannten Ausführungsumgebung diese zwingend nutzen. Eine reine auf Software-basierte Implementierung DARF NICHT verwendet werden. Hierzu MÜSSEN über Betriebssystem-APIs bereitgestellte Informationen ausgewertet werden.</span> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-privatekeycontainer-swift-145-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:145</code></h4>

<p>Enforced via access attribute</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21578,A_21579,A_21580,A_21583] Enforced via access attribute
kSecAttrTokenID as String: kSecAttrTokenIDSecureEnclave,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21580-a_21580-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21580">A_21580</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21580" severity="MUSS" class="target-element">
<p><b>A_21580 - Ausschluss von Eigenimplementierungen zur Schlüsselverwaltung</b></p>
<p>Das Authenticator-Modul MUSS für die Schlüsselerzeugung des Schlüsselpaars PuK_SE_AUT/PrK_SE_AUT Mechanismen des Geräts verwenden. Es DARF kryptographische Schlüssel NICHT selbst erzeugen, innerhalb des ihm zur Verfügung stehenden Speicherbereichs speichern oder auf Daten anwenden.  <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-privatekeycontainer-swift-145-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:145</code></h4>

<p>Enforced via access attribute</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21578,A_21579,A_21580,A_21583] Enforced via access attribute
kSecAttrTokenID as String: kSecAttrTokenIDSecureEnclave,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21581-a_21581-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21581">A_21581</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21581" severity="MUSS" class="target-element">
<p><b>A_21581 - Verfügbarkeit von kryptographischen Algorithmen</b></p>
<p>Das Authenticator-Modul MUSS sicherstellen, dass die in der folgenden Tabelle genannten Algorithmen zur Anwendung des PrK_SE_AUT zur Verfügung stehen:<br> </p>
<p data-keep-next="true" class="polarion-rte-caption-paragraph" style="text-align: left;" id="polarion___2">Tabelle <span data-sequence="Tabelle" class="polarion-rte-caption">3</span>: Kryptographische Verfahren</p>
<table id="polarion_wiki macro name=table;params=width=100%|uid=676" class="polarion-Document-table" style="width: 100%;margin-left: auto;margin-right: auto;border: 1px solid #CCCCCC;empty-cells: show;border-collapse: collapse;">
<tbody>
<tr>
<th style="font-weight: bold;background-color: #F0F0F0;text-align: left;vertical-align: top;width: 76px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Schema</th>
<th style="font-weight: bold;background-color: #F0F0F0;text-align: left;vertical-align: top;width: 390px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Algorithmus</th>
<th style="font-weight: bold;background-color: #F0F0F0;text-align: left;vertical-align: top;width: 103px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Schlüssel</th>
</tr>
<tr>
<td style="text-align: left;vertical-align: top;width: 76px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Signatur</td>
<td style="text-align: left;vertical-align: top;width: 390px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">ECDSA auf Basis der Kurve P-256 und SHA-256</td>
<td style="text-align: left;vertical-align: top;width: 103px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">PrK_SE_AUT</td>
</tr>
</tbody>
</table> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-privatekeycontainer-swift-141-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:141</code></h4>

<p>Algorithm selection</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21581,A_21589] Algorithm selection
kSecAttrKeyType as String: kSecAttrKeyTypeECSECPrimeRandom,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21582-a_21582-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21582">A_21582</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21582" severity="MUSS" class="target-element">
<p><b>A_21582 - Lokale Authentisierung des Nutzers vor Anwendung des PrK_SE_AUT zur Authentisierung</b></p>
<p>Das Authenticator-Modul MUSS dem Nutzer die Wahl einer lokal verfügbaren Authentisierungsmethode überlassen, die zur autorisierten Anwendung des PrK_SE_AUT verwendet wird, das Authenticator-Modul  
</p>
<ul>
<li>MUSS hierbei auf dem Gerät bereits unter dem Nutzeraccount registrierte Mittel anbieten. Der Nutzer MUSS hierbei eine Auswahl treffen können,</li>
<li>MUSS dem Benutzer hierbei mindestens eine pauschale Gruppierung in biometrische oder wissensbasierte Faktoren anbieten. Zugelassen sind die in der folgenden Tabelle genannten Mittel,</li>
<li>DARF den Nutzer zur Anlage solcher Mittel auffordern.</li>
</ul>Das Authenticator-Modul MUSS den Nutzer über spezifische Schwächen seiner Wahl aufklären (z. B. solcher in Verbindung mit der Anwendung von Mustern) und ggf. Hinweise zu einer geeigneten Verwendung geben. Das Authenticator-Modul MUSS in den Parametern, die dem Betriebssystem zur Schlüsselerzeugung gesetzt werden, festlegen,<br> 
<ul>
<li>auf Basis welcher der vom Nutzer gewählten Mittel die Anwendung des Schlüssels PrK_SE_AUT auf Daten durch den Nutzer autorisiert wird,</li>
<li>dass die Anwendung des Schlüssels PrK_SE_AUT auf den zum Zeitpunkt der Erzeugung verwendeten Nutzeraccount beschränkt ist.</li>
</ul>
<p style="text-align: left;" class="polarion-rte-caption-paragraph" data-keep-next="true" id="polarion___3">Tabelle <span class="polarion-rte-caption" data-sequence="Tabelle">4</span>: Zugelassene, lokale Authentisierungsmittel</p>
<table style="width: 100%;margin-left: auto;margin-right: auto;border: 1px solid #CCCCCC;empty-cells: show;border-collapse: collapse;" class="polarion-Document-table" id="polarion_wiki macro name=table;params=width=100%|uid=681">
<tbody>
<tr>
<th style="font-weight: bold;background-color: #F0F0F0;text-align: left;vertical-align: top;width: 141px;height: 35px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Art</th>
<th style="font-weight: bold;background-color: #F0F0F0;text-align: left;vertical-align: top;width: 391px;height: 35px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Faktor</th>
<th style="font-weight: bold;background-color: #F0F0F0;text-align: left;vertical-align: top;width: 188px;height: 35px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Zugelassen:</th>
</tr>
<tr>
<td style="text-align: left;vertical-align: top;width: 141px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;" rowspan="4" colspan="1">biometrisch</td>
<td style="text-align: left;vertical-align: top;width: 391px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Finger</td>
<td style="text-align: left;vertical-align: top;width: 188px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">ja</td>
</tr>
<tr>
<td style="text-align: left;vertical-align: top;width: 391px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Stimme</td>
<td style="text-align: left;vertical-align: top;width: 188px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">ja</td>
</tr>
<tr>
<td style="text-align: left;vertical-align: top;width: 391px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Gesicht</td>
<td style="text-align: left;vertical-align: top;width: 188px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">ja</td>
</tr>
<tr>
<td style="text-align: left;vertical-align: top;width: 391px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Iris</td>
<td style="text-align: left;vertical-align: top;width: 188px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">ja</td>
</tr>
<tr>
<td style="text-align: left;vertical-align: top;width: 141px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;" rowspan="3" colspan="1">wissensbasiert</td>
<td style="text-align: left;vertical-align: top;width: 391px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">PIN</td>
<td style="text-align: left;vertical-align: top;width: 188px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">ja</td>
</tr>
<tr>
<td style="text-align: left;vertical-align: top;width: 391px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Passwort</td>
<td style="text-align: left;vertical-align: top;width: 188px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">ja</td>
</tr>
<tr>
<td style="text-align: left;vertical-align: top;width: 391px;height: 20px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Muster</td>
<td style="text-align: left;vertical-align: top;width: 188px;height: 20px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">ja</td>
</tr>
<tr>
<td style="text-align: left;vertical-align: top;width: 141px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;" rowspan="4" colspan="1">Präsenz</td>
<td style="text-align: left;vertical-align: top;width: 391px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Wischen</td>
<td style="text-align: left;vertical-align: top;width: 188px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">nein</td>
</tr>
<tr>
<td style="text-align: left;vertical-align: top;width: 391px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Kopplung mit einer Uhr</td>
<td style="text-align: left;vertical-align: top;width: 188px;height: 19px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">nein</td>
</tr>
<tr>
<td style="text-align: left;vertical-align: top;width: 391px;height: 26px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Knopfdruck</td>
<td style="text-align: left;vertical-align: top;width: 188px;height: 26px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">nein</td>
</tr>
<tr>
<td style="text-align: left;vertical-align: top;width: 391px;height: 21px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">Körpersensoren</td>
<td style="text-align: left;vertical-align: top;width: 188px;height: 21px;border: 1px solid #CCCCCC;border-top: 1px solid #CCCCCC;border-bottom: 1px solid #CCCCCC;border-right: 1px solid #CCCCCC;border-left: 1px solid #CCCCCC;padding: 5px;">nein</td>
</tr>
</tbody>
</table> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-privatekeycontainer-swift-128-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:128</code></h4>

<p>method selection</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21582] method selection
// [REQ:gemSpec_IDP_Frontend:A_21587] via `.privateKeyUsage`
[.privateKeyUsage,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21583-a_21583-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21583">A_21583</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21583" severity="MUSS" class="target-element">
<p><b>A_21583 - Qualitative Anforderungen an lokale Authentisierungsmittel</b></p>
<p>Das Authenticator-Modul MUSS sicherherstellen, dass die von Gerät und Hardware realisierten Mechanismen zur biometrischen Authentisierung bzw. Authentifizierung von ausreichender Qualität sind.  <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Secure Enclave is enforced with code attributes.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-145-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:145</code></h4>

<p>Enforced via access attribute</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21578,A_21579,A_21580,A_21583] Enforced via access attribute
kSecAttrTokenID as String: kSecAttrTokenIDSecureEnclave,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21584-a_21584-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21584">A_21584</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21584" severity="MUSS" class="target-element">
<p><b>A_21584 - Verwendung von Geräte-eigenen Mechanismen zur Authentisierung des Nutzers</b></p>
<p>Das Authenticator-Modul MUSS sich zur Implementierung der Authentifizierungsverfahren zur autorisierten Anwendung des PrK_SE_AUT auf diejenigen Mechanismen beschränken, die durch die Kombination von Betriebssystem und Hardware zur Verfügung gestellt werden. Das Authenticator-Modul DARF hierbei ausschließlich die vom Betriebssystem zur Verfügung gestellte Information über eine erfolgreiche oder nicht-erfolgreiche Authentifizierung und deren Art verarbeiten. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>There is no API to allow or disallow an biometric authentication, iOS is handling the authorization process while using the private key for any cryptographic operation.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-236-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:236</code></h4>

<p>private key usage triggers biometric unlock</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21584] private key usage triggers biometric unlock
guard let signature = SecKeyCreateSignature(privateKey,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21585-a_21585-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21585">A_21585</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21585" severity="MUSS" class="target-element">
<p><b>A_21585 - Beschränkung der Nutzung des PrK_SE_AUT auf das Authenticator-Modul</b></p>
<p>Das Authenticator-Modul MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> die Parameter für die Erzeugung des Schlüsselpaars PrK_SE_AUT/PuK_SE_AUT so setzen, dass sichergestellt ist, dass der Schlüssel PrK_SE_AUT ausschließlich über das Authenticator-Modul auf Daten anwendbar ist. Eine App-übergreifende Nutzung MUSS ausgeschlossen werden. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Default behavior for all apps when using private access group (https://developer.apple.com/documentation/security/keychain_services/keychain_items/sharing_access_to_keychain_items_among_a_collection_of_apps)</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21586-a_21586-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21586">A_21586</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21586" severity="MUSS" class="target-element">
<p><b>A_21586 - Löschung des PrK_SE_AUT als Reaktion auf Systemereignisse</b></p>
<p>Das Authenticator-Modul MUSS bei der Übergabe des Kommandos zur Schlüsselerzeugung an das Betriebssystem in den Parametern festlegen, dass bei folgenden Systemereignissen der private Schlüssel PrK_SE_AUT nicht mehr verwendbar ist: 
</p>
<ul>
<li>Löschung des lokalen Geräte-Accounts, innerhalb dessen der PrK_SE_AUT erzeugt wurde. </li>
<li>Setzen von schwachen Authentifizierungsmethoden oder entfernen von Authentifizierungsmethoden des Geräte-Accounts.</li>
<li>Reset des Gerätes oder Deinstallation von Betriebssystem-Updates.</li>
<li>Re-Enrolment oder Löschung von biometrischen Referenzmerkmalen.</li>
</ul> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>iOS will delete all user related data after user-account reset. Key-Chain data is not being synced with iCloud since <code>kSecAttrSynchronizable</code> is not applied</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-125-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:125</code></h4>

<p>prevents migration to other devices</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21586] prevents migration to other devices
// [REQ:BSI-eRp-ePA:O.Data_15#2] prevents migration to other devices
kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly,

</code></pre>
<h4 id='code-sources-idp-privatekeycontainer-swift-132-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:132</code></h4>

<p>invalidates biometry after changes</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21586] invalidates biometry after changes
// [REQ:BSI-eRp-ePA:O.Auth_5#2] Key invalidates on changes of registered
// biometric features
.biometryCurrentSet], &amp;error) else {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21587-a_21587-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21587">A_21587</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21587" severity="MUSS" class="target-element">
<p><b>A_21587 - Beschränkung des PrK_SE_AUT auf Signaturbildung</b></p>
<p>Das Authenticator-Modul MUSS die Parameter für die Erzeugung des Schlüsselpaars PrK_SE_AUT/PuK_SE_AUT so setzen, dass sichergestellt ist, dass der Schlüssel PrK_SE_AUT ausschließlich zum Zweck der Signaturbildung auf Daten angewendet werden kann.  <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-privatekeycontainer-swift-129-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:129</code></h4>

<p>via <code>.privateKeyUsage</code></p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21582] method selection
// [REQ:gemSpec_IDP_Frontend:A_21587] via `.privateKeyUsage`
[.privateKeyUsage,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21588-a_21588-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21588">A_21588</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21588" severity="MUSS" class="target-element">
<p><b>A_21588 - Erzeugung eines Key-Identifiers für das Schlüsselpaar PrK_SE_AUT/PuK_SE_AUT gegenüber dem IdP-Dienst</b></p>
<p>Das Authenticator-Modul MUSS einen Key-Identifier zur Identifikation des Schlüsselpaars PrK_SE_AUT/PuK_SE_AUT gegenüber dem IdP-Dienst erzeugen. Der Key-Identifier MUSS so erzeugt werden, dass die Erzeugung ein und desselben Identifiers über verschiedene Geräte eines Nutzers mit hoher Wahrscheinlichkeit ausgeschlossen ist. Der Key-Identifier MUSS zufällig erzeugt werden. Er DARF NICHT aus Nutzer- oder Gerätedaten abgeleitet werden. Der zum IdP-Dienst übertragene Key-Identifier MUSS eine Länge von 32 Byte besitzen. Der Wert KANN zur Referenzierung des PrK_SE_AUT im lokalen Schlüsselspeicher verwendet werden. Der Key-Identifier selbst oder ein Datenobjekt, aus dem er abgeleitet werden kann, MUSS auf dem Endgerät gespeichert werden. Der Key-Identifier selbst oder das Datenobjekt MUSS gegen Löschung und anwendungsübergreifende Verwendung geschützt sein. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-13-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:13</code></h4>

<p>key identfier generator, number of bytes 32</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21588] key identfier generator, number of bytes 32
keyIdentifierGenerator: @escaping (() throws -&gt; Data) = { try generateSecureRandom(length: 32) },

</code></pre>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-36-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:36</code></h4>

<p>Key generation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21588] Key generation
let keyIdentifier = try keyIdentifierGenerator()

</code></pre>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-101-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:101</code></h4>

<p>usage as base64 encoded string</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21588] usage as base64 encoded string
guard let someIdentifier = identifier,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21589-a_21589-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21589">A_21589</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21589" severity="MUSS" class="target-element">
<p><b>A_21589 - Erzeugung des Schlüsselpaars PrK_SE_AUT/PuK_SE_AUT</b></p>
<p><span style="font-weight: normal;">Das Authenticator-Modul MUSS ein Schlüsselpaar PrK_SE_AUT/PuK_SE_AUT erzeugen. Das Schlüsselpaar MUSS für die Anwendung des Algorithmus ECDSA auf Basis der Kurve P-256 geeignet sein. Das Authenticator-Modul MUSS hierbei über die Betriebssystem-APIs die in Abschnitt [gemSpec_IDP_Frontend#Parameter für die Schlüsselerzeugung und Auswahl eines Schlüsselspeichers]<br> beschriebenen Parameter zur Durchsetzung der dort genannten Anforderungen und die Schlüssel innerhalb des dort identifizierten Schlüsselspeichers setzen.</span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-privatekeycontainer-swift-141-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:141</code></h4>

<p>Algorithm selection</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21581,A_21589] Algorithm selection
kSecAttrKeyType as String: kSecAttrKeyTypeECSECPrimeRandom,

</code></pre>
<h4 id='code-sources-idp-privatekeycontainer-swift-143-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:143</code></h4>

<p>Key length</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21589] Key length
kSecAttrKeySizeInBits as String: 256,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21590-a_21590-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21590">A_21590</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21590" severity="MUSS" class="target-element">
<p><b>A_21590 - Beschränkung der Nutzung des PrK_SE_AUT auf Authentisierung gegenüber dem IdP-Dienst</b></p>
<p>Das Authenticator-Modul MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den Smartcard-IDP unterstützt,</span> den Schlüssel PrK_SE_AUT ausschließlich zum Zweck der Authentifizierung gegenüber dem IdP-Dienst verwenden. Es darf dem Nutzer keine andere Option anbieten oder den Schlüssel anderweitig verwenden. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>References of <code>SecureEnclaveSignatureProvider</code> is limited to registration and altVerify usage.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-18-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:18</code></h4>

<p>This is the container to represent biometric keys. Usage is limited to</p>
<pre class="highlight plaintext"><code>/// Represents a (SecureEnclave) private key, namely `PrK_SE_AUT`, secured by iOS Biometrics.
///
/// [REQ:gemSpec_IDP_Frontend:A_21590] This is the container to represent biometric keys. Usage is limited to
/// authorization purposes
/// [REQ:BSI-eRp-ePA:O.Cryp_7#2] Container for private key operations using secure enclave private keys
public struct PrivateKeyContainer {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21591-a_21591-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21591">A_21591</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21591" severity="MUSS" class="target-element">
<p><b>A_21591 - Erhebung von Geräteinformationen</b></p>
<p>Das Authenticator-Modul MUSS die folgenden Informationen über das verwendete Gerät über Betriebssystem-APIs erheben: 
</p>
<ul>
<li>Name des Herstellers,</li>
<li>Name des Produkts,</li>
<li>Name des Modells,</li>
<li>Name des Betriebssystems und</li>
<li>Version des Betriebssystems.</li>
</ul>Hierbei MUSS der Datentyp &ldquo;Device_Type&rdquo; gebildet werden. Die hier erhobenen Geräteinformationen MÜSSEN zusammen mit einem vom Nutzer für das Gerät vergebenen Namen zur Datenstruktur &ldquo;Device_Informationen&rdquo; kombiniert werden. <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-models-registrationdata-swift-57-code' class='heading'><code>../Sources/IDP/Models/RegistrationData.swift:57</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Dienst:A_21415:Device_Type]
/// [REQ:gemSpec_IDP_Frontend:A_21591]
public struct DeviceType: Codable {

</code></pre>
<h4 id='code-sources-idp-uidevice-extension-swift-10-code' class='heading'><code>../Sources/IDP/UIDevice+Extension.swift:10</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21591,A_21600]
func deviceInformation() -&gt; RegistrationData.DeviceInformation {

</code></pre>
<h4 id='code-sources-idp-uidevice-extension-swift-43-code' class='heading'><code>../Sources/IDP/UIDevice+Extension.swift:43</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21591,A_21600]
func deviceInformation() -&gt; RegistrationData.DeviceInformation {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21595-a_21595-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21595">A_21595</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21595" severity="MUSS" class="target-element">
<p><b>A_21595 - Lokale Speicherung des C.CH.AUT</b></p>
<p>Das Authenticator-Modul MUSS das Authentifizierungszertifikat C.CH.AUT nach erfolgreicher Registrierung für die Verwendung in weiteren Authentifizierungsvorgängen lokal auf dem Endgerät speichern. Die Speicherung MUSS so erfolgen, dass eine missbräuchliche Verwendung des Zertifikats durch andere Anwendungen in ausreichendem Maß verhindert wird. Das Authenticator-Modul DARF im Fall einer nicht erfolgreichen Registrierung das Authentifizierungszertifikat C.CH.AUT NICHT speichern. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-231-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:231</code></h4>

<p>Store within keychain</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21595] Store within keychain
success = try keychainHelper.setGenericPassword(keyIdentifier, for: idpBiometricKeyIdentifier)

</code></pre>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-51-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:51</code></h4>

<p>Store pairing data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595,A_21595] Store pairing data
certificateStorage.set(certificate: certificate)

</code></pre>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-72-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:72</code></h4>

<p>case deletion</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21595] case deletion
certificateStorage.set(certificate: nil)

</code></pre>
<h4 id='code-sources-idp-idpstorage-swift-12-code' class='heading'><code>../Sources/IDP/IDPStorage.swift:12</code></h4>

<p>Storage Protocol</p>
<pre class="highlight plaintext"><code>/// Interface to access an eGK Certificate that should be kept private
/// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Protocol
public protocol SecureEGKCertificateStorage {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-76-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:76</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-129-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:129</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-145-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:145</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)

</code></pre>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-20-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:20</code></h4>

<p>Storage Implementation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_4#3] Implementation of data storage that is persisted via keychain
// [REQ:BSI-eRp-ePA:O.Source_7#2,O.Data_2#2,O.Auth_13#3] Implementation of data storage that is persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {

</code></pre>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-204-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:204</code></h4>

<p>Store within keychain</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21595] Store within keychain
_ = try? keychainHelper.setGenericPassword(derBytes, for: egkAuthCertIdentifier)

</code></pre>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-51-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:51</code></h4>

<p>Store pairing data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595,A_21595] Store pairing data
certificateStorage.set(certificate: certificate)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21598-a_21598-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21598">A_21598</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21598" severity="MUSS" class="target-element">
<p><b>A_21598 - Löschung von lokalen Daten bei Fehlschlag</b></p>
<p>Das Authenticator-Modul MUSS bei fehlschlagender Registrierung alle lokal erzeugten Daten (einschließlich der erzeugten kryptographischen Schlüssel) über die Betriebssystem-APIs des Geräts löschen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-51-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:51</code></h4>

<p>Store pairing data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595,A_21595] Store pairing data
certificateStorage.set(certificate: certificate)

</code></pre>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-69-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:69</code></h4>

<p>Delete all stored keys/identifiers/certificate in case of an unsuccessful</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598] Delete all stored keys/identifiers/certificate in case of an unsuccessful
// registration
public func abort(pairingSession: PairingSession) throws {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-76-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:76</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-129-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:129</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-145-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:145</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21600-a_21600-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21600">A_21600</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21600" severity="MUSS" class="target-element">
<p><b>A_21600 - Einholen von aktuellen Geräteinformationen</b></p>
<p>Das Authenticator-Modul MUSS aktuelle Geräteinformationen über die Betriebssystem-APIs einholen und dabei eine Device-Information-Struktur wie in [gemSpec_IDP_Dienst} Abschnitt C beschrieben konstruieren.  <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-uidevice-extension-swift-10-code' class='heading'><code>../Sources/IDP/UIDevice+Extension.swift:10</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21591,A_21600]
func deviceInformation() -&gt; RegistrationData.DeviceInformation {

</code></pre>
<h4 id='code-sources-idp-uidevice-extension-swift-43-code' class='heading'><code>../Sources/IDP/UIDevice+Extension.swift:43</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21591,A_21600]
func deviceInformation() -&gt; RegistrationData.DeviceInformation {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_21603-a_21603-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_21603">A_21603</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21603" severity="MUSS" class="target-element">
<p><b>A_21603 - Ermöglichung der Löschung von alternativen Authentisierungsmitteln und lokal gespeicherten Daten</b></p>
<p><span style="font-weight: normal;">Das Authenticator-Modul MUSS dem Nutzer die Möglichkeit geben, lokal gespeicherte Daten dauerhaft zu löschen und über Betriebssystem-APIs des Geräts eine Löschung des PrK_SE_AUT auszulösen. Die Löschung MUSS eventuell vorhandene <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">SSO_TOKEN</span> mit einbeziehen.</span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-251-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:251</code></h4>

<p>Certificate</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21603] Certificate
set(certificate: nil)

</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-42-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:42</code></h4>

<p>Certificate</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-01#2] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_IDP_Frontend:A_21603] Certificate
// [REQ:BSI-eRp-ePA:O.Auth_14#4] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
storage.wipe()

</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-48-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:48</code></h4>

<p>key identifier</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21603] key identifier
storage.set(keyIdentifier: nil)

</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-55-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:55</code></h4>

<p>PrK_SE_AUT/PuK_SE_AUT</p>
<pre class="highlight plaintext"><code>// If deletion fails we cannot do anything
// [REQ:gemSpec_IDP_Frontend:A_21603] PrK_SE_AUT/PuK_SE_AUT
_ = try? PrivateKeyContainer.deleteExistingKey(for: identifier)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_22294-01-a_22294-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_22294-01">A_22294-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_22294-01" severity="MUSS" class="target-element">
<p><b>A_22294-01 - Ermöglichen der Nutzung von sektoralen Identity Providern zur Authentisierung</b></p>
<p>Das Anwendungsfrontend MUSS<span style="color: #000000;">, wenn es eine Authentifizierung über den sektoralen IDP unterstützt,</span> dem Nutzer die Option zur Verwendung von sektoralen Identity Providern zur Authentisierung ermöglichen. Hierzu müssen ihm die Namen &ldquo;idp_name&quot; der verfügbaren sektoralen Identity Provider, aus der zuvor heruntergeladenen Liste, in nachvollziehbarer Form auf der Benutzeroberfläche dargestellt und zur Auswahl angeboten werden.<span id="polarion-comment:883"></span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationdomain-swift-90-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationDomain.swift:90</code></h4>

<p>Start login via gID</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22294-01] Start login via gID
// [REQ:BSI-eRp-ePA:O.Auth_4#9,O.Plat_10#2] Start login via gID
return .publisher(

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthselectiondomain-swift-91-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthSelectionDomain.swift:91</code></h4>

<p>Select KK</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_4#6] Business logic of user selecting the insurance company
// [REQ:gemSpec_IDP_Frontend:A_22294-01] Select KK
state.selectedKK = entry

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_22295-01-a_22295-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_22295-01">A_22295-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_22295-01" severity="MUSS" class="target-element">
<p><b>A_22295-01 - Anfrage zur Authentisierung bei einem sektoralen Identity Provider beim IDP-Dienst</b></p>
<p><span style="color: #000000;">Das Anwendungsfrontend MUSS, wenn es eine Authentifizierung über den sektoralen IDP unterstützt, bei der Auswahl eines sektoralen Identity Provider durch den Nutzer einen Authorization Request an den Third-Party Authorization Endpoint (<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">idp_sek_2=false</span>) oder den Federation Authorization Endpoint (<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">idp_sek_2=true</span>) des IDP-Dienstes senden. Der Authorization Request entspricht der in [gemSpec_IDP_Dienst#7.1] genannten Form, aber MUSS um einen weiteren Parameter <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">idp_iss</span> ergänzt werden, dessen Wert dem Identifikator entspricht, welcher zum vom Benutzer ausgewählten Namen (<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">idp_name</span>) gehört. Das Frontend muss sich den Wert <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">idp_sek_2</span> zum Request speichern, um später die korrekte Zuordnung treffen zu können</span>.<span style="font-size: 10pt;line-height: 1.5;"><span id="polarion-comment:881"></span></span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-452-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:452</code></h4>

<p>Usage of kk_app_id</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22295-01] Usage of kk_app_id
let extAuth = IDPExtAuth(kkAppId: entry.identifier,

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-986-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:986</code></h4>

<p>Test</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22295-01] Test
// [REQ:gemSpec_IDP_Frontend:A_22299-01] Test
func testStartExtAuth() throws {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_22296-01-a_22296-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_22296-01">A_22296-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_22296-01" severity="MUSS" class="target-element">
<p><b>A_22296-01 - Einlesen und Prüfen der Liste der sektoralen Identity Provider</b></p>
<p>Das Anwendungsfrontend MUSS<span style="color: #000000;">, wenn es eine Authentifizierung über den sektoralen IDP unterstützt,</span> die Liste der bekannten alternativen Authentisierungsanwendungen unter der im Discovery Document des IDP-Dienstes unter &quot;kk_app_list_uri&rdquo; gefundenen Adresse beziehen und ihre Integrität prüfen.<br> <span title="Added">Das Anwendungsfrontend MUSS die Signatur des unter &ldquo;<span style="font-size: 10pt;line-height: 1.5;">fed_idp_list_uri&rdquo; heruntergeladenen JWS </span>mathematisch prüfen und auf ein zeitlich gültiges C.FD.SIG-Zertifikat mit der Rollen-OID <span style="font-style: italic;">&ldquo;</span><span style="font-style: normal;">oid_idpd</span><span style="font-style: italic;">&rdquo;</span> zurückführen, welches von einer dem Anwendungsfrontend bekannten CA der Komponenten-PKI ausgestellt wurde.<span id="polarion-comment:885"></span></span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-421-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:421</code></h4>

<p>Signature verification</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22296-01] Signature verification
// [REQ:gemSpec_IDP_Frontend:A_23082#3] Signature verification
// [REQ:BSI-eRp-ePA:O.Resi_6#3] Discovery Document signature verification
guard try jwtContainer.verify(with: document.discKey) == true else {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthselectiondomain-swift-72-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthSelectionDomain.swift:72</code></h4>

<p>Load available apps</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22296-01] Load available apps
// [REQ:gemSpec_IDP_Frontend:A_23082#2] Load available apps
return .publisher(

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-953-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:953</code></h4>

<p>Test</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22296-01] Test
// [REQ:gemSpec_IDP_Frontend:A_23082#4] Test
func testLoadDirectoryKKAppsInvalidSignature() throws {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_22299-01-a_22299-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_22299-01">A_22299-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_22299-01" severity="MUSS" class="target-element">
<p><b>A_22299-01 - Weiterleitung des Authorization Request an einen sektoralen Identity Provider</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den sektoralen IDP unterstützt, </span>den als Redirect erhaltenen Authorization Request des IDP-Dienstes an die in der target_url des redirect enthaltene URI weiterleiten und sich dabei den verwendeten <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">state</span> Parameter merken, um später erhaltene Antworten des sektoralen Identity Provider zuzuordnen.<span id="polarion-comment:880"></span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-469-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:469</code></h4>

<p>Remember State parameter for later verification</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22299-01] Remember State parameter for later verification
guard let components = URLComponents(url: redirectUrl, resolvingAgainstBaseURL: true),

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationdomain-swift-105-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationDomain.swift:105</code></h4>

<p>Follow redirect</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22299-01] Follow redirect
// [REQ:BSI-eRp-ePA:O.Plat_10#3] Follow redirect
guard environment.resourceHandler.canOpenURL(url) else {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-987-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:987</code></h4>

<p>Test</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22295-01] Test
// [REQ:gemSpec_IDP_Frontend:A_22299-01] Test
func testStartExtAuth() throws {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_22301-01-a_22301-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_22301-01">A_22301-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_22301-01" severity="MUSS" class="target-element">
<p><b>A_22301-01 - Annahme des Authorization Code über App2App-Kommunikation</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den sektoralen IDP unterstützt,</span> den Authorization Code AUTHORIZATION_CODE_IDP,  den <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">state</span> Parameter sowie den optionalen Parameter <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">kk_app_redirect_uri</span>, welche mittels App2App-Kommunikation vom Authenticator-Modul des sektoralen Identity Provider übergeben werden, akzeptieren, wenn der state mit dem Wert einer kürzlich vom IDP-Dienst erhaltenen Anfrage übereinstimmt.<span id="polarion-comment:878"></span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-scenedelegate-swift-227-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:227</code></h4>

<p>If app needs reauthentication routing starts here.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22301-01#2] If app needs reauthentication routing starts here.
self.routeTo(.universalLink(url))

</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-260-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:260</code></h4>

<p>If app is already started, routing starts here.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22301-01#3] If app is already started, routing starts here.
routeTo(.universalLink(url))

</code></pre>
<h4 id='code-sources-erpapp-screens-appstartdomain-swift-224-code' class='heading'><code>../Sources/eRpApp/Screens/AppStartDomain.swift:224</code></h4>

<p>App2App gID will trigger this case</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22301-01#4] App2App gID will trigger this case
case "/extauth":

</code></pre>
<h4 id='code-sources-erpapp-screens-appstartdomain-swift-234-code' class='heading'><code>../Sources/eRpApp/Screens/AppStartDomain.swift:234</code></h4>

<p>set actual destination in main tab</p>
<pre class="highlight plaintext"><code>// // [REQ:gemSpec_IDP_Frontend:A_22301-01#5] set actual destination in main tab
await send(.destination(.app(.main(action: .externalLogin(url)))))

</code></pre>
<h4 id='code-sources-erpapp-screens-main-maindomain-swift-258-code' class='heading'><code>../Sources/eRpApp/Screens/Main/MainDomain.swift:258</code></h4>

<p>Redirect into ExtAuthPendingDomain</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#7] redirect into correct domain
// [REQ:gemSpec_IDP_Frontend:A_22301-01#6|3] Redirect into ExtAuthPendingDomain
return .run { send in
}
case let .importTaskByUrl(url):
</code></pre>
<h4 id='code-sources-erpapp-screens-main-extauth-extauthpendingdomain-swift-157-code' class='heading'><code>../Sources/eRpApp/Screens/Main/ExtAuth/ExtAuthPendingDomain.swift:157</code></h4>

<p>Actual handling of the universal link, user feedback via dialogs e.g.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#8] Validate data by parsing url and only allowing predefined variables as String
// [REQ:gemSpec_IDP_Frontend:A_22301-01#7] Actual handling of the universal link, user feedback via dialogs e.g.
case let .externalLogin(url),

</code></pre>
<h4 id='code-sources-erpapp-screens-main-extauth-extauthpendingdomain-swift-169-code' class='heading'><code>../Sources/eRpApp/Screens/Main/ExtAuth/ExtAuthPendingDomain.swift:169</code></h4>

<p>Login part is handled by idpSesson</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22301-01#8|5] Login part is handled by idpSesson
environment.idpSession
    .extAuthVerifyAndExchange(
        url,
        idTokenValidator: idTokenValidator.validate(idToken:)
    )
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-490-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:490</code></h4>

<p>Extract the components.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22301-01#9|7] Extract the components.
guard let components = URLComponents(url: url, resolvingAgainstBaseURL: true),
      let code = components.queryItemWithName("code")?.value,
      let state = components.queryItemWithName("state")?.value else {
    return Fail(
        error: IDPError.internal(error: .extAuthVerifyAndExchangeMissingQueryItem)
    ).eraseToAnyPublisher()
}
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-501-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:501</code></h4>

<p>Send authorization request</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22301-01#10] Send authorization request
return extAuthVerify(verify)

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-510-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:510</code></h4>

<p>Check for existing challenge session</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22301-01#11] Check for existing challenge session
guard let challengeSession = extAuthRequestStorage.getExtAuthRequest(for: token.state) else {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-477-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:477</code></h4>

<p>The challenge session has been set here.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22301-01#12] The challenge session has been set here.
self.extAuthRequestStorage.setExtAuthRequest(challengeSession, for: storageIdentifier)

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-1088-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:1088</code></h4>

<p>Negative Test</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22301-01#20] Negative Test
func testExtAuthVerifyAndExchangeFailesWithoutReferenceStateGID() throws {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_22302-01-a_22302-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_22302-01">A_22302-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_22302-01" severity="MUSS" class="target-element">
<p><b>A_22302-01 - Weiterleitung des Authorization Code an den IDP-Dienst</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-size: 10pt;line-height: 1.5;">, wenn es eine Authentifizierung über den sektoralen IDP unterstützt,</span> den empfangenen Authorization Code AUTHORIZATION_CODE_IDP abhängig vom für den ausgehenden Request gespeicherten Parameter verarbeiten:<br> 
</p>
<ul> 
<li>Ist <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">idp_sek_2=false</span> sendet es den AUTHORIZATION_CODE_IDP, den <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">state </span>Parameter sowie  den optionalen Parameter <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">kk_app_redirect_uri</span>  als HTTP-POST an den im Discovery Document referenzierten Third-Party Authorization Endpoint des IDP-Dienstes.</li> 
<li>Ist <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">idp_sek_2=true</span> sendet es den AUTHORIZATION_CODE_IDP und den <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">state </span>Parameter als HTTP-POST an den im Discovery Document referenzierten Federation Authorization Endpoint des IDP-Dienstes.<span id="polarion-comment:877"></span>
</li> 
</ul> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>As of now <code>idp_sek_2</code> can only be true, as the <code>false</code> case is no longer allowed. Thus only the <code>true</code> case is implemented in the following code places.</p>
<h4 id='code-sources-idp-internal-realidpclient-swift-461-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:461</code></h4>

<p>Sending the required data as POST to the backend.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22302-01#2] Sending the required data as POST to the backend.
func extAuthVerify(_ verify: IDPExtAuthVerify,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_22313-01-a_22313-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_22313-01">A_22313-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_22313-01" severity="MUSS" class="target-element">
<p><b>A_22313-01 - Absicherung des Aufrufs zu Authenticator-Modulen von sektoralen Identity Providern</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-weight: normal;font-style: normal;font-size: 10pt;color: #000000;background-color: #FFFFFF;line-height: 1.5;">, wenn es eine Authentifizierung über den sektoralen IDP unterstützt,</span> für Aufrufe zu Authenticator-Modulen sektoraler Identity Provider die Verifikationsmechanismen des Betriebssystems verwenden. Die folgenden Parameter müssen gesetzt sein: <br> Android: Keine weiteren.<br> iOS: .universalLinksOnly:false<span id="polarion-comment:879"></span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationdomain-swift-111-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationDomain.swift:111</code></h4>

<p>Universal link options</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22313-01] Universal link options
environment.resourceHandler.open(url, options: [.universalLinksOnly: false]) { result in

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_frontend-latest-index-html-a_23082-a_23082-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Frontend/latest/index.html#A_23082">A_23082</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_23082" severity="MUSS" class="target-element">
<p><b>A_23082 - Abruf und Anzeige der IDP Liste</b></p>
<p>Das Anwendungsfrontend MUSS, wenn es eine Authentifizierung über den sektoralen IDP unterstützt, sofern nicht anderweitig ein sektoraler Identity Provider zuvor gemerkt oder festgelegt wurde, die IDP-Liste vom Authorization-Server herunterladen, auf Integrität prüfen und (bei erfolgreicher Prüfung) dem Benutzer zur Auswahl anzeigen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthselectiondomain-swift-73-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthSelectionDomain.swift:73</code></h4>

<p>Load available apps</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22296-01] Load available apps
// [REQ:gemSpec_IDP_Frontend:A_23082#2] Load available apps
return .publisher(

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-422-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:422</code></h4>

<p>Signature verification</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22296-01] Signature verification
// [REQ:gemSpec_IDP_Frontend:A_23082#3] Signature verification
// [REQ:BSI-eRp-ePA:O.Resi_6#3] Discovery Document signature verification
guard try jwtContainer.verify(with: document.discKey) == true else {

</code></pre>
<h4 id='code-tests-idptests-defaultidpsessiontests-swift-954-code' class='heading'><code>../Tests/IDPTests/DefaultIDPSessionTests.swift:954</code></h4>

<p>Test</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_22296-01] Test
// [REQ:gemSpec_IDP_Frontend:A_23082#4] Test
func testLoadDirectoryKKAppsInvalidSignature() throws {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthselectionview-swift-48-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthSelectionView.swift:48</code></h4>

<p>Display of KK apps</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_23082#5] Display of KK apps
if !store.filteredKKList.apps.isEmpty {

</code></pre>
<h2 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_sek-latest-index-html-gemspec_idp_sek-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Sek/latest/index.html">gemSpec_IDP_Sek</a></h2>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_sek-latest-index-html-a_22299-a_22299-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Sek/latest/index.html#A_22299">A_22299</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-cardwall-introduction-cardwallintroductiondomain-swift-190-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/Introduction/CardWallIntroductionDomain.swift:190</code></h4>

<p>Follow redirect</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22299] Follow redirect
// [REQ:BSI-eRp-ePA:O.Plat_10#3] Follow redirect
guard resourceHandler.canOpenURL(url) else {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_idp_sek-latest-index-html-a_22313-01-a_22313-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_IDP_Sek/latest/index.html#A_22313-01">A_22313-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_22313-01" severity="MUSS" class="target-element">
<p><b>A_22313-01 - Absicherung des Aufrufs zu Authenticator-Modulen von sektoralen Identity Providern</b></p>
<p>Das Anwendungsfrontend MUSS<span style="font-weight: normal;font-style: normal;font-size: 10pt;color: #000000;background-color: #FFFFFF;line-height: 1.5;">, wenn es eine Authentifizierung über den sektoralen IDP unterstützt,</span> für Aufrufe zu Authenticator-Modulen sektoraler Identity Provider die Verifikationsmechanismen des Betriebssystems verwenden. Die folgenden Parameter müssen gesetzt sein: <br> Android: Keine weiteren.<br> iOS: .universalLinksOnly:false<span id="polarion-comment:879"></span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-cardwall-introduction-cardwallintroductiondomain-swift-196-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/Introduction/CardWallIntroductionDomain.swift:196</code></h4>

<p>Remember State parameter for later verification</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22313-01] Remember State parameter for later verification
resourceHandler.open(url, options: [:]) { result in

</code></pre>
<h2 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gemspec_krypt-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html">gemSpec_Krypt</a></h2>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_17124-a_17124-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_17124">A_17124</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>TLS is enforced by the platform for every HTTP connection. Certain domains can be excluded from this rule by listing them in a dedicated NSAppTransportSecurity exception list. This list is empty for our application, see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_17205-a_17205-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_17205">A_17205</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_17205" severity="MUSS" class="target-element">
<p><b>A_17205 - Signatur der TSL: Signieren und Prüfen (ECC-Migration)</b></p>
<p>Alle Produkttypen, die die TSL(ECC-RSA) signieren oder prüfen, MÜSSEN dafür das Signaturverfahren ECDSA [BSI-TR-03111] auf Basis der Domainparameter brainpoolP256r1 verwenden mit dem XMLDSig-Identifier „ <a class="descriptionLink" target="_blank" href="http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha256">http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha256</a>“ [XMLDSig]. Als Hashfunktion (Messagedigest) MUSS SHA-256 [FIPS-180-4] verwendet werden.<br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The app does not use the TSL. All TSL related parts are handled within the eRp-FD.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_17207-a_17207-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_17207">A_17207</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_17207" severity="MUSS" class="target-element">
<p><b>A_17207 - Signaturen binärer Daten (ECC-Migration)</b></p>
<p>Alle Produkttypen, die (nicht-XML-)Signaturen von Daten auf Basis eines ECC-Schlüssels erzeugen oder prüfen, MÜSSEN dafür das Signaturverfahren ECDSA [BSI-TR-03111] auf Basis der Domainparameter brainpoolP256r1 verwenden (vgl. [RFC-5753] und [RFC-6090]). Als Hashfunktion (Messagedigest) MÜSSEN sie SHA-256 [FIPS-180-4] verwenden. <br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-605-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:605</code></h4>

<p>Assure only brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
var alg: JWT.Algorithm? {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-288-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:288</code></h4>

<p>Only implemented for brainpoolP256r1</p>
<pre class="highlight plaintext"><code>// Validate JWT/DiscoveryDocument signature
// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02] Assure that brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4361-02] Assure that brainpoolP256r1 is used
// [REQ:BSI-eRp-ePA:O.Resi_6#4] Discovery Document signature verification
guard (try? fetchedDocument.backing.verify(with: fetchedDocument.discKey)) ?? false else {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-633-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:633</code></h4>

<p>Only implemented for brainpoolP256r1</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_IDP_Frontend:A_19908-01] Signature check
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let verified = try? challenge.challenge.verify(with: document.authentication.cert),

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-23-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:23</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02]
public func verify(signature raw: Data, message: Data) throws -&gt; Bool {

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-33-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:33</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let key = brainpoolP256r1VerifyPublicKey() else {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-472-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:472</code></h4>

<p>Assure only brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
let alg: JWT.Algorithm = .bp256r1

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-517-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:517</code></h4>

<p>Assure only brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let alg = autCertificateResponse.info.algorithm.alg

</code></pre>

<p>BrainpoolP256r1 parameter spec is used for creating/verifying key for signature usage; exception: Biometric use case uses secp256r1 (This is considered in its respective specification.)</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_17322-a_17322-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_17322">A_17322</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_17322" severity="MUSS" class="target-element">
<p><b>A_17322 - TLS-Verbindungen nur zulässige Ciphersuiten und TLS-Versionen (ECC-Migration)</b></p>
<p>Alle Produkttypen, die Übertragungen mittels TLS durchführen, MÜSSEN sicherstellen, dass sie nur (durch andere Anforderungen) zugelassene TLS-Ciphersuiten bzw. TLS-Versionen anbieten bzw. verwenden. <br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>TLS is enforced by the platform for every HTTP connection. Certain domains can be excluded from this rule by listing them in a dedicated NSAppTransportSecurity exception list. This list is empty for our application, see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_17359-a_17359-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_17359">A_17359</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_17359" severity="MUSS" class="target-element">
<p><b>A_17359 - Signaturen binärer Daten (Dokumente) (ECC-Migration)</b></p>
<p>Alle Produkttypen, die (nicht-XML-)Signaturen von Dokumenten auf Basis eines ECC-Schlüssels erzeugen oder prüfen, MÜSSEN dabei die Vorgaben aus A_17207 umsetzen und die Signatur nach [ETSI-CAdES] (interoperables Container-Format) bei der Erzeugung kodieren bzw. bei der Prüfung auswerten.<br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Not applicable, since there is no exchange of CAdES-encoded documents signed by a ECC key in our system. Generally the created signatures adhere to A_17207 if not stated otherwise in the respective specifications.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_17775-a_17775-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_17775">A_17775</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_17775" severity="SOLL" class="target-element">
<p><b>A_17775 - TLS-Verbindungen Reihenfolge Ciphersuiten (ECC-Migration)</b></p>
<p>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="HTML Tidy for Java (vers. 26 Sep 2004), see www.w3.org" name="generator"></p>
<title></title>
<p><span>Alle Produkttypen, die Übertragungen mittels TLS durchführen und in der Rolle TLS-Server agieren, SOLLEN die Reihenfolge der Ciphersuiten in der Liste &ldquo;cipher_suites&rdquo; aus dem TLS-ClientHello bei der Auswahl der Ciphersuite befolgen.</span></p> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We cannot interfere with cipher suite lists, see <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a> for actual order.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_18464-a_18464-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_18464">A_18464</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_18464" severity="DARF NICHT" class="target-element">
<p><b>A_18464 - TLS-Verbindungen, nicht Version 1.1</b></p>
<p>Alle Produkttypen, die Übertragungen mittels TLS durchführen, DÜRFEN NICHT die TLS-Version 1.1 [RFC-4346] unterstützen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-33-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:33</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_IDP_Frontend:A_20606#2] Setup of minimum TLS Version to use.
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework
urlSessionConfiguration.tlsMinimumSupportedProtocolVersion = .TLSv12

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_18467-a_18467-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_18467">A_18467</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_18467" severity="KANN" class="target-element">
<p><b>A_18467 - TLS-Verbindungen, Version 1.3</b></p>
<p>Alle Produkttypen, die Übertragungen mittels TLS durchführen, KÖNNEN die TLS-Version 1.3 [RFC-8446] unterstützen, falls sie<br> 
</p>
<ol> 
<li>dabei nur nach [BSI-TR-02102-2] empfohlene Verbindungskonfigurationen (Handshake-Modi, (EC)DH-Gruppen, Signaturverfahren, Ciphersuiten etc.) verwenden, und </li> 
<li>mindestens die Ciphersuite &ldquo;TLS_AES_128_GCM_SHA256&rdquo; dabei unterstützen. </li> 
</ol> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-33-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:33</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_IDP_Frontend:A_20606#2] Setup of minimum TLS Version to use.
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework
urlSessionConfiguration.tlsMinimumSupportedProtocolVersion = .TLSv12

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_19215-a_19215-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_19215">A_19215</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use https only, see <code>DefaultHTTPClient.swift</code>. ATS forbids other connections.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_20161-01-a_20161-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_20161-01">A_20161-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20161-01" severity="MUSS" class="target-element">
<p><b>A_20161-01 - E-Rezept-Client, Request-Erstellung</b></p>
<p>Ein E-Rezept-Client MUSS, falls ihm noch kein gültiges E-Rezept-VAU-Zertifikat vorliegt, ein solches nach den fachlichen Vorgaben von A_20160-* beziehen (<span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">/VAUCertificate</span><span style="font-family: Arial, Helvetica;">).<br> Ein E-Rezept-Client MUSS sicherstellen, dass gültige Sperrinformation (OCSP-Response mit Sperrstatus &ldquo;good&rdquo;) für das Zertifikat vorliegen, die maximal 12 Stunden alt sind. Liegen diese nicht vor so MUSS der Client ein Verbindungsaufbau auf VAU-Protokoll-Ebene ablehnen/unterbinden.<br><br> Ein E-Rezept-Client MUSS bei der Request-Erstellung folgende Schritte durchführen.</span><br> 
</p>
<ol>
<li>Er erzeugt einen HTTP-Request, den er an die VAU senden möchte, als Datenstruktur (vgl. Beispiele nach dieser Anforderung).</li>
<li>Er erzeugt zufällig eine 128-Bit lange hexadezimalkodierte Request-ID (also 32 Zeichen, Buchstaben a-f kleingeschrieben).</li>
<li>Er erzeugt zufällig einen 128-Bit AES-Schlüssel (im Weiteren auch Antwortschlüssel genannt), den er hexadezimal kodiert (also 32 Zeichen, Buchstaben a-f kleingeschrieben).</li>
<li>Er MUSS die Request-ID und den AES-Schlüssel für jeden HTTP-Request an die VAU zufällig neu erzeugen.</li>
<li>Er erzeugt die folgende Zeichenkette p mit<br> p=&ldquo;1&rdquo; + &ldquo; &rdquo; + JWT-Authentisierungstoken + &ldquo; &rdquo; + Request-ID + &ldquo; &rdquo; + AES-Schlüssel + &ldquo; &rdquo; + Datenstruktur aus Schritt 1.</li>
<li>Die Zeichenkette p MUSS mittels des ECIES-Verfahrens [SEC1-2009] und mit folgenden Vorgaben verschlüsselt werden:</li>
<li style="list-style: none">
<ol>
<li>Er MUSS ein ephemeres ECDH-Schlüsselpaar erzeugen und mit diesem und dem VAU-Schlüssel aus A_20160-* ein ECDH gemäß [NIST-800-56-A] durchgeführen. Das somit erzeugte gemeinsame Geheimnis ist Grundlage für die folgende Schlüsselableitung.</li>
<li>Als Schlüsselableitungsfunktion MUSS er die HKDF nach [RFC-5869] auf Basis von SHA-256 verwenden.</li>
<li>Dabei MUSS er den Ableitungsvektor &ldquo;ecies-vau-transport&rdquo; verwenden, d. h. in der Fomulierung von [RFC-5869] info=&ldquo;ecies-vau-transport&rdquo; .</li>
<li>Er MUSS mit dieser Schlüsselableitung einen AES-128-Bit Content-Encryption-Key für die Verwendung von AES/GCM ableiten.</li>
<li>Er MUSS für Verschlüsselung mittels AES/GCM einen 96 Bit langen IV zufällig erzeugen.</li>
<li>Er MUSS mit dem CEK und dem IV mittels AES/GCM p verschlüsseln, wobei dabei ein 128 Bit langer Authentication-Tag zu verwenden ist.</li>
<li>Er MUSS das Ergebnis wie folgt kodieren: chr(0x01) || &lt;32 Byte X-Koordinate von öffentlichen Schlüssel aus (a) &gt; || &lt;32 Byte Y-Koordinate&gt; || &lt;12 Byte IV&gt; || &lt;AES-GCM-Chiffrat&gt; || &lt;16 Byte AuthenticationTag&gt; (vgl. auch Tab_KRYPT_ERP und folgende die Beispielverschlüsselung).<br> Die Koordinaten sind (wie üblich) vorne mit chr(0) zu padden solange bis sie eine Kodierungslänge von 32 Byte erreichen.</li>
</ol>
</li>
<li>Er erzeugt einen HTTPS-Request an den FD mit der POST-Methode und dem Pfad <span style="font-family: 'Courier New', Courier, monospace, HanWangKanTan;">/VAU/&lt;Nutzerpseudonym&gt;[/optional-beliebiger-weiterer-URL-Pfadteil]</span> mit dem Content-Type &lsquo;<span style="font-size: 10pt;line-height: 1.5;">application/octet-stream&rsquo; und sendet diesen an die Webschnittstelle des FD.<br> &ldquo;Nutzerpseudonym&rdquo; MUSS eine ggf. aus der vorherigen (zeitlich letzten) Antwort des FD dem Nutzer übergebene URL-sichere Zeichenkette sein (bspw. ein 128 Byte langer Hexadezimal-Kode).<br> Falls dem Client kein Nutzerpseudonym vorliegt so MUSS er &ldquo;0&rdquo; als Nutzerpseudonym verwenden.</span>
</li>
</ol> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-26-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:26</code></h4>

<p>Encryption interface</p>
<pre class="highlight plaintext"><code>/// Perform encryption of the data that the implementing instance has been initialized with
/// in order to send it to a VAU service endpoint. See: gemSpec_Krypt A_20161-01
///
/// [REQ:gemSpec_Krypt:A_20161-01#2] Encryption interface
///
/// - Returns: Encrypted HTTPRequest as specified to be sent to a VAU endpoint
/// - Throws: `VAUError` in case of encryption failure
func encrypt() throws -&gt; Data

</code></pre>
<h4 id='code-sources-vauclient-vauinterceptor-swift-48-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:48</code></h4>

<p>Encapsulate “real” HTTPRequest into VAU envelop</p>
<pre class="highlight plaintext"><code>// Prepare outer request (encrypt original request and embed it into a new one)
// [REQ:gemSpec_Krypt:A_20161-01#3] Encapsulate "real" HTTPRequest into VAU envelop
.processToVauRequest(urlRequest: request, vauCryptoProvider: vauCryptoProvider)

</code></pre>
<h4 id='code-sources-vauclient-vauinterceptor-swift-65-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:65</code></h4>

<p>Encapsulate “real” HTTPRequest into VAU envelop</p>
<pre class="highlight plaintext"><code>// Prepare outer request (encrypt original request and embed it into a new one)
// [REQ:gemSpec_Krypt:A_20161-01#4] Encapsulate "real" HTTPRequest into VAU envelop
func processToVauRequest(

</code></pre>
<h4 id='code-sources-vauclient-internal-urlrequest-serialize-swift-14-code' class='heading'><code>../Sources/VAUClient/internal/URLRequest+Serialize.swift:14</code></h4>

<p>1:</p>
<pre class="highlight plaintext"><code>/// Serialize the request into a String that can be interpreted by the VAU server
/// - Note: A HTTP body is only included into the string representation when it is UTF-8 encoded.
/// [REQ:gemSpec_Krypt:A_20161-01#11] 1:
func encodeToRawString() throws -&gt; String {

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-45-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:45</code></h4>

<p>2: Request-ID Generator</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20161-01#12] 2: Request-ID Generator
let requestIdGenerator = { try VAURandom.generateSecureRandom(length: 16).hexStringLowerCase }

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-47-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:47</code></h4>

<p>3: AES-Key Generator</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20161-01#13] 3: AES-Key Generator
let symmetricKeyGenerator = { SymmetricKey(size: SymmetricKeySize(bitCount: 128)) }

</code></pre>
<h4 id='code-sources-vauclient-vauinterceptor-swift-92-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:92</code></h4>

<p>4: vauCrypto is generating new entity and thus a new request/id everytime</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20161-01#14|5] 4: vauCrypto is generating new entity and thus a new request/id everytime
let vauCrypto = try vauCryptoProvider.provide(
    for: stringEncodedRequest,
    vauCertificate: vauCertificate,
    bearerToken: bearerToken
)
</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-90-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:90</code></h4>

<p>5:</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20161-01#15] 5:
guard let payload = "1 \(bearerToken) \(requestId) \(symKeyHex) \(message)".data(using: .utf8) else {

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-138-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:138</code></h4>

<p>6a-g</p>
<pre class="highlight plaintext"><code>/// Perform Elliptic Curve Integrated Encryption Scheme [SEC1-2009] on some payload
/// [REQ:gemSpec_Krypt:A_20161-01#16] 6a-g
static func encrypt(

</code></pre>
<h4 id='code-sources-vauclient-internal-vauendpointhandler-swift-17-code' class='heading'><code>../Sources/VAUClient/internal/VAUEndpointHandler.swift:17</code></h4>

<p>7: VAU-Endpoint respects userpseudonym if present</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20161-01#17|10] 7: VAU-Endpoint respects userpseudonym if present
var vauEndpoint: AnyPublisher&lt;URL, VAUError&gt; {
    vauStorage.userPseudonym
        .map { userPseudonym in
            // If the client has yet not been assigned a user pseudonym, then default to "0".
            let userPseudonymPathComponent = userPseudonym ?? "0"
            return self.vauEndpoint(withLastComponent: userPseudonymPathComponent)
        }
        .setFailureType(to: VAUError.self)
        .eraseToAnyPublisher()
}
</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_20163-a_20163-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_20163">A_20163</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20163" severity="MUSS" class="target-element">
<p><b>A_20163 - E-Rezept-VAU, Nutzeranfrage, Ent- und Verschlüsselung</b></p>
<p>Die E-Rezept-VAU MUSS das Folgende sicherstellen und im Falle eines Fehlschlagens die Abarbeitung des Requests mit einer entsprechenden Fehlermeldung an die sie aufrufende Webschnittstelle abbrechen.<br> 
</p>
<ol>
<li>Die E-Rezept-VAU MUSS einen verschlüsselten Nutzer-Request von der Webschnittstelle entgegennehmen.</li>
<li>Die E-Rezept-VAU MUSS einen verschlüsselten Nutzer-Request nach den kryptographischen Vorgaben aus A_20161-* und mit dem privaten Schlüssel aus A_20160-* versuchen zu entschlüsseln.</li>
<li>Die E-Rezept-VAU MUSS den erhaltenden Klartext p auf den Strukturaufbau aus A_20160-* prüfen.</li>
<li>Die E-Rezept-VAU MUSS das JWT-Authentisierungstoken auf Gültigkeit prüfen.</li>
<li>Die E-Rezept-VAU MUSS den in p kodieren HTTP-Request abarbeiten.</li>
<li>Die E-Rezept-VAU MUSS einen 128-Bit-AES-CMAC-Schlüssel zufällig erzeugen und mindestens alle 10 Tage wechseln.</li>
<li>Die E-Rezept-VAU MUSS aus dem &ldquo;sub&rdquo;-Feld-Wert mittels des CMAC-Schlüssels den 128 Bit langen CMAC-Wert berechnen und hexadezimal kodieren (32 Byte lang). Dies sei das Prenutzerpseudonym (PNP).</li>
<li>Die Antwort &ldquo;a&rdquo; auf den HTTP-Request aus p MUSS wie folgt kodiert werden:<br> a=&ldquo;1&quot;  + &rdquo; &ldquo; + Request-ID-aus-p + &rdquo; &ldquo; + Response-Header-und-Body.</li>
<li>Die E-Rezept-VAU MUSS a mittels des 128-Bit langen AES-Schlüssels aus p und AES/GCM (96 Bit zufällig erzeugter IV, 128 Authentication Tag) verschlüsseln und erhält c&rsquo;.</li>
<li>Die E-Rezept-VAU MUSS c&rsquo; und das PNP an die Webschnittstelle als Antwort übergeben.</li>
</ol> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-34-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:34</code></h4>
<pre class="highlight plaintext"><code>/// Perform decryption and validation of given data with the secret key material the implementing instance holds.
///
/// [REQ:gemSpec_Krypt:A_20163]
///
/// - Parameter data: Data to be decrypted
/// - Returns: Decrypted UTF8 string representation of the given data
/// - Throws: `VAUError` in case of decryption failure or when the decrypted data could not be validated
func decrypt(data: Data) throws -&gt; String

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_20174-a_20174-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_20174">A_20174</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20174" severity="MUSS" class="target-element">
<p><b>A_20174 - E-Rezept-Client, Response-Auswertung</b></p>
<p>Ein E-Rezept-Client MUSS bei der Response-Auswertung (vgl. vorgehenden Client-Request aus A_20161-*) folgende Schritte durchführen. Dabei MUSS der Client bei Fehlschlagens im Folgenden aufgeführten Prüfungen die Analyse der Response abbrechen, und er MUSS die Request-ID und den AES-Antwortschlüssel sicher löschen.<br> 
</p>
<ol>
<li>Er MUSS prüfen, ob der Content-Type der Response &lsquo;<span style="font-size: 10pt;line-height: 1.5;">application/octet-stream&rsquo; ist.</span>
</li>
<li><span style="font-size: 10pt;line-height: 1.5;">Wenn im Response-Header die Variable &quot;Userpseudonym&rdquo; vorhanden ist, so MUSS er den Wert von &ldquo;Userpseudonym&rdquo; als NP für den nächsten Request an die VAU verwenden. (Der Client MUSS einen ggf. vorhandenen alten Wert des NP im Client überschrieben.)</span></li>
<li><span style="font-size: 10pt;line-height: 1.5;">Er MUSS das Antwort-Chiffrat mit den Vorgaben aus A_20163 (9) und dem AES-Antwort entschlüsseln und prüfen ob die Entschlüsselung erfolgreich möglich war.</span></li>
<li><span style="font-size: 10pt;line-height: 1.5;">Er MUSS prüfen, ob die Struktur des erhaltenen Klartextes p der Struktur aus A_20163 (8) entspricht.</span></li>
<li><span style="font-size: 10pt;line-height: 1.5;">Er MUSS  prüfen, ob die Request-ID in p der Request-ID aus dem Client-Request entspricht (Gleichheit prüfen).</span></li>
<li><span style="font-size: 10pt;line-height: 1.5;">Er MUSS das dritte Feld-Element in p (&ldquo;Response-Header-und-Body&rdquo;) als HTTP-Antwort der E-Rezept-VAU in fachlich weiter verarbeiten.</span></li>
</ol> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-vauclient-vauinterceptor-swift-133-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:133</code></h4>

<p>1: Check Content-Type</p>
<pre class="highlight plaintext"><code>// Process VAU server response (validate and extract+decrypt inner FHIR service response)
// [REQ:gemSpec_Krypt:A_20174#11|12] 1: Check Content-Type
static func processVauResponse(httpResponse: HTTPResponse, vauCrypto: VAUCrypto, originalUrl: URL) throws
    guard httpResponse.status == .ok,
          httpResponse.response.value(forHTTPHeaderField: "Content-Type") == "application/octet-stream"
    else {
        return httpResponse
    }
    let extracted = httpResponse.data
    let decrypted = try vauCrypto.decrypt(data: extracted)
    let decoded = try decrypted.decodeToHTTPResponse(url: originalUrl)
    return decoded
}
}
</code></pre>
<h4 id='code-sources-vauclient-vauinterceptor-swift-53-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:53</code></h4>

<p>2: Handle userpseudonym</p>
<pre class="highlight plaintext"><code>// Process VAU server response (validate and extract+decrypt inner FHIR service response)
// [REQ:gemSpec_Krypt:A_20174#12] 2: Handle userpseudonym
.handleUserPseudonym(vauEndpointHandler: self.vauEndpointHandler)

</code></pre>
<h4 id='code-sources-vauclient-internal-vauendpointhandler-swift-34-code' class='heading'><code>../Sources/VAUClient/internal/VAUEndpointHandler.swift:34</code></h4>

<p>2:</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20174#12] 2:
if let pseudonym = httpResponse.response.value(forHTTPHeaderField: "userpseudonym") {

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-115-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:115</code></h4>

<p>3: Decrypt using AES symmetric key</p>
<pre class="highlight plaintext"><code>// Steps according to gemSpec_Krypt A_20174
// [REQ:gemSpec_Krypt:A_20174#13] 3: Decrypt using AES symmetric key
guard let sealed = try? AES.GCM.SealedBox(combined: data),

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-122-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:122</code></h4>

<p>4+5: Verify decrypted message. Expect: “1 <request> &lt;response header+body&gt;&ldquo;</request></p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20174#14] 4+5: Verify decrypted message. Expect: "1 &lt;request id&gt; &lt;response header+body&gt;"
let separated = utf8.split(separator: " ", maxSplits: 2).map { String($0) }

</code></pre>
<h4 id='code-sources-vauclient-vauinterceptor-swift-54-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:54</code></h4>

<p>6: Remove the envelop</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20174#16] 6: Remove the envelop
.processVauResponse(vauCrypto: vauCrypto, originalUrl: originalUrl)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_20175-a_20175-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_20175">A_20175</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20175" severity="MUSS" class="target-element">
<p><b>A_20175 - E-Rezept-Client, Speicherung Nutzerpseudonym</b></p>
<p>Ein E-Rezept-Client MUSS das im Request verwendete Nutzerpseudonym (NP) in Software speichern (kein HSM/TPM/SE) und das NP ausschließlich für seinen Einsatzzweck der E-Rezept-VAU-Kommunikation verwenden. Insbesondere MUSS der Client die Vertraulichkeit des NP wahren (bspw. nicht unnötig in Protokolleinträgen und Fehlermeldungen aufführen). <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-vauclient-vaustorage-swift-11-code' class='heading'><code>../Sources/VAUClient/VAUStorage.swift:11</code></h4>

<p>VAUStorage provides a getter and a setter for user pseudonym</p>
<pre class="highlight plaintext"><code>/// VAU Storage protocol
/// [REQ:gemSpec_Krypt:A_20175#1|7] VAUStorage provides a getter and a setter for user pseudonym
public protocol VAUStorage {
    var userPseudonym: AnyPublisher&lt;String?, Never&gt; { get }

    /// Set and save a user pseudonym
    /// - Parameter userPseudonym: value to save. Pass in nil to unset
    func set(userPseudonym: String?)
}
</code></pre>
<h4 id='code-sources-vauclient-vaustorage-swift-20-code' class='heading'><code>../Sources/VAUClient/VAUStorage.swift:20</code></h4>

<p>Implementation of VAUStorage is using the Filesystem</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20175#2|2] Implementation of VAUStorage is using the Filesystem
public class FileVAUStorage: VAUStorage {
    let userPseudonymFilePath: URL
</code></pre>
<h4 id='code-sources-erpapp-session-standardsessioncontainer-swift-154-code' class='heading'><code>../Sources/eRpApp/Session/StandardSessionContainer.swift:154</code></h4>

<p>Initialization of the VAUStorage at a predefined location in the filesystem</p>
<pre class="highlight plaintext"><code>// Local VAU storage configuration
// [REQ:gemSpec_Krypt:A_20175#3|10] Initialization of the VAUStorage at a predefined location in the filesystem
lazy var vauStorage: VAUStorage = {
        for: .documentDirectory,
        in: .userDomainMask,
        appropriateFor: nil,
        create: false
    )
    .appendingPathComponent("VauStorage") else {
        preconditionFailure("Could not create a filePath for the vau storage.")
    }
    return FileVAUStorage(vauStorageBaseFilePath: vauStorageFilePath)
</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_20607-a_20607-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_20607">A_20607</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use https only, see <code>DefaultHTTPClient.swift</code>. ATS forbids other connections.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_21216-a_21216-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_21216">A_21216</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21216" severity="MUSS" class="target-element">
<p><b>A_21216 - E-Rezept-Client, Zertifikatsprüfung auf TSL-Basis</b></p>
<p>Ein E-Rezept-Client, der nicht das E-Rezept-FdV ist, MUSS das VAU-Zertifikat vom E-Rezept-FD beziehen (vgl. A_20160-*, URL /VAUCertificate) und ebenfalls für dieses Zertifikat die OCSP-Response <span id="polarion-comment:556"></span>für dieses Zertifikat beziehen (vgl. A_20160-*, URL /VAUCertificateOCSPResponse). Er MUSS das Zertifikat mittels <span style="font-family: Arial, Helvetica;">TUC_PKI_018</span> (OCSP-Graceperiod=12h, PolicyList={oid_erp-vau}) prüfen und dabei die vom FD bezogene OCSP-Response verwenden. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-truststore-internal-certlist-swift-11-code' class='heading'><code>../Sources/TrustStore/internal/CertList.swift:11</code></h4>
<pre class="highlight plaintext"><code>/// Data structure according to */CertList* endpoint
/// [REQ:gemSpec_Krypt:A_21216]
public struct CertList: Codable, Equatable {

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucertlist-swift-11-code' class='heading'><code>../Sources/VAUClient/internal/VAUCertList.swift:11</code></h4>
<pre class="highlight plaintext"><code>/// Data structure according to */CertList* endpoint
/// [REQ:gemSpec_Krypt:A_21216]
public struct VAUCertList: Codable, Equatable {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_21217-a_21217-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_21217">A_21217</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21217" severity="MUSS" class="target-element">
<p><b>A_21217 - E-Rezept-FD, Zertifikatslisten und OCSP-Response für Clients</b></p>
<p>Ein E-Rezept-FD MUSS<br> 
</p>
<ol> 
<li>nachdem die E-Rezept-VAU-Identität (vgl. A_20160-*) erzeugt wurde mittels des Algorithmus aus Tab_KRYPT_ERP_FD_Zertifikatsliste_erstellen die Datenstruktur analog zu Tab_KRYPT_ERP_Zertifikatsliste erstellen.</li> 
<li>diese erzeugte Zertifikatsliste auf seiner Webschnittstelle (HTTPS) über die URL /CertList (GET-Methode, Reponse-Content-Type &lsquo;application/json&rsquo;) verfügbar machen.</li> 
<li>die Zertifikatsliste mittels des Algorithmus aus Tab_KRYPT_ERP_FD_Zertifikatsliste_erstellen aktualisieren wenn (1) die E-Rezept-VAU-Identität aktualisiert wurde (Schlüsselwechsel der VAU etc.) oder (2) die gematik neue IDP-Zertifikate über die Liste E-Rezept-Clients bekannt machen möchte. Im Fall (2) meldet die gematik dies an den FD.</li> 
<li>an seiner Webschnittstelle (HTTPS) über die URL /OCSPList (GET-Methode, Reponse-Content-Type &lsquo;application/json&rsquo;) ein Array mit den base64-kodierten OCSP-Responses für die alle Zertifikate aus dem Array &quot;ee_certs&rdquo;. Diese OCSP-Response-Liste muss der FD mindestens alle 11 Stunden mit &ldquo;frischen&rdquo; OCSP-Responses für die Zertifikate aus dem Array &ldquo;ee_certs&rdquo; aktualisieren.</li> 
</ol> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-truststore-internal-ocsplist-swift-10-code' class='heading'><code>../Sources/TrustStore/internal/OCSPList.swift:10</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_Krypt:A_21217]
/// Data structure according to */OCSPList* endpoint
public struct OCSPList: Codable, Equatable {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_21218-a_21218-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_21218">A_21218</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21218" severity="MUSS" class="target-element">
<p><b>A_21218 - E-Rezept-Client, Zertifikatsprüfung auf Basis der X.509-Root</b></p>
<p>Das E-Rezept-FdV MUSS die RCA3 (das Zertifikat der Version 3 der X.509-Root der TI) als Vertrauensanker im Programm-Code bzw. mit dem Programm-Code fest assoziiert enthalten und als Basis für die Prüfung von TI-Zertifikat verwenden.<br> Das FdV MUSS einen TI-Zertifikate-Truststore enthalten und pflegen, wie folgend definiert.<br> <br> Der Truststore MUSS Prüfschlüssel/Zertifikat aufgeteilt in folgende vier Kategorien enthalten: (A) Root-Schlüssel, (B) CA-Zertifikate, &copy; E-Rezept-VAU-Zertifikat, (D) IDP-Zertifikat(e). Initial kann dieser Truststore nur RCA3 enthalten oder die Zertifikate die mittels Tab_KRYPT_ERP_FD_Zertifikatsliste_erstellen ermittelt werden. <br> Falls im Truststore keine Zertifikate für Kategorie &copy; und (D) vorliegen, so MUSS das FdV den Truststore aktualisieren indem es über den FD (URL /CertList) die Zertifikatsliste lädt und diese mittels des Algorithmus Tab_KRYPT_ERP_FdV_Truststore_aktualisieren prüft und ggf. in den Truststore lädt.<br> Das E-Rezept-FdV MUSS über den FD (URL /OCSPList) OCSP-Responses für die Zertifikate &copy; und (D) beziehen, wenn aktuell keine OCSP-Responses für diese Zertifikate im FdV vorliegen, die jünger als 12 Stunden sind.<br> Falls in der OCSP-Liste OCSP-Responses enthalten sind die zu keinem der Zertifikate &copy; und (D) passen, so MUSS das FdV den Truststore aktualisieren (s. o.).<br> Zertifikate aus &copy; und (D) MÜSSEN OCSP-Responses, die jünger als 12 Stunden sind besitzen, damit diese Zertifikate in fachliche Use-Cases im FdV verwendet werden können.<br> <br> Die OCSP-Responder-Zertifikate MÜSSEN per Signaturprüfung auf ein Zertifikat der Kategorie (B) rückführbar sein, ansonsten MÜSSEN die entsprechenden OCSP-Responses verworfen werden.<br> <br> Das FdV MUSS bei der Prüfung der TI-Zertifikate in fachlichen Use-Cases im FdV, prüfen ob das Zertifikat im oben beschriebenen Truststore enthalten ist und eine gültige OCSP-Response enthält die jünger als 12 Stunden ist. Falls dies nicht so ist, so ist das Ergebnis der Prüfung des TI-Zertifikats FAIL.<br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-tests-truststoretests-x509truststoretests-swift-328-code' class='heading'><code>../Tests/TrustStoreTests/X509TrustStoreTests.swift:328</code></h4>

<p>OCSP responder certificates must be verifiable by the trust store</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] OCSP responder certificates must be verifiable by the trust store
func testCheckEeCertificatesStatus_failWhenResponsesCannotBeVerifiedByTrustStore() throws {

</code></pre>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-68-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:68</code></h4>

<p><code>DefaultTrustStoreSession</code> coordinates loading and validity checking</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218,A_21222#2] `DefaultTrustStoreSession` coordinates loading and validity checking
extension DefaultTrustStoreSession: TrustStoreSession {

</code></pre>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-179-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:179</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218]
func loadOCSPResponses() -&gt; AnyPublisher&lt;[OCSPResponse], TrustStoreError&gt; {

</code></pre>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-192-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:192</code></h4>

<p>If only OCSP responses &gt;12h available, we must request new ones</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] If only OCSP responses &gt;12h available, we must request new ones
ocspResponses

</code></pre>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-210-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:210</code></h4>

<p>If only OCSP responses &gt;12h available, …</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] If only OCSP responses &gt;12h available, ...
ocspResponses

</code></pre>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-234-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:234</code></h4>

<p>If only OCSP responses &gt;12h available, we must request new ones</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] If only OCSP responses &gt;12h available, we must request new ones
func allSatisfyNotProducedBefore(date: Date) -&gt; Bool {

</code></pre>
<h4 id='code-sources-truststore-truststoresession-swift-13-code' class='heading'><code>../Sources/TrustStore/TrustStoreSession.swift:13</code></h4>
<pre class="highlight plaintext"><code>/// TrustStoreSession acts as an interactor/mediator for the TrustStoreClient and TrustStoreStorage
///
/// [REQ:gemSpec_Krypt:A_21218,A_21222]
public protocol TrustStoreSession {

</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-13-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:13</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218]
// [REQ:gemSpec_eRp_FdV:A_20032-01]
// Category A: Cross root certificates
private let rootCa: X509

</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-105-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:105</code></h4>
<pre class="highlight plaintext"><code>/// Match a collection of `OCSPResponse`s with the end entity certificates of this `X509TrustStore`.
/// Checks response status, revocation status for each certificate and validates the signer certificates of
///   the responses itself.
///
/// [REQ:gemSpec_Krypt:A_21218]
/// [REQ:gemSpec_eRp_FdV:A_20032-01]
///
/// - Note: This function assumes that up-to-dateness of the responses itself has already been checked.
///
/// - Returns: true on successful matching/validation, false if not successful or error
func checkEeCertificatesStatus(with ocspResponses: [OCSPResponse]) throws -&gt; Bool {

</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-103-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:103</code></h4>

<p>OCSP responder certificates must be verifiable by the trust store</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] OCSP responder certificates must be verifiable by the trust store
let verifiedOCSPResponses = basicVerifyFilter(ocspResponses: ocspResponses)

</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-111-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:111</code></h4>

<p>For every EE certificate there must be a matching OCSP response</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] For every EE certificate there must be a matching OCSP response
let matchedResponses = try eeCertAndSignerTuple.map { eeCertificate, signer in

</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-119-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:119</code></h4>

<p>For every OCSP response there must be a matching EE certificate</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] For every OCSP response there must be a matching EE certificate
let matchedEeCerts = try ocspResponses.map { response in

</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-130-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:130</code></h4>

<p>OCSP responder certificates must be verifiable by the trust store</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] OCSP responder certificates must be verifiable by the trust store
private func basicVerifyFilter(ocspResponses: [OCSPResponse]) -&gt; [OCSPResponse] {

</code></pre>
<h4 id='3-code-sources-truststore-x509truststore-swift-151-code' class='heading'>(3) <code>../Sources/TrustStore/X509TrustStore.swift:151</code></h4>

<p>Check ca_certs against category A certificates</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218:(3)] Check ca_certs against category A certificates
private static let caCertRegex =

</code></pre>
<h4 id='4-code-sources-truststore-x509truststore-swift-168-code' class='heading'>(4) <code>../Sources/TrustStore/X509TrustStore.swift:168</code></h4>

<p>Check ee_certs against category A+B certificates</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218:(4)] Check ee_certs against category A+B certificates
typealias VauAndIpdCerts = (vauCerts: [X509], idpCerts: [X509])

</code></pre>
<h4 id='code-sources-erpapp-appconfiguration-swift-117-code' class='heading'><code>../Sources/eRpApp/AppConfiguration.swift:117</code></h4>

<p>Gematik Root CA 3 as a trust anchor has to be set in the program code</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] Gematik Root CA 3 as a trust anchor has to be set in the program code
// [REQ:BSI-eRp-ePA:O.Ntwk_4#2|16] Gematik Root CA 3 as a trust anchor has to be set in the program code
// swiftlint:disable:next force_try
let TRUSTANCHOR_GemRootCa3 = try! TrustAnchor(withPEM: """

</code></pre>
<h4 id='code-tests-truststoretests-defaulttruststoresessiontests-swift-125-code' class='heading'><code>../Tests/TrustStoreTests/DefaultTrustStoreSessionTests.swift:125</code></h4>

<p>If only OCSP responses &gt;12h available, we must request new ones</p>
<pre class="highlight plaintext"><code>// Advance the time so that saved mocked OCSP responses will be invalidated
// The same mocked OCSP responses will be received by the client cannot be validated,
//  so expect a session failure.
// [REQ:gemSpec_Krypt:A_21218] If only OCSP responses &gt;12h available, we must request new ones
currentDate = currentDate.advanced(by: TimeInterval(expirationInterval))

</code></pre>
<h4 id='code-tests-truststoretests-x509truststoretests-swift-251-code' class='heading'><code>../Tests/TrustStoreTests/X509TrustStoreTests.swift:251</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218]
func testCheckCertificateStatus_FdEnc() throws {

</code></pre>
<h4 id='code-tests-truststoretests-x509truststoretests-swift-270-code' class='heading'><code>../Tests/TrustStoreTests/X509TrustStoreTests.swift:270</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218]
func testCheckCertificateStatus_FdEncIdpSig1IdpSig3() throws {

</code></pre>
<h4 id='code-tests-truststoretests-x509truststoretests-swift-290-code' class='heading'><code>../Tests/TrustStoreTests/X509TrustStoreTests.swift:290</code></h4>

<p>For every EE certificate there must be a matching OCSP response</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] For every EE certificate there must be a matching OCSP response
func testCheckCertificateStatus_failWhenOneEeCertHasNoMatchingResponse() throws {

</code></pre>
<h4 id='code-tests-truststoretests-x509truststoretests-swift-309-code' class='heading'><code>../Tests/TrustStoreTests/X509TrustStoreTests.swift:309</code></h4>

<p>For every  OCSP response there must be a matching EE certificate</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] For every  OCSP response there must be a matching EE certificate
func testCheckCertificateStatus_failWhenOneResponseHasNoMatchingEeCert() throws {

</code></pre>

<p>Note: grace period for OCSP responses is 12h</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_21222-a_21222-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_21222">A_21222</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21222" severity="MUSS" class="target-element">
<p><b>A_21222 - E-Rezept-Client, allgemein Zertifikatsprüfung</b></p>
<p>Ein E-Rezept-Client MUSS bevor er TI-X.509-Zertifikate in fachlichen Abläufen (bspw. VAU-Kanal) verwendet, diese Zertifikate prüfen (vgl. A_21216 und A_21218). <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-truststore-truststoresession-swift-13-code' class='heading'><code>../Sources/TrustStore/TrustStoreSession.swift:13</code></h4>
<pre class="highlight plaintext"><code>/// TrustStoreSession acts as an interactor/mediator for the TrustStoreClient and TrustStoreStorage
///
/// [REQ:gemSpec_Krypt:A_21218,A_21222]
public protocol TrustStoreSession {

</code></pre>

<p>The <code>TrustStoreSession</code> protocol and the implementation <code>DefaultTrustStoreSession</code> provide interfaces for validating certificates. Validity of the IDP Certificates is always checked, as the discovery document is only available as a stream, and each access will trigger a validity check. FD Certificates</p>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-68-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:68</code></h4>

<p><code>DefaultTrustStoreSession</code> coordinates loading and validity checking</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218,A_21222#2] `DefaultTrustStoreSession` coordinates loading and validity checking
extension DefaultTrustStoreSession: TrustStoreSession {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-264-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:264</code></h4>

<p>DiscoveryDocument is validated with the active trustStoreSession</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Resi_6#2] Implementation of loading the discovery document for fetching signature and
// encryption keys.
// [REQ:gemSpec_Krypt:A_21222#3] DiscoveryDocument is validated with the active trustStoreSession
private func loadDiscoveryDocument() -&gt; AnyPublisher&lt;DiscoveryDocument, IDPError&gt; {

</code></pre>
<h4 id='code-sources-vauclient-vaucertificate-swift-20-code' class='heading'><code>../Sources/VAUClient/VAUCertificate.swift:20</code></h4>

<p>Vau Certificate provider</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21222#4|7] Vau Certificate provider
func loadAndVerifyVauCertificate() -&gt; AnyPublisher&lt;VAUCertificate, VAUError&gt; {
    trustStoreSession.loadVauCertificate()
        .first()
        .mapError { $0.asVAUError() }
        .map { X509VAUCertificate(x509: $0) }
        .eraseToAnyPublisher()
}
</code></pre>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-75-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:75</code></h4>

<p>Loading of the whole trust store, filtering for vau certificate</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21222#5|5] Loading of the whole trust store, filtering for vau certificate
public func loadVauCertificate() -&gt; AnyPublisher&lt;X509, TrustStoreError&gt; {
    loadOCSPCheckedTrustStore()
        .map(\.vauCert)
        .eraseToAnyPublisher()
}
</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_21275-a_21275-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_21275">A_21275</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>TLS is enforced by the platform for every HTTP connection. Certain domains can be excluded from this rule by listing them in a dedicated NSAppTransportSecurity exception list. This list is empty for our application, see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_21275-e2-88-9201-a_21275-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_21275%E2%88%9201">A_21275−01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>TLS is enforced by the platform for every HTTP connection. Certain domains can be excluded from this rule by listing them in a dedicated NSAppTransportSecurity exception list. This list is empty for our application, see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_21332-02-a_21332-02-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_21332-02">A_21332-02</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21332-02" severity="MUSS" class="target-element">
<p><b>A_21332-02 - E-Rezept: TLS-Vorgaben</b></p>
<p>Ein E-Rezept-FD, ein Apothekenverzeichnis, ein E-Rezept-Client und ein IDP MÜSSEN in Bezug auf die TLS-Verbindung zwischen ihnen 
</p>
<ol> 
<li>folgende Ciphersuiten unterstützen</li> 
<ul> 
<li>TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 (0xC0, 0x30),</li> 
<li>TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256 (0xC0, 0x2F),</li> 
<li>TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384 (0xC0, 0x2C),</li> 
<li>TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256 (0xC0, 0x2B).</li> 
</ul> 
<li>Sie KÖNNEN weitere Cipher-Suiten aus [TR-02102-2, Abschnitt 3.3.1 Tabelle 1] unterstützen. </li> 
<li>Bei dem ephemeren Elliptic-Curve-Diffie-Hellman-Schlüsselaustausch und bei der Signaturprüfung mittels ECDSA MÜSSEN die Kurven P-256 oder P-384 [FIPS-186-5] unterstützt werden. Daneben SOLLEN die Kurven brainpoolP256r1, brainpoolP384r1 oder brainpoolP512r1 (vgl. [RFC-5639] und [RFC-7027]) unterstützt werden. Andere Kurven SOLLEN NICHT verwendet werden (Hinweis: die Intention des letzten Satzes ist insbesondere, dass die Ordnung des Basispunktes in E(F_p) nicht zu klein werden darf).</li> 
</ol> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>TLS is enforced by the platform for every HTTP connection. Certain domains can be excluded from this rule by listing them in a dedicated NSAppTransportSecurity exception list. This list is empty for our application, see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-a_4389-a_4389-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#A_4389">A_4389</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='1-code-sources-vauclient-internal-vaucrypto-swift-94-code' class='heading'>1 <code>../Sources/VAUClient/internal/VAUCrypto.swift:94</code></h4>

<p>IVs must not be reused, IVs bit length must be larger or equal to 96</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_4389:1] IVs must not be reused, IVs bit length must be larger or equal to 96
let nonceGenerator = { try VAURandom.generateSecureRandom(length: self.eciesSpec.ivSize) }

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-a_4357-gs-a_4357-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS-A_4357">GS-A_4357</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-internal-idpcrypto-swift-15-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:15</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>/// Key-pair generator type based on BrainpoolP256r1
///
/// [REQ:gemSpec_Krypt:GS-A_4357,GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
public typealias BrainpoolKeyGenerator = () throws -&gt; BrainpoolP256r1.KeyExchange.PrivateKey

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwe-kdf-swift-31-code' class='heading'><code>../Sources/IDP/internal/JWT/JWE+KDF.swift:31</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4357] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:gemSpec_Krypt:GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
case bpp256r1(BrainpoolP256r1.KeyExchange.PublicKey,

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-99-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:99</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4357] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:gemSpec_Krypt:GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:BSI-eRp-ePA:O.Cryp_3#5] Brainpool key generator
// [REQ:gemSpec_eRp_FdV:A_19179#5] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
let keyPairGenerator = { try BrainpoolP256r1.KeyExchange.generateKey() }

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-a_4357-01-gs-a_4357-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS-A_4357-01">GS-A_4357-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-289-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:289</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// Validate JWT/DiscoveryDocument signature
// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02] Assure that brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4361-02] Assure that brainpoolP256r1 is used
// [REQ:BSI-eRp-ePA:O.Resi_6#4] Discovery Document signature verification
guard (try? fetchedDocument.backing.verify(with: fetchedDocument.discKey)) ?? false else {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-635-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:635</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_IDP_Frontend:A_19908-01] Signature check
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let verified = try? challenge.challenge.verify(with: document.authentication.cert),

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-24-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:24</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02]
public func verify(signature raw: Data, message: Data) throws -&gt; Bool {

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-34-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:34</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let key = brainpoolP256r1VerifyPublicKey() else {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-473-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:473</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
let alg: JWT.Algorithm = .bp256r1

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-518-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:518</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let alg = autCertificateResponse.info.algorithm.alg

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-606-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:606</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
var alg: JWT.Algorithm? {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-a_4357-02-gs-a_4357-02-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS-A_4357-02">GS-A_4357-02</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="GS-A_4357-02" severity="MUSS" class="target-element">
<p><b>GS-A_4357-02 - X.509-Identitäten für die Erstellung und Prüfung digitaler nicht-qualifizierter elektronischer Signaturen</b></p>
<p>Alle Produkttypen, die X.509-Identitäten bei der Erstellung oder Prüfung digitaler nicht-qualifizierter elektronischer Signaturen verwenden, MÜSSEN die in Tab_KRYPT_002 aufgeführten Algorithmen unterstützen und die Tabellenvorgaben erfüllen. <br>Produkttypen, die Zertifikate (X.509-Identitäten) auf Basis der Schlüsselgeneration „ECDSA“ ausstellen (vgl. Abschnitt 5.1) oder verwenden, MÜSSEN die in Tab_KRYPT_002a aufgeführten Algorithmen und die Tabellenvorgaben erfüllen. <br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-289-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:289</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// Validate JWT/DiscoveryDocument signature
// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02] Assure that brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4361-02] Assure that brainpoolP256r1 is used
// [REQ:BSI-eRp-ePA:O.Resi_6#4] Discovery Document signature verification
guard (try? fetchedDocument.backing.verify(with: fetchedDocument.discKey)) ?? false else {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-635-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:635</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_IDP_Frontend:A_19908-01] Signature check
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let verified = try? challenge.challenge.verify(with: document.authentication.cert),

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-24-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:24</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02]
public func verify(signature raw: Data, message: Data) throws -&gt; Bool {

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-34-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:34</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let key = brainpoolP256r1VerifyPublicKey() else {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-473-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:473</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
let alg: JWT.Algorithm = .bp256r1

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-518-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:518</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let alg = autCertificateResponse.info.algorithm.alg

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-606-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:606</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
var alg: JWT.Algorithm? {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-a_4359-gs-a_4359-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS-A_4359">GS-A_4359</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>TLS is enforced by the platform for every HTTP connection. Certain domains can be excluded from this rule by listing them in a dedicated NSAppTransportSecurity exception list. This list is empty for our application, see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-a_4361-02-gs-a_4361-02-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS-A_4361-02">GS-A_4361-02</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="GS-A_4361-02" severity="MUSS" class="target-element">
<p><b>GS-A_4361-02 - X.509-Identitäten für die Erstellung und Prüfung digitaler Signaturen</b></p>
<p>Alle Produkttypen, die X.509-Identitäten verwenden, die zur Erstellung und Prüfung digitaler Signaturen in Bezug auf TI-Komponenten (technische X.509-Zertifikate) genutzt werden, MÜSSEN alle in Tab_KRYPT_002 aufgeführten Algorithmen unterstützen und die Tabellenanforderungen erfüllen.    <br>Produkttypen die Zertifikate (X.509-Identitäten) auf Basis der Schlüsselgeneration „ECDSA“ ausstellen (vgl. Abschnitt 5.1) oder verwenden, MÜSSEN die in Tab_KRYPT_002a aufgeführten Algorithmen und die Tabellenvorgaben erfüllen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-defaultidpsession-swift-290-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:290</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// Validate JWT/DiscoveryDocument signature
// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02] Assure that brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4361-02] Assure that brainpoolP256r1 is used
// [REQ:BSI-eRp-ePA:O.Resi_6#4] Discovery Document signature verification
guard (try? fetchedDocument.backing.verify(with: fetchedDocument.discKey)) ?? false else {

</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-635-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:635</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_IDP_Frontend:A_19908-01] Signature check
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let verified = try? challenge.challenge.verify(with: document.authentication.cert),

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-24-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:24</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02]
public func verify(signature raw: Data, message: Data) throws -&gt; Bool {

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-34-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:34</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let key = brainpoolP256r1VerifyPublicKey() else {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-473-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:473</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
let alg: JWT.Algorithm = .bp256r1

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-518-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:518</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let alg = autCertificateResponse.info.algorithm.alg

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-606-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:606</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
var alg: JWT.Algorithm? {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-a_4367-gs-a_4367-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS-A_4367">GS-A_4367</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="GS-A_4367" severity="MUSS" class="target-element">
<p><b>GS-A_4367 - Zufallszahlengenerator</b></p>
<p>Alle Produkttypen, die Zufallszahlen generieren, MÜSSEN die Anforderungen aus [BSI-TR-03116-1#3.<span style="text-decoration: line-through;background-color: #FFFF99;"></span>8 Erzeugung von Zufallszahlen] erfüllen.<br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-internal-idpcrypto-swift-15-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:15</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>/// Key-pair generator type based on BrainpoolP256r1
///
/// [REQ:gemSpec_Krypt:GS-A_4357,GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
public typealias BrainpoolKeyGenerator = () throws -&gt; BrainpoolP256r1.KeyExchange.PrivateKey

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwe-kdf-swift-32-code' class='heading'><code>../Sources/IDP/internal/JWT/JWE+KDF.swift:32</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4357] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:gemSpec_Krypt:GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
case bpp256r1(BrainpoolP256r1.KeyExchange.PublicKey,

</code></pre>
<h4 id='code-sources-idp-internal-seckeyrandom-swift-20-code' class='heading'><code>../Sources/IDP/internal/SecKeyRandom.swift:20</code></h4>
<pre class="highlight plaintext"><code>/// Generate random Data with given length
///
/// [REQ:gemSpec_Krypt:GS-A_4367]
/// [REQ:BSI-eRp-ePA:O.Rand_1#2] Secure Random generator.
///
/// - Parameters:
///   - length: the number of bytes to generate
///   - randomizer: the randomizer to be used. Default: kSecRandomDefault
/// - Returns: the random initialized Data
/// - Throws: `IDPError`
public func generateSecureRandom(length: Int, randomizer: SecRandomRef? = kSecRandomDefault) throws -&gt; Data {

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-100-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:100</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4357] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:gemSpec_Krypt:GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:BSI-eRp-ePA:O.Cryp_3#5] Brainpool key generator
// [REQ:gemSpec_eRp_FdV:A_19179#5] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
let keyPairGenerator = { try BrainpoolP256r1.KeyExchange.generateKey() }

</code></pre>
<h4 id='code-sources-vauclient-internal-vaurandom-swift-21-code' class='heading'><code>../Sources/VAUClient/internal/VAURandom.swift:21</code></h4>
<pre class="highlight plaintext"><code>/// Generate random Data with given length
///
/// [REQ:gemSpec_Krypt:GS-A_4367]
/// [REQ:BSI-eRp-ePA:O.Rand_1#3] Secure Random generator.
///
/// - Parameters:
///   - length: the number of bytes to generate
///   - randomizer: the randomizer to be used. Default: kSecRandomDefault
/// - Returns: the random initialized Data
/// - Throws: `VAUError`
static func generateSecureRandom(length: Int, randomizer: SecRandomRef? = kSecRandomDefault) throws -&gt; Data {

</code></pre>

<p>We use the platform provided secure random generator. iOS is <a href="https://csrc.nist.gov/CSRC/media/projects/cryptographic-module-validation-program/documents/security-policies/140sp3431.pdf">FIPS 140-2</a> certified. The operating system uses an entropy pool with different sources, including a <a href="https://support.apple.com/en-gb/guide/security/seca0c73a75b/web">true random number generator</a> from the secure enclave, that is present on every device. Security certifcates can be found <a href="https://support.apple.com/de-li/guide/certifications/apc3fa917cb49/web">https://support.apple.com/de-li/guide/certifications/apc3fa917cb49/web</a>, including FIPS 140-2 und Common Criteria.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-a_4368-gs-a_4368-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS-A_4368">GS-A_4368</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="GS-A_4368" severity="MUSS" class="target-element">
<p><b>GS-A_4368 - Schlüsselerzeugung</b></p>
<p>Alle Produkttypen, die Schlüssel erzeugen, MÜSSEN die Anforderungen aus [BSI-TR-03116-1#3.<span style="text-decoration: line-through;background-color: #FFFF99;"></span>9 Schlüsselerzeugung] erfüllen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-internal-idpcrypto-swift-56-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:56</code></h4>

<p>AES key generation via CryptoKit</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:1] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#3] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
// [REQ:gemSpec_IDP_Frontend:A_21323#4] AES key generation via CryptoKit
aesKey: SymmetricKey = SymmetricKey(size: SymmetricKeySize(bitCount: 256))

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-152-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:152</code></h4>

<p>AES key generation via CryptoKit</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:2] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#6] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
let secretKey = SymmetricKey(data: sharedSecret)

</code></pre>

<p>We use the platform provided secure random generator. iOS is <a href="https://csrc.nist.gov/CSRC/media/projects/cryptographic-module-validation-program/documents/security-policies/140sp3431.pdf">FIPS 140-2</a> certified. The operating system uses an entropy pool with different sources, including a <a href="https://support.apple.com/en-gb/guide/security/seca0c73a75b/web">true random number generator</a> from the secure enclave, that is present on every device. Security certifcates can be found <a href="https://support.apple.com/de-li/guide/certifications/apc3fa917cb49/web">https://support.apple.com/de-li/guide/certifications/apc3fa917cb49/web</a>, including FIPS 140-2 und Common Criteria.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-a_4385-gs-a_4385-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS-A_4385">GS-A_4385</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="GS-A_4385" severity="MUSS" class="target-element">
<p><b>GS-A_4385 - TLS-Verbindungen, Version 1.2</b></p>
<p>Alle Produkttypen, die Übertragungen mittels TLS durchführen, MÜSSEN die TLS-Version 1.2 [RFC-5246] unterstützen.<br> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-33-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:33</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_IDP_Frontend:A_20606#2] Setup of minimum TLS Version to use.
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework
urlSessionConfiguration.tlsMinimumSupportedProtocolVersion = .TLSv12

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-a_4387-gs-a_4387-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS-A_4387">GS-A_4387</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="GS-A_4387" severity="DARF NICHT" class="target-element">
<p><b>GS-A_4387 - TLS-Verbindungen, nicht Version 1.0</b></p>
<p>Alle Produkttypen, die Übertragungen mittels TLS durchführen, DÜRFEN NICHT die TLS-Version 1.0 unterstützen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-33-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:33</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_IDP_Frontend:A_20606#2] Setup of minimum TLS Version to use.
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework
urlSessionConfiguration.tlsMinimumSupportedProtocolVersion = .TLSv12

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-a_4389-gs-a_4389-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS-A_4389">GS-A_4389</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="GS-A_4389" severity="MUSS" class="target-element">
<p><b>GS-A_4389 - Symmetrischer Anteil der hybriden Verschlüsselung binärer Daten</b></p>
<p></p>
<p style="margin-left: 0px;"><span>Produkttypen, die die hybride Verschlüsselung binärer Daten durchführen, MÜ</span><span>S</span><span>SEN für den symmetrischen Anteil der Verschlüsselung die folgenden Vorgaben berück</span><span>sic</span><span>h</span><span>tigen:</span></p>
<ul>
<li><p><span>Als symmetrische Block-Chiffre muss AES [FIPS-197] mit einer Schlüs</span><span>sellänge von 256 Bit im Galois/Counter Mode (GCM) g</span><span>e</span><span>mäß [NIST-SP-800-38D] mit der Tag-Länge von 128 Bit verwe</span><span>n</span><span>det werden.</span></p></li>
<li><p><span>Die IVs dürfen sich bei gleichem Schlüssel nicht wiederholen (vgl. [NIST-SP-800-38D#S.25] und [BSI-TR-02102-1#S.24]). Der IV soll e</span><span>i</span><span>ne Bitlänge von 96 Bit besitzen, seine Länge muss mindestens 96 Bit sein. Es wird empfohlen den IV zufällig zu wä</span><span>h</span><span>len (vgl. [gem</span><span>Spec_Krypt#GS-A_4367]).</span></p></li>
<li><p><span>Hinweis: Im Normalfall ist davon auszugehen, dass für die Sicherung der I</span><span>n</span><span>tegrität und Authentizität der zu verschlüsselnden Daten zudem noch eine Signatur dieser Daten notwe</span><span>n</span><span>dig ist.</span></p></li>
</ul> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='2-code-sources-idp-internal-idpcrypto-swift-48-code' class='heading'>2 <code>../Sources/IDP/internal/IDPCrypto.swift:48</code></h4>

<p>IVs must not be reused, IVs bit length must be larger or equal to 96</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:2] IVs must not be reused, IVs bit length must be larger or equal to 96
try generateSecureRandom(length: IDPCrypto.AES256GCMSpec.nonceBytes)

</code></pre>
<h4 id='1-code-sources-idp-internal-idpcrypto-swift-54-code' class='heading'>1 <code>../Sources/IDP/internal/IDPCrypto.swift:54</code></h4>

<p>256bit GCM symmetric key</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:1] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#3] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
// [REQ:gemSpec_IDP_Frontend:A_21323#4] AES key generation via CryptoKit
aesKey: SymmetricKey = SymmetricKey(size: SymmetricKeySize(bitCount: 256))

</code></pre>
<h4 id='2-code-sources-vauclient-internal-vaucrypto-swift-150-code' class='heading'>2 <code>../Sources/VAUClient/internal/VAUCrypto.swift:150</code></h4>

<p>256bit GCM symmetric key</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:2] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#6] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
let secretKey = SymmetricKey(data: sharedSecret)

</code></pre>
<h4 id='1-code-sources-vauclient-internal-vaucrypto-swift-169-code' class='heading'>1 <code>../Sources/VAUClient/internal/VAUCrypto.swift:169</code></h4>

<p>256bit GCM symmetric key</p>
<pre class="highlight plaintext"><code>// f) Encrypt
// [REQ:gemSpec_Krypt:GS-A_4389:1] 256bit GCM symmetric key
let sealedBox = try AES.GCM.seal(payload, using: cek, nonce: nonce)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-a_4390-gs-a_4390-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS-A_4390">GS-A_4390</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="GS-A_4390" severity="MUSS" class="target-element">
<p><b>GS-A_4390 - Asymmetrischer Anteil der hybriden Verschlüsselung binärer Daten</b></p>
<p>Produkttypen, die die hybride Verschlüsselung binärer Daten durchführen, MÜSSEN für den asymmetrischen Anteil der Verschlüsselung die folgenden Vorgaben berücksichtigen:<br> 
</p>
<ul> 
<li>Als asymmetrisches Verschlüsselungsverfahren MUSS RSAES-OAEP gemäß [PKCS#1, Kapitel 7.1] verwendet werden.<br> </li> 
<li>Als Mask-Generation-Function für die Verwendung in RSAES-OAEP MUSS MGF 1 mit SHA-256 als Hash-Funktion gemäß [PKCS#1, Anhang B.2.1] verwendet werden.<br> </li> 
</ul> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-avs-avscmsencrypter-swift-21-code' class='heading'><code>../Sources/AVS/AVSCmsEncrypter.swift:21</code></h4>

<p>RSAES-OAEP with MGF1 implemented in sub-framework OpenSSL-swift</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4390] RSAES-OAEP with MGF1 implemented in sub-framework OpenSSL-swift
// [REQ:gemSpec_eRp_FdV:A_22778-01#3] Encryption of message to the Pharmacy is done with all provided
// certificates
// [REQ:gemSpec_eRp_FdV:A_22779-01#3] Encrypted message is of form of a PKCS#7 container (CMS)
// https://github.com/gematik/OpenSSL-Swift/blob/3c1ea91ba5abfefecfe3588815cb928d777e29ad/Sources/OpenSSL/CMS/CMSContentInfo.swift#L88
// swiftlint:disable:previous line_length
let cms = try CMSContentInfo.encryptPartial(data: data)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-e2-88-92a_5035-gs-a_5035-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS%E2%88%92A_5035">GS−A_5035</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use https only, see <code>DefaultHTTPClient.swift</code>. ATS forbids other connections.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-e2-88-92a_5322-gs-a_5322-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS%E2%88%92A_5322">GS−A_5322</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>There is no API to control the session length, developer forums suggest it is 10 minutes for iOS.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-e2-88-92a_5339-gs-a_5339-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS%E2%88%92A_5339">GS−A_5339</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We cannot interfere with cipher suite lists, see <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a> for actual order.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-e2-88-92a_5526-gs-a_5526-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS%E2%88%92A_5526">GS−A_5526</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use the recommended NSURLSession for best network security <a href="https://developer.apple.com/documentation/security/preventing_insecure_network_connections">Preventing insecure network connections</a></p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_krypt-latest-index-html-gs-e2-88-92a_5542-gs-a_5542-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_Krypt/latest/index.html#GS%E2%88%92A_5542">GS−A_5542</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use the recommended NSURLSession for best network security <a href="https://developer.apple.com/documentation/security/preventing_insecure_network_connections">Preventing insecure network connections</a></p>
<h2 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_apovzd-latest-index-html-gemspec_erp_apovzd-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_APOVZD/latest/index.html">gemSpec_eRp_APOVZD</a></h2>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_apovzd-latest-index-html-a_21154-a_21154-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_APOVZD/latest/index.html#A_21154">A_21154</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_21154" severity="MUSS" class="target-element">
<p><b>A_21154 - Client des Apothekenverzeichnisses - Erlaubnis Standortabfrage</b></p>
<p>Das Clientsystem MUSS vom Nutzer vor der ersten Abfrage zu dessen aktueller Geoposition die Einwilligung zur Abfrage und Zustimmung zur Übermittlung an das Apothekenverzeichnis einholen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-pharmacy-search-pharmacysearchdomain-swift-534-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Search/PharmacySearchDomain.swift:534</code></h4>

<p>If user defined filters contain location element, ask for permission</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_APOVZD:A_21154] If user defined filters contain location element, ask for permission
if filterOptions.contains(.currentLocation) {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_apovzd-latest-index-html-a_21779-a_21779-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_APOVZD/latest/index.html#A_21779">A_21779</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-pharmacy-modelsr4-bundle-location-swift-138-code' class='heading'><code>../Sources/Pharmacy/ModelsR4.Bundle+Location.swift:138</code></h4>

<p>delivery pharmacy</p>
<pre class="highlight plaintext"><code>// [[REQ:gemSpec_eRp_APOVZD:A_21779] delivery pharmacy
case "498":

</code></pre>
<h4 id='code-sources-pharmacy-modelsr4-bundle-location-swift-195-code' class='heading'><code>../Sources/Pharmacy/ModelsR4.Bundle+Location.swift:195</code></h4>

<p>Map pickup pharmacy</p>
<pre class="highlight plaintext"><code>// [[REQ:gemSpec_eRp_APOVZD:A_21779] Map pickup pharmacy
case "OUTPHARM":

</code></pre>
<h4 id='code-sources-pharmacy-modelsr4-bundle-location-swift-200-code' class='heading'><code>../Sources/Pharmacy/ModelsR4.Bundle+Location.swift:200</code></h4>

<p>Map shipping pharmacy</p>
<pre class="highlight plaintext"><code>// [[REQ:gemSpec_eRp_APOVZD:A_21779] Map shipping pharmacy
case "MOBL":

</code></pre>
<h2 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-gemspec_erp_fdv-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html">gemSpec_eRp_FdV</a></h2>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19086-a_19086-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19086">A_19086</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19086" severity="DARF NICHT" class="target-element">
<p><b>A_19086 - E-Rezept-FdV: Verbot von Werbe-Tracking</b></p>
<p><span style="font-size: 10pt;line-height: 1.5;">Das E-Rezept-FdV DARF ein Werbe-Tracking NICHT verwenden. </span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Tracking is only implemented for the purpose of Usability-Tracking. Sessions are not persisted, session ids are recreated each app startup.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19087-a_19087-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19087">A_19087</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Tracking is only implemented for the purpose of Usability-Tracking. Sessions are not persisted, session ids are recreated each app startup.</p>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-13-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:13</code></h4>

<p>Implementation of the opt-in usability-tracker.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19087#2] Implementation of the opt-in usability-tracker.
final class ContentSquareAnalyticsAdapter: NSObject, Tracker {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19088-a_19088-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19088">A_19088</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-189-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:189</code></h4>

<p>Show comply route to display analytics usage within</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19088,A_19091-01#1,A_19092-01#2] Show comply route to display analytics usage within
// onboarding
// [REQ:BSI-eRp-ePA:O.Purp_3#5] Show comply route to display analytics usage within onboarding
// [REQ:gemSpec_eRp_FdV:A_19089-01#2] Show comply route to display analytics usage within onboarding
case .showTracking:

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19089-01-a_19089-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19089-01">A_19089-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19089-01" severity="MUSS" class="target-element">
<p><b>A_19089-01 - E-Rezept-FdV: Informationen zur Einwilligung</b></p>
<p>Das E-Rezept-FdV MUSS, falls es Tracking-Funktionen implementiert, die Tracking-Daten mehrerer Nutzersessions verknüpfen, den Versicherten vor der Einwilligung in die Aktivierung dieser Tracking-Funktion in verständlicher und leicht zugänglicher Form sowie in einer klaren und einfachen Sprache folgende Einwilligungsinformationen anzeigen: 
</p>
<ul> 
<li>welche Daten durch die Tracking-Funktionen erhoben werden,</li> 
<li>zu welchen Zwecken die Daten erhoben werden,</li> 
<li>welche Informationen durch die Auswertung der erhobenen Daten gewonnen werden und ob Rückschlüsse auf den Gesundheitszustand des Nutzers möglich wären,</li> 
<li>wer die Empfänger der Daten sind,</li> 
<li>wie lange die Daten gespeichert werden</li> 
<li>wie die Tracking-Funktionen deaktiviert werden können.</li> 
</ul> <b>[&lt;=]</b>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We do not link user session of multiple app starts, we forcefully regenerate a new user-id. Nevertheless the following still applies: Opt-In for Analytics will be asked while the app onboarding runs. After the onboarding ran, the user may change the analytics settings in the settings menu.</p>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-192-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:192</code></h4>

<p>Show comply route to display analytics usage within onboarding</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19088,A_19091-01#1,A_19092-01#2] Show comply route to display analytics usage within
// onboarding
// [REQ:BSI-eRp-ePA:O.Purp_3#5] Show comply route to display analytics usage within onboarding
// [REQ:gemSpec_eRp_FdV:A_19089-01#2] Show comply route to display analytics usage within onboarding
case .showTracking:

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-47-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:47</code></h4>

<p>Show information dialog for analytics usage</p>
<pre class="highlight plaintext"><code>// Tracking comply sheet presentation
// [REQ:BSI-eRp-ePA:O.Purp_5#3] Show comply view for settings triggered analytics enabling
// [REQ:gemSpec_eRp_FdV:A_19982#3,A_19089-01#3] Show information dialog for analytics usage
Rectangle()

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-177-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:177</code></h4>

<p>User info for usage analytics</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19089-01#4] User info for usage analytics
Label(title: { Text(L10n.stgTrkTxtExplanation) }, icon: {})

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19090-a_19090-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19090">A_19090</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-61-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:61</code></h4>

<p>activate tracking only if permitted</p>
<pre class="highlight plaintext"><code>/// Starts tracking and calls `optIn` if permission is granted by the user.
/// Calling this method after calling `resetSessionID()` will create a new `sessionID`
// [REQ:gemSpec_eRp_FdV:A_19090] activate tracking only if permitted
private func startIfPermitted() {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19090-01-a_19090-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19090-01">A_19090-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19090-01" severity="MUSS" class="target-element">
<p><b>A_19090-01 - E-Rezept-FdV: Aktivierung erst nach Lesebestätigung der Einwilligungsinformationen</b></p>
<p>Das E-Rezept-FdV MUSS sicherstellen, falls es Tracking-Funktionen implementiert, die Tracking-Daten mehrerer Nutzersessions verknüpfen,  dass die Einwilligung des Nutzers in die Aktivierung dieser Tracking-Funktionen erst erfolgt, wenn der Nutzer bestätigt, die angezeigten Einwilligungsinformationen gelesen zu haben. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-scenedelegate-swift-300-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:300</code></h4>

<p>activate after optIn is granted</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090-01] activate after optIn is granted
tracker.stopTracking()

</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-194-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:194</code></h4>

<p>User confirms the opt in within settings</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090-01,A_19091-01#2] User confirms the opt in within settings
// [REQ:BSI-eRp-ePA:O.Purp_3#6] Accept usage analytics
case .alert(.presented(.allowTracking)):

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-165-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:165</code></h4>

<p>User confirms the opt in within settings</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090-01,A_19091-01#4] User confirms the opt in within settings
// [REQ:BSI-eRp-ePA:O.Purp_5#4] User confirms the opt in within settings
case .confirmedOptInTracking:

</code></pre>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-43-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:43</code></h4>

<p>activate after optIn is granted</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090-01] activate after optIn is granted
Contentsquare.start()

</code></pre>

<p>We do not link user session of multiple app starts, we forcefully regenerate a new user-id. Nevertheless the following still applies: Opt-In for Analytics will be asked while the app onboarding runs. After the onboarding ran, the user may change the analytics settings in the settings menu.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19091-01-a_19091-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19091-01">A_19091-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19091-01" severity="MUSS" class="target-element">
<p><b>A_19091-01 - E-Rezept-FdV: Verbot von mehrmaligen Einwilligungsabfragen</b></p>
<p><span style="font-size: 10pt;line-height: 1.5;">Das E-Rezept-FdV </span>MUSS, falls es Tracking-Funktionen implementiert, die Tracking-Daten mehrerer Nutzersessions verknüpfen, technisch sicherstellen, dass der Benutzer der App maximal einmal eine Abfrage zur Einwilligung in das Tracking angezeigt bekommt. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We do not link user session of multiple app starts, we forcefully regenerate a new user-id. Nevertheless the following still applies: Opt-In for Analytics will be asked while the app onboarding runs. After the onboarding ran, the user may change the analytics settings in the settings menu.</p>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-189-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:189</code></h4>

<p>Show comply route to display analytics usage within</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19088,A_19091-01#1,A_19092-01#2] Show comply route to display analytics usage within
// onboarding
// [REQ:BSI-eRp-ePA:O.Purp_3#5] Show comply route to display analytics usage within onboarding
// [REQ:gemSpec_eRp_FdV:A_19089-01#2] Show comply route to display analytics usage within onboarding
case .showTracking:

</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-194-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:194</code></h4>

<p>User confirms the opt in within settings</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090-01,A_19091-01#2] User confirms the opt in within settings
// [REQ:BSI-eRp-ePA:O.Purp_3#6] Accept usage analytics
case .alert(.presented(.allowTracking)):

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-156-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:156</code></h4>

<p>Show comply route to display analytics usage within settings</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19091-01#3] Show comply route to display analytics usage within settings
state.destination = .complyTracking(.init())

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-165-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:165</code></h4>

<p>User confirms the opt in within settings</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090-01,A_19091-01#4] User confirms the opt in within settings
// [REQ:BSI-eRp-ePA:O.Purp_5#4] User confirms the opt in within settings
case .confirmedOptInTracking:

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19092-01-a_19092-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19092-01">A_19092-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19092-01" severity="DARF NICHT" class="target-element">
<p><b>A_19092-01 - E-Rezept-FdV: Kopplungsverbot</b></p>
<p>Das E-Rezept-FdV DARF, falls es Tracking-Funktionen implementiert, die Tracking-Daten mehrerer Nutzersessions verknüpfen, die Nutzung des E-Rezept-FdV NICHT an die Aktivierung des Session-übergreifenden Tracking koppeln. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We do not link user session of multiple app starts, we forcefully regenerate a new user-id. Nevertheless the following still applies: Opt-In for Analytics will be asked while the app onboarding runs. After the onboarding ran, the user may change the analytics settings in the settings menu.</p>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-189-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:189</code></h4>

<p>Show comply route to display analytics usage within</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19088,A_19091-01#1,A_19092-01#2] Show comply route to display analytics usage within
// onboarding
// [REQ:BSI-eRp-ePA:O.Purp_3#5] Show comply route to display analytics usage within onboarding
// [REQ:gemSpec_eRp_FdV:A_19089-01#2] Show comply route to display analytics usage within onboarding
case .showTracking:

</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-199-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:199</code></h4>

<p>User may choose to not accept analytics, onboarding will still continue</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19092-01#3] User may choose to not accept analytics, onboarding will still continue
// [REQ:BSI-eRp-ePA:O.Purp_3#7] Deny usage analytics
case .alert(.dismiss):

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19093-01-a_19093-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19093-01">A_19093-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19093-01" severity="MUSS" class="target-element">
<p><b>A_19093-01 - E-Rezept-FdV: Keine direkt identifizierenden personenbezogenen Daten</b></p>
<p>Das E-Rezept-FdV MUSS sicherstellen, falls es Tracking-Funktionen implementiert, dass die Tracking-Informationen keine Daten enthalten, die natürliche Personen direkt identifizieren. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Usage Tracking is called very sparse and boils down to one place where all visited screens are recorded. See usage of <code>@Dependency(\.tracker)</code> for all cases where the actual analytics framework is used.</p>
<h4 id='code-sources-erpapp-tracking-analyticsreducer-swift-38-code' class='heading'><code>../Sources/eRpApp/Tracking/AnalyticsReducer.swift:38</code></h4>

<p>Very sparse usage of actual tracking boils down to this call where</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19093-01#2] Very sparse usage of actual tracking boils down to this call where
// only displayed screens are tracked
tracker.track(screen: newRoute)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19094-01-a_19094-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19094-01">A_19094-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19094-01" severity="MUSS" class="target-element">
<p><b>A_19094-01 - E-Rezept-FdV: Keine Weitergabe von Sicherheitsmerkmalen</b></p>
<p>Das E-Rezept-FdV MUSS sicherstellen, falls es Tracking-Funktionen implementiert, dass in den übermittelten Tracking-Informationen keine Sicherheitsmerkmale enthalten sind. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Usage Tracking is called very sparse and boils down to one place where all visited screens are recorded. See usage of <code>@Dependency(\.tracker)</code> for all cases where the actual analytics framework is used.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19095-a_19095-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19095">A_19095</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-74-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:74</code></h4>

<p>resets sessionID so that on next app start a new sessionID will be created</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19095] resets sessionID so that on next app start a new sessionID will be created
Contentsquare.optOut()

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19096-01-a_19096-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19096-01">A_19096-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19096-01" severity="MUSS" class="target-element">
<p><b>A_19096-01 - E-Rezept-FdV: Jederzeit neue Generierung der Pseudonyme</b></p>
<p>Das E-Rezept-FdV MUSS, falls es Tracking-Funktionen implementiert, die Tracking-Daten mehrerer Nutzersessions verknüpfen, technisch sicherstellen, dass eine neue Generierung der pseudonymen Identifier jederzeit durch den Nutzer des FdVs veranlasst werden kann. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We do not link user session of multiple app starts, we forcefully regenerate a new user-id. Nevertheless the following still applies.</p>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-63-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:63</code></h4>

<p>Remove existing sessions while starting the framework, tracking is</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19096-01#1] Remove existing sessions while starting the framework, tracking is
// never cross session.
Contentsquare.start()

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19097-01-a_19097-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19097-01">A_19097-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19097-01" severity="MUSS" class="target-element">
<p><b>A_19097-01 - E-Rezept-FdV: Deaktivierung zu jeder Zeit</b></p>
<p>Das E-Rezept-FdV MUSS technisch sicherstellen, falls es Tracking-Funktionen implementiert, die Tracking-Daten mehrerer Nutzersessions verknüpfen, dass aktivierte Tracking-Funktionen jederzeit durch den Nutzer des FdVs deaktiviert werden können. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We do not link user session of multiple app starts, we forcefully regenerate a new user-id. Nevertheless the following still applies.</p>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-158-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:158</code></h4>

<p>Toggle within Settings to enable and disable usage analytics</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19097-01#2] Toggle within Settings to enable and disable usage analytics
// [REQ:BSI-eRp-ePA:O.Purp_5#1] Toggle within Settings to enable and disable usage analytics
// [REQ:BSI-eRp-ePA:O.Purp_6#1] Current Analytics state is inspectable by the user
// [REQ:gemSpec_eRp_FdV:A_19982#4] Opt out of analytics
Toggle(isOn: $store.trackerOptIn.sending(\.toggleTrackingTapped).animation()) {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19176-a_19176-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19176">A_19176</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Authenticity is provided by the appstore and app signing. We choose secure options where possible as the default value. Where the user can choose options, we inform by presenting additional information (e.g. “storing” the login).</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19177-a_19177-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19177">A_19177</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19177" severity="MUSS" class="target-element">
<p><b>A_19177 - E-Rezept-FdV – Anzeige von Protokolldaten</b></p>
<p><span style="font-size: 10pt;line-height: 1.5;">Das E-Rezept-FdV MUSS es den Versicherten ermöglichen, die für die Fachanwendung für ihn erzeugten Protokolleinträge anzeigen zu können.</span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>An Audit Log for every FD access is available in each user profile.</p>
<h4 id='code-sources-erpapp-screens-settings-profiles-protocol-auditeventsview-swift-12-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Protocol/AuditEventsView.swift:12</code></h4>

<p>View displaying the audit events</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19177#1,A_19185#2] View displaying the audit events
// [REQ:BSI-eRp-ePA:O.Auth_6#3] View displaying the audit events
struct AuditEventsView: View {

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofileview-swift-400-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileView.swift:400</code></h4>

<p>Actual Button to open the audit events</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19177#2,A_19185#3] Actual Button to open the audit events
// [REQ:BSI-eRp-ePA:O.Auth_6#2] Actual Button to open the audit events
NavigationLink(item: $store.scope(state: \.destination?.auditEvents,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19178-a_19178-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19178">A_19178</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19178" severity="MUSS" class="target-element">
<p><b>A_19178 - E-Rezept-FdV – Schutzmaßnahmen gegen die OWASP-Mobile-Top-10-Risiken</b></p>
<p>Das E-Rezept-FdV MUSS Maßnahmen zum Schutz vor den in der jeweils aktuellen Version genannten OWASP-Mobile-Top-10-Risiken [OWASPMobileTop10] umsetzen.  <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Is covered by our MSTG.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19179-a_19179-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19179">A_19179</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Annotation in code</p>
<h4 id='code-sources-idp-internal-idpcrypto-swift-44-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:44</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19179#2] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:BSI-eRp-ePA:O.Cryp_3#3] Brainpool key generator
try BrainpoolP256r1.KeyExchange.generateKey()

</code></pre>
<h4 id='code-sources-idp-internal-idpcrypto-swift-55-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:55</code></h4>

<p>AES key generation via CryptoKit</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:1] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#3] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
// [REQ:gemSpec_IDP_Frontend:A_21323#4] AES key generation via CryptoKit
aesKey: SymmetricKey = SymmetricKey(size: SymmetricKeySize(bitCount: 256))

</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwe-kdf-swift-36-code' class='heading'><code>../Sources/IDP/internal/JWT/JWE+KDF.swift:36</code></h4>

<p>Key pair generation delegated to OpenSSL</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_3#4] Brainpool key generator
// [REQ:gemSpec_eRp_FdV:A_19179#4] Key pair generation delegated to OpenSSL
= { try BrainpoolP256r1.KeyExchange.generateKey() })

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-102-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:102</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4357] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:gemSpec_Krypt:GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:BSI-eRp-ePA:O.Cryp_3#5] Brainpool key generator
// [REQ:gemSpec_eRp_FdV:A_19179#5] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
let keyPairGenerator = { try BrainpoolP256r1.KeyExchange.generateKey() }

</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-151-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:151</code></h4>

<p>AES key generation via CryptoKit</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:2] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#6] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
let secretKey = SymmetricKey(data: sharedSecret)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19181-01-a_19181-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19181-01">A_19181-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>There is an opt-in option for analytics. Full app functionality is available also without opting in. The user’s choice is requested during onboarding and the user can opt-in and opt-out of analytics at any time. There are no further configuration choices. After successful authentication via health card the corresponding prescriptions, protocol data and messages are displayed.</p>

<p>The onboarding contains defaults that are best practices, such as using biometrics for authentication. While using the Cardwall, selecting the “save login” option results in an dialog with additional information, to let the user make informed decisions. A missing device passcode results in a dialog that is recommending the setup of a device passcode.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19182-a_19182-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19182">A_19182</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>In order to minimize the risk of unknown vulnerabilities in dependencies, we use different measures: We develop according to Security by Design Principles (see E-Rezept-App - SSDLC.pdf - Section Richtlinien, Vorgaben und Best Practices). We train our engineers focussing on secure design and coding best practices (see Sicherheitsschulungen.pdf). We publish our Code on Github and use a bug bounty program (https://www.gematik.de/datensicherheit -&gt; Coordinated Vulnerability Disclosure Program)</p>

<p>See <a href="#OSource_1">O.Source_1</a> for input/output validation.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19183-a_19183-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19183">A_19183</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We have no implementation of any sharing mechanism of FD data.</p>

<p>See <a href="#OPurp_8">O.Purp_8</a> for usages.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19184-a_19184-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19184">A_19184</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-onboarding-onboardinganalyticsview-swift-20-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingAnalyticsView.swift:20</code></h4>

<p>Information for the user what is collected</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19184] Information for the user what is collected
VStack(alignment: .leading, spacing: 16) {

</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-207-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:207</code></h4>

<p>Alert for the user to choose.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19184] Alert for the user to choose.
static let trackingAlertState: AlertState&lt;Action.Alert&gt; = {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19185-a_19185-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19185">A_19185</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Communication with the Fachdienst is protocoled via Audit Events. The user can revise them in the Settings menu (Profile Settings).</p>
<h4 id='code-sources-erpapp-screens-settings-profiles-protocol-auditeventsview-swift-12-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Protocol/AuditEventsView.swift:12</code></h4>

<p>View displaying the audit events</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19177#1,A_19185#2] View displaying the audit events
// [REQ:BSI-eRp-ePA:O.Auth_6#3] View displaying the audit events
struct AuditEventsView: View {

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofileview-swift-400-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileView.swift:400</code></h4>

<p>Actual Button to open the audit events</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19177#2,A_19185#3] Actual Button to open the audit events
// [REQ:BSI-eRp-ePA:O.Auth_6#2] Actual Button to open the audit events
NavigationLink(item: $store.scope(state: \.destination?.auditEvents,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19186-a_19186-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19186">A_19186</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-17-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:17</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_4#3] Implementation of data storage that is persisted via keychain
// [REQ:BSI-eRp-ePA:O.Source_7#2,O.Data_2#2,O.Auth_13#3] Implementation of data storage that is persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19187-a_19187-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19187">A_19187</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-vauclient-vauinterceptor-swift-39-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:39</code></h4>

<p>VAU Bearer must be set to trigger a request</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19187] VAU Bearer must be set to trigger a request
return vauAccessTokenProvider.vauBearerToken

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19188-a_19188-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19188">A_19188</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>session data (ACCESS_TOKEN, ID_TOKEN, SSO_TOKEN, CAN) is saved in the keychain. Its deletion is managed by the OS. The key chain is sandboxed and can only be shared with other apps by the same vendor when explicitly set. All other mentioned data is deleted.</p>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-18-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:18</code></h4>

<p>Deletion of data saved here is managed by the OS.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_4#3] Implementation of data storage that is persisted via keychain
// [REQ:BSI-eRp-ePA:O.Source_7#2,O.Data_2#2,O.Auth_13#3] Implementation of data storage that is persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19229-01-a_19229-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19229-01">A_19229-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19229-01" severity="MUSS" class="target-element">
<p><b>A_19229-01 - E-Rezept-FdV: E-Rezept lokal löschen - Löschen aller verknüpfter Daten</b></p>
<p>Das E-Rezept-FdV MUSS, wenn es ein E-Rezept lokal im E-Rezept-FdV löscht, auch alle mit dem E-Rezept verknüpften Daten im E-Rezept-FdV löschen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Audit events will be deleted when the referencing task is deleted. Cascading relationship “task -&gt; audit event” is defined in Sources/eRpLocalStorage/Prescriptions/ErxTask.xcdatamodeld/ErxTask.xcdatamodel/contents</p>
<h4 id='code-sources-erpapp-screens-main-prescriptiondetail-prescriptiondetaildomain-swift-195-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionDetail/PrescriptionDetailDomain.swift:195</code></h4>

<p>Deletion button is tapped -&gt; delete confirmation dialog shows</p>
<pre class="highlight plaintext"><code>// Delete
// [REQ:gemSpec_eRp_FdV:A_19229-01#2] Deletion button is tapped -&gt; delete confirmation dialog shows
case .delete:

</code></pre>
<h4 id='code-sources-erpapp-screens-main-prescriptiondetail-prescriptiondetaildomain-swift-205-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionDetail/PrescriptionDetailDomain.swift:205</code></h4>

<p>Confirmation dialog was confirmed, deletion is triggered</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19229-01#3] Confirmation dialog was confirmed, deletion is triggered
case .destination(.presented(.alert(.confirmedDelete))):

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19480-a_19480-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19480">A_19480</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-idp-idpsession-swift-26-code' class='heading'><code>../Sources/IDP/IDPSession.swift:26</code></h4>

<p>usage of this token is limited to FD/IDP Access.</p>
<pre class="highlight plaintext"><code>/// Subscribe to the session's IDPToken and receive the latest (session) token through this Publisher
///
/// [REQ:gemSpec_eRp_FdV:A_19480] usage of this token is limited to FD/IDP Access.
var autoRefreshedToken: AnyPublisher&lt;IDPToken?, IDPError&gt; { get }

</code></pre>
<h4 id='code-sources-idp-idpstorage-swift-34-code' class='heading'><code>../Sources/IDP/IDPStorage.swift:34</code></h4>

<p>usage of this token is limited to FD/IDP Access.</p>
<pre class="highlight plaintext"><code>/// Retrieve and set an IDP Token
/// [REQ:gemSpec_eRp_FdV:A_19480] usage of this token is limited to FD/IDP Access.
var token: AnyPublisher&lt;IDPToken?, Never&gt; { get }

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19739-a_19739-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19739">A_19739</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_19739" severity="MUSS" class="target-element">
<p><b>A_19739 - E-Rezept FdV: verpflichtende Zertifikatsprüfung</b></p>
<p>Das E-Rezept-FdV MUSS alle Zertifikate, die es aktiv verwendet (bspw. TLS-Verbindungsaufbau), auf Integrität und Authentizität prüfen. Falls die Prüfung kein positives Ergebnis (&ldquo;gültig&rdquo;) liefert, so MUSS es die von dem Zertifikat und den darin enthaltenen Attributen (bspw. öffentliche Schlüssel) abhängenden Arbeitsabläufe ablehnen.<br>Das E-Rezept-FdV MUSS alle öffentlichen Schlüssel, die es verwenden will, auf eine positiv verlaufene Zertifikatsprüfung zurückführen können. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>For TLS certificates, this is implemented by not deactivating ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity</code>. For TI Certificates, this is implemented within the TrustStore module.</p>
<h4 id='code-sources-truststore-truststoresession-swift-19-code' class='heading'><code>../Sources/TrustStore/TrustStoreSession.swift:19</code></h4>
<pre class="highlight plaintext"><code>/// Request and validate the VAU certificate
///
/// [REQ:gemSpec_eRp_FdV:A_19739]
///
/// - Returns: A publisher that emits a validated VAU certificate or an error
func loadVauCertificate() -&gt; AnyPublisher&lt;X509, TrustStoreError&gt;

</code></pre>
<h4 id='code-sources-truststore-truststoresession-swift-29-code' class='heading'><code>../Sources/TrustStore/TrustStoreSession.swift:29</code></h4>
<pre class="highlight plaintext"><code>/// Try to validate a given certificate against the underlying truststore.
/// An OCSP response will also be requested and checked against
///
/// [REQ:gemSpec_eRp_FdV:A_19739]
///
/// - Parameter certificate: the certificate to be validated
/// - Returns: A publisher that emits a Boolean stating whether or not the certificate could be validated.
func validate(certificate: X509) -&gt; AnyPublisher&lt;Bool, TrustStoreError&gt;

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19979-a_19979-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19979">A_19979</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>We use external services: The Apothekenverzeichnis and our analytics framework. During the communication with the pharmacy, there will be data shared via a prescription code. The requirement to this feature is described in gemSpec_eRp_FdV sectin 5.2.3.10 and 5.2.3.11.</p>

<p>We do not share sensitive data with third parties. See data usages within <a href="#OPurp_8">O.Purp_8</a> and <a href="#OArch_2">O.Arch_2</a>.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19980-a_19980-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19980">A_19980</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The user is informed and required to accept this information via the data protection statement. Related data and services are listed in sections 5.</p>
<h4 id='code-sources-erpapp-screens-settings-dataprivacy-dataprivacyview-swift-14-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/DataPrivacy/DataPrivacyView.swift:14</code></h4>

<p>Actual View driving the display of <code>DataPrivacy.html</code></p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_1#2] Actual View driving the display of `DataPrivacy.html`
// [REQ:BSI-eRp-ePA:O.Arch_8#3] Webview containing local html without javascript
// [REQ:gemSpec_eRp_FdV:A_19980#2] Actual View driving the display of `DataPrivacy.html`
struct DataPrivacyView: View {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19981-a_19981-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19981">A_19981</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The user is informed and required to accept this information via the data protection statement. Related data and services are listed in sections 5.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19982-a_19982-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19982">A_19982</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>The agreement to the use of the analytics framework can be revoked. But other agreements cannot be revoked, since the app would not operate properly.</p>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-157-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:157</code></h4>

<p>Opt out of analytics</p>
<pre class="highlight plaintext"><code>// Tracking
// [REQ:gemSpec_eRp_FdV:A_19088, A_19089-01#5, A_19092-01#4, A_19097-01#1] React to later opt-in or deactivation
// of usage analytics
// [REQ:BSI-eRp-ePA:O.Purp_5#2] Actual disabling of analytics
// [REQ:gemSpec_eRp_FdV:A_19982#2] Opt out of analytics
case let .toggleTrackingTapped(optIn):

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-47-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:47</code></h4>

<p>Show information dialog for analytics usage</p>
<pre class="highlight plaintext"><code>// Tracking comply sheet presentation
// [REQ:BSI-eRp-ePA:O.Purp_5#3] Show comply view for settings triggered analytics enabling
// [REQ:gemSpec_eRp_FdV:A_19982#3,A_19089-01#3] Show information dialog for analytics usage
Rectangle()

</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-161-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:161</code></h4>

<p>Opt out of analytics</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19097-01#2] Toggle within Settings to enable and disable usage analytics
// [REQ:BSI-eRp-ePA:O.Purp_5#1] Toggle within Settings to enable and disable usage analytics
// [REQ:BSI-eRp-ePA:O.Purp_6#1] Current Analytics state is inspectable by the user
// [REQ:gemSpec_eRp_FdV:A_19982#4] Opt out of analytics
Toggle(isOn: $store.trackerOptIn.sending(\.toggleTrackingTapped).animation()) {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19983-a_19983-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19983">A_19983</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>All used services except our analytics framework are permitted and attested by the Gematik and under the TI monitoring. The usage of our analytics framework is not under our control, but we exclusively send data to it and receive none.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_19984-a_19984-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_19984">A_19984</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-pharmacy-fhirclient-pharmacyoperation-swift-24-code' class='heading'><code>../Sources/Pharmacy/FHIRClient+PharmacyOperation.swift:24</code></h4>

<p>validate pharmacy data format conforming to FHIR</p>
<pre class="highlight plaintext"><code>/// Convenience function for searching for pharmacies
///
/// [REQ:gemSpec_eRp_FdV:A_19984] validate pharmacy data format conforming to FHIR
///
/// - Parameters:
///   - searchTerm: Search term
///   - position: Pharmacy position (latitude and longitude)
/// - Returns: `AnyPublisher` that emits a list of `PharmacyLocation`s or is empty when not found
public func searchPharmacies(by searchTerm: String,

</code></pre>
<h4 id='code-sources-erpkit-scannederxtask-swift-48-code' class='heading'><code>../Sources/eRpKit/ScannedErxTask.swift:48</code></h4>

<p>parse task id and access code</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19984] parse task id and access code
guard let taskId = taskString.match(pattern: Self.taskIdRegex) else {

</code></pre>
<h4 id='code-sources-erpkit-scannederxtask-swift-103-code' class='heading'><code>../Sources/eRpKit/ScannedErxTask.swift:103</code></h4>

<p>validate data matrix code structure</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19984] validate data matrix code structure
// [REQ:BSI-eRp-ePA:O.Source_1#4] actual validation by decoding into predefined structure
erxToken = try jsonDecoder.decode(ErxToken.self, from: jsonData)

</code></pre>
<h4 id='code-sources-erpremotestorage-fhirclient-erxtaskoperation-swift-246-code' class='heading'><code>../Sources/eRpRemoteStorage/FHIRClient+ErxTaskOperation.swift:246</code></h4>

<p>validate pharmacy data format conforming to FHIR</p>
<pre class="highlight plaintext"><code>/// Requests all communication Resources for the logged in user
///
/// [REQ:gemSpec_eRp_FdV:A_19984] validate pharmacy data format conforming to FHIR
///
/// - Returns: Array of all loaded communication resources
/// - Parameter referenceDate: Communications with `timestamp` greater or equal `referenceDate` will be fetched
public func communicationResources(

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20032-01-a_20032-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20032-01">A_20032-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Note: grace period for OCSP responses is 12h</p>
<h4 id='code-sources-truststore-x509truststore-swift-14-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:14</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218]
// [REQ:gemSpec_eRp_FdV:A_20032-01]
// Category A: Cross root certificates
private let rootCa: X509

</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-106-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:106</code></h4>
<pre class="highlight plaintext"><code>/// Match a collection of `OCSPResponse`s with the end entity certificates of this `X509TrustStore`.
/// Checks response status, revocation status for each certificate and validates the signer certificates of
///   the responses itself.
///
/// [REQ:gemSpec_Krypt:A_21218]
/// [REQ:gemSpec_eRp_FdV:A_20032-01]
///
/// - Note: This function assumes that up-to-dateness of the responses itself has already been checked.
///
/// - Returns: true on successful matching/validation, false if not successful or error
func checkEeCertificatesStatus(with ocspResponses: [OCSPResponse]) throws -&gt; Bool {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20033-a_20033-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20033">A_20033</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20033" severity="MUSS" class="target-element">
<p><b>A_20033 - E-Rezept-FdV: Prüfung Internet-Zertifikate</b></p>
<p>Das E-Rezept-FdV MUSS für die Prüfung des internetseitigen Zertifikats von Diensten der TI das Zertifikat auf ein CA-Zertifikat einer CA, die die &ldquo;CA/Browser Forum Baseline Requirements for the Issuance and Management of Publicly-Trusted Certificates&rdquo; (<a href="https://cabforum.org/baseline-requirements-documents/" target="_top" class="descriptionLink">https://cabforum.org/baseline-requirements-documents/</a>) erfüllt, kryptographisch (Signaturprüfung) zurückführen können. Ansonsten MUSS es das Zertifikat als &ldquo;ungültig&rdquo; bewerten.<br> Das E-Rezept-FdV MUSS die zeitliche Gültigkeit des Zertifikats prüfen. Falls diese Prüfung negativ ausfällt, muss es das Zertifikat als &ldquo;ungültig&rdquo; bewerten.  <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>For TLS certificates, this is implemented by not deactivating ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity</code>. For TI Certificates, this is implemented within the TrustStore module.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20167-02-a_20167-02-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20167-02">A_20167-02</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20167-02" severity="MUSS" class="target-element">
<p><b>A_20167-02 - E-Rezept-FdV: Authentisierung E-Rezept-Fachdienst - IDP-Dienst - Rolle Anwendungsfrontend und optional Authenticator-Modul</b></p>
<p><span style="font-size: 10pt;line-height: 1.5;">Das E-Rezept-FdV MUSS, wenn es eine Authentifizierung des Nutzers über den IDP-Dienst, in seiner Rolle als Authorization-Server, unterstützt, entweder als anfragendes Anwendungsfrontend und Authenticator-Modul oder, wenn ein Authenticator-Modul in einer anderen für die TI zugelassene App genutzt wird, als anfragendes Anwendungsfrontend agieren.</span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-data-prescriptionrepository-swift-133-code' class='heading'><code>../Sources/eRpApp/Data/PrescriptionRepository.swift:133</code></h4>

<p>no token/not authorized, show authenticator module</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167-02#2,A_20172] no token/not authorized, show authenticator module
if Result.success(false) == isAuthenticated {

</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-redeemservice-redeemservice-swift-151-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/RedeemService/RedeemService.swift:151</code></h4>

<p>no token/not authorized, show authenticator module</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167-02#3,A_20172] no token/not authorized, show authenticator module
if Result.success(false) == authenticated {

</code></pre>
<h4 id='code-sources-idp-idpinterceptor-swift-61-code' class='heading'><code>../Sources/IDP/IDPInterceptor.swift:61</code></h4>

<p>no token available, bailout</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167-02#4] no token available, bailout
.authentication(error)

</code></pre>
<h4 id='code-sources-idp-idpinterceptor-swift-71-code' class='heading'><code>../Sources/IDP/IDPInterceptor.swift:71</code></h4>

<p>invalidate/delete unauthorized token</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167-02#5] invalidate/delete unauthorized token
// [REQ:BSI-eRp-ePA:O.Source_5#2] invalidate/delete unauthorized token
self.session.invalidateAccessToken()

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20172-a_20172-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20172">A_20172</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-data-prescriptionrepository-swift-133-code' class='heading'><code>../Sources/eRpApp/Data/PrescriptionRepository.swift:133</code></h4>

<p>no token/not authorized, show authenticator module</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167-02#2,A_20172] no token/not authorized, show authenticator module
if Result.success(false) == isAuthenticated {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-profile-swift-50-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Profile.swift:50</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20172]
func idpChallengePublisher(for profileID: UUID) -&gt; AsyncStream&lt;CardWallReadCardDomain.Action&gt; {

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-profile-swift-75-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Profile.swift:75</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20172]
// [REQ:gemSpec_IDP_Frontend:A_20526-01] sign and verify with idp
func signChallengeWithNFCCard(

</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-profile-swift-107-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Profile.swift:107</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20172]
// [REQ:gemSpec_IDP_Frontend:A_20526-01] verify with idp
func verifyResultWithIDP(

</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-redeemservice-redeemservice-swift-151-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/RedeemService/RedeemService.swift:151</code></h4>

<p>no token/not authorized, show authenticator module</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167-02#3,A_20172] no token/not authorized, show authenticator module
if Result.success(false) == authenticated {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20181-01-a_20181-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20181-01">A_20181-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20181-01" severity="DARF NICHT" class="target-element">
<p><b>A_20181-01 - E-Rezept-FdV: E-Rezept-Token als 2D-Code anzeigen - personenbezogene Daten</b></p>
<p><span style="font-size: 10pt;line-height: 1.5;">Das E-Rezept-FdV DARF NICHT im Anwendungsfall &ldquo;E-Rezept-Token als 2D-Code anzeigen&rdquo; personenbezogene Daten zusammen mit der Anzeige des 2D-Codes anzeigen.</span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Screen that presents the DataMatrix code for redeeming a prescription only contains some static texts and the image of the code.</p>
<h4 id='code-sources-erpapp-screens-matrixcode-matrixcodeview-swift-17-code' class='heading'><code>../Sources/eRpApp/Screens/MatrixCode/MatrixCodeView.swift:17</code></h4>

<p>Screen that presents the DataMatrix code for redeeming a prescription only</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20181-01#2] Screen that presents the DataMatrix code for redeeming a prescription only
// contains some static texts and the image of the code.
struct MatrixCodeView: View {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20182-a_20182-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20182">A_20182</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20182" severity="DARF NICHT" class="target-element">
<p><b>A_20182 - E-Rezept-FdV - Makelverbot</b></p>
<p><span style="font-size: 10pt;line-height: 1.5;">Das E-Rezept-FdV DARF NICHT zusätzliche Funktionalitäten enthalten, die die berufs- oder gewerbsmäßige Zuweisung und das Makeln von E-Rezepten unterstützen oder den Nutzer in seiner Entscheidung beeinflussen, welche elektronischen Verordnungen in welcher Apotheke eingelöst werden.</span> <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>No advertisement or similar is presented in the app. Assigning a prescription to an pharmacy in only possible via the app’s pharmacy search. Pharmacy search results are only based on search term and filter criteria set by the user.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20183-a_20183-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20183">A_20183</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-pharmacy-pharmacyfhirdatasource-swift-31-code' class='heading'><code>../Sources/Pharmacy/PharmacyFHIRDataSource.swift:31</code></h4>
<pre class="highlight plaintext"><code>/// API for requesting pharmacies with the passed search term
///
/// [REQ:gemSpec_eRp_FdV:A_20183]
///
/// - Parameter searchTerm: String that send to the server for filtering the pharmacies response
/// - Parameter position: Position (latitude and longitude) of pharmacy
/// - Parameter filter: further filter parameters for pharmacies
/// - Returns: `AnyPublisher` that emits all `PharmacyLocation`s for the given `searchTerm`
public func searchPharmacies(by searchTerm: String,

</code></pre>
<h4 id='code-sources-pharmacy-pharmacyremotedatastore-swift-22-code' class='heading'><code>../Sources/Pharmacy/PharmacyRemoteDataStore.swift:22</code></h4>
<pre class="highlight plaintext"><code>/// API for requesting pharmacies with the passed search term
///
/// [REQ:gemSpec_eRp_FdV:A_20183]
///
/// - Parameter searchTerm: String that send to the server for filtering the pharmacies response
/// - Parameter position: Position (latitude and longitude) of pharmacy
/// - Parameter filter: further filter parameters for pharmacies
/// - Returns: `AnyPublisher` that emits all `PharmacyLocation`s for the given `searchTerm`
func searchPharmacies(by searchTerm: String,

</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-search-pharmacysearchdomain-swift-396-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Search/PharmacySearchDomain.swift:396</code></h4>

<p>search results mirrored verbatim, no sorting, no highlighting</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20183] search results mirrored verbatim, no sorting, no highlighting
state.searchState = .searchRunning

</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-search-pharmacysearchmapdomain-swift-254-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Search/PharmacySearchMapDomain.swift:254</code></h4>

<p>search results mirrored verbatim, no sorting, no highlighting</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20183] search results mirrored verbatim, no sorting, no highlighting
return .run { [center = state.mapLocation.region.center, filter = state.pharmacyFilterOptions] send in

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20184-a_20184-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20184">A_20184</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-123-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:123</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20184]
// [REQ:gemSpec_IDP_Frontend:A_21328#3] KeychainStorage implementation
let success: Bool

</code></pre>
<h4 id='code-sources-erpapp-session-standardsessioncontainer-swift-91-code' class='heading'><code>../Sources/eRpApp/Session/StandardSessionContainer.swift:91</code></h4>

<p>Keychain storage encrypts session/ssl tokens</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21328#2] Keychain storage encrypts session tokens
// [REQ:gemSpec_eRp_FdV:A_20184] Keychain storage encrypts session/ssl tokens
storage: secureUserStore,

</code></pre>
<h4 id='code-sources-erpapp-session-standardsessioncontainer-swift-109-code' class='heading'><code>../Sources/eRpApp/Session/StandardSessionContainer.swift:109</code></h4>

<p>No persistent storage for idp pairing session</p>
<pre class="highlight plaintext"><code>storage: MemoryStorage(), // [REQ:gemSpec_eRp_FdV:A_20184] No persistent storage for idp pairing session
schedulers: schedulers,

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20185-a_20185-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20185">A_20185</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-159-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:159</code></h4>

<p>OptOut for user</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20185,A_20187] OptOut for user
state.trackerOptIn = false

</code></pre>

<p>Token invalidation happens after 12 hours as the IDP provied SSO-Token is no longer valid after that time.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20186-a_20186-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20186">A_20186</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-248-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:248</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-1#3] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
set(can: nil)

</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-41-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:41</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-01#2] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_IDP_Frontend:A_21603] Certificate
// [REQ:BSI-eRp-ePA:O.Auth_14#4] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
storage.wipe()

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20187-a_20187-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20187">A_20187</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-159-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:159</code></h4>

<p>OptOut for user</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20185,A_20187] OptOut for user
state.trackerOptIn = false

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20193-a_20193-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20193">A_20193</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Camera is only used for scanning recipes and avatar setup. CoreLocation is used for pharmacy search. Usage is requested before actual first usage, the user is asked for permission. This is also enforced by the OS.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20194-a_20194-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20194">A_20194</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Camera is only used for scanning recipes and avatar setup. CoreLocation is used for pharmacy search. Usage is requested before actual first usage, the user is asked for permission. This is also enforced by the OS.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20202-a_20202-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20202">A_20202</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Camera is only used for scanning recipes and avatar setup. CoreLocation is used for pharmacy search. Usage is requested before actual first usage, the user is asked for permission. This is also enforced by the OS.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20206-a_20206-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20206">A_20206</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-35-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:35</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_IDP_Frontend:A_20606#2] Setup of minimum TLS Version to use.
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework
urlSessionConfiguration.tlsMinimumSupportedProtocolVersion = .TLSv12

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20208-a_20208-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20208">A_20208</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-pharmacy-pharmacyfhiroperation-swift-14-code' class='heading'><code>../Sources/Pharmacy/PharmacyFHIROperation.swift:14</code></h4>
<pre class="highlight plaintext"><code>/// Search for pharmacies by name
/// [REQ:gemSpec_eRp_FdV:A_20208]
case searchPharmacies(searchTerm: String, position: Position?, filter: [String: String], handler: Handler)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20285-a_20285-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20285">A_20285</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_20285" severity="MUSS" class="target-element">
<p><b>A_20285 - E-Rezept-FdV: Wettbewerbsneutralität für Darstellung Apotheken</b></p>
<p>Das E-Rezept-FdV MUSS Apotheken wettbewerbsneutral darstellen (bspw. Sortierung nach Alphabet oder Entfernung vom aktuellen Standort des Nutzers). <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-pharmacy-search-pharmacysearchdomain-swift-405-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Search/PharmacySearchDomain.swift:405</code></h4>

<p>pharmacy order is resolved on server side</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20285] pharmacy order is resolved on server side
state.pharmacies = pharmacies

</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-search-pharmacysearchmapdomain-swift-268-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Search/PharmacySearchMapDomain.swift:268</code></h4>

<p>pharmacy order is resolved on server side</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20285] pharmacy order is resolved on server side
state.pharmacies = pharmacies.map {

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_20603-a_20603-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_20603">A_20603</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-screens-main-prescriptiondetail-prescriptiondetaildomain-swift-92-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionDetail/PrescriptionDetailDomain.swift:92</code></h4>

<p>Usages of matrixCodeGenerator for code generation. UserProfile is neither part of</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20603] Usages of matrixCodeGenerator for code generation. UserProfile is neither part of
// the screen nor the state.
@Dependency(\.erxMatrixCodeGenerator) var matrixCodeGenerator: ErxMatrixCodeGenerator

</code></pre>
<h4 id='code-sources-erpapp-screens-matrixcode-matrixcodedomain-swift-71-code' class='heading'><code>../Sources/eRpApp/Screens/MatrixCode/MatrixCodeDomain.swift:71</code></h4>

<p>Usages of matrixCodeGenerator for code generation. UserProfile is neither part of</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20603] Usages of matrixCodeGenerator for code generation. UserProfile is neither part of
// the screen nor the state.
@Dependency(\.erxMatrixCodeGenerator) var erxMatrixCodeGenerator: ErxMatrixCodeGenerator

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_22778-01-a_22778-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_22778-01">A_22778-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_22778-01" severity="MUSS" class="target-element">
<p><b>A_22778-01 - E-Rezept-FdV - Einlösen ohne Anmelden - Verschlüsselung mit C.HCI.ENC</b></p>
<p>Das E-Rezept-FdV MUSS im Anwendungsfall &ldquo;Einlösen ohne Anmelden&rdquo; die Nachricht des Versicherten mit allen bereitgestellten C.HCI.ENC Zertifikaten (inkl. der verschiedenen kryptografischen Verfahren) der adressierten Apotheke (Verschlüsselungszertifikat der SMC-B C.HCI.ENC) verschlüsseln. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Encryption of message to the Pharmacy is done with/for all provided certificates/recipients.</p>
<h4 id='code-sources-avs-avscmsencrypter-swift-10-code' class='heading'><code>../Sources/AVS/AVSCmsEncrypter.swift:10</code></h4>

<p>Encryption of message to the Pharmacy is done for all provided recipients</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_22778-01#2] Encryption of message to the Pharmacy is done for all provided recipients
func cmsEncrypt(_ data: Data, recipients: [X509]) throws -&gt; Data

</code></pre>
<h4 id='code-sources-avs-avscmsencrypter-swift-22-code' class='heading'><code>../Sources/AVS/AVSCmsEncrypter.swift:22</code></h4>

<p>Encryption of message to the Pharmacy is done with all provided</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4390] RSAES-OAEP with MGF1 implemented in sub-framework OpenSSL-swift
// [REQ:gemSpec_eRp_FdV:A_22778-01#3] Encryption of message to the Pharmacy is done with all provided
// certificates
// [REQ:gemSpec_eRp_FdV:A_22779-01#3] Encrypted message is of form of a PKCS#7 container (CMS)
// https://github.com/gematik/OpenSSL-Swift/blob/3c1ea91ba5abfefecfe3588815cb928d777e29ad/Sources/OpenSSL/CMS/CMSContentInfo.swift#L88
// swiftlint:disable:previous line_length
let cms = try CMSContentInfo.encryptPartial(data: data)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_22779-01-a_22779-01-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_22779-01">A_22779-01</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_22779-01" severity="MUSS" class="target-element">
<p><b>A_22779-01 - E-Rezept-FdV - Einlösen ohne Anmelden - Nachricht verschlüsseln</b></p>
<p>Das E-Rezept-FdV MUSS im Anwendungsfall &ldquo;Einlösen ohne Anmelden&rdquo; die Daten ausschließlich als PKCS#7 verschlüsselten Datensatz (CMS) bereitstellen. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Encrypted message is of form of a PKCS#7 container (CMS)</p>
<h4 id='code-sources-avs-avsmessageconverter-swift-32-code' class='heading'><code>../Sources/AVS/AVSMessageConverter.swift:32</code></h4>

<p>Encrypted message is of form of a PKCS#7 container (CMS)</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_22779-01#2] Encrypted message is of form of a PKCS#7 container (CMS)
// 1. Create a CMS AuthenticatedEnvelopedData structure with help from OpenSSL-swift
let cmsAuthEnvelopedData = try avsCmsEncrypter.cmsEncrypt(data, recipients: recipients)

</code></pre>
<h4 id='code-sources-avs-avscmsencrypter-swift-24-code' class='heading'><code>../Sources/AVS/AVSCmsEncrypter.swift:24</code></h4>

<p>Encrypted message is of form of a PKCS#7 container (CMS)</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4390] RSAES-OAEP with MGF1 implemented in sub-framework OpenSSL-swift
// [REQ:gemSpec_eRp_FdV:A_22778-01#3] Encryption of message to the Pharmacy is done with all provided
// certificates
// [REQ:gemSpec_eRp_FdV:A_22779-01#3] Encrypted message is of form of a PKCS#7 container (CMS)
// https://github.com/gematik/OpenSSL-Swift/blob/3c1ea91ba5abfefecfe3588815cb928d777e29ad/Sources/OpenSSL/CMS/CMSContentInfo.swift#L88
// swiftlint:disable:previous line_length
let cms = try CMSContentInfo.encryptPartial(data: data)

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_24525-a_24525-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_24525">A_24525</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_24525" severity="MUSS" class="target-element">
<p><b>A_24525 - E-Rezept-FdV Tracking-Funktionen als Opt-in</b></p>
<p>Das E-Rezept-FdV MUSS, falls es Tracking-Funktionen implementiert, die Tracking-Daten mehrerer Nutzersessions verknüpfen, technisch sicherstellen, dass diese Tracking-Funktionen bei der Installation des FdV standardmäßig deaktiviert sind und nur nach expliziter Einwilligung durch den Versicherten als Nutzer des FdV aktiviert werden (Opt-in). <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>Whether analytics are enabled or not is persisted using <code>UserDefaults</code>. As these usere Defaults are empty upon installation, any call to <code>bool(for:)</code> will return to false. Opt-In for Analytics will be asked while the app onboarding runs.</p>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-37-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:37</code></h4>

<p>Calculate if analytics are enabled or not.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_24525#2] Calculate if analytics are enabled or not.
userDefaults.appTrackingAllowed

</code></pre>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_24579-a_24579-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_24579">A_24579</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_24579" severity="MUSS" class="target-element">
<p><b>A_24579 - E-Rezept-FdV: Apotheke suchen: neutrale Darstellung der Optionen</b></p>
<p>Das E-Rezept-FdV MUSS im Anwendungsfall &ldquo;Apotheke suchen&rdquo; die Apothekensuche und die Suchergebnisse so darstellen, dass Belieferungsoptionen nicht hervorgehoben oder bevorzugt werden. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>

<p>See snapshot test (e.g. ‘testPharmacySearch_searchResultSuccess.iPhone8-light.png’) or the actual app to verify.</p>
<h3 id='a-href-https-gemspec-gematik-de-docs-gemspec-gemspec_erp_fdv-latest-index-html-a_24857-a_24857-a' class='heading'><a href="https://gemspec.gematik.de/docs/gemSpec/gemSpec_eRp_FdV/latest/index.html#A_24857">A_24857</a></h3>
<h4 id='original-requirement' class='heading'>Original Requirement</h4>

<div id="A_24857" severity="MUSS" class="target-element">
<p><b>A_24857 - E-Rezept-FdV: Authentifizierung des Nutzers am E-Rezept-FdV zum Start des E-Rezept-FdV</b></p>
<p>Das E-Rezept-FdV MUSS den Nutzer beim Starten des E-Rezept-FdV am E-Rezept-FdV authentisieren. <b>[&lt;=]</b></p>
</div>
<h4 id='implementation' class='heading'>Implementation</h4>
<h4 id='code-sources-erpapp-scenedelegate-swift-180-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:180</code></h4>

<p>Present the authentication window upon every startup</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_8#2] Present the authentication window
// [REQ:gemSpec_eRp_FdV:A_24857#2] Present the authentication window upon every startup
// dispatching necessary to prevents keyboard not showing on iOS 16
DispatchQueue.main.async { [weak self] in

</code></pre>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>&copy; 2024 <a class="link" href="https://www.gematik.de" target="_blank" rel="external noopener">gematik GmbH</a>. All rights reserved. (Last updated: 2024-07-24)</p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external noopener">jazzy ♪♫ v0.14.4</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external noopener">Realm</a> project.</p>
    </section>
  </body>
</html>
