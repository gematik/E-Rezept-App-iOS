<!DOCTYPE html>
<html lang="en">
  <head>
    <title>requirements  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>


    <a title="requirements  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
           1.22.1 Docs
        </a>
         (0% documented)
      </p>
    
      <div class="header-col--secondary">
        <form role="search" action="search.json">
          <input type="text" placeholder="Search documentation" data-typeahead>
        </form>
      </div>
    
        <p class="header-col header-col--secondary">
          <a class="header-link" href="https://github.com/gematik/E-Rezept-App-iOS">
            <img class="header-icon" src="img/gh.png" alt="GitHub"/>
            View on GitHub
          </a>
        </p>
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html"> Reference</a>
      <img class="carat" src="img/carat.png" alt=""/>
      requirements  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Guides.html">Guides</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="modules.html">Modules</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="error_handling.html">error_handling</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="requirement-notes.html">requirement-notes</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="requirements.html">requirements</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions.html#/AppKit">AppKit</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content top-matter">
            
            <h1 id='requirements' class='heading'>Requirements</h1>
<h2 id='bsi-erp-epa' class='heading'>BSI-eRp-ePA</h2>
<h3 id='o-arch_1' class='heading'>O.Arch_1</h3>

<p>See external SSDLC documentation.</p>
<h3 id='o-arch_2' class='heading'>O.Arch_2</h3>

<p>Data storage is divided into service driven data that is stored within a database, user driven data that must be secured, such as the eGK CAN or the eGK Certificate and user specific data that is not critical, such as already seen tooltips or preferences.</p>
<h4 id='code-sources-erplocalstorage-coredatacontrollerfactory-swift-32-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataControllerFactory.swift:32</code></h4>

<p>CoreData databases are protected</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#2,O.Arch_2#2] CoreData databases are protected
self.fileProtection = fileProtection
</code></pre>
<h4 id='code-sources-erplocalstorage-coredatacontroller-swift-59-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataController.swift:59</code></h4>

<p>actual protection setting on file system level</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#3,O.Arch_2#3] actual protection setting on file system level
protectedStoreDescription.setOption(
</code></pre>
<h4 id='code-sources-erplocalstorage-coredatacontroller-swift-83-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataController.swift:83</code></h4>

<p>Database backup exclusion</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#4,O.Arch_2#4,O.Arch_4#2,O.Data_15#1] Database backup exclusion
if excludeFromBackup, let storeUrl = store.url {
</code></pre>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-23-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:23</code></h4>

<p>Implementation of data storage that is</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemF_Tokenverschlüsselung:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_2#5,O.Arch_4#3,O.Source_7#2,O.Data_2#2] Implementation of data storage that is
// persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {
</code></pre>
<h4 id='code-sources-erplocalstorage-userstore-userdefaultsstore-swift-12-code' class='heading'><code>../Sources/eRpLocalStorage/UserStore/UserDefaultsStore.swift:12</code></h4>

<p>User data that has no password character</p>
<pre class="highlight plaintext"><code>/// Interface to access user specific data
/// [REQ:BSI-eRp-ePA:O.Arch_2#6] User data that has no password character
public class UserDefaultsStore: UserDataStore {
</code></pre>
<h3 id='o-arch_3' class='heading'>O.Arch_3</h3>

<p>All cryptography is specified by gemSpec_Krypt in corporation with BSI</p>
<h3 id='o-arch_4' class='heading'>O.Arch_4</h3>

<p>All data is either stored encrypted within the keychain or excluded from system backup, which also excludes files from cloud backup.</p>
<h4 id='code-sources-erplocalstorage-coredatacontroller-swift-83-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataController.swift:83</code></h4>

<p>Database backup exclusion</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#4,O.Arch_2#4,O.Arch_4#2,O.Data_15#1] Database backup exclusion
if excludeFromBackup, let storeUrl = store.url {
</code></pre>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-23-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:23</code></h4>

<p>Implementation of data storage that is</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemF_Tokenverschlüsselung:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_2#5,O.Arch_4#3,O.Source_7#2,O.Data_2#2] Implementation of data storage that is
// persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {
</code></pre>
<h3 id='o-arch_5' class='heading'>O.Arch_5</h3>

<p>CAN and PIN verification is not done within the application but on the eGK chip. Actual authentication by confirming the eGK signature and validating the eGK certificate is done by the IDP. Authorization of users is done by the FD by validating the Access-Token signature.</p>
<h3 id='o-arch_6' class='heading'>O.Arch_6</h3>

<p>Apple already implements this with a signed binary delivered to customers. An altered application can only run on a jailbroken device. If a user is using a jailbroken device, may it be known or unknown, we display a security alert so a user can make an informed decision to use or not use the application.</p>
<h4 id='code-sources-erpapp-screens-main-mainview-swift-122-code' class='heading'><code>../Sources/eRpApp/Screens/Main/MainView.swift:122</code></h4>

<p>trigger device security check</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#2,O.Resi_2#2,O.Plat_1#2] trigger device security check
viewStore.send(.loadDeviceSecurityView)
</code></pre>
<h4 id='code-sources-erpapp-session-helper-devicesecuritymanager-swift-58-code' class='heading'><code>../Sources/eRpApp/Session/Helper/DeviceSecurityManager.swift:58</code></h4>

<p>calculate system risk for jailbreak and missing device pin</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#3,O.Resi_2#3,O.Plat_1#3] calculate system risk for jailbreak and missing device pin
var showSystemSecurityWarning: AnyPublisher&lt;DeviceSecurityWarningType, Never&gt; {
</code></pre>
<h4 id='code-sources-erpapp-session-helper-devicesecuritymanager-swift-112-code' class='heading'><code>../Sources/eRpApp/Session/Helper/DeviceSecurityManager.swift:112</code></h4>

<p>Jailbreak detection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#4,O.Resi_2#4] Jailbreak detection
func informJailbreakDetected() -&gt; Bool {
</code></pre>
<h4 id='code-sources-erpapp-screens-main-devicesecurity-devicesecurityrooteddevice-devicesecurityrooteddeviceview-swift-9-code' class='heading'><code>../Sources/eRpApp/Screens/Main/DeviceSecurity/DeviceSecurityRootedDevice/DeviceSecurityRootedDeviceView.swift:9</code></h4>

<p>Jailbreak information view</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#5,O.Resi_2#5] Jailbreak information view
struct DeviceSecurityRootedDeviceView: View {
</code></pre>
<h3 id='o-arch_7' class='heading'>O.Arch_7</h3>

<p>See <code>Source/eRpApp/Resources/en.lproj/FOSS.html</code> for library usage purposes    .</p>
<h3 id='o-arch_8' class='heading'>O.Arch_8</h3>
<h4 id='code-sources-erpapp-screens-settings-termsofuse-termsofuseview-swift-12-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/TermsOfUse/TermsOfUseView.swift:12</code></h4>

<p>Webview containint local html without javascript</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_3#2] Actual view for the Terms of Use display
// [REQ:BSI-eRp-ePA:O.Arch_8#1] Webview containint local html without javascript
struct TermsOfUseView: View {
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-foss-fossview-swift-10-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/FOSS/FOSSView.swift:10</code></h4>

<p>Webview containint local html without javascript</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_8#2] Webview containint local html without javascript
struct FOSSView: View {
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-dataprivacy-dataprivacyview-swift-13-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/DataPrivacy/DataPrivacyView.swift:13</code></h4>

<p>Webview containing local html without javascript</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_1#2] Actual View driving the display of `DataPrivacy.html`
// [REQ:BSI-eRp-ePA:O.Arch_8#3] Webview containing local html without javascript
// [REQ:gemSpec_eRp_FdV:A_19980#2] Actual View driving the display of `DataPrivacy.html`
struct DataPrivacyView: View {
</code></pre>
<h3 id='o-arch_9' class='heading'>O.Arch_9</h3>

<p>Link within DataPrivacy.html to <a href="https://www.gematik.de/datensicherheit">https://www.gematik.de/datensicherheit</a></p>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingcontainer-swift-75-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingContainer.swift:75</code></h4>

<p>DataPrivacy display within Onboarding</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_9#2] DataPrivacy display within Onboarding
.sheet(isPresented: viewStore.binding(get: \.showTermsOfPrivacy,
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingslegalinfoview-swift-44-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsLegalInfoView.swift:44</code></h4>

<p>DataPrivacy display within Settings</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_9#3] DataPrivacy display within Settings
NavigationLinkStore(
</code></pre>
<h3 id='o-arch_10' class='heading'>O.Arch_10</h3>

<p>Currently only implemented via APIKey usage against APOVZD and FD. All requests against the backends may respond with an 403 status code. The App stays usable, but only without any server connection.</p>
<h3 id='o-arch_11' class='heading'>O.Arch_11</h3>

<p>Not implemented</p>
<h3 id='o-arch_12' class='heading'>O.Arch_12</h3>

<p>Not necessary due to O.Arch_11 not being implemented.</p>
<h3 id='o-auth_1' class='heading'>O.Auth_1</h3>

<p>Our authentication concept is described in the following repository: <a href="https://github.com/gematik/api-erp/blob/master/docs/authentisieren.adoc">https://github.com/gematik/api-erp/blob/master/docs/authentisieren.adoc</a> ||| We have more detailed diagrams regarding the context of the authentication in the SIS: Authentication on the central IDP: E-Rezept-App-Authentifizierungskonzept.pdf ||| Authentication via Fast Track: E-Rezept-App-Authentifizierungskonzept_Fast_Track.pdf</p>
<h3 id='o-auth_2' class='heading'>O.Auth_2</h3>

<p>There is no client side separation of authentication and authorization.</p>
<h3 id='o-auth_3' class='heading'>O.Auth_3</h3>

<p>One way to connect to the FD is to login by using the eGK. To login with the eGK, the card, a CAN and a PIN is needed. The other way is to use a insurance company provided app. These apps must implement a second factor as well. See all <code>CardWall</code> prefixed files for all implementation details.</p>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationdomain-swift-82-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationDomain.swift:82</code></h4>

<p>Start login with KK</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22294] Start login with KK
// [REQ:BSI-eRp-ePA:O.Auth_3#2,O.Plat_10#2] Start login with KK
return .publisher(
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-swift-193-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.swift:193</code></h4>

<p>Implementation of eGK connection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_3#2] Implementation of eGK connection
case let .signChallenge(challenge):
</code></pre>
<h3 id='o-auth_4' class='heading'>O.Auth_4</h3>

<p>There is no step up from always using 2nd factor authentication. Tokens have short lifetimes of 12h (server defined) SSO-Tokens and 5m Access-Tokens.</p>
<h3 id='o-auth_5' class='heading'>O.Auth_5</h3>

<p>A Audit Log for every FD access is available in each user profile.</p>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofileview-swift-502-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileView.swift:502</code></h4>

<p>Actual Button to open the audit events</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19177#2,A_19185#3] Actual Button to open the audit events
// [REQ:BSI-eRp-ePA:O.Auth_5#2] Actual Button to open the audit events
NavigationLinkStore(
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-profiles-protocol-auditeventsview-swift-12-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Protocol/AuditEventsView.swift:12</code></h4>

<p>View displaying the audit events</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19177#1,A_19185#2] View displaying the audit events
// [REQ:BSI-eRp-ePA:O.Auth_5#3] View displaying the audit events
struct AuditEventsView: View {
</code></pre>
<h3 id='o-auth_6' class='heading'>O.Auth_6</h3>

<p>There are not passwords to guess for server login within our application. Only eGK login is directly available within the application. The users application password is not delayed, as any user with PIN access would have access to the unencrypted file system as well.</p>
<h4 id='code-sources-erpapp-screens-appauthentication-appauthenticationpassword-appauthenticationpassworddomain-swift-8-code' class='heading'><code>../Sources/eRpApp/Screens/AppAuthentication/AppAuthenticationPassword/AppAuthenticationPasswordDomain.swift:8</code></h4>

<p>Domain handling App Authentication</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_6#2] Domain handling App Authentication
struct AppAuthenticationPasswordDomain: ReducerProtocol {
</code></pre>
<h4 id='code-sources-erpapp-session-helper-appsecuritymanager-swift-41-code' class='heading'><code>../Sources/eRpApp/Session/Helper/AppSecurityManager.swift:41</code></h4>

<p>Actual password check</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_6#3] Actual password check
func matches(password: String) throws -&gt; Bool {
</code></pre>
<h3 id='o-auth_7' class='heading'>O.Auth_7</h3>

<p>The SceneDelegate exchanges the active window with an authentication window every time the app gains focus</p>
<h4 id='code-sources-erpapp-scenedelegate-swift-174-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:174</code></h4>

<p>Present the authentication window</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_7#2] Present the authentication window
// dispatching necessary to prevents keyboard not showing on iOS 16
DispatchQueue.main.async { [weak self] in
</code></pre>
<h3 id='o-auth_8' class='heading'>O.Auth_8</h3>

<p>A Timer is used to measure the time a user is inactive. Every user interaction resets the timer.</p>
<h4 id='code-sources-erpapp-scenedelegate-swift-330-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:330</code></h4>

<p>A timer is used to determine inactive users</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_8#2] A timer is used to determine inactive users
self?.presentAppAuthenticationDomain(scene: scene)
</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-311-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:311</code></h4>

<p>the timer is reset on user interaction</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_8#3] the timer is reset on user interaction
self?.setupTimer(scene: scene)
</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-340-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:340</code></h4>

<p>User interaction is determined by using a higher order reducer watching all</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_8#4] User interaction is determined by using a higher order reducer watching all
// actions
NotificationCenter.default.post(name: .userInteractionDetected, object: nil, userInfo: nil)
</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-47-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:47</code></h4>

<p>Concat the user interaction reducer to the normal application reducer</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_8#5] Concat the user interaction reducer to the normal application reducer
reducer: AppStartDomain().analytics().notifyUserInteraction().prepareUITestsDependencies(),
</code></pre>
<h3 id='o-auth_9' class='heading'>O.Auth_9</h3>

<p>Token invalidation happens after 12 hours. If a user is still active, a re-authentication via eGK, Biometrics or Insurance App is necessary. Each meaning the possession and or knowledge of the needed user input.</p>
<h4 id='code-sources-idp-defaultidpsession-swift-778-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:778</code></h4>

<p>application is also checking for expiration</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Auth_9#2] application is also checking for expiration
guard token.expires &gt; time() else {
</code></pre>
<h3 id='o-auth_10' class='heading'>O.Auth_10</h3>

<p>Authentication via eGK cannot be altered, as the physical card cannot be modified without authentication (e.g. PIN change). See gemSpec_COS for details. Adding a authentication key that is secured via biometrics (labeled as &ldquo;save login&rdquo; within the card wall) enforces a new authentication via eGK on server side.</p>
<h3 id='o-auth_11' class='heading'>O.Auth_11</h3>

<p>We use TLS Pinning and a Trust Store for VAU communication. See TrustStore and VAU Module for implementation.</p>
<h3 id='o-auth_12' class='heading'>O.Auth_12</h3>

<p>unused</p>
<h3 id='o-biom_1' class='heading'>O.Biom_1</h3>

<p>The authentication via biometric is only available upon successfull authentication via eGK + PIN.</p>
<h3 id='o-biom_2' class='heading'>O.Biom_2</h3>

<p>Minimal OS version is set to iOS 15 in compliance with TR-03161-1 Anhang C. See <code>options.deploymentTarget.iOS</code> path within <code>project.yml</code> or the generated <code>IPHONEOS_DEPLOYMENT_TARGET</code> within the <code>project.pbxproj</code> file.</p>
<h3 id='o-biom_3' class='heading'>O.Biom_3</h3>

<p>Minimal OS version is set to iOS 15 in compliance with TR-03161-1 Anhang C. See <code>options.deploymentTarget.iOS</code> path within <code>project.yml</code> or the generated <code>IPHONEOS_DEPLOYMENT_TARGET</code> within the <code>project.pbxproj</code> file.</p>

<p>We do not access the sensor directly. All access is hidden behind OS Frameworks. A Denylist is implemented by the IDP while registering the device for biometric access.</p>
<h3 id='o-biom_4' class='heading'>O.Biom_4</h3>

<p>Minimal OS version is set to iOS 15 in compliance with TR-03161-1 Anhang C. See <code>options.deploymentTarget.iOS</code> path within <code>project.yml</code> or the generated <code>IPHONEOS_DEPLOYMENT_TARGET</code> within the <code>project.pbxproj</code> file.</p>
<h3 id='o-biom_5' class='heading'>O.Biom_5</h3>
<h4 id='code-sources-erpapp-screens-appauthentication-appauthenticationdomain-swift-129-code' class='heading'><code>../Sources/eRpApp/Screens/AppAuthentication/AppAuthenticationDomain.swift:129</code></h4>

<p>Check whether at least one biometric reference is available.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Biom_5#1] Check whether at least one biometric reference is available.
func loadAppAuthenticationOption() -&gt; EffectTask&lt;AppAuthenticationDomain.Action&gt; {
</code></pre>
<h3 id='o-biom_6' class='heading'>O.Biom_6</h3>

<p>Biometric secured private keys are invalid whenever the biometrics setup changes. </p>
<h4 id='code-sources-idp-privatekeycontainer-swift-132-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:132</code></h4>

<p>invalidates biometry after changes</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21586] invalidates biometry after changes
// [REQ:BSI-eRp-ePA:O.Biom_6#2] invalidates biometry after changes
.biometryCurrentSet], &amp;error) else {
</code></pre>
<h3 id='o-biom_7' class='heading'>O.Biom_7</h3>
<h4 id='code-sources-erpapp-screens-appauthentication-appauthenticationbiometry-biometricsauthenticationchallengeprovider-swift-78-code' class='heading'><code>../Sources/eRpApp/Screens/AppAuthentication/AppAuthenticationBiometry/BiometricsAuthenticationChallengeProvider.swift:78</code></h4>

<p>Live implementation of AuthenticationChallengeProvider for FaceID methods</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Biom_7#1] Live implementation of AuthenticationChallengeProvider for FaceID methods
struct BiometricsAuthenticationChallengeProvider: AuthenticationChallengeProvider {
</code></pre>
<h4 id='code-sources-erpapp-session-helper-systemkeychainaccesshelper-swift-206-code' class='heading'><code>../Sources/eRpApp/Session/Helper/SystemKeychainAccessHelper.swift:206</code></h4>

<p>Live implementation of KeychainAccessHelper that reaches into system&rsquo;s Keychain methods</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Biom_7#2] Live implementation of KeychainAccessHelper that reaches into system's Keychain methods
struct SystemKeychainAccessHelper: KeychainAccessHelper {
</code></pre>
<h3 id='o-biom_8' class='heading'>O.Biom_8</h3>

<p>If evaluation failed 5 times, a not escapable error is presented</p>
<h4 id='code-sources-erpapp-screens-appauthentication-appauthenticationbiometry-biometricsauthenticationchallengeprovider-swift-32-code' class='heading'><code>../Sources/eRpApp/Screens/AppAuthentication/AppAuthenticationBiometry/BiometricsAuthenticationChallengeProvider.swift:32</code></h4>

<p>see also:</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Biom_8#2] see also:
// https://developer.apple.com/documentation/localauthentication/laerror/code/2867589-biometrylockout
if LAError.Code(rawValue: error.code) == LAError.biometryLockout {
</code></pre>
<h3 id='o-cryp_1' class='heading'>O.Cryp_1</h3>

<p>Private keys for encryption are either created and stored within the secure enclave or stored within the eGK. As encryption for Server communication is done ephemeral via ECDH-ES, no static private keys on client side are necessary.</p>
<h4 id='code-sources-idp-models-signedchallenge-swift-36-code' class='heading'><code>../Sources/IDP/Models/SignedChallenge.swift:36</code></h4>

<p>Signature via ecdh ephemeral-static</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#2] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#5] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(
</code></pre>
<h4 id='code-sources-idp-models-signedauthenticationdata-swift-27-code' class='heading'><code>../Sources/IDP/Models/SignedAuthenticationData.swift:27</code></h4>

<p>Signature via ecdh ephemeral-static</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#3] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#4] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(
</code></pre>
<h4 id='code-sources-idp-models-registrationdata-swift-108-code' class='heading'><code>../Sources/IDP/Models/RegistrationData.swift:108</code></h4>

<p>Signature via ecdh ephemeral-static</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#4] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#3] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwe-encryption-swift-20-code' class='heading'><code>../Sources/IDP/internal/JWT/JWE+Encryption.swift:20</code></h4>

<p>Signature via ecdh ephemeral-static</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#5] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#6] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(
</code></pre>
<h4 id='code-sources-idp-internal-tokenpayload-swift-180-code' class='heading'><code>../Sources/IDP/internal/TokenPayload.swift:180</code></h4>

<p>Signature via ecdh ephemeral-static</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#6] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#2] one time usage for JWE ECDH-ES Encryption
guard let jweHeader = try? JWE.Header(algorithm: JWE.Algorithm.ecdh_es(keyExchangeContext),
</code></pre>
<h3 id='o-cryp_2' class='heading'>O.Cryp_2</h3>

<p>All cryptographic requirements are defined within <code>gemSpec_Krypt</code>. The document was created together with BSI.</p>
<h3 id='o-cryp_3' class='heading'>O.Cryp_3</h3>

<p>All cryptographic requirements are defined within <code>gemSpec_Krypt</code>. The document was created together with BSI.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-62-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:62</code></h4>

<p>Secure Enclave Key generation</p>
<pre class="highlight plaintext"><code>// Keychain Query
// [REQ:BSI-eRp-ePA:O.Cryp_3#2,O.Cryp_6#2] Secure Enclave Key generation
let query: [String: Any] = [kSecClass as String: kSecClassKey,
</code></pre>
<h4 id='code-sources-idp-internal-idpcrypto-swift-45-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:45</code></h4>

<p>Brainpool key generator</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19179#2] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:BSI-eRp-ePA:O.Cryp_3#3] Brainpool key generator
try BrainpoolP256r1.KeyExchange.generateKey()
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwe-kdf-swift-35-code' class='heading'><code>../Sources/IDP/internal/JWT/JWE+KDF.swift:35</code></h4>

<p>Brainpool key generator</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_3#4] Brainpool key generator
// [REQ:gemSpec_eRp_FdV:A_19179#4] Key pair generation delegated to OpenSSL
= { try BrainpoolP256r1.KeyExchange.generateKey() })
</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-99-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:99</code></h4>

<p>Brainpool key generator</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4357] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:gemSpec_Krypt:GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:BSI-eRp-ePA:O.Cryp_3#5] Brainpool key generator
// [REQ:gemSpec_eRp_FdV:A_19179#5] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
let keyPairGenerator = { try BrainpoolP256r1.KeyExchange.generateKey() }
</code></pre>
<h3 id='o-cryp_4' class='heading'>O.Cryp_4</h3>

<p>All cryptographic requirements are defined within <code>gemSpec_Krypt</code>. The document was created together with BSI.</p>
<h4 id='code-sources-idp-internal-tokenpayload-swift-181-code' class='heading'><code>../Sources/IDP/internal/TokenPayload.swift:181</code></h4>

<p>one time usage for JWE ECDH-ES Encryption</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#6] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#2] one time usage for JWE ECDH-ES Encryption
guard let jweHeader = try? JWE.Header(algorithm: JWE.Algorithm.ecdh_es(keyExchangeContext),
</code></pre>
<h4 id='code-sources-idp-models-registrationdata-swift-109-code' class='heading'><code>../Sources/IDP/Models/RegistrationData.swift:109</code></h4>

<p>one time usage for JWE ECDH-ES Encryption</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#4] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#3] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(
</code></pre>
<h4 id='code-sources-idp-models-signedauthenticationdata-swift-28-code' class='heading'><code>../Sources/IDP/Models/SignedAuthenticationData.swift:28</code></h4>

<p>one time usage for JWE ECDH-ES Encryption</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#3] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#4] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(
</code></pre>
<h4 id='code-sources-idp-models-signedchallenge-swift-37-code' class='heading'><code>../Sources/IDP/Models/SignedChallenge.swift:37</code></h4>

<p>one time usage for JWE ECDH-ES Encryption</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#2] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#5] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwe-encryption-swift-21-code' class='heading'><code>../Sources/IDP/internal/JWT/JWE+Encryption.swift:21</code></h4>

<p>one time usage for JWE ECDH-ES Encryption</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_1#5] Signature via ecdh ephemeral-static
// [REQ:BSI-eRp-ePA:O.Cryp_4#6] one time usage for JWE ECDH-ES Encryption
let algorithm = JWE.Algorithm.ecdh_es(JWE.Algorithm.KeyExchangeContext.bpp256r1(
</code></pre>
<h3 id='o-cryp_5' class='heading'>O.Cryp_5</h3>

<p>We use Brainpool256R1 and ECSECPrimeRandom 256, see usages in O.Cryp_1 to O.Cryp_4</p>
<h3 id='o-cryp_6' class='heading'>O.Cryp_6</h3>

<p>Persisted cryptographic keys are created within the devices secure enclave. Temporal keys are discarded as soon as usage is no longer needed.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-62-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:62</code></h4>

<p>Secure Enclave Key generation</p>
<pre class="highlight plaintext"><code>// Keychain Query
// [REQ:BSI-eRp-ePA:O.Cryp_3#2,O.Cryp_6#2] Secure Enclave Key generation
let query: [String: Any] = [kSecClass as String: kSecClassKey,
</code></pre>
<h3 id='o-cryp_7' class='heading'>O.Cryp_7</h3>

<p>As Brainpool256R1 is not available within secure enclave but enforced by BSI where possible, we use secure enclave encryption only for biometric authentication. Everywhere else, cryptographic operations are ephemeral or use the eGK as a secure execution environment.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-20-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:20</code></h4>

<p>Container for private key operations using secure enclave private keys</p>
<pre class="highlight plaintext"><code>/// Represents a (SecureEnclave) private key, namely `PrK_SE_AUT`, secured by iOS Biometrics.
///
/// [REQ:gemSpec_IDP_Frontend:A_21590] This is the container to represent biometric keys. Usage is limited to
/// authorization purposes
/// [REQ:BSI-eRp-ePA:O.Cryp_7#2] Container for private key operations using secure enclave private keys
public struct PrivateKeyContainer {
</code></pre>
<h3 id='o-data_1' class='heading'>O.Data_1</h3>

<p>User preferences are asked without discrimination within the onboarding process</p>
<h3 id='o-data_2' class='heading'>O.Data_2</h3>

<p>We use the OS Keychain to persist sensitive data. The keychain either stores or encrypts via SecureEnclave. </p>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-23-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:23</code></h4>

<p>Implementation of data storage that is</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemF_Tokenverschlüsselung:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_2#5,O.Arch_4#3,O.Source_7#2,O.Data_2#2] Implementation of data storage that is
// persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {
</code></pre>
<h3 id='o-data_3' class='heading'>O.Data_3</h3>

<p>Currently it is not possible to store data within the secure enclave on iOS. We store all data on the encrypted application container on the device. See <code>eRpApp.entitlements</code> for <code>NSFileProtectionCompleteUnlessOpen</code> usage.</p>
<h3 id='o-data_4' class='heading'>O.Data_4</h3>

<p>Everything we store, safe or send anywhere is both verified as in O.Resi_4 and or encrypted, such as Keychain or the application container.</p>
<h3 id='o-data_5' class='heading'>O.Data_5</h3>

<p>Ephemeral private keys are released as soon as they are no longer needed (see O.Source_5)</p>
<h3 id='o-data_6' class='heading'>O.Data_6</h3>

<p>Collected data is sparse and use case related as required.</p>
<h4 id='code-sources-erpapp-screens-cardwall-can-cardwallcanview-swift-163-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/CAN/CardWallCANView.swift:163</code></h4>

<p>CAN is used for eGK connection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#2,O.Data_6#2] CAN is used for eGK connection
CardWallCANInputView(
</code></pre>
<h4 id='code-sources-erpapp-screens-cameraview-erxtaskscannerview-swift-27-code' class='heading'><code>../Sources/eRpApp/Screens/CameraView/ErxTaskScannerView.swift:27</code></h4>

<p>Scanning tasks contains purpose related data input</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#1,O.Data_6#3] Scanning tasks contains purpose related data input
// [REQ:BSI-eRp-ePA:O.Source_1#1] Scanning tasks starts with scanner callback
viewStore.send(.analyse(scanOutput: $0))
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-pin-cardwallpinview-swift-31-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/PIN/CardWallPINView.swift:31</code></h4>

<p>PIN is used for eGK Connection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#3,O.Data_6#4] PIN is used for eGK Connection
PINView(store: store).padding()
</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-redeem-pharmacycontactview-swift-10-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Redeem/PharmacyContactView.swift:10</code></h4>

<p>Contact information is collected when needed for redeeming</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#6,O.Data_6#5] Contact information is collected when needed for redeeming
struct PharmacyContactView: View {
</code></pre>
<h4 id='code-sources-erpapp-tracking-analyticsreducer-swift-16-code' class='heading'><code>../Sources/eRpApp/Tracking/AnalyticsReducer.swift:16</code></h4>

<p>User interaction analytics trigger &hellip;</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#4,O.Purp_4#1,O.Data_6#6] User interaction analytics trigger ...
struct AnalyticsReducer&lt;ContentReducer: ReducerProtocol&gt;: ReducerProtocol
</code></pre>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-99-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:99</code></h4>

<p>&hellip; records data only if user opt-in is given.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#5,O.Purp_4#2,O.Data_6#7] ... records data only if user opt-in is given.
if optIn {
</code></pre>
<h3 id='o-data_7' class='heading'>O.Data_7</h3>

<p>Private data is not initially created by the application. Only additional information, such as redeeming or deleting prescriptions create data. The created data is kept on the FD.</p>
<h3 id='o-data_8' class='heading'>O.Data_8</h3>

<p>The device camera is used for scanning prescriptions.</p>
<h4 id='code-sources-erpapp-screens-cameraview-avscannerview-swift-40-code' class='heading'><code>../Sources/eRpApp/Screens/CameraView/AVScannerView.swift:40</code></h4>

<p>This controller uses the camera as an input device. Frames are processed but never</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_8#2] This controller uses the camera as an input device. Frames are processed but never
// stored, metadata is never created here.
class AVScannerViewController: UIViewController, AVCaptureMetadataOutputObjectsDelegate {
</code></pre>
<h3 id='o-data_9' class='heading'>O.Data_9</h3>

<p>The device camera is used for scanning prescriptions, no picture files are created.</p>
<h3 id='o-data_10' class='heading'>O.Data_10</h3>

<p>Password fields are marked as such and thus disallow autocorrections. Search for <code>SecureField</code> or <code>SecureFieldWithReveal</code> for all usages.</p>
<h4 id='code-sources-erpapp-components-controls-securefieldwithreveal-swift-36-code' class='heading'><code>../Sources/eRpApp/Components/Controls/SecureFieldWithReveal.swift:36</code></h4>

<p><code>SecureFields</code> are used for password input.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_10#3] `SecureFields` are used for password input.
SecureField(text: $text) {
</code></pre>
<h3 id='o-data_11' class='heading'>O.Data_11</h3>

<p>We use default platform behavior for password fields.</p>
<h3 id='o-data_12' class='heading'>O.Data_12</h3>

<p>There is no API from Apple that allows extraction of biometric data.</p>
<h3 id='o-data_13' class='heading'>O.Data_13</h3>

<p>Suppressing Screenshots is not possible as of now.</p>
<h4 id='code-sources-erpapp-scenedelegate-swift-240-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:240</code></h4>

<p>Moving the application to the background blurs the application</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_13#2,O.Plat_12#2] Moving the application to the background blurs the application
// window.
addBlurOverlayToWindow()
</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-161-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:161</code></h4>

<p>Moving the application to the foreground removes the blur.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_13#3,O.Plat_12#3] Moving the application to the foreground removes the blur.
removeBlurOverlayFromWindow()
</code></pre>
<h3 id='o-data_14' class='heading'>O.Data_14</h3>

<p>See <code>eRpApp.entitlements</code> for <code>NSFileProtectionCompleteUnlessOpen</code> usage.</p>
<h3 id='o-data_15' class='heading'>O.Data_15</h3>

<p>Biometric keys are always bound to the device and cannot leave the secure enclave. Actual user data is excluded from backups and cannot be exported.</p>
<h4 id='code-sources-erplocalstorage-coredatacontroller-swift-83-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataController.swift:83</code></h4>

<p>Database backup exclusion</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#4,O.Arch_2#4,O.Arch_4#2,O.Data_15#1] Database backup exclusion
if excludeFromBackup, let storeUrl = store.url {
</code></pre>
<h4 id='code-sources-idp-privatekeycontainer-swift-126-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:126</code></h4>

<p>prevents migration to other devices</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21586] prevents migration to other devices
// [REQ:BSI-eRp-ePA:O.Data_15#2] prevents migration to other devices
kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly,
</code></pre>
<h3 id='o-data_16' class='heading'>O.Data_16</h3>

<p>Storing application data is not possible on iOS.</p>
<h3 id='o-data_17' class='heading'>O.Data_17</h3>

<p>Deletion is completely handled by the OS. We have no means of doing anything while deinstallation is running. All sensitive keychain data is tied to the user profile id and cannot be accessed after deinstallation. though technically the information still persists for a short period of time (&lt;24h) after some kind of daily cleanup routine by the OS it will be removed. The user may choose to manually logout or delete profiles before app deletion.</p>
<h3 id='o-data_18' class='heading'>O.Data_18</h3>

<p>Deletion is completely handled by the OS. We have no means of doing anything while deinstallation is running. All sensitive keychain data is tied to the user profile id and cannot be accessed after deinstallation. though technically the information still persists for a short period of time (&lt;24h) after some kind of daily cleanup routine by the OS it will be removed. The user may choose to manually logout or delete profiles before app deletion.</p>
<h3 id='o-data_19' class='heading'>O.Data_19</h3>

<p>Not applicable: no kill switch realized.</p>
<h3 id='o-ntwk_1' class='heading'>O.Ntwk_1</h3>

<p>no exceptions set in NSAppTransportSecurity, HTTP via TLS is enforced; OS will use system root certificates in combination with set pinned certificates. see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>
<h3 id='o-ntwk_2' class='heading'>O.Ntwk_2</h3>

<p>We use one wrapper around NSURLSession for network communication that uses an ephemeral configuration only allowing TLS 1.2 or greater.</p>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-42-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:42</code></h4>

<p>URLSession is used as Network Framework</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_Krypt:GS-A_5322] TODO: Check if limiting SSL Sessions is possible, check for renegotiation
// swiftlint:disable:previous todo
// [REQ:gemSpec_IDP_Frontend:A_20606] Live URLs not present in NSAppTransportSecurity exception list for allowed
// HTTP communication
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Sess_1#2,O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework

</code></pre>
<h3 id='o-ntwk_3' class='heading'>O.Ntwk_3</h3>

<p>We use NSURLSession for network communication</p>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-42-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:42</code></h4>

<p>URLSession is used as Network Framework</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_Krypt:GS-A_5322] TODO: Check if limiting SSL Sessions is possible, check for renegotiation
// swiftlint:disable:previous todo
// [REQ:gemSpec_IDP_Frontend:A_20606] Live URLs not present in NSAppTransportSecurity exception list for allowed
// HTTP communication
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Sess_1#2,O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework

</code></pre>
<h3 id='o-ntwk_4' class='heading'>O.Ntwk_4</h3>

<p>The App Transport Security Settings for all pinned certificates and the supported domains is done in <code>eRpApp/Resources/Info.plist</code>. For more informations take a look at the apple documentation of <a href="https://developer.apple.com/news/?id=g9ejcf8y">How to configure server certificates</a> and <a href="https://developer.apple.com/documentation/bundleresources/information_property_list/nsapptransportsecurity/nspinneddomains">NSPinnedDomains</a>.</p>
<h3 id='o-ntwk_5' class='heading'>O.Ntwk_5</h3>

<p>By using NSURLSession ATS (App Transport Security) handles that within the application.</p>
<h3 id='o-ntwk_6' class='heading'>O.Ntwk_6</h3>

<p>The server uses extended validation certificates to ensure maximum authenticity.</p>
<h3 id='o-ntwk_7' class='heading'>O.Ntwk_7</h3>

<p>The system enforces ATS <a href="https://developer.apple.com/documentation/bundleresources/information_property_list/nsapptransportsecurity/">App Transport Security</a> since the app uses the standard URL Loading System <code>URLSession</code> which automatically negotiate the most secure connection available from the server. Also there are no exceptions configured in the <code>eRpApp/Resources/Info.plist</code> thus insecure networt connections are disabled by default.</p>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-42-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:42</code></h4>

<p>URLSession is used as Network Framework</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_Krypt:GS-A_5322] TODO: Check if limiting SSL Sessions is possible, check for renegotiation
// swiftlint:disable:previous todo
// [REQ:gemSpec_IDP_Frontend:A_20606] Live URLs not present in NSAppTransportSecurity exception list for allowed
// HTTP communication
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Sess_1#2,O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework

</code></pre>
<h3 id='o-ntwk_8' class='heading'>O.Ntwk_8</h3>

<p>Since this is a requirement for a backend system, it is not applicable to the FdV</p>
<h3 id='o-ntwk_9' class='heading'>O.Ntwk_9</h3>

<p>Since this is a requirement for a backend system, it is not applicable to the FdV</p>
<h3 id='o-paid_1' class='heading'>O.Paid_1</h3>

<p>The app does not offer any purchases.</p>
<h3 id='o-paid_2' class='heading'>O.Paid_2</h3>

<p>The app does not offer any purchases.</p>
<h3 id='o-paid_3' class='heading'>O.Paid_3</h3>

<p>The app does not offer any purchases.</p>
<h3 id='o-paid_4' class='heading'>O.Paid_4</h3>

<p>The app does not offer any purchases.</p>
<h3 id='o-paid_5' class='heading'>O.Paid_5</h3>

<p>The app does not offer any purchases.</p>
<h3 id='o-paid_6' class='heading'>O.Paid_6</h3>

<p>The app does not offer any purchases.</p>
<h3 id='o-paid_7' class='heading'>O.Paid_7</h3>

<p>The app does not offer any purchases.</p>
<h3 id='o-paid_8' class='heading'>O.Paid_8</h3>

<p>The app does not offer any purchases.</p>
<h3 id='o-paid_9' class='heading'>O.Paid_9</h3>

<p>The app does not offer any purchases.</p>
<h3 id='o-paid_10' class='heading'>O.Paid_10</h3>

<p>The app does not offer any purchases.</p>
<h3 id='o-pass_1' class='heading'>O.Pass_1</h3>

<p>We use zxcvbn-ios as a password strength indicator and enforcer for the application password.</p>
<h3 id='o-pass_2' class='heading'>O.Pass_2</h3>

<p>We use zxcvbn-ios as a password strength indicator and enforcer for the application password.</p>
<h3 id='o-pass_3' class='heading'>O.Pass_3</h3>

<p>The user may change the app passwords within the settings.</p>
<h4 id='code-sources-erpapp-screens-settings-appsecurity-createpasswordview-swift-10-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/AppSecurity/CreatePasswordView.swift:10</code></h4>

<p>View for changing the user password</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Pass_3#2] View for changing the user password
struct CreatePasswordView: View {
</code></pre>
<h3 id='o-pass_4' class='heading'>O.Pass_4</h3>

<p>There is no protocol for the application password within the application. If there is one, the keychain may hold it.</p>
<h3 id='o-pass_5' class='heading'>O.Pass_5</h3>

<p>We use the keychain to persist the app password. The app password is not hashed.</p>
<h3 id='o-plat_1' class='heading'>O.Plat_1</h3>

<p>We test for device pincode at startup and show a dialog if no pin is set.</p>
<h4 id='code-sources-erpapp-screens-main-mainview-swift-122-code' class='heading'><code>../Sources/eRpApp/Screens/Main/MainView.swift:122</code></h4>

<p>trigger device security check</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#2,O.Resi_2#2,O.Plat_1#2] trigger device security check
viewStore.send(.loadDeviceSecurityView)
</code></pre>
<h4 id='code-sources-erpapp-session-helper-devicesecuritymanager-swift-58-code' class='heading'><code>../Sources/eRpApp/Session/Helper/DeviceSecurityManager.swift:58</code></h4>

<p>calculate system risk for jailbreak and missing device pin</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#3,O.Resi_2#3,O.Plat_1#3] calculate system risk for jailbreak and missing device pin
var showSystemSecurityWarning: AnyPublisher&lt;DeviceSecurityWarningType, Never&gt; {
</code></pre>
<h4 id='code-sources-erpapp-session-helper-devicesecuritymanager-swift-68-code' class='heading'><code>../Sources/eRpApp/Session/Helper/DeviceSecurityManager.swift:68</code></h4>

<p>Missing system pin detection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Plat_1#4] Missing system pin detection
var informMissingSystemPin: AnyPublisher&lt;Bool, Never&gt; {
</code></pre>
<h3 id='o-plat_2' class='heading'>O.Plat_2</h3>

<p>The app ony configures entitlements that are used for it&rsquo;s primary purpose. All configured entitlements are configured in <code>eRpApp/Resources/Info.plist</code> and in <code>eRpApp/Resources/eRpApp.entitlements</code>.</p>
<h3 id='o-plat_3' class='heading'>O.Plat_3</h3>

<p>We use the platform dialogs for this. Localizations can be found within <code>InfoPlist.strings</code></p>
<h3 id='o-plat_4' class='heading'>O.Plat_4</h3>

<p>We never show sensitive data as all errors are localized with custom descriptions (See <code>LocalizedError</code> implementations). Some errors have localized parameters such as a failed PIN counter. Some errors are sent from the server, these messages show only generic information what went wrong.</p>
<h3 id='o-plat_5' class='heading'>O.Plat_5</h3>

<p>Not applicable: displaying of messages not realized.</p>
<h3 id='o-plat_6' class='heading'>O.Plat_6</h3>

<p>Implemented by the OS Sandboxing.</p>
<h3 id='o-plat_7' class='heading'>O.Plat_7</h3>

<p>Implemented by the OS Sandboxing.</p>
<h3 id='o-plat_8' class='heading'>O.Plat_8</h3>

<p>Not applicable: broadcasting of messages not realized. Sandboxing does not allow that Broadcasts from NSNotificationCenter leave the application.</p>
<h3 id='o-plat_9' class='heading'>O.Plat_9</h3>

<p>Not applicable: broadcasting of messages not realized.</p>
<h3 id='o-plat_10' class='heading'>O.Plat_10</h3>

<p>Interprocess communication is implemented using Universal Linking. Current use cases are limited to login with insurance company apps. No sensitive data is transferred, the actual payload is decided by the server.</p>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationdomain-swift-82-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationDomain.swift:82</code></h4>

<p>Start login with KK</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22294] Start login with KK
// [REQ:BSI-eRp-ePA:O.Auth_3#2,O.Plat_10#2] Start login with KK
return .publisher(
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationdomain-swift-97-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationDomain.swift:97</code></h4>

<p>Follow redirect</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22299] Follow redirect
// [REQ:BSI-eRp-ePA:O.Plat_10#3] Follow redirect
guard environment.resourceHandler.canOpenURL(url) else {
</code></pre>
<h3 id='o-plat_11' class='heading'>O.Plat_11</h3>

<p>WebViews only display local content that is delivered together with the application. Javascript is disabled, linking and loading other content is disabled. All website open the system browser.</p>
<h4 id='code-sources-erpapp-screens-settings-dataprivacy-dataprivacyview-swift-27-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/DataPrivacy/DataPrivacyView.swift:27</code></h4>

<p>disabled javascript</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Plat_11#2] disabled javascript
wkWebView.configuration.defaultWebpagePreferences.allowsContentJavaScript = false
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-termsofuse-termsofuseview-swift-26-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/TermsOfUse/TermsOfUseView.swift:26</code></h4>

<p>disabled javascript</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Plat_11#3] disabled javascript
wkWebView.configuration.defaultWebpagePreferences.allowsContentJavaScript = false
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-foss-fossview-swift-25-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/FOSS/FOSSView.swift:25</code></h4>

<p>disabled javascript</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Plat_11#4] disabled javascript
wkWebView.configuration.defaultWebpagePreferences.allowsContentJavaScript = false
</code></pre>
<h3 id='o-plat_12' class='heading'>O.Plat_12</h3>

<p>The content window is blurred upon leaving the application to not expose content to the system multitasking switcher.</p>
<h4 id='code-sources-erpapp-scenedelegate-swift-240-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:240</code></h4>

<p>Moving the application to the background blurs the application</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_13#2,O.Plat_12#2] Moving the application to the background blurs the application
// window.
addBlurOverlayToWindow()
</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-161-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:161</code></h4>

<p>Moving the application to the foreground removes the blur.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Data_13#3,O.Plat_12#3] Moving the application to the foreground removes the blur.
removeBlurOverlayFromWindow()
</code></pre>
<h3 id='o-plat_13' class='heading'>O.Plat_13</h3>

<p>Implemented using a <code>WKWebViewDelegate</code>.</p>
<h4 id='code-sources-erpapp-screens-settings-dataprivacytermsofusenavigationdelegate-swift-9-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/DataPrivacyTermsOfUseNavigationDelegate.swift:9</code></h4>

<p>Delegate disables unused schemes</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Plat_13#2] Delegate disables unused schemes
class DataPrivacyTermsOfUseNavigationDelegate: NSObject, WKNavigationDelegate {
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-dataprivacy-dataprivacyview-swift-23-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/DataPrivacy/DataPrivacyView.swift:23</code></h4>

<p>Usage of the delegate</p>
<pre class="highlight plaintext"><code>// swiftlint:disable:next weak_delegate
// [REQ:BSI-eRp-ePA:O.Plat_13#3] Usage of the delegate
let navigationDelegate = DataPrivacyTermsOfUseNavigationDelegate()
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-foss-fossview-swift-21-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/FOSS/FOSSView.swift:21</code></h4>

<p>Usage of the delegate</p>
<pre class="highlight plaintext"><code>// swiftlint:disable:next weak_delegate
// [REQ:BSI-eRp-ePA:O.Plat_13#4] Usage of the delegate
let navigationDelegate = DataPrivacyTermsOfUseNavigationDelegate()
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-termsofuse-termsofuseview-swift-22-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/TermsOfUse/TermsOfUseView.swift:22</code></h4>

<p>Usage of the delegate</p>
<pre class="highlight plaintext"><code>// swiftlint:disable:next weak_delegate
// [REQ:BSI-eRp-ePA:O.Plat_13#5] Usage of the delegate
let navigationDelegate = DataPrivacyTermsOfUseNavigationDelegate()
</code></pre>
<h3 id='o-plat_14' class='heading'>O.Plat_14</h3>

<p>WebViews only display local content that is delivered together with the application. No cookies are created.</p>
<h3 id='o-plat_15' class='heading'>O.Plat_15</h3>

<p>The app&rsquo;s memory is subject to the operating system&rsquo;s memory and therefore it has no control over the used memory.</p>
<h3 id='o-plat_16' class='heading'>O.Plat_16</h3>

<p>During the onboarding process the user is forced to secure the access to the app either via a biometric trait or a strong password.</p>
<h3 id='o-purp_1' class='heading'>O.Purp_1</h3>
<h4 id='code-sources-erpapp-screens-onboarding-onboardinglegalinfoview-swift-159-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingLegalInfoView.swift:159</code></h4>

<p>Display as part of the onboarding</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_1#1] Display as part of the onboarding
struct OnboardingPrivacyView: View {
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-dataprivacy-dataprivacyview-swift-12-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/DataPrivacy/DataPrivacyView.swift:12</code></h4>

<p>Actual View driving the display of <code>DataPrivacy.html</code></p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_1#2] Actual View driving the display of `DataPrivacy.html`
// [REQ:BSI-eRp-ePA:O.Arch_8#3] Webview containing local html without javascript
// [REQ:gemSpec_eRp_FdV:A_19980#2] Actual View driving the display of `DataPrivacy.html`
struct DataPrivacyView: View {
</code></pre>
<h3 id='o-purp_2' class='heading'>O.Purp_2</h3>
<h4 id='code-sources-erpapp-screens-cameraview-erxtaskscannerview-swift-27-code' class='heading'><code>../Sources/eRpApp/Screens/CameraView/ErxTaskScannerView.swift:27</code></h4>

<p>Scanning tasks contains purpose related data input</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#1,O.Data_6#3] Scanning tasks contains purpose related data input
// [REQ:BSI-eRp-ePA:O.Source_1#1] Scanning tasks starts with scanner callback
viewStore.send(.analyse(scanOutput: $0))
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-can-cardwallcanview-swift-163-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/CAN/CardWallCANView.swift:163</code></h4>

<p>CAN is used for eGK connection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#2,O.Data_6#2] CAN is used for eGK connection
CardWallCANInputView(
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-pin-cardwallpinview-swift-31-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/PIN/CardWallPINView.swift:31</code></h4>

<p>PIN is used for eGK Connection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#3,O.Data_6#4] PIN is used for eGK Connection
PINView(store: store).padding()
</code></pre>
<h4 id='code-sources-erpapp-tracking-analyticsreducer-swift-16-code' class='heading'><code>../Sources/eRpApp/Tracking/AnalyticsReducer.swift:16</code></h4>

<p>User interaction analytics trigger &hellip;</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#4,O.Purp_4#1,O.Data_6#6] User interaction analytics trigger ...
struct AnalyticsReducer&lt;ContentReducer: ReducerProtocol&gt;: ReducerProtocol
</code></pre>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-99-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:99</code></h4>

<p>&hellip; records data only if user opt-in is given.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#5,O.Purp_4#2,O.Data_6#7] ... records data only if user opt-in is given.
if optIn {
</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-redeem-pharmacycontactview-swift-10-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Redeem/PharmacyContactView.swift:10</code></h4>

<p>Contact information is collected when needed for redeeming</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#6,O.Data_6#5] Contact information is collected when needed for redeeming
struct PharmacyContactView: View {
</code></pre>
<h3 id='o-purp_3' class='heading'>O.Purp_3</h3>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingcontainer-swift-89-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingContainer.swift:89</code></h4>

<p>Terms of Use display is part of the onboarding</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_3#1] Terms of Use display is part of the onboarding
.sheet(isPresented: viewStore.binding(get: \.showTermsOfUse,
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-termsofuse-termsofuseview-swift-11-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/TermsOfUse/TermsOfUseView.swift:11</code></h4>

<p>Actual view for the Terms of Use display</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_3#2] Actual view for the Terms of Use display
// [REQ:BSI-eRp-ePA:O.Arch_8#1] Webview containint local html without javascript
struct TermsOfUseView: View {
</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardinglegalinfoview-swift-72-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingLegalInfoView.swift:72</code></h4>

<p>User acceptance</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_3#3] User acceptance
OnboardingLegalInfoCheckmarkView(isAccepted: $isAllAccepted)
</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingcontainer-swift-68-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingContainer.swift:68</code></h4>

<p>Callback triggers tracking alert</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_3#4] Callback triggers tracking alert
viewStore.send(.showTracking)
</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-200-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:200</code></h4>

<p>Show comply route to display analytics usage within onboarding</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19088,A_19091#1,A_19092] Show comply route to display analytics usage within
// onboarding
// [REQ:BSI-eRp-ePA:O.Purp_3#5] Show comply route to display analytics usage within onboarding
case .showTracking:
</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-204-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:204</code></h4>

<p>Accept usage analytics</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090,A_19091#2] User confirms the opt in within settings
// [REQ:BSI-eRp-ePA:O.Purp_3#6] Accept usage analytics
case .alert(.presented(.allowTracking)):
</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-209-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:209</code></h4>

<p>Deny usage analytics</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19092] User may choose to not accept analytics
// [REQ:BSI-eRp-ePA:O.Purp_3#7] Deny usage analytics
case .alert(.dismiss):
</code></pre>
<h3 id='o-purp_4' class='heading'>O.Purp_4</h3>
<h4 id='code-sources-erpapp-tracking-analyticsreducer-swift-16-code' class='heading'><code>../Sources/eRpApp/Tracking/AnalyticsReducer.swift:16</code></h4>

<p>User interaction analytics trigger &hellip;</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#4,O.Purp_4#1,O.Data_6#6] User interaction analytics trigger ...
struct AnalyticsReducer&lt;ContentReducer: ReducerProtocol&gt;: ReducerProtocol
</code></pre>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-99-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:99</code></h4>

<p>&hellip; records data only if user opt-in is given.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#5,O.Purp_4#2,O.Data_6#7] ... records data only if user opt-in is given.
if optIn {
</code></pre>
<h3 id='o-purp_5' class='heading'>O.Purp_5</h3>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-224-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:224</code></h4>

<p>Toggle within Settings to enable and disable usage tracking</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19097] Toggle within Settings to enable and disable usage tracking
// [REQ:BSI-eRp-ePA:O.Purp_5#1] Toggle within Settings to enable and disable usage tracking
// [REQ:BSI-eRp-ePA:O.Purp_6#1] Current Analytics state is inspectable by the user
// [REQ:gemSpec_eRp_FdV:A_19982#4] Opt out of analytics
Toggle(isOn: viewStore.binding(
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-207-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:207</code></h4>

<p>Actual disabling of analytics</p>
<pre class="highlight plaintext"><code>// Tracking
// [REQ:gemSpec_eRp_FdV:A_19088, A_19089, A_19092, A_19097] OptIn for usage tracking
// [REQ:BSI-eRp-ePA:O.Purp_5#2] Actual disabling of analytics
// [REQ:gemSpec_eRp_FdV:A_19982#2] Opt out of analytics
case let .toggleTrackingTapped(optIn):
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-61-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:61</code></h4>

<p>Show comply view for settings triggered analytics enabling</p>
<pre class="highlight plaintext"><code>// Tracking comply sheet presentation
// [REQ:BSI-eRp-ePA:O.Purp_5#3] Show comply view for settings triggered analytics enabling
// [REQ:gemSpec_eRp_FdV:A_19982#3] Opt out of analytics
Rectangle()
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-218-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:218</code></h4>

<p>User confirms the opt in within settings</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090,A_19091#4] User confirms the opt in within settings
// [REQ:BSI-eRp-ePA:O.Purp_5#4] User confirms the opt in within settings
case .confirmedOptInTracking:
</code></pre>
<h3 id='o-purp_6' class='heading'>O.Purp_6</h3>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-225-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:225</code></h4>

<p>Current Analytics state is inspectable by the user</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19097] Toggle within Settings to enable and disable usage tracking
// [REQ:BSI-eRp-ePA:O.Purp_5#1] Toggle within Settings to enable and disable usage tracking
// [REQ:BSI-eRp-ePA:O.Purp_6#1] Current Analytics state is inspectable by the user
// [REQ:gemSpec_eRp_FdV:A_19982#4] Opt out of analytics
Toggle(isOn: viewStore.binding(
</code></pre>

<p>As most of the user decisions are client side no history is available. Only the current state can be inspected.</p>
<h3 id='o-purp_7' class='heading'>O.Purp_7</h3>

<p>Most libraries are self written and cover only what is needed. Dependencies are only included if really necessary. We think about including only sub packages, but as most dependencies are very small, this is hardly used. Besides that, no means of removing unused dependency functionality is available for the platform.</p>
<h3 id='o-purp_8' class='heading'>O.Purp_8</h3>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-23-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:23</code></h4>

<p>Implementation of data storage that is</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemF_Tokenverschlüsselung:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_2#5,O.Arch_4#3,O.Source_7#2,O.Data_2#2] Implementation of data storage that is
// persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {
</code></pre>
<h4 id='code-sources-erplocalstorage-coredatacontrollerfactory-swift-32-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataControllerFactory.swift:32</code></h4>

<p>CoreData databases are protected</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#2,O.Arch_2#2] CoreData databases are protected
self.fileProtection = fileProtection
</code></pre>
<h4 id='code-sources-erplocalstorage-coredatacontroller-swift-59-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataController.swift:59</code></h4>

<p>actual protection setting on file system level</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#3,O.Arch_2#3] actual protection setting on file system level
protectedStoreDescription.setOption(
</code></pre>
<h4 id='code-sources-erplocalstorage-coredatacontroller-swift-83-code' class='heading'><code>../Sources/eRpLocalStorage/CoreDataController.swift:83</code></h4>

<p>Database backup exclusion</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_8#4,O.Arch_2#4,O.Arch_4#2,O.Data_15#1] Database backup exclusion
if excludeFromBackup, let storeUrl = store.url {
</code></pre>
<h3 id='o-purp_9' class='heading'>O.Purp_9</h3>
<h4 id='code-sources-erpapp-screens-settings-idptokenview-idptokenview-swift-11-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/IDPTokenView/IDPTokenView.swift:11</code></h4>

<p>Access and SSO Token display</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_9#1] Access and SSO Token display
// [REQ:BSI-eRp-ePA:O.Tokn_5#3] Access and SSO Token display
struct IDPTokenView: View {
</code></pre>
<h3 id='o-rand_1' class='heading'>O.Rand_1</h3>

<p>We use the platform provided secure random generator. See <a href="https://support.apple.com/en-gb/guide/security/seca0c73a75b/web">Apple Support Website</a> for details.</p>
<h4 id='code-sources-idp-internal-seckeyrandom-swift-21-code' class='heading'><code>../Sources/IDP/internal/SecKeyRandom.swift:21</code></h4>

<p>Secure Random generator.</p>
<pre class="highlight plaintext"><code>/// Generate random Data with given length
///
/// [REQ:gemSpec_Krypt:GS-A_4367]
/// [REQ:BSI-eRp-ePA:O.Rand_1#2] Secure Random generator.
///
/// - Parameters:
///   - length: the number of bytes to generate
///   - randomizer: the randomizer to be used. Default: kSecRandomDefault
/// - Returns: the random initialized Data
/// - Throws: `IDPError`
public func generateSecureRandom(length: Int, randomizer: SecRandomRef? = kSecRandomDefault) throws -&gt; Data {
</code></pre>
<h4 id='code-sources-vauclient-internal-vaurandom-swift-22-code' class='heading'><code>../Sources/VAUClient/internal/VAURandom.swift:22</code></h4>

<p>Secure Random generator.</p>
<pre class="highlight plaintext"><code>/// Generate random Data with given length
///
/// [REQ:gemSpec_Krypt:GS-A_4367]
/// [REQ:BSI-eRp-ePA:O.Rand_1#3] Secure Random generator.
///
/// - Parameters:
///   - length: the number of bytes to generate
///   - randomizer: the randomizer to be used. Default: kSecRandomDefault
/// - Returns: the random initialized Data
/// - Throws: `VAUError`
static func generateSecureRandom(length: Int, randomizer: SecRandomRef? = kSecRandomDefault) throws -&gt; Data {
</code></pre>
<h3 id='o-rand_2' class='heading'>O.Rand_2</h3>

<p>We use the platform provided secure random generator. See <a href="https://support.apple.com/en-gb/guide/security/seca0c73a75b/web">Apple Support Website</a> for details.</p>
<h3 id='o-rand_3' class='heading'>O.Rand_3</h3>

<p>We use the platform provided secure random generator. See <a href="https://support.apple.com/en-gb/guide/security/seca0c73a75b/web">Apple Support Website</a> for details.</p>
<h3 id='o-rand_4' class='heading'>O.Rand_4</h3>

<p>We use the platform provided secure random generator. See <a href="https://support.apple.com/en-gb/guide/security/seca0c73a75b/web">Apple Support Website</a> for details.</p>
<h3 id='o-resi_1' class='heading'>O.Resi_1</h3>

<p>The onboarding contains defaults that are best practices, such as using biometrics for authentication. While using the Cardwall, selecting the &ldquo;save login&rdquo; option results in an dialog with additional information, to let the user make informed decisions. A missing device passcode results in a dialog that is recommending the setup of a device passcode.</p>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingregisterauthenticationview-swift-11-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingRegisterAuthenticationView.swift:11</code></h4>

<p>View containing onboarding authentication</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Resi_1#2] View containing onboarding authentication
struct OnboardingRegisterAuthenticationView: View, KeyboardReadable {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-login-cardwallloginoptionview-swift-119-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/Login/CardWallLoginOptionView.swift:119</code></h4>

<p>View containing information regarding the login options.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21574] Actual view
// [REQ:BSI-eRp-ePA:O.Resi_1#3] View containing information regarding the login options.
struct PrivacyWarningViewContainer: View {
</code></pre>
<h4 id='code-sources-erpapp-screens-main-devicesecurity-devicesecuritynosystempin-devicesecuritysystempinview-swift-9-code' class='heading'><code>../Sources/eRpApp/Screens/Main/DeviceSecurity/DeviceSecurityNoSystemPin/DeviceSecuritySystemPinView.swift:9</code></h4>

<p>View containing the &ldquo;no system pin&rdquo; message.</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Resi_1#4] View containing the "no system pin" message.
struct DeviceSecuritySystemPinView: View {
</code></pre>
<h3 id='o-resi_2' class='heading'>O.Resi_2</h3>

<p>Jailbreak detection is done on startup of the application after the app authentication. If a jailbreak is detected, a information dialog is presented to the user.</p>
<h4 id='code-sources-erpapp-screens-main-mainview-swift-122-code' class='heading'><code>../Sources/eRpApp/Screens/Main/MainView.swift:122</code></h4>

<p>trigger device security check</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#2,O.Resi_2#2,O.Plat_1#2] trigger device security check
viewStore.send(.loadDeviceSecurityView)
</code></pre>
<h4 id='code-sources-erpapp-session-helper-devicesecuritymanager-swift-58-code' class='heading'><code>../Sources/eRpApp/Session/Helper/DeviceSecurityManager.swift:58</code></h4>

<p>calculate system risk for jailbreak and missing device pin</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#3,O.Resi_2#3,O.Plat_1#3] calculate system risk for jailbreak and missing device pin
var showSystemSecurityWarning: AnyPublisher&lt;DeviceSecurityWarningType, Never&gt; {
</code></pre>
<h4 id='code-sources-erpapp-session-helper-devicesecuritymanager-swift-112-code' class='heading'><code>../Sources/eRpApp/Session/Helper/DeviceSecurityManager.swift:112</code></h4>

<p>Jailbreak detection</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#4,O.Resi_2#4] Jailbreak detection
func informJailbreakDetected() -&gt; Bool {
</code></pre>
<h4 id='code-sources-erpapp-screens-main-devicesecurity-devicesecurityrooteddevice-devicesecurityrooteddeviceview-swift-9-code' class='heading'><code>../Sources/eRpApp/Screens/Main/DeviceSecurity/DeviceSecurityRootedDevice/DeviceSecurityRootedDeviceView.swift:9</code></h4>

<p>Jailbreak information view</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Arch_6#5,O.Resi_2#5] Jailbreak information view
struct DeviceSecurityRootedDeviceView: View {
</code></pre>
<h3 id='o-resi_3' class='heading'>O.Resi_3</h3>

<p>Starting within a debug environment is only possible on rooted/jailbroken devices. If that is the case, the user sees a dialog and can choose to continue or cancel using the application. See O.Resi_2 for jailbreak detection details.</p>
<h3 id='o-resi_4' class='heading'>O.Resi_4</h3>

<p>Starting with unusal app rights is only possible on rooted/jailbroken devices. If that is the case, the user sees a dialog and can choose to continue or cancel using the application. See O.Resi_2 for jailbreak detection details.</p>
<h3 id='o-resi_5' class='heading'>O.Resi_5</h3>

<p>Device Integrity may only be compromised on jailbroken devices. If that is the case, the user sees a dialog and can choose to continue or cancel using the application. See O.Resi_2 for jailbreak detection details. We exclude very old and unsecure devices, by restricting the application to modern iOS Versions. That restriction is automatically restricting the range of devices it can run on. See <code>options.deploymentTarget.iOS</code> path within <code>project.yml</code> or the generated <code>IPHONEOS_DEPLOYMENT_TARGET</code> within the <code>project.pbxproj</code> file for the iOS Version restriction.</p>
<h3 id='o-resi_6' class='heading'>O.Resi_6</h3>

<p>IDP Communication is secured by using TLS with pinned Certificates as well as JWEs with keys that are pinned using a TI specific trust anchor as well as OCSP. FD Communication is secured by using TLS and VAU encryption, again with pinned Certificates for both methods. APOVZD communication uses TLS with pinned certificates. The Pinned certificates fingerprints can be found within <code>Sources/eRpApp/Resources/Info.plist</code>.</p>
<h4 id='code-sources-idp-defaultidpsession-swift-261-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:261</code></h4>

<p>Implementation of loading the discovery document for fetching signature and</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Resi_6#2] Implementation of loading the discovery document for fetching signature and
// encryption keys.
private func loadDiscoveryDocument() -&gt; AnyPublisher&lt;DiscoveryDocument, IDPError&gt; {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-420-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:420</code></h4>

<p>Discovery Document signature verification</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22296] Signature verification
// [REQ:BSI-eRp-ePA:O.Resi_6#3] Discovery Document signature verification
guard try jwtContainer.verify(with: document.discKey) == true else {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-290-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:290</code></h4>

<p>Discovery Document signature verification</p>
<pre class="highlight plaintext"><code>// Validate JWT/DiscoveryDocument signature
// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02] Assure that brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4361-02] Assure that brainpoolP256r1 is used
// [REQ:BSI-eRp-ePA:O.Resi_6#4] Discovery Document signature verification
guard (try? fetchedDocument.backing.verify(with: fetchedDocument.discKey)) ?? false else {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-752-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:752</code></h4>

<p>Discovery Document signature verification</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Resi_6#5] Discovery Document signature verification
validate(certificate: discoveryDocument.discKey)
</code></pre>
<h3 id='o-resi_7' class='heading'>O.Resi_7</h3>

<p>Recent Jailbreaks force a reboot or restart of springboard. Thus the application will also be restarted in these cases. The check for hardening is done on app startup and should be sufficient.</p>
<h3 id='o-resi_8' class='heading'>O.Resi_8</h3>

<p>The application source is available on github. Any measure of preventing reverse engineering would be pointless.</p>
<h3 id='o-resi_9' class='heading'>O.Resi_9</h3>

<p>Data is not stored while moving between platforms or devices. Private keys are stored within the secure enclave an cannot leave the device.</p>
<h3 id='o-resi_10' class='heading'>O.Resi_10</h3>

<p>Missing internet connection or other means of disruption use the same error mechanisms as every part of the app uses for normal errors. Data is only deleted where appropriate, e.g. invalid tokens are deleted. User Data is not deleted unless explicitly confirmed by the user.</p>
<h3 id='o-sess_1' class='heading'>O.Sess_1</h3>

<p>TLS Session handling is done via NSURLSession. Cookie based user sessions are never created, all connections are ephemeral, remote APIs are stateless.</p>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-42-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:42</code></h4>

<p>URLSession is used as Network Framework</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_Krypt:GS-A_5322] TODO: Check if limiting SSL Sessions is possible, check for renegotiation
// swiftlint:disable:previous todo
// [REQ:gemSpec_IDP_Frontend:A_20606] Live URLs not present in NSAppTransportSecurity exception list for allowed
// HTTP communication
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Sess_1#2,O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework

</code></pre>
<h3 id='o-sess_2' class='heading'>O.Sess_2</h3>

<p>not applicable</p>
<h3 id='o-sess_3' class='heading'>O.Sess_3</h3>

<p>not applicable</p>
<h3 id='o-sess_4' class='heading'>O.Sess_4</h3>

<p>not applicable</p>
<h3 id='o-sess_5' class='heading'>O.Sess_5</h3>

<p>not applicable</p>
<h3 id='o-sess_6' class='heading'>O.Sess_6</h3>

<p>not applicable</p>
<h3 id='o-sess_7' class='heading'>O.Sess_7</h3>

<p>not applicable</p>
<h3 id='o-source_1' class='heading'>O.Source_1</h3>
<h4 id='code-sources-erpapp-screens-cameraview-erxtaskscannerview-swift-28-code' class='heading'><code>../Sources/eRpApp/Screens/CameraView/ErxTaskScannerView.swift:28</code></h4>

<p>Scanning tasks starts with scanner callback</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_2#1,O.Data_6#3] Scanning tasks contains purpose related data input
// [REQ:BSI-eRp-ePA:O.Source_1#1] Scanning tasks starts with scanner callback
viewStore.send(.analyse(scanOutput: $0))
</code></pre>
<h4 id='code-sources-erpapp-screens-cameraview-scannerdomain-swift-133-code' class='heading'><code>../Sources/eRpApp/Screens/CameraView/ScannerDomain.swift:133</code></h4>

<p>analyse the input</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#2] analyse the input
let result = try CodeAnalyser.analyse(scanOutput: scanOutput, with: state.acceptedTaskBatches)
</code></pre>
<h4 id='code-sources-erpapp-screens-cameraview-scannerdomain-helper-swift-16-code' class='heading'><code>../Sources/eRpApp/Screens/CameraView/ScannerDomain+Helper.swift:16</code></h4>

<p>validation</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#3] validation
static func analyse(scanOutput: [ScanOutput],
</code></pre>
<h4 id='code-sources-erpkit-scannederxtask-swift-104-code' class='heading'><code>../Sources/eRpKit/ScannedErxTask.swift:104</code></h4>

<p>actual validation by decoding into predefined structure</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19984] validate data matrix code structure
// [REQ:BSI-eRp-ePA:O.Source_1#4] actual validation by decoding into predefined structure
erxToken = try jsonDecoder.decode(ErxToken.self, from: jsonData)
</code></pre>
<h4 id='code-sources-erpapp-scenedelegate-swift-244-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:244</code></h4>

<p>External application calls via Universal Linking</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#5] External application calls via Universal Linking
func scene(_: UIScene, continue userActivity: NSUserActivity) {
</code></pre>
<h4 id='code-sources-erpapp-screens-appstartdomain-swift-251-code' class='heading'><code>../Sources/eRpApp/Screens/AppStartDomain.swift:251</code></h4>

<p>External application calls via Universal Linking</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#6] External application calls via Universal Linking
case let .universalLink(url):
</code></pre>
<h4 id='code-sources-erpapp-screens-main-maindomain-swift-193-code' class='heading'><code>../Sources/eRpApp/Screens/Main/MainDomain.swift:193</code></h4>

<p>redirect into correct domain</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#7] redirect into correct domain
return .run { send in
</code></pre>
<h4 id='code-sources-erpapp-screens-main-extauth-extauthpendingdomain-swift-212-code' class='heading'><code>../Sources/eRpApp/Screens/Main/ExtAuth/ExtAuthPendingDomain.swift:212</code></h4>

<p>Validate data by parsing url and only allowing predefined variables as String</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_1#8] Validate data by parsing url and only allowing predefined variables as String
case let .externalLogin(url),
</code></pre>
<h3 id='o-source_2' class='heading'>O.Source_2</h3>

<p>Data escaping is done by the OS Frameworks. We never generate manual SQL Queries, CoreData is used as an ORM, Queries are build with NSFetchRequests and NSPredicates that escape all manual input. Actual user data is transported via FHIR and escaping is handled by the used FHIR library provided by Apple.</p>
<h4 id='code-sources-erplocalstorage-pharmacy-pharmacycoredatastore-swift-13-code' class='heading'><code>../Sources/eRpLocalStorage/Pharmacy/PharmacyCoreDataStore.swift:13</code></h4>

<p>CoreDataStore adapter for <code>PharmacyLocation</code>s</p>
<pre class="highlight plaintext"><code>/// Store for fetching, creating, updating or deleting `PharmacyLocation`s on the provided `CoreDataController`
/// [REQ:BSI-eRp-ePA:O.Source_2#2] CoreDataStore adapter for `PharmacyLocation`s
public class PharmacyCoreDataStore: PharmacyLocalDataStore, CoreDataCrudable {
</code></pre>
<h4 id='code-sources-erplocalstorage-prescriptions-erxtaskcoredatastore-swift-20-code' class='heading'><code>../Sources/eRpLocalStorage/Prescriptions/ErxTaskCoreDataStore.swift:20</code></h4>

<p>CoreDataStore adapter for <code>ErxTask</code>s</p>
<pre class="highlight plaintext"><code>// tag::ErxTaskCoreDataStoreDescription[]
/// Store for fetching, creating, updating or deleting `ErxTask`s and it‘s underlying types. Access to most entities is
/// tied to the given profileId.
/// [REQ:BSI-eRp-ePA:O.Source_2#3] CoreDataStore adapter for `ErxTask`s
public class DefaultErxTaskCoreDataStore: ErxTaskCoreDataStore {
</code></pre>
<h4 id='code-sources-erplocalstorage-profiles-profilecoredatastore-swift-13-code' class='heading'><code>../Sources/eRpLocalStorage/Profiles/ProfileCoreDataStore.swift:13</code></h4>

<p>CoreDataStore adapter for <code>Profile</code>s</p>
<pre class="highlight plaintext"><code>/// Store for fetching, creating, updating or deleting `Profile`s on the provided `CoreDataController`
/// [REQ:BSI-eRp-ePA:O.Source_2#4] CoreDataStore adapter for `Profile`s
public class ProfileCoreDataStore: ProfileDataStore, CoreDataCrudable {
</code></pre>
<h4 id='code-sources-erplocalstorage-shipmentinfo-shipmentinfocoredatastore-swift-13-code' class='heading'><code>../Sources/eRpLocalStorage/ShipmentInfo/ShipmentInfoCoreDataStore.swift:13</code></h4>

<p>CoreDataStore adapter for <code>ShipmentInfoEntity</code>s</p>
<pre class="highlight plaintext"><code>/// Store for fetching, creating, updating or deleting `ShipmentInfoEntity`s on the provided `CoreDataController`
/// [REQ:BSI-eRp-ePA:O.Source_2#5] CoreDataStore adapter for `ShipmentInfoEntity`s
public class ShipmentInfoCoreDataStore: ShipmentInfoDataStore, CoreDataCrudable {
</code></pre>
<h4 id='code-sources-erplocalstorage-avstransaction-avstransactioncoredatastore-swift-13-code' class='heading'><code>../Sources/eRpLocalStorage/AVSTransaction/AVSTransactionCoreDataStore.swift:13</code></h4>

<p>CoreDataStore adapter for <code>AVSTransactionEntity</code>s</p>
<pre class="highlight plaintext"><code>/// Store for fetching, creating, updating or deleting `AVSTransactionEntity`s on the provided `CoreDataController`
/// [REQ:BSI-eRp-ePA:O.Source_2#6] CoreDataStore adapter for `AVSTransactionEntity`s
public class AVSTransactionCoreDataStore: AVSTransactionDataStore, CoreDataCrudable {
</code></pre>
<h4 id='code-sources-pharmacy-modelsr4-bundle-location-swift-18-code' class='heading'><code>../Sources/Pharmacy/ModelsR4.Bundle+Location.swift:18</code></h4>

<p>Extension containing all FHIR related parsing for Pharmacies</p>
<pre class="highlight plaintext"><code>/// [REQ:BSI-eRp-ePA:O.Source_2#7] Extension containing all FHIR related parsing for Pharmacies
extension ModelsR4.Bundle {
</code></pre>

<p>See all files named <code>ModelsR4.Bundles+&lt;TypeName&gt;</code> within <code>eRpRemoteStorage</code> Package to find all references for FD related FHIR parsing. All other files within the Module are either helpers or provide support for creating FHIR objects that may be sent to the FD.</p>
<h3 id='o-source_3' class='heading'>O.Source_3</h3>

<p>Error messages are localized using the <code>Foundation.LocalizedError</code> protocol. Search for <code>LocalizedError</code> to see all instances. Most errors are localized with static text, some errors contain server side error messages. User data is never used for error messages. Logging is only active on debug builds.</p>
<h3 id='o-source_4' class='heading'>O.Source_4</h3>

<p>Exception handling in swift uses Errors to represent the exception. We use a custom protocol <code>CodedError</code> that is autogenerated for all error messages. Together with <code>LocalizedError</code> we create error messages that contain a user readable description as well as some technical identifiers to easily identify specific error scenarios and give better support. See <code>CodedError.swift</code> and <code>CodedError.generated.swift</code> for the protocol and the autogenerated implementations of it.</p>
<h3 id='o-source_5' class='heading'>O.Source_5</h3>

<p>As exceptions and errors are kind of the same construct in swift, this aspect is hard to answer. If a server responds with 401/403 we delete tokens or other security measures, because they are no longer valid anyways. While logging in via biometrics we create temporary data containers for the user certificate and key identifier, that are deleted if the process is not completed properly and kept if the process completes.</p>
<h4 id='code-sources-idp-idpinterceptor-swift-72-code' class='heading'><code>../Sources/IDP/IDPInterceptor.swift:72</code></h4>

<p>invalidate/delete unauthorized token</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167] invalidate/delete unauthorized token
// [REQ:BSI-eRp-ePA:O.Source_5#2] invalidate/delete unauthorized token
self.session.invalidateAccessToken()
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-107-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:107</code></h4>

<p>Invalidation means deleting the token</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_5#3] Invalidation means deleting the token
storage.set(token: nil)
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-61-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:61</code></h4>

<p>Creation of the pairing session</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_5#4] Creation of the pairing session
pairingSession = try sessionProvider.signatureProvider(for: profileID).createPairingSession()
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-77-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:77</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-130-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:130</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-146-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:146</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)
</code></pre>
<h3 id='o-source_6' class='heading'>O.Source_6</h3>

<p>Swift uses Automatic Reference Counting that does not require active memory management. Raw memory access is possible but only used for swift-OpenSSL dependency that wraps the c library.</p>
<h3 id='o-source_7' class='heading'>O.Source_7</h3>

<p>All sensitive data is handled via reference types. After usage the swift runtime handles deletion of the in memory representation. Secure enclave encryption keys can never leave the secure enclave.</p>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-23-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:23</code></h4>

<p>Implementation of data storage that is</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemF_Tokenverschlüsselung:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_2#5,O.Arch_4#3,O.Source_7#2,O.Data_2#2] Implementation of data storage that is
// persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {
</code></pre>
<h3 id='o-source_8' class='heading'>O.Source_8</h3>

<p>We use swift macros to remove development code. Configuration of server Environments is done within <code>AppConfiguration.swift</code>. A debug menu is available within settings, rooted within <code>SettingsView.swift</code>.</p>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-36-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:36</code></h4>

<p>Debug menu is only visible on debug builds</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_8#3] Debug menu is only visible on debug builds
#if ENABLE_DEBUG_VIEW
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-255-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:255</code></h4>

<p>DebugSectionView is only available on debug builds</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_8#4] DebugSectionView is only available on debug builds
private struct DebugSectionView: View {
</code></pre>
<h4 id='code-sources-erpapp-screens-debugview-debugview-swift-13-code' class='heading'><code>../Sources/eRpApp/Screens/DebugView/DebugView.swift:13</code></h4>

<p>DebugView is only available on debug builds</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Source_8#5] DebugView is only available on debug builds
struct DebugView: View {
</code></pre>
<h3 id='o-source_9' class='heading'>O.Source_9</h3>

<p>We use swift macros to remove debug mechanism code. A debug menu is available within settings, rooted within <code>SettingsView.swift</code>. All debug classes are excluded from release builds by using swift macros to remove the whole classes/structs.</p>
<h3 id='o-source_10' class='heading'>O.Source_10</h3>

<p>We use common defaults for all compiler security related settings. See Xcode build configuration for eRpApp Target using current Xcode for actual settings.</p>
<h3 id='o-source_11' class='heading'>O.Source_11</h3>

<p>We do not create any kind of logs for release builds.</p>
<h3 id='o-tokn_1' class='heading'>O.Tokn_1</h3>

<p>The token is stored within the keychain for long lasting tokens, short living tokens as used in biometric pairing process are not persisted and only live in the memory.</p>
<h4 id='code-sources-idp-idpstorage-swift-37-code' class='heading'><code>../Sources/IDP/IDPStorage.swift:37</code></h4>

<p>protocol defintion for token storage</p>
<pre class="highlight plaintext"><code>/// Set and save the IDPToken
/// [REQ:BSI-eRp-ePA:O.Tokn_1#2] protocol defintion for token storage
func set(token: IDPToken?)
</code></pre>
<h4 id='code-sources-erpapp-session-memorystorage-swift-41-code' class='heading'><code>../Sources/eRpApp/Session/MemoryStorage.swift:41</code></h4>

<p>MemoryStorage implementation</p>
<pre class="highlight plaintext"><code>/// [REQ:BSI-eRp-ePA:O.Tokn_1#3] MemoryStorage implementation
func set(token: IDPToken?) {
</code></pre>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-127-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:127</code></h4>

<p>KeychainStorage implementation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20184]
// [REQ:gemSpec_eRp_FdV:A_21328#3] KeychainStorage implementation
// [REQ:BSI-eRp-ePA:O.Tokn_1#4] KeychainStorage implementation
let success: Bool
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-235-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:235</code></h4>

<p>Storing the token from a successfull login</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Tokn_1#5] Storing the token from a successfull login
self?.storage.set(token: token)
</code></pre>
<h3 id='o-tokn_2' class='heading'>O.Tokn_2</h3>

<p>The token is created by the backend, we have no means of manipulating the content.</p>
<h3 id='o-tokn_3' class='heading'>O.Tokn_3</h3>

<p>The token is created by the backend, we have no means of manipulating the content.</p>
<h3 id='o-tokn_4' class='heading'>O.Tokn_4</h3>

<p>The token is created by the IDP and signed there. We have not valid signing identity within the application to sign the token.</p>
<h3 id='o-tokn_5' class='heading'>O.Tokn_5</h3>

<p>A Section within User Profiles contains all tokens for that profile on the device</p>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofileview-swift-409-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileView.swift:409</code></h4>

<p>Section for Token display</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Tokn_5#2] Section for Token display
private struct TokenSectionView: View {
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-idptokenview-idptokenview-swift-12-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/IDPTokenView/IDPTokenView.swift:12</code></h4>

<p>Access and SSO Token display</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_9#1] Access and SSO Token display
// [REQ:BSI-eRp-ePA:O.Tokn_5#3] Access and SSO Token display
struct IDPTokenView: View {
</code></pre>
<h3 id='o-tokn_6' class='heading'>O.Tokn_6</h3>

<p>A logout button is available within each user profile.</p>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofileview-swift-217-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileView.swift:217</code></h4>

<p>Logout Button</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Tokn_6#2] Logout Button
Button(action: {
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofiledomain-swift-281-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileDomain.swift:281</code></h4>

<p>Call the token removal upon manual logout</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499-01#1] Call the SSO_TOKEN removal upon manual logout
// [REQ:BSI-eRp-ePA:O.Tokn_6#3] Call the token removal upon manual logout
return .run { [profileId = state.profileId] _ in
</code></pre>
<h3 id='o-trdp_1' class='heading'>O.TrdP_1</h3>

<p>A list of all active used dependencies can be found within <code>dependencies.yml</code>. The list contains dependencies from SwiftPM.</p>
<h3 id='o-trdp_2' class='heading'>O.TrdP_2</h3>

<p>SAST Scans are also including external libraries. </p>
<h3 id='o-trdp_3' class='heading'>O.TrdP_3</h3>

<p>Library updates are done by a manual periodic process. If any security issues arise and no fix is expected to be provided, a manual fork of external libraries is implemented.</p>
<h3 id='o-trdp_4' class='heading'>O.TrdP_4</h3>

<p>Actual dependencies can be found within <code>eRp-App.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved</code> and <code>Cartfile.resolved</code> containing pinned versions with corresponding hashes. Library updates always require manual interaction to update the <code>*.resolved</code> files. We use very few providers of libraries and try to avoid any unnecessary dependency. Each providing party/dependency is evaluated by looking at GitHub metrics like open issues, stars and activity in general.</p>
<h3 id='o-trdp_5' class='heading'>O.TrdP_5</h3>

<p>We do not share sensitive data with third parties. Se data usages within <code>Purp_8</code> and <code>O.Arch_2</code>.</p>
<h3 id='o-trdp_6' class='heading'>O.TrdP_6</h3>

<p>See <code>O.Source_1</code> and <code>O.Arch_6</code>.</p>
<h3 id='o-trdp_7' class='heading'>O.TrdP_7</h3>

<p>As most libraries are source code dependencies, these scans are part of SAST Scanning. Libraries that are not source code dependencies are the precompiled OpenSSL and OpenHealthCardKit (own library but different repository). All third party libraries are mirrored into internal repositories. If necessary we fork libraries to apply fixes.</p>
<h2 id='gemf_biometrie' class='heading'>gemF_Biometrie</h2>
<h3 id='a_21415' class='heading'>A_21415</h3>
<h4 id='pairing_data-code-sources-idp-models-pairingdata-swift-12-code' class='heading'>Pairing_Data <code>../Sources/IDP/Models/PairingData.swift:12</code></h4>
<pre class="highlight plaintext"><code>/// Structure for registering a biometric key. See `SignedPairingData` for sigend representation.
/// [REQ:gemF_Biometrie:A_21415:Pairing_Data]
public struct PairingData: Claims, Codable {
</code></pre>
<h4 id='registration_data-code-sources-idp-models-registrationdata-swift-13-code' class='heading'>Registration_Data <code>../Sources/IDP/Models/RegistrationData.swift:13</code></h4>
<pre class="highlight plaintext"><code>/// Bundles data needed for creating and verifiying a pairing.
/// [REQ:gemF_Biometrie:A_21415:Registration_Data]
/// [REQ:gemSpec_IDP_Frontend:A_21416] Data Structure
public struct RegistrationData: Claims, Codable {
</code></pre>
<h4 id='device_information-code-sources-idp-models-registrationdata-swift-39-code' class='heading'>Device_Information <code>../Sources/IDP/Models/RegistrationData.swift:39</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemF_Biometrie:A_21415:Device_Information]
public struct DeviceInformation: Codable {
</code></pre>
<h4 id='device_type-code-sources-idp-models-registrationdata-swift-56-code' class='heading'>Device_Type <code>../Sources/IDP/Models/RegistrationData.swift:56</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemF_Biometrie:A_21415:Device_Type]
/// [REQ:gemSpec_IDP_Frontend:A_21591]
public struct DeviceType: Codable {
</code></pre>
<h4 id='encrypted_registration_data-code-sources-idp-models-registrationdata-swift-104-code' class='heading'>Encrypted_Registration_Data <code>../Sources/IDP/Models/RegistrationData.swift:104</code></h4>

<p>Returns JWE encrypted Registration_Data</p>
<pre class="highlight plaintext"><code>/// [REQ:gemF_Biometrie:A_21415:Encrypted_Registration_Data] Returns JWE encrypted Registration_Data
/// [REQ:gemSpec_IDP_Frontend:A_21416] Encryption
func encrypted(with publicKey: BrainpoolP256r1.KeyExchange.PublicKey,
</code></pre>
<h4 id='signed_pairing_data-code-sources-idp-models-signedpairingdata-swift-12-code' class='heading'>Signed_Pairing_Data <code>../Sources/IDP/Models/SignedPairingData.swift:12</code></h4>
<pre class="highlight plaintext"><code>/// Signed (with eGK) version of `PairingData`.
/// [REQ:gemF_Biometrie:A_21415:Signed_Pairing_Data]
public struct SignedPairingData {
</code></pre>
<h3 id='a_21450' class='heading'>A_21450</h3>
<h4 id='pairing_entry-code-sources-idp-models-pairingentry-swift-12-code' class='heading'>Pairing_Entry <code>../Sources/IDP/Models/PairingEntry.swift:12</code></h4>
<pre class="highlight plaintext"><code>/// Represents stored data within the idp.
/// [REQ:gemF_Biometrie:A_21450:Pairing_Entry]
public struct PairingEntry: Equatable, Codable {
</code></pre>
<h2 id='gemf_tokenverschlüsselung' class='heading'>gemF_Tokenverschlüsselung</h2>
<h3 id='a_20526-01' class='heading'>A_20526-01</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-153-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:153</code></h4>

<p>Encryption with JWE</p>
<pre class="highlight plaintext"><code>// [REQ:gemF_Tokenverschlüsselung:A_20526-01] Encryption with JWE
guard let jwe = try? signedChallenge.encrypt(with: document.encryptionPublicKey,
</code></pre>
<h4 id='code-sources-idp-models-idpchallengesession-swift-86-code' class='heading'><code>../Sources/IDP/Models/IDPChallengeSession.swift:86</code></h4>

<p>Embed certificate</p>
<pre class="highlight plaintext"><code>// [REQ:gemF_Tokenverschlüsselung:A_20526-01] Embed certificate
let header = JWT.Header(alg: alg, x5c: certificates, typ: "JWT", cty: "NJWT")
</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-146-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:146</code></h4>

<p>Building and sending the request</p>
<pre class="highlight plaintext"><code>// [REQ:gemF_Tokenverschlüsselung:A_20526-01] Building and sending the request
var request = URLRequest(url: document.authentication.url, cachePolicy: .reloadIgnoringCacheData)
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-361-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:361</code></h4>

<p>Smartcard signature</p>
<pre class="highlight plaintext"><code>// first sign the challenge
// [REQ:gemSpec_IDP_Frontend:A_20700-07] C.CH.AUT
// [REQ:gemF_Tokenverschlüsselung:A_20526-01] Smartcard signature
// [REQ:gemF_Tokenverschlüsselung:A_20700-05,A_20700-06] sign
let autCertificateResponse: AutCertificateResponse
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-488-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:488</code></h4>

<p>Smartcard signature</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-07] C.CH.AUT
// [REQ:gemF_Tokenverschlüsselung:A_20526-01] Smartcard signature
// [REQ:gemF_Tokenverschlüsselung:A_20700-06] sign
let certificate: AutCertificateResponse
</code></pre>
<h3 id='a_20700-05' class='heading'>A_20700-05</h3>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-362-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:362</code></h4>

<p>sign</p>
<pre class="highlight plaintext"><code>// first sign the challenge
// [REQ:gemSpec_IDP_Frontend:A_20700-07] C.CH.AUT
// [REQ:gemF_Tokenverschlüsselung:A_20526-01] Smartcard signature
// [REQ:gemF_Tokenverschlüsselung:A_20700-05,A_20700-06] sign
let autCertificateResponse: AutCertificateResponse
</code></pre>
<h3 id='a_20700-06' class='heading'>A_20700-06</h3>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-267-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:267</code></h4>

<p>sign</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20526-01] sign
// [REQ:gemF_Tokenverschlüsselung:A_20700-06] sign
func sign( // swiftlint:disable:this function_body_length
can: String,
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-362-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:362</code></h4>

<p>sign</p>
<pre class="highlight plaintext"><code>// first sign the challenge
// [REQ:gemSpec_IDP_Frontend:A_20700-07] C.CH.AUT
// [REQ:gemF_Tokenverschlüsselung:A_20526-01] Smartcard signature
// [REQ:gemF_Tokenverschlüsselung:A_20700-05,A_20700-06] sign
let autCertificateResponse: AutCertificateResponse
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-489-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:489</code></h4>

<p>sign</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-07] C.CH.AUT
// [REQ:gemF_Tokenverschlüsselung:A_20526-01] Smartcard signature
// [REQ:gemF_Tokenverschlüsselung:A_20700-06] sign
let certificate: AutCertificateResponse
</code></pre>
<h3 id='a_21322' class='heading'>A_21322</h3>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-21-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:21</code></h4>

<p>Storage implementation uses iOS Keychain</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemF_Tokenverschlüsselung:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_2#5,O.Arch_4#3,O.Source_7#2,O.Data_2#2] Implementation of data storage that is
// persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {
</code></pre>
<h2 id='gemspec_fd_erp' class='heading'>gemSpec_FD_eRp</h2>
<h3 id='a_19145' class='heading'>A_19145</h3>
<h4 id='code-sources-erpapp-screens-main-prescriptionlist-model-prescription-swift-212-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionList/Model/Prescription.swift:212</code></h4>

<p>prevent deletion while task is in progress</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_FD_eRp:A_19145] prevent deletion while task is in progress
return erxTask.status != .inProgress
</code></pre>
<h3 id='a_21267' class='heading'>A_21267</h3>
<h4 id='code-sources-erpapp-screens-main-prescriptionlist-model-prescription-swift-30-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionList/Model/Prescription.swift:30</code></h4>

<p>direct assignment</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_FD_eRp:A_21267] direct assignment
var type: PrescriptionType = .regular
</code></pre>
<h3 id='a_21360' class='heading'>A_21360</h3>
<h4 id='code-sources-erpapp-screens-main-prescriptionlist-model-prescription-swift-176-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionList/Model/Prescription.swift:176</code></h4>

<p>no redeem informations available for flowtype 169</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_FD_eRp:A_21360] no redeem informations available for flowtype 169
guard type != .directAssignment
</code></pre>
<h3 id='a_22102' class='heading'>A_22102</h3>
<h4 id='code-sources-erpapp-screens-main-prescriptionlist-model-prescription-swift-204-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionList/Model/Prescription.swift:204</code></h4>

<p>prevent deletion of tasks with flowtype 169 while not completed</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_FD_eRp:A_22102] prevent deletion of tasks with flowtype 169 while not completed
guard type != .directAssignment
</code></pre>
<h2 id='gemspec_idp_frontend' class='heading'>gemSpec_IDP_Frontend</h2>
<h3 id='a_19908-01' class='heading'>A_19908-01</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-629-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:629</code></h4>

<p>Signature check</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_IDP_Frontend:A_19908-01] Signature check
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let verified = try? challenge.challenge.verify(with: document.authentication.cert),
</code></pre>
<h3 id='a_19937' class='heading'>A_19937</h3>
<h4 id='code-sources-idp-models-idperror-swift-85-code' class='heading'><code>../Sources/IDP/Models/IDPError.swift:85</code></h4>

<p>Error formatting</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937,A_20605,A_20085] Error formatting
public var description: String {
</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-501-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:501</code></h4>

<p>Decoding server errors</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937,A_20605] Decoding server errors
private static func responseError(for body: Data) -&gt; IDPError {
</code></pre>
<h4 id='code-sources-erpapp-common-errorlocalization-idperror-localization-swift-23-code' class='heading'><code>../Sources/eRpApp/Common/ErrorLocalization/IDPError+Localization.swift:23</code></h4>

<p>Localized description of server errors</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937,A_20605,A_20085] Localized description of server errors
case let .internal(error: error): return error.localizedDescription
</code></pre>
<h3 id='a_19938-01' class='heading'>A_19938-01</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-203-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:203</code></h4>

<p>Decrypt, fails if wrong aes key</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19938-01,A_20283-01] Decrypt, fails if wrong aes key
guard let decrypted = try? token.decrypted(with: self.cryptoBox.aesKey) else {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-226-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:226</code></h4>

<p>Usage</p>
<pre class="highlight plaintext"><code>idToken: decrypted.idToken, // [REQ:gemSpec_IDP_Frontend:A_19938-01] Usage
ssoToken: exchange.sso,
</code></pre>
<h3 id='a_20068-01' class='heading'>A_20068-01</h3>

<p>: Implemented with ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity.NSPinnedDomains</code></p>
<h3 id='a_20079' class='heading'>A_20079</h3>
<h4 id='code-sources-idp-internal-realidpclient-swift-263-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:263</code></h4>

<p>Network timeouts will traverse the queue as <code>HTTPError</code>s.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20079] Network timeouts will traverse the queue as `HTTPError`s.
$0.asIDPError()
</code></pre>
<h3 id='a_20085' class='heading'>A_20085</h3>
<h4 id='code-sources-idp-models-idperror-swift-85-code' class='heading'><code>../Sources/IDP/Models/IDPError.swift:85</code></h4>

<p>Error formatting</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937,A_20605,A_20085] Error formatting
public var description: String {
</code></pre>
<h4 id='code-sources-erpapp-common-errorlocalization-idperror-localization-swift-13-code' class='heading'><code>../Sources/eRpApp/Common/ErrorLocalization/IDPError+Localization.swift:13</code></h4>

<p>Error localization is not done yet, this is the place to localize</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20085] Error localization is not done yet, this is the place to localize
// accordingly.
switch self {
</code></pre>
<h4 id='code-sources-erpapp-common-errorlocalization-idperror-localization-swift-23-code' class='heading'><code>../Sources/eRpApp/Common/ErrorLocalization/IDPError+Localization.swift:23</code></h4>

<p>Localized description of server errors</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937,A_20605,A_20085] Localized description of server errors
case let .internal(error: error): return error.localizedDescription
</code></pre>
<h3 id='a_20283-01' class='heading'>A_20283-01</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-203-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:203</code></h4>

<p>Decrypt, fails if wrong aes key</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19938-01,A_20283-01] Decrypt, fails if wrong aes key
guard let decrypted = try? token.decrypted(with: self.cryptoBox.aesKey) else {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-224-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:224</code></h4>

<p>Usage</p>
<pre class="highlight plaintext"><code>accessToken: decrypted.accessToken, // [REQ:gemSpec_IDP_Frontend:A_20283-01] Usage
expires: self.time().addingTimeInterval(TimeInterval(token.expiresIn)),
</code></pre>
<h3 id='a_20309' class='heading'>A_20309</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-607-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:607</code></h4>

<p>generation and hashing for codeChallenge</p>
<pre class="highlight plaintext"><code>// Generate a verifierCode
// [REQ:gemSpec_IDP_Frontend:A_20309] generation and hashing for codeChallenge
guard let verifierCode = try? self.cryptoBox.generateRandomVerifier(),
</code></pre>
<h4 id='code-sources-idp-internal-idpcrypto-swift-67-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:67</code></h4>

<p>verifierLength is 32 bytes, encoded to base64 this results in 43 chars</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20309] verifierLength is 32 bytes, encoded to base64 this results in 43 chars
// (32 * 4 / 3 = 42,6)
try randomGenerator(verifierLength).encodeBase64urlsafe().utf8string
</code></pre>
<h3 id='a_20483' class='heading'>A_20483</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-615-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:615</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20483]
return self.client.requestChallenge(
</code></pre>
<h3 id='a_20499' class='heading'>A_20499</h3>

<p>Not applicable as authenticator module is within FdV, not 3rd party app.</p>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-248-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:248</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-1#3] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
set(can: nil)
</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-39-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:39</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-01#2] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_IDP_Frontend:A_21603] Certificate
storage.wipe()
</code></pre>
<h3 id='a_20499-01' class='heading'>A_20499-01</h3>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofiledomain-swift-280-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileDomain.swift:280</code></h4>

<p>Call the SSO_TOKEN removal upon manual logout</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499-01#1] Call the SSO_TOKEN removal upon manual logout
// [REQ:BSI-eRp-ePA:O.Tokn_6#3] Call the token removal upon manual logout
return .run { [profileId = state.profileId] _ in
</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-39-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:39</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-01#2] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_IDP_Frontend:A_21603] Certificate
storage.wipe()
</code></pre>
<h3 id='a_20499-1' class='heading'>A_20499-1</h3>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-248-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:248</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-1#3] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
set(can: nil)
</code></pre>
<h3 id='a_20512' class='heading'>A_20512</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-277-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:277</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20512]
self.storage.set(discovery: nil)
</code></pre>
<h4 id='code-sources-idp-models-discoverydocument-swift-181-code' class='heading'><code>../Sources/IDP/Models/DiscoveryDocument.swift:181</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20512]
func isValid(on date: Date) -&gt; Bool {
</code></pre>
<h3 id='a_20525' class='heading'>A_20525</h3>

<p>Not applicable as authenticator module is within FdV, not 3rd party app</p>

<p>Not applicable as authenticator module is within FdV. Consent is given by using the app.</p>
<h3 id='a_20526-01' class='heading'>A_20526-01</h3>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-swift-410-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.swift:410</code></h4>

<p>sign and verify with idp</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20172]
// [REQ:gemSpec_IDP_Frontend:A_20526-01] sign and verify with idp
func signChallengeWithNFCCard(
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-swift-442-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.swift:442</code></h4>

<p>verify with idp</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20172]
// [REQ:gemSpec_IDP_Frontend:A_20526-01] verify with idp
func verifyResultWithIDP(
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-266-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:266</code></h4>

<p>sign</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20526-01] sign
// [REQ:gemF_Tokenverschlüsselung:A_20700-06] sign
func sign( // swiftlint:disable:this function_body_length
can: String,
</code></pre>
<h3 id='a_20527' class='heading'>A_20527</h3>

<p>Not directly applicable as authenticator module is within FdV, not 3rd party app. AUTHORIZATION_CODE will be used directly.</p>
<h4 id='code-sources-idp-defaultidpsession-swift-166-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:166</code></h4>

<p>Returning the AUTHORIZATION_CODE</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20527] Returning the AUTHORIZATION_CODE
return Just(exchangeToken).setFailureType(to: IDPError.self).eraseToAnyPublisher()
</code></pre>
<h3 id='a_20529-01' class='heading'>A_20529-01</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-184-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:184</code></h4>

<p>Encryption</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20529-01] Encryption
// [REQ:gemSpec_IDP_Frontend:A_21323,A_21324#1] Crypto box contains `Token-Key`
guard let encryptedKeyVerifier = try? KeyVerifier(
</code></pre>
<h3 id='a_20600' class='heading'>A_20600</h3>
<h4 id='code-sources-idp-internal-realidpclient-swift-173-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:173</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20600]
return IDPExchangeToken(
</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-486-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:486</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20600]
return IDPExchangeToken(code: code,
</code></pre>
<h3 id='a_20601' class='heading'>A_20601</h3>
<h4 id='code-sources-idp-internal-realidpclient-swift-101-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:101</code></h4>

<p>Transfer</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20603,A_20601,A_20601-01] Transfer
URLQueryItem(name: "client_id", value: clientConfig.clientId.urlPercentEscapedString()),
</code></pre>
<h3 id='a_20601-01' class='heading'>A_20601-01</h3>
<h4 id='code-sources-idp-internal-realidpclient-swift-101-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:101</code></h4>

<p>Transfer</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20603,A_20601,A_20601-01] Transfer
URLQueryItem(name: "client_id", value: clientConfig.clientId.urlPercentEscapedString()),
</code></pre>
<h3 id='a_20602' class='heading'>A_20602</h3>
<h4 id='code-sources-idp-idpinterceptor-swift-56-code' class='heading'><code>../Sources/IDP/IDPInterceptor.swift:56</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20602,A_21325#1]
request.setValue("\(token.tokenType) \(token.accessToken)", forHTTPHeaderField: "Authorization")
</code></pre>
<h3 id='a_20603' class='heading'>A_20603</h3>
<h4 id='code-sources-idp-internal-realidpclient-swift-101-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:101</code></h4>

<p>Transfer</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20603,A_20601,A_20601-01] Transfer
URLQueryItem(name: "client_id", value: clientConfig.clientId.urlPercentEscapedString()),
</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-249-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:249</code></h4>

<p>transfer</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20603] transfer
"client_id": clientConfig.clientId,
</code></pre>
<h4 id='code-sources-erpapp-appconfiguration-swift-15-code' class='heading'><code>../Sources/eRpApp/AppConfiguration.swift:15</code></h4>

<p>Actual ID</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20603] Actual ID
private static let defaultClientId: String = "eRezeptApp"
</code></pre>
<h4 id='code-sources-erpapp-appconfiguration-swift-59-code' class='heading'><code>../Sources/eRpApp/AppConfiguration.swift:59</code></h4>

<p>Actual ID</p>
<pre class="highlight plaintext"><code>// clientId
// [REQ:gemSpec_IDP_Frontend:A_20603] Actual ID
let clientId: String = defaultClientId
</code></pre>
<h3 id='a_20605' class='heading'>A_20605</h3>
<h4 id='code-sources-idp-models-idperror-swift-85-code' class='heading'><code>../Sources/IDP/Models/IDPError.swift:85</code></h4>

<p>Error formatting</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937,A_20605,A_20085] Error formatting
public var description: String {
</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-501-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:501</code></h4>

<p>Decoding server errors</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937,A_20605] Decoding server errors
private static func responseError(for body: Data) -&gt; IDPError {
</code></pre>
<h4 id='code-sources-erpapp-common-errorlocalization-idperror-localization-swift-23-code' class='heading'><code>../Sources/eRpApp/Common/ErrorLocalization/IDPError+Localization.swift:23</code></h4>

<p>Localized description of server errors</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_19937,A_20605,A_20085] Localized description of server errors
case let .internal(error: error): return error.localizedDescription
</code></pre>
<h3 id='a_20606' class='heading'>A_20606</h3>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-39-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:39</code></h4>

<p>Live URLs not present in NSAppTransportSecurity exception list for allowed</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_Krypt:GS-A_5322] TODO: Check if limiting SSL Sessions is possible, check for renegotiation
// swiftlint:disable:previous todo
// [REQ:gemSpec_IDP_Frontend:A_20606] Live URLs not present in NSAppTransportSecurity exception list for allowed
// HTTP communication
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Sess_1#2,O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework

</code></pre>
<h3 id='a_20607' class='heading'>A_20607</h3>

<p>no exceptions set in NSAppTransportSecurity, HTTP via TLS is enforced; OS will use system root certificates in combination with set pinned certificates. see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>
<h3 id='a_20608' class='heading'>A_20608</h3>

<p>: Implemented with ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity.NSPinnedDomains</code></p>
<h3 id='a_20608-01' class='heading'>A_20608-01</h3>

<p>: Implemented with ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity.NSPinnedDomains</code></p>
<h3 id='a_20609' class='heading'>A_20609</h3>

<p>no exceptions set in NSAppTransportSecurity, HTTP via TLS is enforced; OS will use system root certificates in combination with set pinned certificates. see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>

<p>: Implemented with ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity.NSPinnedDomains</code></p>
<h3 id='a_20614' class='heading'>A_20614</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-265-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:265</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623,A_20614]
.validateOrNil(with: trustStoreSession, timeProvider: time)
</code></pre>
<h3 id='a_20617-01' class='heading'>A_20617-01</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-265-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:265</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623,A_20614]
.validateOrNil(with: trustStoreSession, timeProvider: time)
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-298-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:298</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623]
.validate(with: self.trustStoreSession, timeProvider: self.time)
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-691-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:691</code></h4>
<pre class="highlight plaintext"><code>/// Returns a Publisher that validates the input streams discoveryDocument against the given trustStoreSession. If
/// the validity cannot be verified, the publisher fails with an `IDPError.trustStore` error.
///
/// [REQ:gemSpec_IDP_Frontend:A_20617-01]
/// [REQ:gemSpec_IDP_Frontend:A_20623]
///
/// - Parameter trustStoreSession: `TrustStoreSession` that is used to check the validity and trust of the
/// discoveryDocument.
/// - Returns: An AnyPublisher of `DiscoveryDocument`and `IDPError`
func validate(with trustStoreSession: TrustStoreSession,
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-723-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:723</code></h4>
<pre class="highlight plaintext"><code>/// Returns a Publisher that validates the input streams discoveryDocument and returns nil if validity cannot be
/// checked. All Errors are caught and result in an empty discoveryDocument.
///
/// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623]
///
/// - Parameters:
///   - trustStoreSession: `TrustStoreSession` that is used to check the validity and trust of the disoveryDocument.
///   - time: Time provider to check the discovery document against.
/// - Returns: An AnyPublisher of `DiscoveryDocument`and `Never`.
func validateOrNil(with trustStoreSession: TrustStoreSession,
</code></pre>
<h3 id='a_20618' class='heading'>A_20618</h3>

<p>no exceptions set in NSAppTransportSecurity, HTTP via TLS is enforced; OS will use system root certificates in combination with set pinned certificates. see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a></p>

<p>: Implemented with ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity.NSPinnedDomains</code></p>
<h3 id='a_20623' class='heading'>A_20623</h3>
<h4 id='code-sources-truststore-x509truststore-swift-193-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:193</code></h4>

<p>IDP oid</p>
<pre class="highlight plaintext"><code>case oidErpVau // 1.2.276.0.76.4.258 == 0x06082A8214004C048202
// [REQ:gemSpec_IDP_Frontend:A_20623] IDP oid
case oidIdpd // 1.2.276.0.76.4.260 == 0x06082A8214004C048204
}
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-298-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:298</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623]
.validate(with: self.trustStoreSession, timeProvider: self.time)
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-692-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:692</code></h4>
<pre class="highlight plaintext"><code>/// Returns a Publisher that validates the input streams discoveryDocument against the given trustStoreSession. If
/// the validity cannot be verified, the publisher fails with an `IDPError.trustStore` error.
///
/// [REQ:gemSpec_IDP_Frontend:A_20617-01]
/// [REQ:gemSpec_IDP_Frontend:A_20623]
///
/// - Parameter trustStoreSession: `TrustStoreSession` that is used to check the validity and trust of the
/// discoveryDocument.
/// - Returns: An AnyPublisher of `DiscoveryDocument`and `IDPError`
func validate(with trustStoreSession: TrustStoreSession,
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-695-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:695</code></h4>

<p>Validation call</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20623] Validation call
return trustStoreSession.validate(discoveryDocument: document)
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-723-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:723</code></h4>
<pre class="highlight plaintext"><code>/// Returns a Publisher that validates the input streams discoveryDocument and returns nil if validity cannot be
/// checked. All Errors are caught and result in an empty discoveryDocument.
///
/// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623]
///
/// - Parameters:
///   - trustStoreSession: `TrustStoreSession` that is used to check the validity and trust of the disoveryDocument.
///   - time: Time provider to check the discovery document against.
/// - Returns: An AnyPublisher of `DiscoveryDocument`and `Never`.
func validateOrNil(with trustStoreSession: TrustStoreSession,
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-753-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:753</code></h4>

<p>Validation</p>
<pre class="highlight plaintext"><code>/// Returns a publisher that checks a discoveryDocument against the trust store. The Stream contains an output
/// boolean for the plain check or an TrustStoreError in case the TrustStoreSession sub streams failed.
///
/// [REQ:gemSpec_IDP_Frontend:A_20623] Validation
///
/// - Parameter discoveryDocument: The DiscoveryDocument that needs to be checked.
/// - Returns: A publisher that contains an output with the check value or an failure if the check failed
/// due to an underlying error.
func validate(discoveryDocument: DiscoveryDocument) -&gt; AnyPublisher&lt;Bool, TrustStoreError&gt; {
</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-179-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:179</code></h4>

<p>oid check</p>
<pre class="highlight plaintext"><code>} else if eeCert.contains(oidBytes: .oidIdpd) { // [REQ:gemSpec_IDP_Frontend:A_20623] oid check
return (vauCerts, idpCerts + [eeCert])
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-265-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:265</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20617-01,A_20623,A_20614]
.validateOrNil(with: trustStoreSession, timeProvider: time)
</code></pre>
<h3 id='a_20625' class='heading'>A_20625</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-210-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:210</code></h4>

<p>Validate ID_TOKEN signature</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20625] Validate ID_TOKEN signature
guard let jwt = try? JWT(from: decrypted.idToken),
</code></pre>
<h3 id='a_20700-05' class='heading'>A_20700-05</h3>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-370-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:370</code></h4>

<p>sign with C.CH.AUT</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-05,A_20700-07] sign with C.CH.AUT
signedChallenge = try await idpChallengeSession.sign(
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-502-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:502</code></h4>

<p>sign with C.CH.AUT</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-05,A_20700-07] sign with C.CH.AUT
signedChallenge = try await session.sign(
</code></pre>
<h3 id='a_20700-07' class='heading'>A_20700-07</h3>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-127-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:127</code></h4>

<p>Biometrics only, other modes currently not supported</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-07] Biometrics only, other modes currently not supported
amr: [
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-360-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:360</code></h4>

<p>C.CH.AUT</p>
<pre class="highlight plaintext"><code>// first sign the challenge
// [REQ:gemSpec_IDP_Frontend:A_20700-07] C.CH.AUT
// [REQ:gemF_Tokenverschlüsselung:A_20526-01] Smartcard signature
// [REQ:gemF_Tokenverschlüsselung:A_20700-05,A_20700-06] sign
let autCertificateResponse: AutCertificateResponse
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-370-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:370</code></h4>

<p>sign with C.CH.AUT</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-05,A_20700-07] sign with C.CH.AUT
signedChallenge = try await idpChallengeSession.sign(
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-487-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:487</code></h4>

<p>C.CH.AUT</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-07] C.CH.AUT
// [REQ:gemF_Tokenverschlüsselung:A_20526-01] Smartcard signature
// [REQ:gemF_Tokenverschlüsselung:A_20700-06] sign
let certificate: AutCertificateResponse
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-502-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:502</code></h4>

<p>sign with C.CH.AUT</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-05,A_20700-07] sign with C.CH.AUT
signedChallenge = try await session.sign(
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-535-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:535</code></h4>

<p>perform signature with OpenHealthCardKit</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20700-07] perform signature with OpenHealthCardKit
card.sign(data: message)
</code></pre>
<h3 id='a_20740' class='heading'>A_20740</h3>
<h4 id='code-sources-idp-internal-realidpclient-swift-110-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:110</code></h4>

<p>transfer</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20740] transfer
name: "redirect_uri",
</code></pre>
<h4 id='code-sources-idp-internal-realidpclient-swift-246-code' class='heading'><code>../Sources/IDP/internal/RealIDPClient.swift:246</code></h4>

<p>transfer</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20740] transfer
"redirect_uri": redirectURI ?? clientConfig.redirectURI.absoluteString,
</code></pre>
<h4 id='code-sources-erpapp-appconfiguration-swift-61-code' class='heading'><code>../Sources/eRpApp/AppConfiguration.swift:61</code></h4>

<p>Actual redirect uri</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20740] Actual redirect uri
let redirectUri = URL(string: "https://redirect.gematik.de/erezept")! // swiftlint:disable:this force_unwrapping
let extAuthRedirectUri = URL(
</code></pre>
<h3 id='a_20741' class='heading'>A_20741</h3>

<p>Configuration within <code>app-configuration.json</code>, organizational process as in A_20603</p>
<h3 id='a_21322' class='heading'>A_21322</h3>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-20-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:20</code></h4>

<p>Storage implementation uses iOS Keychain</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemF_Tokenverschlüsselung:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_2#5,O.Arch_4#3,O.Source_7#2,O.Data_2#2] Implementation of data storage that is
// persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {
</code></pre>
<h3 id='a_21323' class='heading'>A_21323</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-185-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:185</code></h4>

<p>Crypto box contains <code>Token-Key</code></p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20529-01] Encryption
// [REQ:gemSpec_IDP_Frontend:A_21323,A_21324#1] Crypto box contains `Token-Key`
guard let encryptedKeyVerifier = try? KeyVerifier(
</code></pre>
<h4 id='code-sources-idp-internal-tokenpayload-swift-169-code' class='heading'><code>../Sources/IDP/internal/TokenPayload.swift:169</code></h4>

<p>Encode into JSON object</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21323#2] Encode into JSON object
// [REQ:gemSpec_IDP_Frontend:A_21324#3] Encode into JSON object
guard let keyVerifierEncoded = try? KeyVerifier.jsonEncoder.encode(self) else {
</code></pre>
<h3 id='a_21324' class='heading'>A_21324</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-185-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:185</code></h4>

<p>Crypto box contains <code>Token-Key</code></p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20529-01] Encryption
// [REQ:gemSpec_IDP_Frontend:A_21323,A_21324#1] Crypto box contains `Token-Key`
guard let encryptedKeyVerifier = try? KeyVerifier(
</code></pre>
<h4 id='code-sources-idp-internal-tokenpayload-swift-170-code' class='heading'><code>../Sources/IDP/internal/TokenPayload.swift:170</code></h4>

<p>Encode into JSON object</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21323#2] Encode into JSON object
// [REQ:gemSpec_IDP_Frontend:A_21324#3] Encode into JSON object
guard let keyVerifierEncoded = try? KeyVerifier.jsonEncoder.encode(self) else {
</code></pre>
<h3 id='a_21325' class='heading'>A_21325</h3>
<h4 id='code-sources-idp-idpinterceptor-swift-56-code' class='heading'><code>../Sources/IDP/IDPInterceptor.swift:56</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20602,A_21325#1]
request.setValue("\(token.tokenType) \(token.accessToken)", forHTTPHeaderField: "Authorization")
</code></pre>
<h4 id='code-sources-erpapp-session-standardsessioncontainer-swift-354-code' class='heading'><code>../Sources/eRpApp/Session/StandardSessionContainer.swift:354</code></h4>

<p>Interceptor order defines what is encrypted via VAU</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21325#2] Interceptor order defines what is encrypted via VAU
let interceptors: [Interceptor] = [
</code></pre>
<h3 id='a_21414' class='heading'>A_21414</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-322-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:322</code></h4>

<p>Encrypt ACCESS_TOKEN when requesting the pairing endpoint</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21414] Encrypt ACCESS_TOKEN when requesting the pairing endpoint
guard let tokenJWT = try? JWT(from: token.accessToken),
</code></pre>
<h3 id='a_21416' class='heading'>A_21416</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-316-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:316</code></h4>

<p>Encryption</p>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21416] Encryption
guard let jwe = try? registrationData.encrypted(with: document.encryptionPublicKey,
</code></pre>
<h4 id='code-sources-idp-models-registrationdata-swift-14-code' class='heading'><code>../Sources/IDP/Models/RegistrationData.swift:14</code></h4>

<p>Data Structure</p>
<pre class="highlight plaintext"><code>/// Bundles data needed for creating and verifiying a pairing.
/// [REQ:gemF_Biometrie:A_21415:Registration_Data]
/// [REQ:gemSpec_IDP_Frontend:A_21416] Data Structure
public struct RegistrationData: Claims, Codable {
</code></pre>
<h4 id='code-sources-idp-models-registrationdata-swift-105-code' class='heading'><code>../Sources/IDP/Models/RegistrationData.swift:105</code></h4>

<p>Encryption</p>
<pre class="highlight plaintext"><code>/// [REQ:gemF_Biometrie:A_21415:Encrypted_Registration_Data] Returns JWE encrypted Registration_Data
/// [REQ:gemSpec_IDP_Frontend:A_21416] Encryption
func encrypted(with publicKey: BrainpoolP256r1.KeyExchange.PublicKey,
</code></pre>
<h3 id='a_21431' class='heading'>A_21431</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-396-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:396</code></h4>

<p>Encryption</p>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21431] Encryption
guard let jwe = try? signedChallenge.encrypted(with: document.encryptionPublicKey,
</code></pre>
<h4 id='code-sources-idp-models-signedauthenticationdata-swift-35-code' class='heading'><code>../Sources/IDP/Models/SignedAuthenticationData.swift:35</code></h4>

<p>exp header</p>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21431] exp header
expiry: originalChallenge.challenge.exp,
</code></pre>
<h3 id='a_21443' class='heading'>A_21443</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-347-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:347</code></h4>

<p>Encrypt ACCESS_TOKEN when requesting the unregister endpoint</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21443] Encrypt ACCESS_TOKEN when requesting the unregister endpoint
guard let tokenJWT = try? JWT(from: token.accessToken),
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-371-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:371</code></h4>

<p>Encrypt ACCESS_TOKEN when requesting the list endpoint</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21443] Encrypt ACCESS_TOKEN when requesting the list endpoint
guard let tokenJWT = try? JWT(from: token.accessToken),
</code></pre>
<h3 id='a_21574' class='heading'>A_21574</h3>
<h4 id='code-sources-erpapp-screens-cardwall-login-cardwallloginoptiondomain-swift-113-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/Login/CardWallLoginOptionDomain.swift:113</code></h4>

<p>Present user information</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21574] Present user information
return EffectTask.send(.presentSecurityWarning)
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-login-cardwallloginoptionview-swift-118-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/Login/CardWallLoginOptionView.swift:118</code></h4>

<p>Actual view</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21574] Actual view
// [REQ:BSI-eRp-ePA:O.Resi_1#3] View containing information regarding the login options.
struct PrivacyWarningViewContainer: View {
</code></pre>
<h3 id='a_21576' class='heading'>A_21576</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-340-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:340</code></h4>

<p>deletion call</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21576] deletion call
public func unregisterDevice(_ keyIdentifier: String, token: IDPToken) -&gt; AnyPublisher&lt;Bool, IDPError&gt; {
</code></pre>
<h3 id='a_21578' class='heading'>A_21578</h3>

<p>iOS only allows Biometric access via secure enclave or higher order apis.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-144-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:144</code></h4>

<p>Enforced via access attribute</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21578,A_21579,A_21580,A_21583] Enforced via access attribute
kSecAttrTokenID as String: kSecAttrTokenIDSecureEnclave,
</code></pre>
<h3 id='a_21579' class='heading'>A_21579</h3>
<h4 id='code-sources-idp-privatekeycontainer-swift-144-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:144</code></h4>

<p>Enforced via access attribute</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21578,A_21579,A_21580,A_21583] Enforced via access attribute
kSecAttrTokenID as String: kSecAttrTokenIDSecureEnclave,
</code></pre>
<h3 id='a_21580' class='heading'>A_21580</h3>
<h4 id='code-sources-idp-privatekeycontainer-swift-144-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:144</code></h4>

<p>Enforced via access attribute</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21578,A_21579,A_21580,A_21583] Enforced via access attribute
kSecAttrTokenID as String: kSecAttrTokenIDSecureEnclave,
</code></pre>
<h3 id='a_21581' class='heading'>A_21581</h3>
<h4 id='code-sources-idp-privatekeycontainer-swift-140-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:140</code></h4>

<p>Algorithm selection</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21581,A_21589] Algorithm selection
kSecAttrKeyType as String: kSecAttrKeyTypeECSECPrimeRandom,
</code></pre>
<h3 id='a_21582' class='heading'>A_21582</h3>
<h4 id='code-sources-idp-privatekeycontainer-swift-128-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:128</code></h4>

<p>method selection</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21582] method selection
// [REQ:gemSpec_IDP_Frontend:A_21587] via `.privateKeyUsage`
[.privateKeyUsage,
</code></pre>
<h3 id='a_21583' class='heading'>A_21583</h3>

<p>Secure Enclave is enforced with code attributes.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-144-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:144</code></h4>

<p>Enforced via access attribute</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21578,A_21579,A_21580,A_21583] Enforced via access attribute
kSecAttrTokenID as String: kSecAttrTokenIDSecureEnclave,
</code></pre>
<h3 id='a_21584' class='heading'>A_21584</h3>

<p>There is no API to allow or disallow an biometric authentication, iOS is handling the authorization process while using the private key for any cryptographic operation.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-235-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:235</code></h4>

<p>private key usage triggers biometric unlock</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21584] private key usage triggers biometric unlock
guard let signature = SecKeyCreateSignature(privateKey,
</code></pre>
<h3 id='a_21585' class='heading'>A_21585</h3>

<p>Default behavior for all apps when using private access group (<a href="https://developer.apple.com/documentation/security/keychain_services/keychain_items/sharing_access_to_keychain_items_among_a_collection_of_apps">https://developer.apple.com/documentation/security/keychain_services/keychain_items/sharing_access_to_keychain_items_among_a_collection_of_apps</a>)</p>
<h3 id='a_21586' class='heading'>A_21586</h3>

<p>iOS will delete all user related data after user-account reset. Key-Chain data is not being synced with iCloud since <code>kSecAttrSynchronizable</code> is not applied  </p>
<h4 id='code-sources-idp-privatekeycontainer-swift-125-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:125</code></h4>

<p>prevents migration to other devices</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21586] prevents migration to other devices
// [REQ:BSI-eRp-ePA:O.Data_15#2] prevents migration to other devices
kSecAttrAccessibleWhenPasscodeSetThisDeviceOnly,
</code></pre>
<h4 id='code-sources-idp-privatekeycontainer-swift-131-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:131</code></h4>

<p>invalidates biometry after changes</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21586] invalidates biometry after changes
// [REQ:BSI-eRp-ePA:O.Biom_6#2] invalidates biometry after changes
.biometryCurrentSet], &amp;error) else {
</code></pre>
<h3 id='a_21587' class='heading'>A_21587</h3>
<h4 id='code-sources-idp-privatekeycontainer-swift-129-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:129</code></h4>

<p>via <code>.privateKeyUsage</code></p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21582] method selection
// [REQ:gemSpec_IDP_Frontend:A_21587] via `.privateKeyUsage`
[.privateKeyUsage,
</code></pre>
<h3 id='a_21588' class='heading'>A_21588</h3>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-13-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:13</code></h4>

<p>key identfier generator, number of bytes 32</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21588] key identfier generator, number of bytes 32
keyIdentifierGenerator: @escaping (() throws -&gt; Data) = { try generateSecureRandom(length: 32) },
</code></pre>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-36-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:36</code></h4>

<p>Key generation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21588] Key generation
let keyIdentifier = try keyIdentifierGenerator()
</code></pre>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-101-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:101</code></h4>

<p>usage as base64 encoded string</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21588] usage as base64 encoded string
guard let someIdentifier = identifier,
</code></pre>
<h3 id='a_21589' class='heading'>A_21589</h3>
<h4 id='code-sources-idp-privatekeycontainer-swift-140-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:140</code></h4>

<p>Algorithm selection</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21581,A_21589] Algorithm selection
kSecAttrKeyType as String: kSecAttrKeyTypeECSECPrimeRandom,
</code></pre>
<h4 id='code-sources-idp-privatekeycontainer-swift-142-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:142</code></h4>

<p>Key length</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21589] Key length
kSecAttrKeySizeInBits as String: 256,
</code></pre>
<h3 id='a_21590' class='heading'>A_21590</h3>

<p>References of <code>SecureEnclaveSignatureProvider</code> is limited to registration and altVerify usage.</p>
<h4 id='code-sources-idp-privatekeycontainer-swift-18-code' class='heading'><code>../Sources/IDP/PrivateKeyContainer.swift:18</code></h4>

<p>This is the container to represent biometric keys. Usage is limited to</p>
<pre class="highlight plaintext"><code>/// Represents a (SecureEnclave) private key, namely `PrK_SE_AUT`, secured by iOS Biometrics.
///
/// [REQ:gemSpec_IDP_Frontend:A_21590] This is the container to represent biometric keys. Usage is limited to
/// authorization purposes
/// [REQ:BSI-eRp-ePA:O.Cryp_7#2] Container for private key operations using secure enclave private keys
public struct PrivateKeyContainer {
</code></pre>
<h3 id='a_21591' class='heading'>A_21591</h3>
<h4 id='code-sources-idp-models-registrationdata-swift-57-code' class='heading'><code>../Sources/IDP/Models/RegistrationData.swift:57</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemF_Biometrie:A_21415:Device_Type]
/// [REQ:gemSpec_IDP_Frontend:A_21591]
public struct DeviceType: Codable {
</code></pre>
<h4 id='code-sources-idp-uidevice-extension-swift-10-code' class='heading'><code>../Sources/IDP/UIDevice+Extension.swift:10</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21591,A_21600]
func deviceInformation() -&gt; RegistrationData.DeviceInformation {
</code></pre>
<h4 id='code-sources-idp-uidevice-extension-swift-43-code' class='heading'><code>../Sources/IDP/UIDevice+Extension.swift:43</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21591,A_21600]
func deviceInformation() -&gt; RegistrationData.DeviceInformation {
</code></pre>
<h3 id='a_21595' class='heading'>A_21595</h3>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-233-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:233</code></h4>

<p>Store within keychain</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21595] Store within keychain
success = try keychainHelper.setGenericPassword(keyIdentifier, for: idpBiometricKeyIdentifier)
</code></pre>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-51-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:51</code></h4>

<p>Store pairing data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595,A_21595] Store pairing data
certificateStorage.set(certificate: certificate)
</code></pre>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-72-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:72</code></h4>

<p>case deletion</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21595] case deletion
certificateStorage.set(certificate: nil)
</code></pre>
<h4 id='code-sources-idp-idpstorage-swift-12-code' class='heading'><code>../Sources/IDP/IDPStorage.swift:12</code></h4>

<p>Storage Protocol</p>
<pre class="highlight plaintext"><code>/// Interface to access an eGK Certificate that should be kept private
/// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Protocol
public protocol SecureEGKCertificateStorage {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-76-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:76</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-129-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:129</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-145-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:145</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)
</code></pre>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-22-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:22</code></h4>

<p>Storage Implementation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemF_Tokenverschlüsselung:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_2#5,O.Arch_4#3,O.Source_7#2,O.Data_2#2] Implementation of data storage that is
// persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {
</code></pre>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-206-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:206</code></h4>

<p>Store within keychain</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21595] Store within keychain
_ = try? keychainHelper.setGenericPassword(derBytes, for: egkAuthCertIdentifier)
</code></pre>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-51-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:51</code></h4>

<p>Store pairing data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595,A_21595] Store pairing data
certificateStorage.set(certificate: certificate)
</code></pre>
<h3 id='a_21598' class='heading'>A_21598</h3>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-51-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:51</code></h4>

<p>Store pairing data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595,A_21595] Store pairing data
certificateStorage.set(certificate: certificate)
</code></pre>
<h4 id='code-sources-idp-defaultsecureenclavesignatureprovider-swift-69-code' class='heading'><code>../Sources/IDP/DefaultSecureEnclaveSignatureProvider.swift:69</code></h4>

<p>Delete all stored keys/identifiers/certificate in case of an unsuccessful</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598] Delete all stored keys/identifiers/certificate in case of an unsuccessful
// registration
public func abort(pairingSession: PairingSession) throws {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-76-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:76</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-129-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:129</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-environment-biometrics-swift-145-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.Environment+Biometrics.swift:145</code></h4>

<p>Failure will delete paring data</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21598,A_21595] Failure will delete paring data
// [REQ:BSI-eRp-ePA:O.Source_5#5] Failure will delete paring data
_ = try? sessionProvider.signatureProvider(for: profileID).abort(pairingSession: pairingSession)
</code></pre>
<h3 id='a_21600' class='heading'>A_21600</h3>
<h4 id='code-sources-idp-uidevice-extension-swift-10-code' class='heading'><code>../Sources/IDP/UIDevice+Extension.swift:10</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21591,A_21600]
func deviceInformation() -&gt; RegistrationData.DeviceInformation {
</code></pre>
<h4 id='code-sources-idp-uidevice-extension-swift-43-code' class='heading'><code>../Sources/IDP/UIDevice+Extension.swift:43</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_IDP_Frontend:A_21591,A_21600]
func deviceInformation() -&gt; RegistrationData.DeviceInformation {
</code></pre>
<h3 id='a_21603' class='heading'>A_21603</h3>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-252-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:252</code></h4>

<p>Certificate</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21603] Certificate
set(certificate: nil)
</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-41-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:41</code></h4>

<p>Certificate</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-01#2] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_IDP_Frontend:A_21603] Certificate
storage.wipe()
</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-47-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:47</code></h4>

<p>key identifier</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_21603] key identifier
storage.set(keyIdentifier: nil)
</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-54-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:54</code></h4>

<p>PrK_SE_AUT/PuK_SE_AUT</p>
<pre class="highlight plaintext"><code>// If deletion fails we cannot do anything
// [REQ:gemSpec_IDP_Frontend:A_21603] PrK_SE_AUT/PuK_SE_AUT
_ = try? PrivateKeyContainer.deleteExistingKey(for: identifier)
</code></pre>
<h2 id='gemspec_idp_sek' class='heading'>gemSpec_IDP_Sek</h2>
<h3 id='a_22294' class='heading'>A_22294</h3>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationdomain-swift-81-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationDomain.swift:81</code></h4>

<p>Start login with KK</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22294] Start login with KK
// [REQ:BSI-eRp-ePA:O.Auth_3#2,O.Plat_10#2] Start login with KK
return .publisher(
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthselectiondomain-swift-112-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthSelectionDomain.swift:112</code></h4>

<p>Select KK</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22294] Select KK
state.selectedKK = entry
</code></pre>
<h3 id='a_22295' class='heading'>A_22295</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-450-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:450</code></h4>

<p>Usage of kk_app_id</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22295] Usage of kk_app_id
let extAuth = IDPExtAuth(kkAppId: entry.identifier,
</code></pre>
<h3 id='a_22296' class='heading'>A_22296</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-419-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:419</code></h4>

<p>Signature verification</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22296] Signature verification
// [REQ:BSI-eRp-ePA:O.Resi_6#3] Discovery Document signature verification
guard try jwtContainer.verify(with: document.discKey) == true else {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthselectiondomain-swift-95-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthSelectionDomain.swift:95</code></h4>

<p>Load available apps</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22296] Load available apps
return .publisher(
</code></pre>
<h3 id='a_22299' class='heading'>A_22299</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-467-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:467</code></h4>

<p>Remember State parameter for later verification</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22299] Remember State parameter for later verification
guard let components = URLComponents(url: redirectUrl, resolvingAgainstBaseURL: true),
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationdomain-swift-96-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationDomain.swift:96</code></h4>

<p>Follow redirect</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22299] Follow redirect
// [REQ:BSI-eRp-ePA:O.Plat_10#3] Follow redirect
guard environment.resourceHandler.canOpenURL(url) else {
</code></pre>
<h3 id='a_22301' class='heading'>A_22301</h3>
<h4 id='code-sources-idp-defaultidpsession-swift-497-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:497</code></h4>

<p>Send authorization request</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22301] Send authorization request
return extAuthVerify(verify)
</code></pre>
<h3 id='a_22313' class='heading'>A_22313</h3>
<h4 id='code-sources-erpapp-screens-cardwall-extauth-cardwallextauthconfirmationdomain-swift-102-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ExtAuth/CardWallExtAuthConfirmationDomain.swift:102</code></h4>

<p>Remember State parameter for later verification</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Sek:A_22313] Remember State parameter for later verification
environment.resourceHandler.open(url, options: [:]) { result in
</code></pre>
<h2 id='gemspec_krypt' class='heading'>gemSpec_Krypt</h2>
<h3 id='a_17124' class='heading'>A_17124</h3>

<p>no exceptions set in NSAppTransportSecurity, see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a> </p>
<h3 id='a_17205' class='heading'>A_17205</h3>

<p>The app does not use the TSL. All TSL related parts are handled within the eRp-FD.</p>
<h3 id='a_17207' class='heading'>A_17207</h3>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-550-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:550</code></h4>

<p>Assure only brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
var alg: JWT.Algorithm? {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-287-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:287</code></h4>

<p>Only implemented for brainpoolP256r1</p>
<pre class="highlight plaintext"><code>// Validate JWT/DiscoveryDocument signature
// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02] Assure that brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4361-02] Assure that brainpoolP256r1 is used
// [REQ:BSI-eRp-ePA:O.Resi_6#4] Discovery Document signature verification
guard (try? fetchedDocument.backing.verify(with: fetchedDocument.discKey)) ?? false else {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-628-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:628</code></h4>

<p>Only implemented for brainpoolP256r1</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_IDP_Frontend:A_19908-01] Signature check
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let verified = try? challenge.challenge.verify(with: document.authentication.cert),
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-23-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:23</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02]
public func verify(signature raw: Data, message: Data) throws -&gt; Bool {
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-33-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:33</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let key = brainpoolP256r1VerifyPublicKey() else {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-365-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:365</code></h4>

<p>Assure only brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let alg = autCertificateResponse.info.algorithm.alg
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-386-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:386</code></h4>

<p>Assure only brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard autCertificateResponse.info.algorithm.alg == .bp256r1 else {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-495-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:495</code></h4>

<p>Assure only brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let alg = certificate.info.algorithm.alg else {
</code></pre>

<p>brainpoolP256r1 is used for creating/verifying key for signature usage; exception: Biometric use case uses secp256r1 (is considered in respective specification)</p>
<h3 id='a_17322' class='heading'>A_17322</h3>

<p>no exceptions set in NSAppTransportSecurity, see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a> </p>
<h3 id='a_17359' class='heading'>A_17359</h3>

<p>brainpoolP256r1 is used for creating/verifying key for signature usage; exception: Biometric use case uses secp256r1 (is considered in respective specification)</p>
<h3 id='a_17775' class='heading'>A_17775</h3>

<p>We cannot interfere with cipher suite lists, see <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a> for actual order.</p>
<h3 id='a_18464' class='heading'>A_18464</h3>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-36-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:36</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_Krypt:GS-A_5322] TODO: Check if limiting SSL Sessions is possible, check for renegotiation
// swiftlint:disable:previous todo
// [REQ:gemSpec_IDP_Frontend:A_20606] Live URLs not present in NSAppTransportSecurity exception list for allowed
// HTTP communication
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Sess_1#2,O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework

</code></pre>
<h3 id='a_18467' class='heading'>A_18467</h3>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-36-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:36</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_Krypt:GS-A_5322] TODO: Check if limiting SSL Sessions is possible, check for renegotiation
// swiftlint:disable:previous todo
// [REQ:gemSpec_IDP_Frontend:A_20606] Live URLs not present in NSAppTransportSecurity exception list for allowed
// HTTP communication
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Sess_1#2,O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework

</code></pre>
<h3 id='a_19215' class='heading'>A_19215</h3>

<p>We use https only, see <code>DefaultHTTPClient.swift</code>. ATS forbids other connections.</p>
<h3 id='a_20161-01' class='heading'>A_20161-01</h3>
<h4 id='code-sources-vauclient-vauinterceptor-swift-47-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:47</code></h4>
<pre class="highlight plaintext"><code>// Prepare outer request (encrypt original request and embed it into a new one)
// [REQ:gemSpec_Krypt:A_20161-01]
.processToVauRequest(urlRequest: request, vauCryptoProvider: vauCryptoProvider)
</code></pre>
<h4 id='code-sources-vauclient-vauinterceptor-swift-63-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:63</code></h4>
<pre class="highlight plaintext"><code>// Prepare outer request (encrypt original request and embed it into a new one)
// [REQ:gemSpec_Krypt:A_20161-01]
func processToVauRequest(
</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-26-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:26</code></h4>
<pre class="highlight plaintext"><code>/// Perform encryption of the data that the implementing instance has been initialized with
/// in order to send it to a VAU service endpoint. See: gemSpec_Krypt A_20161-01
///
/// [REQ:gemSpec_Krypt:A_20161-01]
///
/// - Returns: Encrypted HTTPRequest as specified to be sent to a VAU endpoint
/// - Throws: `VAUError` in case of encryption failure
func encrypt() throws -&gt; Data
</code></pre>
<h4 id='5-code-sources-vauclient-internal-vaucrypto-swift-88-code' class='heading'>5 <code>../Sources/VAUClient/internal/VAUCrypto.swift:88</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20161-01:5]
guard let payload = "1 \(bearerToken) \(requestId) \(symKeyHex) \(message)".data(using: .utf8) else {
</code></pre>
<h4 id='6a-g-code-sources-vauclient-internal-vaucrypto-swift-135-code' class='heading'>6a-g <code>../Sources/VAUClient/internal/VAUCrypto.swift:135</code></h4>
<pre class="highlight plaintext"><code>/// Perform Elliptic Curve Integrated Encryption Scheme [SEC1-2009] on some payload
/// [REQ:gemSpec_Krypt:A_20161-01:6a-g]
static func encrypt(
</code></pre>
<h3 id='a_20163' class='heading'>A_20163</h3>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-34-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:34</code></h4>
<pre class="highlight plaintext"><code>/// Perform decryption and validation of given data with the secret key material the implementing instance holds.
///
/// [REQ:gemSpec_Krypt:A_20163]
///
/// - Parameter data: Data to be decrypted
/// - Returns: Decrypted UTF8 string representation of the given data
/// - Throws: `VAUError` in case of decryption failure or when the decrypted data could not be validated
func decrypt(data: Data) throws -&gt; String
</code></pre>
<h3 id='a_20174' class='heading'>A_20174</h3>
<h4 id='code-sources-vauclient-vauinterceptor-swift-52-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:52</code></h4>
<pre class="highlight plaintext"><code>// Process VAU server response (validate and extract+decrypt inner FHIR service response)
// [REQ:gemSpec_Krypt:A_20174]
.handleUserPseudonym(vauEndpointHandler: self.vauEndpointHandler)
</code></pre>
<h4 id='code-sources-vauclient-vauinterceptor-swift-130-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:130</code></h4>
<pre class="highlight plaintext"><code>// Process VAU server response (validate and extract+decrypt inner FHIR service response)
// [REQ:gemSpec_Krypt:A_20174]
static func processVauResponse(httpResponse: HTTPResponse, vauCrypto: VAUCrypto, originalUrl: URL) throws
</code></pre>
<h4 id='3-code-sources-vauclient-internal-vaucrypto-swift-112-code' class='heading'>3 <code>../Sources/VAUClient/internal/VAUCrypto.swift:112</code></h4>

<p>Decrypt using AES symmetric key</p>
<pre class="highlight plaintext"><code>// Steps according to gemSpec_Krypt A_20174
// [REQ:gemSpec_Krypt:A_20174:3] Decrypt using AES symmetric key
guard let sealed = try? AES.GCM.SealedBox(combined: data),
</code></pre>
<h4 id='4-5-code-sources-vauclient-internal-vaucrypto-swift-119-code' class='heading'>4,5 <code>../Sources/VAUClient/internal/VAUCrypto.swift:119</code></h4>

<p>Verify decrypted message. Expect: &ldquo;1 <request id> <response header and body>&rdquo;</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20174:4,5] Verify decrypted message. Expect: "1 &lt;request id&gt; &lt;response header and body&gt;"
let separated = utf8.split(separator: " ", maxSplits: 2).map { String($0) }
</code></pre>
<h4 id='2-code-sources-vauclient-internal-vauendpointhandler-swift-13-code' class='heading'>2 <code>../Sources/VAUClient/internal/VAUEndpointHandler.swift:13</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20174:2]
func didReceiveUserPseudonym(in httpResponse: HTTPResponse)
</code></pre>
<h4 id='2-code-sources-vauclient-internal-vauendpointhandler-swift-34-code' class='heading'>2 <code>../Sources/VAUClient/internal/VAUEndpointHandler.swift:34</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_20174:2]
if let pseudonym = httpResponse.response.value(forHTTPHeaderField: "userpseudonym") {
</code></pre>
<h3 id='a_20175' class='heading'>A_20175</h3>
<h4 id='code-sources-vauclient-vaustorage-swift-15-code' class='heading'><code>../Sources/VAUClient/VAUStorage.swift:15</code></h4>
<pre class="highlight plaintext"><code>/// Retrieve a previously saved UserPseudonym
///
/// [REQ:gemSpec_Krypt:A_20175]
var userPseudonym: AnyPublisher&lt;String?, Never&gt; { get }
</code></pre>
<h4 id='code-sources-vauclient-vaustorage-swift-22-code' class='heading'><code>../Sources/VAUClient/VAUStorage.swift:22</code></h4>
<pre class="highlight plaintext"><code>/// Set and save a user pseudonym
///
/// [REQ:gemSpec_Krypt:A_20175]
///
/// - Parameter userPseudonym: value to save. Pass in nil to unset
func set(userPseudonym: String?)
</code></pre>
<h3 id='a_20607' class='heading'>A_20607</h3>

<p>We use https only, see <code>DefaultHTTPClient.swift</code>. ATS forbids other connections.</p>
<h3 id='a_21216' class='heading'>A_21216</h3>
<h4 id='code-sources-truststore-internal-certlist-swift-11-code' class='heading'><code>../Sources/TrustStore/internal/CertList.swift:11</code></h4>
<pre class="highlight plaintext"><code>/// Data structure according to */CertList* endpoint
/// [REQ:gemSpec_Krypt:A_21216]
public struct CertList: Codable, Equatable {
</code></pre>
<h4 id='code-sources-vauclient-internal-vaucertlist-swift-11-code' class='heading'><code>../Sources/VAUClient/internal/VAUCertList.swift:11</code></h4>
<pre class="highlight plaintext"><code>/// Data structure according to */CertList* endpoint
/// [REQ:gemSpec_Krypt:A_21216]
public struct VAUCertList: Codable, Equatable {
</code></pre>
<h3 id='a_21217' class='heading'>A_21217</h3>
<h4 id='code-sources-truststore-internal-ocsplist-swift-10-code' class='heading'><code>../Sources/TrustStore/internal/OCSPList.swift:10</code></h4>
<pre class="highlight plaintext"><code>/// [REQ:gemSpec_Krypt:A_21217]
/// Data structure according to */OCSPList* endpoint
public struct OCSPList: Codable, Equatable {
</code></pre>
<h3 id='a_21218' class='heading'>A_21218</h3>
<h4 id='code-sources-erpapp-appconfiguration-swift-94-code' class='heading'><code>../Sources/eRpApp/AppConfiguration.swift:94</code></h4>

<p>Gematik Root CA 3 as a trust anchor has to be set in the program code</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] Gematik Root CA 3 as a trust anchor has to be set in the program code
// swiftlint:disable:next force_try
let TRUSTANCHOR_GemRootCa3 = try! TrustAnchor(withPEM: """
</code></pre>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-68-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:68</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218,A_21222]
extension DefaultTrustStoreSession: TrustStoreSession {
</code></pre>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-178-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:178</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218]
func loadOCSPResponses() -&gt; AnyPublisher&lt;[OCSPResponse], TrustStoreError&gt; {
</code></pre>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-191-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:191</code></h4>

<p>If only OCSP responses &gt;12h available, we must request new ones</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] If only OCSP responses &gt;12h available, we must request new ones
ocspResponses
</code></pre>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-209-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:209</code></h4>

<p>If only OCSP responses &gt;12h available, &hellip;</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] If only OCSP responses &gt;12h available, ...
ocspResponses
</code></pre>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-233-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:233</code></h4>

<p>If only OCSP responses &gt;12h available, we must request new ones</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] If only OCSP responses &gt;12h available, we must request new ones
func allSatisfyNotProducedBefore(date: Date) -&gt; Bool {
</code></pre>
<h4 id='code-sources-truststore-truststoresession-swift-13-code' class='heading'><code>../Sources/TrustStore/TrustStoreSession.swift:13</code></h4>
<pre class="highlight plaintext"><code>/// TrustStoreSession acts as an interactor/mediator for the TrustStoreClient and TrustStoreStorage
///
/// [REQ:gemSpec_Krypt:A_21218,A_21222]
public protocol TrustStoreSession {
</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-13-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:13</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218]
// [REQ:gemSpec_eRp_FdV:A_20032-01]
// Category A: Cross root certificates
private let rootCa: X509
</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-105-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:105</code></h4>
<pre class="highlight plaintext"><code>/// Match a collection of `OCSPResponse`s with the end entity certificates of this `X509TrustStore`.
/// Checks response status, revocation status for each certificate and validates the signer certificates of
///   the responses itself.
///
/// [REQ:gemSpec_Krypt:A_21218]
/// [REQ:gemSpec_eRp_Fdv:A_20032-01]
///
/// - Note: This function assumes that up-to-dateness of the responses itself has already been checked.
///
/// - Returns: true on successful matching/validation, false if not successful or error
func checkEeCertificatesStatus(with ocspResponses: [OCSPResponse]) throws -&gt; Bool {
</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-103-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:103</code></h4>

<p>OCSP responder certificates must be verifiable by the trust store</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] OCSP responder certificates must be verifiable by the trust store
let verifiedOCSPResponses = basicVerifyFilter(ocspResponses: ocspResponses)
</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-111-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:111</code></h4>

<p>For every EE certificate there must be a matching OCSP response</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] For every EE certificate there must be a matching OCSP response
let matchedResponses = try eeCertAndSignerTuple.map { eeCertificate, signer in
</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-119-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:119</code></h4>

<p>For every OCSP response there must be a matching EE certificate</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] For every OCSP response there must be a matching EE certificate
let matchedEeCerts = try ocspResponses.map { response in
</code></pre>
<h4 id='code-sources-truststore-x509truststore-swift-130-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:130</code></h4>

<p>OCSP responder certificates must be verifiable by the trust store</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218] OCSP responder certificates must be verifiable by the trust store
private func basicVerifyFilter(ocspResponses: [OCSPResponse]) -&gt; [OCSPResponse] {
</code></pre>
<h4 id='3-code-sources-truststore-x509truststore-swift-151-code' class='heading'>(3) <code>../Sources/TrustStore/X509TrustStore.swift:151</code></h4>

<p>Check ca_certs against category A certificates</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218:(3)] Check ca_certs against category A certificates
private static let caCertRegex =
</code></pre>
<h4 id='4-code-sources-truststore-x509truststore-swift-168-code' class='heading'>(4) <code>../Sources/TrustStore/X509TrustStore.swift:168</code></h4>

<p>Check ee_certs against category A+B certificates</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218:(4)] Check ee_certs against category A+B certificates
typealias VauAndIpdCerts = (vauCerts: [X509], idpCerts: [X509])
</code></pre>

<p>Note: grace period for OCSP responses is 12h</p>
<h3 id='a_21222' class='heading'>A_21222</h3>
<h4 id='code-sources-truststore-defaulttruststoresession-swift-68-code' class='heading'><code>../Sources/TrustStore/DefaultTrustStoreSession.swift:68</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218,A_21222]
extension DefaultTrustStoreSession: TrustStoreSession {
</code></pre>
<h4 id='code-sources-truststore-truststoresession-swift-13-code' class='heading'><code>../Sources/TrustStore/TrustStoreSession.swift:13</code></h4>
<pre class="highlight plaintext"><code>/// TrustStoreSession acts as an interactor/mediator for the TrustStoreClient and TrustStoreStorage
///
/// [REQ:gemSpec_Krypt:A_21218,A_21222]
public protocol TrustStoreSession {
</code></pre>
<h3 id='a_21275' class='heading'>A_21275</h3>

<p>no exceptions set in NSAppTransportSecurity, see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a> </p>
<h3 id='a_21275-01' class='heading'>A_21275−01</h3>

<p>no exceptions set in NSAppTransportSecurity, see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a> </p>
<h3 id='a_21332' class='heading'>A_21332</h3>

<p>no exceptions set in NSAppTransportSecurity, see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a> </p>
<h3 id='a_4389' class='heading'>A_4389</h3>
<h4 id='1-code-sources-vauclient-internal-vaucrypto-swift-92-code' class='heading'>1 <code>../Sources/VAUClient/internal/VAUCrypto.swift:92</code></h4>

<p>IVs must not be reused, IVs bit length must be larger or equal to 96</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_4389:1] IVs must not be reused, IVs bit length must be larger or equal to 96
let nonceGenerator = { try VAURandom.generateSecureRandom(length: self.eciesSpec.ivSize) }
</code></pre>
<h3 id='gs-a_4357' class='heading'>GS-A_4357</h3>
<h4 id='code-sources-idp-internal-idpcrypto-swift-15-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:15</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>/// Key-pair generator type based on BrainpoolP256r1
///
/// [REQ:gemSpec_Krypt:GS-A_4357,GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
public typealias BrainpoolKeyGenerator = () throws -&gt; BrainpoolP256r1.KeyExchange.PrivateKey
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwe-kdf-swift-31-code' class='heading'><code>../Sources/IDP/internal/JWT/JWE+KDF.swift:31</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4357] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:gemSpec_Krypt:GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
case bpp256r1(BrainpoolP256r1.KeyExchange.PublicKey,
</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-97-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:97</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4357] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:gemSpec_Krypt:GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:BSI-eRp-ePA:O.Cryp_3#5] Brainpool key generator
// [REQ:gemSpec_eRp_FdV:A_19179#5] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
let keyPairGenerator = { try BrainpoolP256r1.KeyExchange.generateKey() }
</code></pre>
<h3 id='gs-a_4357-01' class='heading'>GS-A_4357-01</h3>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-551-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:551</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
var alg: JWT.Algorithm? {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-630-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:630</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_IDP_Frontend:A_19908-01] Signature check
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let verified = try? challenge.challenge.verify(with: document.authentication.cert),
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-24-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:24</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02]
public func verify(signature raw: Data, message: Data) throws -&gt; Bool {
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-34-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:34</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let key = brainpoolP256r1VerifyPublicKey() else {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-366-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:366</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let alg = autCertificateResponse.info.algorithm.alg
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-387-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:387</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard autCertificateResponse.info.algorithm.alg == .bp256r1 else {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-496-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:496</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let alg = certificate.info.algorithm.alg else {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-288-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:288</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// Validate JWT/DiscoveryDocument signature
// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02] Assure that brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4361-02] Assure that brainpoolP256r1 is used
// [REQ:BSI-eRp-ePA:O.Resi_6#4] Discovery Document signature verification
guard (try? fetchedDocument.backing.verify(with: fetchedDocument.discKey)) ?? false else {
</code></pre>
<h3 id='gs-a_4357-02' class='heading'>GS-A_4357-02</h3>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-551-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:551</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
var alg: JWT.Algorithm? {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-630-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:630</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_IDP_Frontend:A_19908-01] Signature check
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let verified = try? challenge.challenge.verify(with: document.authentication.cert),
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-24-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:24</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02]
public func verify(signature raw: Data, message: Data) throws -&gt; Bool {
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-34-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:34</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let key = brainpoolP256r1VerifyPublicKey() else {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-366-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:366</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let alg = autCertificateResponse.info.algorithm.alg
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-387-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:387</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard autCertificateResponse.info.algorithm.alg == .bp256r1 else {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-496-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:496</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let alg = certificate.info.algorithm.alg else {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-288-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:288</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// Validate JWT/DiscoveryDocument signature
// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02] Assure that brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4361-02] Assure that brainpoolP256r1 is used
// [REQ:BSI-eRp-ePA:O.Resi_6#4] Discovery Document signature verification
guard (try? fetchedDocument.backing.verify(with: fetchedDocument.discKey)) ?? false else {
</code></pre>
<h3 id='gs-a_4359' class='heading'>GS-A_4359</h3>

<p>no exceptions set in NSAppTransportSecurity, see also: <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a> </p>
<h3 id='gs-a_4361-02' class='heading'>GS-A_4361-02</h3>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-551-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:551</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
var alg: JWT.Algorithm? {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-630-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:630</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_IDP_Frontend:A_19908-01] Signature check
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let verified = try? challenge.challenge.verify(with: document.authentication.cert),
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-24-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:24</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02]
public func verify(signature raw: Data, message: Data) throws -&gt; Bool {
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwtsignatureverifier-swift-34-code' class='heading'><code>../Sources/IDP/internal/JWT/JWTSignatureVerifier.swift:34</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207]
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let key = brainpoolP256r1VerifyPublicKey() else {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-366-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:366</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let alg = autCertificateResponse.info.algorithm.alg
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-387-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:387</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard autCertificateResponse.info.algorithm.alg == .bp256r1 else {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-nfcsignatureprovider-swift-496-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/NFCSignatureProvider.swift:496</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_17207] Assure only brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02,GS-A_4361-02] Assure that brainpoolP256r1 is used
guard let alg = certificate.info.algorithm.alg else {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-289-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:289</code></h4>

<p>Assure that brainpoolP256r1 is used</p>
<pre class="highlight plaintext"><code>// Validate JWT/DiscoveryDocument signature
// [REQ:gemSpec_Krypt:A_17207] Only implemented for brainpoolP256r1
// [REQ:gemSpec_Krypt:GS-A_4357-01,GS-A_4357-02] Assure that brainpoolP256r1 is used
// [REQ:gemSpec_Krypt:GS-A_4361-02] Assure that brainpoolP256r1 is used
// [REQ:BSI-eRp-ePA:O.Resi_6#4] Discovery Document signature verification
guard (try? fetchedDocument.backing.verify(with: fetchedDocument.discKey)) ?? false else {
</code></pre>
<h3 id='gs-a_4367' class='heading'>GS-A_4367</h3>
<h4 id='code-sources-idp-internal-idpcrypto-swift-15-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:15</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>/// Key-pair generator type based on BrainpoolP256r1
///
/// [REQ:gemSpec_Krypt:GS-A_4357,GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
public typealias BrainpoolKeyGenerator = () throws -&gt; BrainpoolP256r1.KeyExchange.PrivateKey
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwe-kdf-swift-32-code' class='heading'><code>../Sources/IDP/internal/JWT/JWE+KDF.swift:32</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4357] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:gemSpec_Krypt:GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
case bpp256r1(BrainpoolP256r1.KeyExchange.PublicKey,
</code></pre>
<h4 id='code-sources-idp-internal-seckeyrandom-swift-20-code' class='heading'><code>../Sources/IDP/internal/SecKeyRandom.swift:20</code></h4>
<pre class="highlight plaintext"><code>/// Generate random Data with given length
///
/// [REQ:gemSpec_Krypt:GS-A_4367]
/// [REQ:BSI-eRp-ePA:O.Rand_1#2] Secure Random generator.
///
/// - Parameters:
///   - length: the number of bytes to generate
///   - randomizer: the randomizer to be used. Default: kSecRandomDefault
/// - Returns: the random initialized Data
/// - Throws: `IDPError`
public func generateSecureRandom(length: Int, randomizer: SecRandomRef? = kSecRandomDefault) throws -&gt; Data {
</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-98-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:98</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4357] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:gemSpec_Krypt:GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:BSI-eRp-ePA:O.Cryp_3#5] Brainpool key generator
// [REQ:gemSpec_eRp_FdV:A_19179#5] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
let keyPairGenerator = { try BrainpoolP256r1.KeyExchange.generateKey() }
</code></pre>
<h4 id='code-sources-vauclient-internal-vaurandom-swift-21-code' class='heading'><code>../Sources/VAUClient/internal/VAURandom.swift:21</code></h4>
<pre class="highlight plaintext"><code>/// Generate random Data with given length
///
/// [REQ:gemSpec_Krypt:GS-A_4367]
/// [REQ:BSI-eRp-ePA:O.Rand_1#3] Secure Random generator.
///
/// - Parameters:
///   - length: the number of bytes to generate
///   - randomizer: the randomizer to be used. Default: kSecRandomDefault
/// - Returns: the random initialized Data
/// - Throws: `VAUError`
static func generateSecureRandom(length: Int, randomizer: SecRandomRef? = kSecRandomDefault) throws -&gt; Data {
</code></pre>
<h3 id='gs-a_4368' class='heading'>GS-A_4368</h3>
<h4 id='code-sources-idp-internal-idpcrypto-swift-55-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:55</code></h4>

<p>AES key generation via CryptoKit</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:1] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#3] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
aesKey: SymmetricKey = SymmetricKey(size: SymmetricKeySize(bitCount: 256))
</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-149-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:149</code></h4>

<p>AES key generation via CryptoKit</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:2] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#6] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
let secretKey = SymmetricKey(data: sharedSecret)
</code></pre>
<h3 id='gs-a_4385' class='heading'>GS-A_4385</h3>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-36-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:36</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_Krypt:GS-A_5322] TODO: Check if limiting SSL Sessions is possible, check for renegotiation
// swiftlint:disable:previous todo
// [REQ:gemSpec_IDP_Frontend:A_20606] Live URLs not present in NSAppTransportSecurity exception list for allowed
// HTTP communication
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Sess_1#2,O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework

</code></pre>
<h3 id='gs-a_4387' class='heading'>GS-A_4387</h3>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-36-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:36</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_Krypt:GS-A_5322] TODO: Check if limiting SSL Sessions is possible, check for renegotiation
// swiftlint:disable:previous todo
// [REQ:gemSpec_IDP_Frontend:A_20606] Live URLs not present in NSAppTransportSecurity exception list for allowed
// HTTP communication
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Sess_1#2,O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework

</code></pre>
<h3 id='gs-a_4389' class='heading'>GS-A_4389</h3>
<h4 id='2-code-sources-idp-internal-idpcrypto-swift-48-code' class='heading'>2 <code>../Sources/IDP/internal/IDPCrypto.swift:48</code></h4>

<p>IVs must not be reused, IVs bit length must be larger or equal to 96</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:2] IVs must not be reused, IVs bit length must be larger or equal to 96
try generateSecureRandom(length: IDPCrypto.AES256GCMSpec.nonceBytes)
</code></pre>
<h4 id='1-code-sources-idp-internal-idpcrypto-swift-53-code' class='heading'>1 <code>../Sources/IDP/internal/IDPCrypto.swift:53</code></h4>

<p>256bit GCM symmetric key</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:1] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#3] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
aesKey: SymmetricKey = SymmetricKey(size: SymmetricKeySize(bitCount: 256))
</code></pre>
<h4 id='2-code-sources-vauclient-internal-vaucrypto-swift-147-code' class='heading'>2 <code>../Sources/VAUClient/internal/VAUCrypto.swift:147</code></h4>

<p>256bit GCM symmetric key</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:2] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#6] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
let secretKey = SymmetricKey(data: sharedSecret)
</code></pre>
<h4 id='1-code-sources-vauclient-internal-vaucrypto-swift-166-code' class='heading'>1 <code>../Sources/VAUClient/internal/VAUCrypto.swift:166</code></h4>

<p>256bit GCM symmetric key</p>
<pre class="highlight plaintext"><code>// f) Encrypt
// [REQ:gemSpec_Krypt:GS-A_4389:1] 256bit GCM symmetric key
let sealedBox = try AES.GCM.seal(payload, using: cek, nonce: nonce)
</code></pre>
<h3 id='gs-a_4390' class='heading'>GS-A_4390</h3>
<h4 id='code-sources-avs-avscmsencrypter-swift-20-code' class='heading'><code>../Sources/AVS/AVSCmsEncrypter.swift:20</code></h4>

<p>RSAES-OAEP with MGF1 implemented in sub-framework OpenSSL-swift</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4390] RSAES-OAEP with MGF1 implemented in sub-framework OpenSSL-swift
// [REQ:gemSpec_eRp_FdV:A_22778#3] Encryption of message to the Pharmacy is done with all provided certificates
// [REQ:gemSpec_eRp_FdV:A_22779#3] Encrypted message is of form of a PKCS#7 container (CMS)
// https://github.com/gematik/OpenSSL-Swift/blob/3c1ea91ba5abfefecfe3588815cb928d777e29ad/Sources/OpenSSL/CMS/CMSContentInfo.swift#L88
// swiftlint:disable:previous line_length
let cms = try CMSContentInfo.encryptPartial(data: data)
</code></pre>
<h3 id='gs-a_5322' class='heading'>GS-A_5322</h3>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-37-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:37</code></h4>

<p>TODO: Check if limiting SSL Sessions is possible, check for renegotiation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_Krypt:GS-A_5322] TODO: Check if limiting SSL Sessions is possible, check for renegotiation
// swiftlint:disable:previous todo
// [REQ:gemSpec_IDP_Frontend:A_20606] Live URLs not present in NSAppTransportSecurity exception list for allowed
// HTTP communication
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Sess_1#2,O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework

</code></pre>
<h3 id='gs-a_5035' class='heading'>GS−A_5035</h3>

<p>We use https only, see <code>DefaultHTTPClient.swift</code>. ATS forbids other connections.</p>
<h3 id='gs-a_5322' class='heading'>GS−A_5322</h3>

<p>There is no API to control the session length, developer forums suggest it is 10 minutes for iOS.</p>
<h3 id='gs-a_5339' class='heading'>GS−A_5339</h3>

<p>We cannot interfere with cipher suite lists, see <a href="https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html">Requirements for Connecting Using ATS</a> for actual order.</p>
<h3 id='gs-a_5526' class='heading'>GS−A_5526</h3>

<p>We use the recommended NSURLSession for best network security <a href="https://developer.apple.com/documentation/security/preventing_insecure_network_connections">Preventing insecure network connections</a></p>
<h3 id='gs-a_5542' class='heading'>GS−A_5542</h3>

<p>We use the recommended NSURLSession for best network security <a href="https://developer.apple.com/documentation/security/preventing_insecure_network_connections">Preventing insecure network connections</a></p>
<h2 id='gemspec_erp_apovzd' class='heading'>gemSpec_eRp_APOVZD</h2>
<h3 id='a_21154' class='heading'>A_21154</h3>
<h4 id='code-sources-erpapp-screens-pharmacy-search-pharmacysearchdomain-swift-324-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Search/PharmacySearchDomain.swift:324</code></h4>

<p>If user defined filters contain location element, ask for permission</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_APOVZD:A_21154] If user defined filters contain location element, ask for permission
if filterOptions.contains(.currentLocation) {
</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-search-pharmacysearchmapdomain-swift-252-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Search/PharmacySearchMapDomain.swift:252</code></h4>

<p>If user defined filters contain location element, ask for permission</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_APOVZD:A_21154] If user defined filters contain location element, ask for permission
if filterOptions.contains(.currentLocation),
</code></pre>
<h3 id='a_21779' class='heading'>A_21779</h3>
<h4 id='code-sources-pharmacy-modelsr4-bundle-location-swift-138-code' class='heading'><code>../Sources/Pharmacy/ModelsR4.Bundle+Location.swift:138</code></h4>

<p>delivery pharmacy</p>
<pre class="highlight plaintext"><code>// [[REQ:gemSpec_eRp_APOVZD:A_21779] delivery pharmacy
case "498":
</code></pre>
<h4 id='code-sources-pharmacy-modelsr4-bundle-location-swift-195-code' class='heading'><code>../Sources/Pharmacy/ModelsR4.Bundle+Location.swift:195</code></h4>

<p>Map pickup pharmacy</p>
<pre class="highlight plaintext"><code>// [[REQ:gemSpec_eRp_APOVZD:A_21779] Map pickup pharmacy
case "OUTPHARM":
</code></pre>
<h4 id='code-sources-pharmacy-modelsr4-bundle-location-swift-200-code' class='heading'><code>../Sources/Pharmacy/ModelsR4.Bundle+Location.swift:200</code></h4>

<p>Map shipping pharmacy</p>
<pre class="highlight plaintext"><code>// [[REQ:gemSpec_eRp_APOVZD:A_21779] Map shipping pharmacy
case "MOBL":
</code></pre>
<h2 id='gemspec_erp_fdv' class='heading'>gemSpec_eRp_FdV</h2>
<h3 id='a_19086' class='heading'>A_19086</h3>

<p>Tracking is only implemented for the purpose of Usability-Tracking. Sessions are not persisted, session ids are recreated each app startup.</p>
<h3 id='a_19087' class='heading'>A_19087</h3>

<p>Tracking is only implemented for the purpose of Usability-Tracking. Sessions are not persisted, session ids are recreated each app startup.</p>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-13-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:13</code></h4>

<p>Implementation of the opt-in usability-tracker.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19087#2] Implementation of the opt-in usability-tracker.
final class ContentSquareAnalyticsAdapter: NSObject, Tracker {
</code></pre>
<h3 id='a_19088' class='heading'>A_19088</h3>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-198-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:198</code></h4>

<p>Show comply route to display analytics usage within</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19088,A_19091#1,A_19092] Show comply route to display analytics usage within
// onboarding
// [REQ:BSI-eRp-ePA:O.Purp_3#5] Show comply route to display analytics usage within onboarding
case .showTracking:
</code></pre>
<h3 id='a_19089' class='heading'>A_19089</h3>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-245-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:245</code></h4>

<p>User info for usage tracking</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19089] User info for usage tracking
Label(title: { Text(L10n.stgTrkTxtExplanation) }, icon: {})
</code></pre>
<h3 id='a_19090' class='heading'>A_19090</h3>
<h4 id='code-sources-erpapp-scenedelegate-swift-293-code' class='heading'><code>../Sources/eRpApp/SceneDelegate.swift:293</code></h4>

<p>activate after optIn is granted</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090] activate after optIn is granted
tracker.stopTracking()
</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-203-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:203</code></h4>

<p>User confirms the opt in within settings</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090,A_19091#2] User confirms the opt in within settings
// [REQ:BSI-eRp-ePA:O.Purp_3#6] Accept usage analytics
case .alert(.presented(.allowTracking)):
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-217-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:217</code></h4>

<p>User confirms the opt in within settings</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090,A_19091#4] User confirms the opt in within settings
// [REQ:BSI-eRp-ePA:O.Purp_5#4] User confirms the opt in within settings
case .confirmedOptInTracking:
</code></pre>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-42-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:42</code></h4>

<p>activate after optIn is granted</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090] activate after optIn is granted
Contentsquare.start()
</code></pre>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-60-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:60</code></h4>

<p>activate tracking only if permitted</p>
<pre class="highlight plaintext"><code>/// Starts tracking and calls `optIn` if permission is granted by the user.
/// Calling this method after calling `resetSessionID()` will create a new `sessionID`
// [REQ:gemSpec_eRp_FdV:A_19090] activate tracking only if permitted
private func startIfPermitted() {
</code></pre>
<h3 id='a_19091' class='heading'>A_19091</h3>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-198-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:198</code></h4>

<p>Show comply route to display analytics usage within</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19088,A_19091#1,A_19092] Show comply route to display analytics usage within
// onboarding
// [REQ:BSI-eRp-ePA:O.Purp_3#5] Show comply route to display analytics usage within onboarding
case .showTracking:
</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-203-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:203</code></h4>

<p>User confirms the opt in within settings</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090,A_19091#2] User confirms the opt in within settings
// [REQ:BSI-eRp-ePA:O.Purp_3#6] Accept usage analytics
case .alert(.presented(.allowTracking)):
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-208-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:208</code></h4>

<p>Show comply route to display analytics usage within settings</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19091#3] Show comply route to display analytics usage within settings
state.destination = .complyTracking
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-217-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:217</code></h4>

<p>User confirms the opt in within settings</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19090,A_19091#4] User confirms the opt in within settings
// [REQ:BSI-eRp-ePA:O.Purp_5#4] User confirms the opt in within settings
case .confirmedOptInTracking:
</code></pre>
<h3 id='a_19092' class='heading'>A_19092</h3>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-198-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:198</code></h4>

<p>Show comply route to display analytics usage within</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19088,A_19091#1,A_19092] Show comply route to display analytics usage within
// onboarding
// [REQ:BSI-eRp-ePA:O.Purp_3#5] Show comply route to display analytics usage within onboarding
case .showTracking:
</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-208-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:208</code></h4>

<p>User may choose to not accept analytics</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19092] User may choose to not accept analytics
// [REQ:BSI-eRp-ePA:O.Purp_3#7] Deny usage analytics
case .alert(.dismiss):
</code></pre>
<h3 id='a_19093' class='heading'>A_19093</h3>

<p>Usage Tracking is called very sparse and boils down to one place where all visited screens are recorded. See usage of <code>@Dependency(\.tracker)</code> for all cases where the actual analytics framework is used.</p>
<h4 id='code-sources-erpapp-tracking-analyticsreducer-swift-38-code' class='heading'><code>../Sources/eRpApp/Tracking/AnalyticsReducer.swift:38</code></h4>

<p>Very sparse usage of actual tracking boils down to this call where</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19093#2] Very sparse usage of actual tracking boils down to this call where
// only displayed screens are tracked
tracker.track(screen: newRoute)
</code></pre>
<h3 id='a_19094' class='heading'>A_19094</h3>

<p>Usage Tracking is called very sparse and boils down to one place where all visited screens are recorded. See usage of <code>@Dependency(\.tracker)</code> for all cases where the actual analytics framework is used.</p>
<h3 id='a_19095' class='heading'>A_19095</h3>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-72-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:72</code></h4>

<p>resets sessionID so that on next app start a new sessionID will be created</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19095] resets sessionID so that on next app start a new sessionID will be created
Contentsquare.optOut()
</code></pre>
<h3 id='a_19096' class='heading'>A_19096</h3>
<h4 id='code-sources-erpapp-tracking-contentsquareanalyticsadapter-swift-61-code' class='heading'><code>../Sources/eRpApp/Tracking/ContentSquareAnalyticsAdapter.swift:61</code></h4>

<p>Remove existing sessions while starting the framework</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19096] Remove existing sessions while starting the framework
Contentsquare.start()
</code></pre>
<h3 id='a_19097' class='heading'>A_19097</h3>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-223-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:223</code></h4>

<p>Toggle within Settings to enable and disable usage tracking</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19097] Toggle within Settings to enable and disable usage tracking
// [REQ:BSI-eRp-ePA:O.Purp_5#1] Toggle within Settings to enable and disable usage tracking
// [REQ:BSI-eRp-ePA:O.Purp_6#1] Current Analytics state is inspectable by the user
// [REQ:gemSpec_eRp_FdV:A_19982#4] Opt out of analytics
Toggle(isOn: viewStore.binding(
</code></pre>
<h3 id='a_19177' class='heading'>A_19177</h3>
<h4 id='code-sources-erpapp-screens-settings-profiles-protocol-auditeventsview-swift-11-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Protocol/AuditEventsView.swift:11</code></h4>

<p>View displaying the audit events</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19177#1,A_19185#2] View displaying the audit events
// [REQ:BSI-eRp-ePA:O.Auth_5#3] View displaying the audit events
struct AuditEventsView: View {
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofileview-swift-501-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileView.swift:501</code></h4>

<p>Actual Button to open the audit events</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19177#2,A_19185#3] Actual Button to open the audit events
// [REQ:BSI-eRp-ePA:O.Auth_5#2] Actual Button to open the audit events
NavigationLinkStore(
</code></pre>
<h3 id='a_19178' class='heading'>A_19178</h3>

<p>Is covered by our MSTG.</p>
<h3 id='a_19179' class='heading'>A_19179</h3>

<p>Annotation in code</p>
<h4 id='code-sources-idp-internal-idpcrypto-swift-44-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:44</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19179#2] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:BSI-eRp-ePA:O.Cryp_3#3] Brainpool key generator
try BrainpoolP256r1.KeyExchange.generateKey()
</code></pre>
<h4 id='code-sources-idp-internal-idpcrypto-swift-54-code' class='heading'><code>../Sources/IDP/internal/IDPCrypto.swift:54</code></h4>

<p>AES key generation via CryptoKit</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:1] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#3] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
aesKey: SymmetricKey = SymmetricKey(size: SymmetricKeySize(bitCount: 256))
</code></pre>
<h4 id='code-sources-idp-internal-jwt-jwe-kdf-swift-36-code' class='heading'><code>../Sources/IDP/internal/JWT/JWE+KDF.swift:36</code></h4>

<p>Key pair generation delegated to OpenSSL</p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Cryp_3#4] Brainpool key generator
// [REQ:gemSpec_eRp_FdV:A_19179#4] Key pair generation delegated to OpenSSL
= { try BrainpoolP256r1.KeyExchange.generateKey() })
</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-100-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:100</code></h4>

<p>Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4357] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:gemSpec_Krypt:GS-A_4367] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
// [REQ:BSI-eRp-ePA:O.Cryp_3#5] Brainpool key generator
// [REQ:gemSpec_eRp_FdV:A_19179#5] Key pair generation delegated to OpenSSL with BrainpoolP256r1 parameters
let keyPairGenerator = { try BrainpoolP256r1.KeyExchange.generateKey() }
</code></pre>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-148-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:148</code></h4>

<p>AES key generation via CryptoKit</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4389:2] 256bit GCM symmetric key
// [REQ:gemSpec_eRp_FdV:A_19179#6] AES key generation via CryptoKit
// [REQ:gemSpec_Krypt:GS-A_4368] AES key generation via CryptoKit
let secretKey = SymmetricKey(data: sharedSecret)
</code></pre>
<h3 id='a_19181-01' class='heading'>A_19181-01</h3>

<p>There is an opt-in option for analytics. Full app functionality is available also without opting in. The user&rsquo;s choice is requested during onboarding and the user can opt-in and opt-out of analytics at any time. There are no further configuration choices. After successful authentication via health card the corresponding prescriptions, protocol data and messages are displayed.</p>
<h3 id='a_19182' class='heading'>A_19182</h3>

<p>In order to minimize the risk of unknown vulnerabilities in dependencies, we use different measures: We develop according to Security by Design Principles (see E-Rezept-App - SSDLC.pdf - Section Richtlinien, Vorgaben und Best Practices). We train our engineers focussing on secure design and coding best practices (see Sicherheitsschulungen.pdf). We publish our Code on Github and use a bug bounty program (<a href="https://www.gematik.de/datensicherheit">https://www.gematik.de/datensicherheit</a> -&gt; Coordinated Vulnerability Disclosure Program) </p>
<h3 id='a_19183' class='heading'>A_19183</h3>

<p>We have no implementation of any sharing mechanism of FD data. </p>
<h3 id='a_19184' class='heading'>A_19184</h3>
<h4 id='code-sources-erpapp-screens-onboarding-onboardinganalyticsview-swift-20-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingAnalyticsView.swift:20</code></h4>

<p>Information for the user what is collected</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19184] Information for the user what is collected
VStack(alignment: .leading, spacing: 16) {
</code></pre>
<h4 id='code-sources-erpapp-screens-onboarding-onboardingdomain-swift-216-code' class='heading'><code>../Sources/eRpApp/Screens/Onboarding/OnboardingDomain.swift:216</code></h4>

<p>Alert for the user to choose.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19184] Alert for the user to choose.
static let trackingAlertState: AlertState&lt;Action.Alert&gt; = {
</code></pre>
<h3 id='a_19185' class='heading'>A_19185</h3>

<p>Communication with the Fachdienst is protocoled via Audit Events. The user can revise them in the Settings menu (Profile Settings).</p>
<h4 id='code-sources-erpapp-screens-settings-profiles-protocol-auditeventsview-swift-11-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Protocol/AuditEventsView.swift:11</code></h4>

<p>View displaying the audit events</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19177#1,A_19185#2] View displaying the audit events
// [REQ:BSI-eRp-ePA:O.Auth_5#3] View displaying the audit events
struct AuditEventsView: View {
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-profiles-edit-editprofileview-swift-501-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/Profiles/Edit/EditProfileView.swift:501</code></h4>

<p>Actual Button to open the audit events</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19177#2,A_19185#3] Actual Button to open the audit events
// [REQ:BSI-eRp-ePA:O.Auth_5#2] Actual Button to open the audit events
NavigationLinkStore(
</code></pre>
<h3 id='a_19186' class='heading'>A_19186</h3>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-18-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:18</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemF_Tokenverschlüsselung:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_2#5,O.Arch_4#3,O.Source_7#2,O.Data_2#2] Implementation of data storage that is
// persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {
</code></pre>
<h3 id='a_19187' class='heading'>A_19187</h3>
<h4 id='code-sources-vauclient-vauinterceptor-swift-38-code' class='heading'><code>../Sources/VAUClient/VAUInterceptor.swift:38</code></h4>

<p>VAU Bearer must be set to trigger a request</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19187] VAU Bearer must be set to trigger a request
return vauAccessTokenProvider.vauBearerToken
</code></pre>
<h3 id='a_19188' class='heading'>A_19188</h3>

<p>session data (ACCESS_TOKEN, ID_TOKEN, SSO_TOKEN, CAN) is saved in the keychain. Its deletion is managed by the OS. The key chain is sandboxed and can only be shared with other apps by the same vendor when explicitly set. All other mentioned data is deleted.</p>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-19-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:19</code></h4>

<p>Deletion of data saved here is managed by the OS.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19186]
// [REQ:gemSpec_eRp_FdV:A_19188] Deletion of data saved here is managed by the OS.
// [REQ:gemSpec_IDP_Frontend:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemF_Tokenverschlüsselung:A_21322] Storage implementation uses iOS Keychain
// [REQ:gemSpec_IDP_Frontend:A_21595] Storage Implementation
// [REQ:BSI-eRp-ePA:O.Purp_8#1,O.Arch_2#5,O.Arch_4#3,O.Source_7#2,O.Data_2#2] Implementation of data storage that is
// persisted via keychain
class KeychainStorage: SecureUserDataStore, IDPStorage, SecureEGKCertificateStorage {
</code></pre>
<h3 id='a_19229' class='heading'>A_19229</h3>

<p>Audit events will be deleted when the referencing task is deleted. Cascading relationship &ldquo;task -&gt; audit event&rdquo; is defined in Sources/eRpLocalStorage/Prescriptions/ErxTask.xcdatamodeld/ErxTask.xcdatamodel/contents</p>
<h4 id='code-sources-erpapp-screens-main-prescriptiondetail-prescriptiondetaildomain-swift-193-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionDetail/PrescriptionDetailDomain.swift:193</code></h4>
<pre class="highlight plaintext"><code>// Delete
// [REQ:gemSpec_eRp_FdV:A_19229]
case .delete:
</code></pre>
<h4 id='code-sources-erpapp-screens-main-prescriptiondetail-prescriptiondetaildomain-swift-200-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionDetail/PrescriptionDetailDomain.swift:200</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19229]
case .destination(.presented(.alert(.confirmedDelete))):
</code></pre>
<h3 id='a_19480' class='heading'>A_19480</h3>
<h4 id='code-sources-idp-idpsession-swift-26-code' class='heading'><code>../Sources/IDP/IDPSession.swift:26</code></h4>

<p>usage of this token is limited to FD/IDP Access.</p>
<pre class="highlight plaintext"><code>/// Subscribe to the session's IDPToken and receive the latest (session) token through this Publisher
///
/// [REQ:gemSpec_eRp_FdV:A_19480] usage of this token is limited to FD/IDP Access.
var autoRefreshedToken: AnyPublisher&lt;IDPToken?, IDPError&gt; { get }
</code></pre>
<h4 id='code-sources-idp-idpstorage-swift-34-code' class='heading'><code>../Sources/IDP/IDPStorage.swift:34</code></h4>

<p>usage of this token is limited to FD/IDP Access.</p>
<pre class="highlight plaintext"><code>/// Retrieve and set an IDP Token
/// [REQ:gemSpec_eRp_FdV:A_19480] usage of this token is limited to FD/IDP Access.
var token: AnyPublisher&lt;IDPToken?, Never&gt; { get }
</code></pre>
<h3 id='a_19739' class='heading'>A_19739</h3>

<p>Implemented with ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity.NSPinnedDomains</code></p>
<h4 id='code-sources-truststore-truststoresession-swift-19-code' class='heading'><code>../Sources/TrustStore/TrustStoreSession.swift:19</code></h4>
<pre class="highlight plaintext"><code>/// Request and validate the VAU certificate
///
/// [REQ:gemSpec_eRp_FdV:A_19739]
///
/// - Returns: A publisher that emits a validated VAU certificate or an error
func loadVauCertificate() -&gt; AnyPublisher&lt;X509, TrustStoreError&gt;
</code></pre>
<h4 id='code-sources-truststore-truststoresession-swift-29-code' class='heading'><code>../Sources/TrustStore/TrustStoreSession.swift:29</code></h4>
<pre class="highlight plaintext"><code>/// Try to validate a given certificate against the underlying truststore.
/// An OCSP response will also be requested and checked against
///
/// [REQ:gemSpec_eRp_FdV:A_19739]
///
/// - Parameter certificate: the certificate to be validated
/// - Returns: A publisher that emits a Boolean stating whether or not the certificate could be validated.
func validate(certificate: X509) -&gt; AnyPublisher&lt;Bool, TrustStoreError&gt;
</code></pre>
<h3 id='a_19979' class='heading'>A_19979</h3>

<p>We use external services: The Apothekenverzeichnis and our analytics framework. During the communication with the pharmacy, there will be data shared via a prescription code. The requirement to this feature is described in gemSpec_eRp_FdV sectin 5.2.3.10 and 5.2.3.11.</p>
<h3 id='a_19980' class='heading'>A_19980</h3>

<p>The user is informed and required to accept this information via the data protection statement. Related data and services are listed in sections 5.</p>
<h4 id='code-sources-erpapp-screens-settings-dataprivacy-dataprivacyview-swift-14-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/DataPrivacy/DataPrivacyView.swift:14</code></h4>

<p>Actual View driving the display of <code>DataPrivacy.html</code></p>
<pre class="highlight plaintext"><code>// [REQ:BSI-eRp-ePA:O.Purp_1#2] Actual View driving the display of `DataPrivacy.html`
// [REQ:BSI-eRp-ePA:O.Arch_8#3] Webview containing local html without javascript
// [REQ:gemSpec_eRp_FdV:A_19980#2] Actual View driving the display of `DataPrivacy.html`
struct DataPrivacyView: View {
</code></pre>
<h3 id='a_19981' class='heading'>A_19981</h3>

<p>The user is informed and required to accept this information via the data protection statement. Related data and services are listed in sections 5.</p>
<h3 id='a_19982' class='heading'>A_19982</h3>

<p>The agreement to the use of the analytics framework can be revoked. But other agreements cannot be revoked, since the app would not operate properly.</p>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-208-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:208</code></h4>

<p>Opt out of analytics</p>
<pre class="highlight plaintext"><code>// Tracking
// [REQ:gemSpec_eRp_FdV:A_19088, A_19089, A_19092, A_19097] OptIn for usage tracking
// [REQ:BSI-eRp-ePA:O.Purp_5#2] Actual disabling of analytics
// [REQ:gemSpec_eRp_FdV:A_19982#2] Opt out of analytics
case let .toggleTrackingTapped(optIn):
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-62-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:62</code></h4>

<p>Opt out of analytics</p>
<pre class="highlight plaintext"><code>// Tracking comply sheet presentation
// [REQ:BSI-eRp-ePA:O.Purp_5#3] Show comply view for settings triggered analytics enabling
// [REQ:gemSpec_eRp_FdV:A_19982#3] Opt out of analytics
Rectangle()
</code></pre>
<h4 id='code-sources-erpapp-screens-settings-settingsview-swift-226-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsView.swift:226</code></h4>

<p>Opt out of analytics</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19097] Toggle within Settings to enable and disable usage tracking
// [REQ:BSI-eRp-ePA:O.Purp_5#1] Toggle within Settings to enable and disable usage tracking
// [REQ:BSI-eRp-ePA:O.Purp_6#1] Current Analytics state is inspectable by the user
// [REQ:gemSpec_eRp_FdV:A_19982#4] Opt out of analytics
Toggle(isOn: viewStore.binding(
</code></pre>
<h3 id='a_19983' class='heading'>A_19983</h3>

<p>All used services except our analytics framework are permitted and attested by the Gematik and under the TI monitoring. The usage of our analytics framework is not under our control, but we exclusively send data to it and receive none.</p>
<h3 id='a_19984' class='heading'>A_19984</h3>
<h4 id='code-sources-pharmacy-fhirclient-pharmacyoperation-swift-24-code' class='heading'><code>../Sources/Pharmacy/FHIRClient+PharmacyOperation.swift:24</code></h4>

<p>validate pharmacy data format conforming to FHIR</p>
<pre class="highlight plaintext"><code>/// Convenience function for searching for pharmacies
///
/// [REQ:gemSpec_eRp_FdV:A_19984] validate pharmacy data format conforming to FHIR
///
/// - Parameters:
///   - searchTerm: Search term
///   - position: Pharmacy position (latitude and longitude)
/// - Returns: `AnyPublisher` that emits a list of `PharmacyLocation`s or is empty when not found
public func searchPharmacies(by searchTerm: String,
</code></pre>
<h4 id='code-sources-erpkit-scannederxtask-swift-48-code' class='heading'><code>../Sources/eRpKit/ScannedErxTask.swift:48</code></h4>

<p>parse task id and access code</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19984] parse task id and access code
guard let taskId = taskString.match(pattern: Self.taskIdRegex) else {
</code></pre>
<h4 id='code-sources-erpkit-scannederxtask-swift-103-code' class='heading'><code>../Sources/eRpKit/ScannedErxTask.swift:103</code></h4>

<p>validate data matrix code structure</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_19984] validate data matrix code structure
// [REQ:BSI-eRp-ePA:O.Source_1#4] actual validation by decoding into predefined structure
erxToken = try jsonDecoder.decode(ErxToken.self, from: jsonData)
</code></pre>
<h4 id='code-sources-erpremotestorage-fhirclient-erxtaskoperation-swift-246-code' class='heading'><code>../Sources/eRpRemoteStorage/FHIRClient+ErxTaskOperation.swift:246</code></h4>

<p>validate pharmacy data format conforming to FHIR</p>
<pre class="highlight plaintext"><code>/// Requests all communication Resources for the logged in user
///
/// [REQ:gemSpec_eRp_FdV:A_19984] validate pharmacy data format conforming to FHIR
///
/// - Returns: Array of all loaded communication resources
/// - Parameter referenceDate: Communications with `timestamp` greater or equal `referenceDate` will be fetched
public func communicationResources(
</code></pre>
<h3 id='a_20032-01' class='heading'>A_20032-01</h3>

<p>Note: grace period for OCSP responses is 12h</p>
<h4 id='code-sources-truststore-x509truststore-swift-14-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:14</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:A_21218]
// [REQ:gemSpec_eRp_FdV:A_20032-01]
// Category A: Cross root certificates
private let rootCa: X509
</code></pre>
<h3 id='a_20033' class='heading'>A_20033</h3>

<p>Implemented with ATS within <code>Info.plist</code>, path: <code>NSAppTransportSecurity.NSPinnedDomains</code></p>
<h3 id='a_20167' class='heading'>A_20167</h3>
<h4 id='code-sources-idp-idpinterceptor-swift-61-code' class='heading'><code>../Sources/IDP/IDPInterceptor.swift:61</code></h4>

<p>no token available, bailout</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167] no token available, bailout
.authentication(error)
</code></pre>
<h4 id='code-sources-idp-idpinterceptor-swift-71-code' class='heading'><code>../Sources/IDP/IDPInterceptor.swift:71</code></h4>

<p>invalidate/delete unauthorized token</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167] invalidate/delete unauthorized token
// [REQ:BSI-eRp-ePA:O.Source_5#2] invalidate/delete unauthorized token
self.session.invalidateAccessToken()
</code></pre>
<h4 id='code-sources-erpapp-data-prescriptionrepository-swift-133-code' class='heading'><code>../Sources/eRpApp/Data/PrescriptionRepository.swift:133</code></h4>

<p>no token/not authorized, show authenticator module</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167,A_20172] no token/not authorized, show authenticator module
if Result.success(false) == isAuthenticated {
</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-redeemservice-redeemservice-swift-150-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/RedeemService/RedeemService.swift:150</code></h4>

<p>no token/not authorized, show authenticator module</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167,A_20172] no token/not authorized, show authenticator module
if Result.success(false) == authenticated {
</code></pre>
<h3 id='a_20172' class='heading'>A_20172</h3>
<h4 id='code-sources-erpapp-data-prescriptionrepository-swift-133-code' class='heading'><code>../Sources/eRpApp/Data/PrescriptionRepository.swift:133</code></h4>

<p>no token/not authorized, show authenticator module</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167,A_20172] no token/not authorized, show authenticator module
if Result.success(false) == isAuthenticated {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-swift-384-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.swift:384</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20172]
func idpChallengePublisher(for profileID: UUID) -&gt; AsyncStream&lt;CardWallReadCardDomain.Action&gt; {
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-swift-409-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.swift:409</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20172]
// [REQ:gemSpec_IDP_Frontend:A_20526-01] sign and verify with idp
func signChallengeWithNFCCard(
</code></pre>
<h4 id='code-sources-erpapp-screens-cardwall-readcard-cardwallreadcarddomain-swift-441-code' class='heading'><code>../Sources/eRpApp/Screens/CardWall/ReadCard/CardWallReadCardDomain.swift:441</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20172]
// [REQ:gemSpec_IDP_Frontend:A_20526-01] verify with idp
func verifyResultWithIDP(
</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-redeemservice-redeemservice-swift-150-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/RedeemService/RedeemService.swift:150</code></h4>

<p>no token/not authorized, show authenticator module</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20167,A_20172] no token/not authorized, show authenticator module
if Result.success(false) == authenticated {
</code></pre>
<h3 id='a_20181' class='heading'>A_20181</h3>

<p>Screen that presents the DataMatrix code for redeeming a prescription only contains some static texts and the image of the code.</p>
<h4 id='code-sources-erpapp-screens-matrixcode-matrixcodeview-swift-11-code' class='heading'><code>../Sources/eRpApp/Screens/MatrixCode/MatrixCodeView.swift:11</code></h4>

<p>Screen that presents the DataMatrix code for redeeming a prescription only contains</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20181#1] Screen that presents the DataMatrix code for redeeming a prescription only contains
//   some static texts and the image of the code.
struct MatrixCodeView: View {
</code></pre>
<h3 id='a_20182' class='heading'>A_20182</h3>

<p>No advertisement or similar is presented in the app. Assigning a prescription to an pharmacy in only possible via the app&rsquo;s pharmacy search. Pharmacy search results are only based on search term and filter criteria set by the user.</p>
<h3 id='a_20183' class='heading'>A_20183</h3>
<h4 id='code-sources-pharmacy-pharmacyfhirdatasource-swift-31-code' class='heading'><code>../Sources/Pharmacy/PharmacyFHIRDataSource.swift:31</code></h4>
<pre class="highlight plaintext"><code>/// API for requesting pharmacies with the passed search term
///
/// [REQ:gemSpec_eRp_FdV:A_20183]
///
/// - Parameter searchTerm: String that send to the server for filtering the pharmacies response
/// - Parameter position: Position (latitude and longitude) of pharmacy
/// - Parameter filter: further filter parameters for pharmacies
/// - Returns: `AnyPublisher` that emits all `PharmacyLocation`s for the given `searchTerm`
public func searchPharmacies(by searchTerm: String,
</code></pre>
<h4 id='code-sources-pharmacy-pharmacyremotedatastore-swift-22-code' class='heading'><code>../Sources/Pharmacy/PharmacyRemoteDataStore.swift:22</code></h4>
<pre class="highlight plaintext"><code>/// API for requesting pharmacies with the passed search term
///
/// [REQ:gemSpec_eRp_FdV:A_20183]
///
/// - Parameter searchTerm: String that send to the server for filtering the pharmacies response
/// - Parameter position: Position (latitude and longitude) of pharmacy
/// - Parameter filter: further filter parameters for pharmacies
/// - Returns: `AnyPublisher` that emits all `PharmacyLocation`s for the given `searchTerm`
func searchPharmacies(by searchTerm: String,
</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-search-pharmacysearchdomain-swift-215-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Search/PharmacySearchDomain.swift:215</code></h4>

<p>search results mirrored verbatim, no sorting, no highlighting</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20183] search results mirrored verbatim, no sorting, no highlighting
state.searchState = .searchRunning
</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-search-pharmacysearchmapdomain-swift-183-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Search/PharmacySearchMapDomain.swift:183</code></h4>

<p>search results mirrored verbatim, no sorting, no highlighting</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20183] search results mirrored verbatim, no sorting, no highlighting
return searchPharmacies(
</code></pre>
<h3 id='a_20184' class='heading'>A_20184</h3>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-125-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:125</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20184]
// [REQ:gemSpec_eRp_FdV:A_21328#3] KeychainStorage implementation
// [REQ:BSI-eRp-ePA:O.Tokn_1#4] KeychainStorage implementation
let success: Bool
</code></pre>
<h4 id='code-sources-erpapp-session-standardsessioncontainer-swift-90-code' class='heading'><code>../Sources/eRpApp/Session/StandardSessionContainer.swift:90</code></h4>

<p>Keychain storage encrypts session/ssl tokens</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_21328#2] Keychain storage encrypts session tokens
// [REQ:gemSpec_eRp_FdV:A_20184] Keychain storage encrypts session/ssl tokens
storage: secureUserStore,
</code></pre>
<h4 id='code-sources-erpapp-session-standardsessioncontainer-swift-108-code' class='heading'><code>../Sources/eRpApp/Session/StandardSessionContainer.swift:108</code></h4>

<p>No persistent storage for idp pairing session</p>
<pre class="highlight plaintext"><code>storage: MemoryStorage(), // [REQ:gemSpec_eRp_FdV:A_20184] No persistent storage for idp pairing session
schedulers: schedulers,
</code></pre>
<h3 id='a_20185' class='heading'>A_20185</h3>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-211-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:211</code></h4>

<p>OptOut for user</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20185,A_20187] OptOut for user
state.trackerOptIn = false
</code></pre>
<h3 id='a_20186' class='heading'>A_20186</h3>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-249-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:249</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-1#3] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
set(can: nil)
</code></pre>
<h4 id='code-sources-erpapp-session-profilesecuredatawiper-swift-40-code' class='heading'><code>../Sources/eRpApp/Session/ProfileSecureDataWiper.swift:40</code></h4>

<p>Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_IDP_Frontend:A_20499,A_20499-01#2] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_eRp_FdV:A_20186] Deletion of SSO_TOKEN, ID_TOKEN, AUTH_TOKEN
// [REQ:gemSpec_IDP_Frontend:A_21603] Certificate
storage.wipe()
</code></pre>
<h3 id='a_20187' class='heading'>A_20187</h3>
<h4 id='code-sources-erpapp-screens-settings-settingsdomain-swift-211-code' class='heading'><code>../Sources/eRpApp/Screens/Settings/SettingsDomain.swift:211</code></h4>

<p>OptOut for user</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20185,A_20187] OptOut for user
state.trackerOptIn = false
</code></pre>
<h3 id='a_20193' class='heading'>A_20193</h3>

<p>Camera is only used for scanning recipes and avatar setup. CoreLocation is used for pharmacy search. Usage is requested before actual first usage, the user is asked for permission. This is also enforced by the OS.</p>
<h3 id='a_20194' class='heading'>A_20194</h3>

<p>Camera is only used for scanning recipes and avatar setup. CoreLocation is used for pharmacy search. Usage is requested before actual first usage, the user is asked for permission. This is also enforced by the OS.</p>
<h3 id='a_20206' class='heading'>A_20206</h3>
<h4 id='code-sources-httpclient-defaulthttpclient-swift-41-code' class='heading'><code>../Sources/HTTPClient/DefaultHTTPClient.swift:41</code></h4>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4385,A_18467,A_18464,GS-A_4387]
// [REQ:gemSpec_Krypt:GS-A_5322] TODO: Check if limiting SSL Sessions is possible, check for renegotiation
// swiftlint:disable:previous todo
// [REQ:gemSpec_IDP_Frontend:A_20606] Live URLs not present in NSAppTransportSecurity exception list for allowed
// HTTP communication
// [REQ:gemSpec_eRp_FdV:A_20206]
// [REQ:BSI-eRp-ePA:O.Sess_1#2,O.Ntwk_2#2,O.Ntwk_3#2,O.Ntwk_7#2] URLSession is used as Network Framework

</code></pre>
<h3 id='a_20208' class='heading'>A_20208</h3>
<h4 id='code-sources-pharmacy-pharmacyfhiroperation-swift-14-code' class='heading'><code>../Sources/Pharmacy/PharmacyFHIROperation.swift:14</code></h4>
<pre class="highlight plaintext"><code>/// Search for pharmacies by name
/// [REQ:gemSpec_eRp_FdV:A_20208]
case searchPharmacies(searchTerm: String, position: Position?, filter: [String: String], handler: Handler)
</code></pre>
<h3 id='a_20285' class='heading'>A_20285</h3>
<h4 id='code-sources-erpapp-screens-pharmacy-search-pharmacysearchdomain-swift-225-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Search/PharmacySearchDomain.swift:225</code></h4>

<p>pharmacy order is resolved on server side</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20285] pharmacy order is resolved on server side
state.pharmacies = pharmacies.map {
</code></pre>
<h4 id='code-sources-erpapp-screens-pharmacy-search-pharmacysearchmapdomain-swift-192-code' class='heading'><code>../Sources/eRpApp/Screens/Pharmacy/Search/PharmacySearchMapDomain.swift:192</code></h4>

<p>pharmacy order is resolved on server side</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20285] pharmacy order is resolved on server side
state.pharmacies = pharmacies.map {
</code></pre>
<h3 id='a_20603' class='heading'>A_20603</h3>
<h4 id='code-sources-erpapp-screens-main-prescriptiondetail-prescriptiondetaildomain-swift-90-code' class='heading'><code>../Sources/eRpApp/Screens/Main/PrescriptionDetail/PrescriptionDetailDomain.swift:90</code></h4>

<p>Usages of matrixCodeGenerator for code generation. UserProfile is neither part of</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20603] Usages of matrixCodeGenerator for code generation. UserProfile is neither part of
// the screen nor the state.
@Dependency(\.erxMatrixCodeGenerator) var matrixCodeGenerator: ErxMatrixCodeGenerator
</code></pre>
<h4 id='code-sources-erpapp-screens-matrixcode-matrixcodedomain-swift-72-code' class='heading'><code>../Sources/eRpApp/Screens/MatrixCode/MatrixCodeDomain.swift:72</code></h4>

<p>Usages of matrixCodeGenerator for code generation. UserProfile is neither part of</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20603] Usages of matrixCodeGenerator for code generation. UserProfile is neither part of
// the screen nor the state.
@Dependency(\.erxMatrixCodeGenerator) var erxMatrixCodeGenerator: ErxMatrixCodeGenerator
</code></pre>
<h3 id='a_21324' class='heading'>A_21324</h3>

<p>Token-key and code-verifier are encoded into an JSON object.</p>
<h4 id='code-sources-idp-internal-tokenpayload-swift-140-code' class='heading'><code>../Sources/IDP/internal/TokenPayload.swift:140</code></h4>

<p>Token-key and code-verifier are encoded into KeyVerifier.</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_21324#2] Token-key and code-verifier are encoded into KeyVerifier.
public struct KeyVerifier: Codable {
</code></pre>
<h3 id='a_21325' class='heading'>A_21325</h3>

<p>AccessToken is encyrpted for each network request to the Fachdienst via VAUClient module.</p>
<h4 id='code-sources-vauclient-internal-vaucrypto-swift-84-code' class='heading'><code>../Sources/VAUClient/internal/VAUCrypto.swift:84</code></h4>

<p>Encryption of accessToken (here bearerToken)</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_21325#2] Encryption of accessToken (here bearerToken)
func encrypt() throws -&gt; Data {
</code></pre>
<h3 id='a_21326' class='heading'>A_21326</h3>

<p>ACCESS_TOKEN information is managed by IDPToken structure</p>
<h4 id='code-sources-idp-models-idptoken-swift-12-code' class='heading'><code>../Sources/IDP/Models/IDPToken.swift:12</code></h4>

<p>Structure holding ACCESS_TOKEN and ID_TOKEN information</p>
<pre class="highlight plaintext"><code>/// IDPToken
///
/// [REQ:gemSpec_eRp_FdV:A_21326#2,A_21327#2] Structure holding ACCESS_TOKEN and ID_TOKEN information
public struct IDPToken: Codable {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-99-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:99</code></h4>

<p>Triggered at every app start, profile change, pull to refresh</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_21326#3,A_21327#3] Triggered at every app start, profile change, pull to refresh
autoRefreshedToken.map { token in
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-769-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:769</code></h4>

<p>Triggered at every app start, profile change, pull to refresh</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_21326#4,A_21327#4] Triggered at every app start, profile change, pull to refresh
func refreshIfExpired(session: DefaultIDPSession,
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-781-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:781</code></h4>

<p>Either return a refreshed IDPToken</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_21326#5,A_21327#5] Either return a refreshed IDPToken
//  (or nil in case of error) to overwrite the current one
guard let session = session else {
</code></pre>
<h3 id='a_21327' class='heading'>A_21327</h3>

<p>ID_TOKEN information is managed by IDPToken structure </p>
<h4 id='code-sources-idp-models-idptoken-swift-12-code' class='heading'><code>../Sources/IDP/Models/IDPToken.swift:12</code></h4>

<p>Structure holding ACCESS_TOKEN and ID_TOKEN information</p>
<pre class="highlight plaintext"><code>/// IDPToken
///
/// [REQ:gemSpec_eRp_FdV:A_21326#2,A_21327#2] Structure holding ACCESS_TOKEN and ID_TOKEN information
public struct IDPToken: Codable {
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-99-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:99</code></h4>

<p>Triggered at every app start, profile change, pull to refresh</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_21326#3,A_21327#3] Triggered at every app start, profile change, pull to refresh
autoRefreshedToken.map { token in
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-769-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:769</code></h4>

<p>Triggered at every app start, profile change, pull to refresh</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_21326#4,A_21327#4] Triggered at every app start, profile change, pull to refresh
func refreshIfExpired(session: DefaultIDPSession,
</code></pre>
<h4 id='code-sources-idp-defaultidpsession-swift-781-code' class='heading'><code>../Sources/IDP/DefaultIDPSession.swift:781</code></h4>

<p>Either return a refreshed IDPToken</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_21326#5,A_21327#5] Either return a refreshed IDPToken
//  (or nil in case of error) to overwrite the current one
guard let session = session else {
</code></pre>
<h3 id='a_21328' class='heading'>A_21328</h3>

<p>Keychain storage encrypts session tokens.</p>
<h4 id='code-sources-erpapp-session-standardsessioncontainer-swift-89-code' class='heading'><code>../Sources/eRpApp/Session/StandardSessionContainer.swift:89</code></h4>

<p>Keychain storage encrypts session tokens</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_21328#2] Keychain storage encrypts session tokens
// [REQ:gemSpec_eRp_FdV:A_20184] Keychain storage encrypts session/ssl tokens
storage: secureUserStore,
</code></pre>
<h4 id='code-sources-erpapp-session-keychainstorage-swift-126-code' class='heading'><code>../Sources/eRpApp/Session/KeychainStorage.swift:126</code></h4>

<p>KeychainStorage implementation</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_20184]
// [REQ:gemSpec_eRp_FdV:A_21328#3] KeychainStorage implementation
// [REQ:BSI-eRp-ePA:O.Tokn_1#4] KeychainStorage implementation
let success: Bool
</code></pre>
<h3 id='a_22778' class='heading'>A_22778</h3>

<p>Encryption of message to the Pharmacy is done with/for all provided certificates/recipients.</p>
<h4 id='code-sources-avs-avscmsencrypter-swift-10-code' class='heading'><code>../Sources/AVS/AVSCmsEncrypter.swift:10</code></h4>

<p>Encryption of message to the Pharmacy is done for all provided recipients</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_22778#2] Encryption of message to the Pharmacy is done for all provided recipients
func cmsEncrypt(_ data: Data, recipients: [X509]) throws -&gt; Data
</code></pre>
<h4 id='code-sources-avs-avscmsencrypter-swift-21-code' class='heading'><code>../Sources/AVS/AVSCmsEncrypter.swift:21</code></h4>

<p>Encryption of message to the Pharmacy is done with all provided certificates</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4390] RSAES-OAEP with MGF1 implemented in sub-framework OpenSSL-swift
// [REQ:gemSpec_eRp_FdV:A_22778#3] Encryption of message to the Pharmacy is done with all provided certificates
// [REQ:gemSpec_eRp_FdV:A_22779#3] Encrypted message is of form of a PKCS#7 container (CMS)
// https://github.com/gematik/OpenSSL-Swift/blob/3c1ea91ba5abfefecfe3588815cb928d777e29ad/Sources/OpenSSL/CMS/CMSContentInfo.swift#L88
// swiftlint:disable:previous line_length
let cms = try CMSContentInfo.encryptPartial(data: data)
</code></pre>
<h3 id='a_22779' class='heading'>A_22779</h3>

<p>Encrypted message is of form of a PKCS#7 container (CMS)</p>
<h4 id='code-sources-avs-avsmessageconverter-swift-32-code' class='heading'><code>../Sources/AVS/AVSMessageConverter.swift:32</code></h4>

<p>Encrypted message is of form of a PKCS#7 container (CMS)</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_eRp_FdV:A_22779#2] Encrypted message is of form of a PKCS#7 container (CMS)
// 1. Create a CMS AuthenticatedEnvelopedData structure with help from OpenSSL-swift
let cmsAuthEnvelopedData = try avsCmsEncrypter.cmsEncrypt(data, recipients: recipients)
</code></pre>
<h4 id='code-sources-avs-avscmsencrypter-swift-22-code' class='heading'><code>../Sources/AVS/AVSCmsEncrypter.swift:22</code></h4>

<p>Encrypted message is of form of a PKCS#7 container (CMS)</p>
<pre class="highlight plaintext"><code>// [REQ:gemSpec_Krypt:GS-A_4390] RSAES-OAEP with MGF1 implemented in sub-framework OpenSSL-swift
// [REQ:gemSpec_eRp_FdV:A_22778#3] Encryption of message to the Pharmacy is done with all provided certificates
// [REQ:gemSpec_eRp_FdV:A_22779#3] Encrypted message is of form of a PKCS#7 container (CMS)
// https://github.com/gematik/OpenSSL-Swift/blob/3c1ea91ba5abfefecfe3588815cb928d777e29ad/Sources/OpenSSL/CMS/CMSContentInfo.swift#L88
// swiftlint:disable:previous line_length
let cms = try CMSContentInfo.encryptPartial(data: data)
</code></pre>
<h2 id='gemspec_erp_fdv' class='heading'>gemSpec_eRp_Fdv</h2>
<h3 id='a_20032-01' class='heading'>A_20032-01</h3>
<h4 id='code-sources-truststore-x509truststore-swift-106-code' class='heading'><code>../Sources/TrustStore/X509TrustStore.swift:106</code></h4>
<pre class="highlight plaintext"><code>/// Match a collection of `OCSPResponse`s with the end entity certificates of this `X509TrustStore`.
/// Checks response status, revocation status for each certificate and validates the signer certificates of
///   the responses itself.
///
/// [REQ:gemSpec_Krypt:A_21218]
/// [REQ:gemSpec_eRp_Fdv:A_20032-01]
///
/// - Note: This function assumes that up-to-dateness of the responses itself has already been checked.
///
/// - Returns: true on successful matching/validation, false if not successful or error
func checkEeCertificatesStatus(with ocspResponses: [OCSPResponse]) throws -&gt; Bool {
</code></pre>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>&copy; 2024 <a class="link" href="https://www.gematik.de" target="_blank" rel="external noopener">gematik GmbH</a>. All rights reserved. (Last updated: 2024-03-20)</p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external noopener">jazzy ♪♫ v0.14.3</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external noopener">Realm</a> project.</p>
    </section>
  </body>
</html>
