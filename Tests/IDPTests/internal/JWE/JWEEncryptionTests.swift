//
//  Copyright (c) 2024 gematik GmbH
//  
//  Licensed under the EUPL, Version 1.2 or â€“ as soon they will be approved by
//  the European Commission - subsequent versions of the EUPL (the Licence);
//  You may not use this work except in compliance with the Licence.
//  You may obtain a copy of the Licence at:
//  
//      https://joinup.ec.europa.eu/software/page/eupl
//  
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the Licence is distributed on an "AS IS" basis,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the Licence for the specific language governing permissions and
//  limitations under the Licence.
//  
//

import Combine
import CryptoKit
import DataKit
import Foundation
@testable import IDP
import Nimble
import OpenSSL
import XCTest

class JWEEncryptionTests: XCTestCase {
    func testEncryption() throws {
        let ephemeralPublic = try BrainpoolP256r1.KeyExchange
            .PublicKey(
                x962: Data(
                    hex: "044178088a425736b88f3a6ab2b7f7e6238c34b1a52c56ce41f53aa61b5f4d98e134bfa20462a67538b5aa530e717f615d0993cfc44ea79619f5d118110edf9241"
                )
            )

        let expectedJWE =
            "eyJhbGciOiJFQ0RILUVTIiwiY3R5IjoiSldUIiwiZW5jIjoiQTI1NkdDTSIsImVwayI6eyJjcnYiOiJCUC0yNTYiLCJrdHkiOiJFQyIsIngiOiJRWGdJaWtKWE5yaVBPbXF5dF9mbUk0dzBzYVVzVnM1QjlUcW1HMTlObU9FIiwieSI6Ik5MLWlCR0ttZFRpMXFsTU9jWDloWFFtVHo4Uk9wNVlaOWRFWUVRN2Zra0UifX0..OX_3DCbccZztqyLd.f9nzQOA6JmZTAN-bRmuHCs_9zdcpmqfPXyJcNWEaFryFwFFhMdEt1Wwkftcy_H6HmxIQUFdYZbJjvSZwo-7umibRKBKcWVfYhnVMEZkz_a__amaQAfsZnNXcU-8FBBZwJe2q83jSofBSTF53zWc6d03INbINZ8lqpfdbu-V6dzAUIUvd7eLT8_n3QtmZX430Rma8PAYJ_qy_UCz9ifXpch7x8Lbq3nYksigUhM2dFXnQxUagvvWpP11pR1Fn2fmcikAgEf3UMji8a0fCRpn4diHFGwko2uty3UDnnG6Ljl37WKYWVyOZmoM5TC5NzupaAkA78V0GarjwsEWlQSWWkYZ2J0H0y-LcQAQwGW57d2liD92w25tc1_IxcO3gxofDrCRqAnj-xuGU8-TjAESBPSofthGFx3w4uWU4bkXB64aId223EmUUHHz2FEuZZ2QMkitZTumhDEGJY0Y_-uhTXR8uxQf26VPTYITqU2zszJd48U6qib9zPdbKDAbYRo-Pfj-Id8awDEj0uvHtBaDlSXQKP6COdGJucX3SdimRuilf30GgFT7Zr6Up7Kac1l8Hg8se7qniZ1M0e890Fc3cZpf3dhv5Qz3DULrsiKrYn6EUo-fPIUXr7NQ1rVuUmhegQNmmBl6kBg1xMDi4p1iuIvYfeWtATCaKuD1IU3OhyvVgvKod8nA6OUh8IDSc1KQh_eJDWkGW2GHzX2zb9Wmi_HJrg9dSHCO2fm_LNchHABHF0DfnufFeKqxShNlQp7hbTutcsMGGWVIcM9ns7iyV07VP20LKQ18X-mFUSGO3om3w0WByghFH6UBlNAsBy9fCboSCUdTTlBiCD3BIa5ZGEr3dHVbcn55yziwkL_4Og6UrDACOM23RMAZr-qz4W8zYr3qGE892i2WJXJMz2-TAd4jOAs_9A2oS8qitLsd3zTYheXSCI_aZrbfsfy5bpiNKSC-wijICe7mgPvDbbwHlnXH6Av1FrdKzn9EkAaYaxWWkl1DStUI5QIUTO6CzjCRTnk5YklkUwHzj_7dO-jcn84Wsr8GCXoU4WaXlMHRTNqYtHbIfhDgRyW7v5zzQKTOgKbCU16gY1sX9bgVgVCIvWxDOpLmhOWnvGy0Pa9gBI7aYSnE9uVoCy3nO3be8FAAph86oKhULzCqBh7-FwzX1NcXCCcqRLdowJGnyuQlf55imkb7eVCvphvMjhAYNJqiVHJ6zfGhaCkq7FD_pLwmKKFSsnWy_0FtA6Nn4op1IBg9UJ6JHAbJQmZsvDfFO7jrOmeCDHfToHb3OCYBBv02Hyz6JOPdYH0AbfqB6JlU8NAo8k0CxK385iZCf8vuTuhv8gLa6Ry-koSG4dWNl-zkxdcdWGg59c9-QPY7EOqDPHNSmNPMDUPlx0bIxWjk_utuFRE7E4c0QnuDIc-9TfC3eySYHTa6CrFkcIj4dvEUi2BxAvJunqNa2sxDWUt62jIHR5CeIuSdOltUNsndo9GKKuqq5sA3lEqrZP6LOnHQxW6qCEVNtDtYBL01mxScEGLEQFklliPSIPODO5EtL7Lf-B-q7XQUUeMY4Ot4Ukq3UhmYxaU1qDwLob8bmT0zjPiCqUtZDOf_IZOLVmwcu_HGA9jV7dkVwNPk4DRMFWakMKNTgqA5HeAZ_jaFHwHbxrqsqcfrmDFTFHtv_zFrA17S5NGOL4b8ge06P4h5Xx-VAwu6Jtn_Uo80bz_5ffwcGfosUJqOSyL1td_xoqGz9l4HJxByaxRBBUBirNgbBnvpaL6KGZICzvFx1CLKy2_aCWFfm29cB8BmLzD1jZe2QPIuCE6KG6XpugYiLyHqcaLxBmbCzi5w_xiKbSzSZ0BJ7XROBTzIvaliAdA_aKymH6DlaL6rVfoHQ2_bMksOX1CLyWDtl6Q9cw6muTnkbMNQoE5hAXuc9cetdVUsxpjAe2TTDJS_pJ3jD9SaQLu-km0mWleB_W_Q9wtfFx114gD6tNTLZzSNsudD-s9hAoDZUQygDhv7DY7ajHgKQmQnmVsXLvsMO3X11rZOiWAI775f0YGQqWlQpBTrJDxLgHcgPR6hFZ8hBwjRZ9mkiP9oHW5OwvCunE4FWrZ10qt6KBZREY9TFewrrOH3YXv3uD8uvecUZysOGZHOoJIX8MS5Fu9OuIN6oUk-GH-JaHC0KznK9UqMhLC2cq2DjHy1abrKds8Km7TxrK9hprjDtJBTgq9TCPWkshh-npsEVKgapSLC-MeObpfjpeP5yNlmHe9c39hRCRSC_bUJuqB34G3Ouf18Eioo5tW9IsWcR4Uh6_9uNFogmPG4jR_rGNkpFVaJPx2hHuMJ2GDTO3NeqfUMSPJ_uOewn8u8ZaE6xvmubt5Wa5s80IpZj-BxXnvoDj4TKW9Ba-H52cPdV_ciWDsLsS0k59cVQNQ0lkvpxRjcSgRgq4MHMJF0vpc5qEg3lZikCmIUZBmcehJjFjB0Uzmi6cVD9IRJuu7ZYbQVMhjr-l8UwXv2u2WrURtJEYnBEwNmOwoMc4j1N8NIb7WSZkOE33Fw9zrBSEFFeW7Rj_-x76nbbaCqZAPB6RBf3jC_J2Bveq0MBx3OdVwY-vvsKu7iQrdLRfLB-YhXtOFbx9oWHSBl1QC1X-6Z0pvt2BBOUnqldTlf-0Ro8SaZAyxJ0iYe577R14esQAP6W2fP_M6awKJAVUCNU8WxEfkbH2OLfbYRxjwewSToTzvVZIKLR_B3gLuDfFc2I0-ONVEq63JIbKlwWIye7hGe3HWUZ-802GFAx3GtThA_5Pe3AoIXaIoVzJA4ozJ5HQ7i4lBXNyCwdx-DmMh2e2t2pa6mV5YeTr7mh5DUw_kB4okp0rwvQ33aN69An83QQFTzcmon13fRiVVBvmKceO6TyikVfZkYuT4gB3l45CWzLKSElPtwg3uIRkEq7ujqT0NbbEnWVZ544BCaANyLN-8gTeE8ZDiiQAU9dsCx54vpFoSQatHVZfS2cZv4Hiy7reR-Ub7x-dJ5mLIx1GHBAByxYJxlEcx-dpg24AaJsbD-qeFd5Pytf8V3lG0e2oby-73jCocoY-SdL_z5KBeZdqUTsZJkY3Q9RSuFnvYkSGGZup5tDG1_o_P1QNKzH_HKsV0YOkEOiaitnHUAKW-VC0BWsR8eaml_tecYXOfu94h_uR0ghEDkcazUb8y0Ci1mblvIZKRR6VuE9bSX9iUMa4-LpQ70WAG5sgTeR1m5uhz6msgO2UuQWaNUf_Ko05RoHXZbil7JaMD8s3X0IL9hNEQJHMp2bFOqzkHwtgk6jmjAXJORduex4fFvzZh4sIhmCdsCcC5JOWxAfEkAfapbs0MCba1-hvl5IdrK9oW-Gx-Rn4a8-uXkZc25xO_GUebEqMjnryY_Z5sfa-9YXCwj_QClauF-wk2dGQ2xA4DLLiLNeMQMh9RcbuEIln8JNQlO8DfEhfqlgNSGAuA.9oh_CP5r8zSlyZJ5jDjZFA"

        let header =
            try "eyJhbGciOiJFQ0RILUVTIiwiY3R5IjoiSldUIiwiZW5jIjoiQTI1NkdDTSIsImVwayI6eyJjcnYiOiJCUC0yNTYiLCJrdHkiOiJFQyIsIngiOiJRWGdJaWtKWE5yaVBPbXF5dF9mbUk0dzBzYVVzVnM1QjlUcW1HMTlObU9FIiwieSI6Ik5MLWlCR0ttZFRpMXFsTU9jWDloWFFtVHo4Uk9wNVlaOWRFWUVRN2Zra0UifX0="
                .decodeBase64URLEncoded()
        let wrappedKey = try "".decodeBase64URLEncoded()
        let ciphertext =
            try "f9nzQOA6JmZTAN-bRmuHCs_9zdcpmqfPXyJcNWEaFryFwFFhMdEt1Wwkftcy_H6HmxIQUFdYZbJjvSZwo-7umibRKBKcWVfYhnVMEZkz_a__amaQAfsZnNXcU-8FBBZwJe2q83jSofBSTF53zWc6d03INbINZ8lqpfdbu-V6dzAUIUvd7eLT8_n3QtmZX430Rma8PAYJ_qy_UCz9ifXpch7x8Lbq3nYksigUhM2dFXnQxUagvvWpP11pR1Fn2fmcikAgEf3UMji8a0fCRpn4diHFGwko2uty3UDnnG6Ljl37WKYWVyOZmoM5TC5NzupaAkA78V0GarjwsEWlQSWWkYZ2J0H0y-LcQAQwGW57d2liD92w25tc1_IxcO3gxofDrCRqAnj-xuGU8-TjAESBPSofthGFx3w4uWU4bkXB64aId223EmUUHHz2FEuZZ2QMkitZTumhDEGJY0Y_-uhTXR8uxQf26VPTYITqU2zszJd48U6qib9zPdbKDAbYRo-Pfj-Id8awDEj0uvHtBaDlSXQKP6COdGJucX3SdimRuilf30GgFT7Zr6Up7Kac1l8Hg8se7qniZ1M0e890Fc3cZpf3dhv5Qz3DULrsiKrYn6EUo-fPIUXr7NQ1rVuUmhegQNmmBl6kBg1xMDi4p1iuIvYfeWtATCaKuD1IU3OhyvVgvKod8nA6OUh8IDSc1KQh_eJDWkGW2GHzX2zb9Wmi_HJrg9dSHCO2fm_LNchHABHF0DfnufFeKqxShNlQp7hbTutcsMGGWVIcM9ns7iyV07VP20LKQ18X-mFUSGO3om3w0WByghFH6UBlNAsBy9fCboSCUdTTlBiCD3BIa5ZGEr3dHVbcn55yziwkL_4Og6UrDACOM23RMAZr-qz4W8zYr3qGE892i2WJXJMz2-TAd4jOAs_9A2oS8qitLsd3zTYheXSCI_aZrbfsfy5bpiNKSC-wijICe7mgPvDbbwHlnXH6Av1FrdKzn9EkAaYaxWWkl1DStUI5QIUTO6CzjCRTnk5YklkUwHzj_7dO-jcn84Wsr8GCXoU4WaXlMHRTNqYtHbIfhDgRyW7v5zzQKTOgKbCU16gY1sX9bgVgVCIvWxDOpLmhOWnvGy0Pa9gBI7aYSnE9uVoCy3nO3be8FAAph86oKhULzCqBh7-FwzX1NcXCCcqRLdowJGnyuQlf55imkb7eVCvphvMjhAYNJqiVHJ6zfGhaCkq7FD_pLwmKKFSsnWy_0FtA6Nn4op1IBg9UJ6JHAbJQmZsvDfFO7jrOmeCDHfToHb3OCYBBv02Hyz6JOPdYH0AbfqB6JlU8NAo8k0CxK385iZCf8vuTuhv8gLa6Ry-koSG4dWNl-zkxdcdWGg59c9-QPY7EOqDPHNSmNPMDUPlx0bIxWjk_utuFRE7E4c0QnuDIc-9TfC3eySYHTa6CrFkcIj4dvEUi2BxAvJunqNa2sxDWUt62jIHR5CeIuSdOltUNsndo9GKKuqq5sA3lEqrZP6LOnHQxW6qCEVNtDtYBL01mxScEGLEQFklliPSIPODO5EtL7Lf-B-q7XQUUeMY4Ot4Ukq3UhmYxaU1qDwLob8bmT0zjPiCqUtZDOf_IZOLVmwcu_HGA9jV7dkVwNPk4DRMFWakMKNTgqA5HeAZ_jaFHwHbxrqsqcfrmDFTFHtv_zFrA17S5NGOL4b8ge06P4h5Xx-VAwu6Jtn_Uo80bz_5ffwcGfosUJqOSyL1td_xoqGz9l4HJxByaxRBBUBirNgbBnvpaL6KGZICzvFx1CLKy2_aCWFfm29cB8BmLzD1jZe2QPIuCE6KG6XpugYiLyHqcaLxBmbCzi5w_xiKbSzSZ0BJ7XROBTzIvaliAdA_aKymH6DlaL6rVfoHQ2_bMksOX1CLyWDtl6Q9cw6muTnkbMNQoE5hAXuc9cetdVUsxpjAe2TTDJS_pJ3jD9SaQLu-km0mWleB_W_Q9wtfFx114gD6tNTLZzSNsudD-s9hAoDZUQygDhv7DY7ajHgKQmQnmVsXLvsMO3X11rZOiWAI775f0YGQqWlQpBTrJDxLgHcgPR6hFZ8hBwjRZ9mkiP9oHW5OwvCunE4FWrZ10qt6KBZREY9TFewrrOH3YXv3uD8uvecUZysOGZHOoJIX8MS5Fu9OuIN6oUk-GH-JaHC0KznK9UqMhLC2cq2DjHy1abrKds8Km7TxrK9hprjDtJBTgq9TCPWkshh-npsEVKgapSLC-MeObpfjpeP5yNlmHe9c39hRCRSC_bUJuqB34G3Ouf18Eioo5tW9IsWcR4Uh6_9uNFogmPG4jR_rGNkpFVaJPx2hHuMJ2GDTO3NeqfUMSPJ_uOewn8u8ZaE6xvmubt5Wa5s80IpZj-BxXnvoDj4TKW9Ba-H52cPdV_ciWDsLsS0k59cVQNQ0lkvpxRjcSgRgq4MHMJF0vpc5qEg3lZikCmIUZBmcehJjFjB0Uzmi6cVD9IRJuu7ZYbQVMhjr-l8UwXv2u2WrURtJEYnBEwNmOwoMc4j1N8NIb7WSZkOE33Fw9zrBSEFFeW7Rj_-x76nbbaCqZAPB6RBf3jC_J2Bveq0MBx3OdVwY-vvsKu7iQrdLRfLB-YhXtOFbx9oWHSBl1QC1X-6Z0pvt2BBOUnqldTlf-0Ro8SaZAyxJ0iYe577R14esQAP6W2fP_M6awKJAVUCNU8WxEfkbH2OLfbYRxjwewSToTzvVZIKLR_B3gLuDfFc2I0-ONVEq63JIbKlwWIye7hGe3HWUZ-802GFAx3GtThA_5Pe3AoIXaIoVzJA4ozJ5HQ7i4lBXNyCwdx-DmMh2e2t2pa6mV5YeTr7mh5DUw_kB4okp0rwvQ33aN69An83QQFTzcmon13fRiVVBvmKceO6TyikVfZkYuT4gB3l45CWzLKSElPtwg3uIRkEq7ujqT0NbbEnWVZ544BCaANyLN-8gTeE8ZDiiQAU9dsCx54vpFoSQatHVZfS2cZv4Hiy7reR-Ub7x-dJ5mLIx1GHBAByxYJxlEcx-dpg24AaJsbD-qeFd5Pytf8V3lG0e2oby-73jCocoY-SdL_z5KBeZdqUTsZJkY3Q9RSuFnvYkSGGZup5tDG1_o_P1QNKzH_HKsV0YOkEOiaitnHUAKW-VC0BWsR8eaml_tecYXOfu94h_uR0ghEDkcazUb8y0Ci1mblvIZKRR6VuE9bSX9iUMa4-LpQ70WAG5sgTeR1m5uhz6msgO2UuQWaNUf_Ko05RoHXZbil7JaMD8s3X0IL9hNEQJHMp2bFOqzkHwtgk6jmjAXJORduex4fFvzZh4sIhmCdsCcC5JOWxAfEkAfapbs0MCba1-hvl5IdrK9oW-Gx-Rn4a8-uXkZc25xO_GUebEqMjnryY_Z5sfa-9YXCwj_QClauF-wk2dGQ2xA4DLLiLNeMQMh9RcbuEIln8JNQlO8DfEhfqlgNSGAuA"
                .decodeBase64URLEncoded()
        let iv = try "OX_3DCbccZztqyLd".decodeBase64URLEncoded()
        let tag = try "9oh/CP5r8zSlyZJ5jDjZFA==".decodeBase64URLEncoded()

        // decrypted ciphertext
        let payload =
            "eyJhbGciOiJCUDI1NlIxIiwidHlwIjoiSldUIiwiY3R5IjoiTkpXVCIsIng1YyI6WyJNSUlDK2pDQ0FxQ2dBd0lCQWdJSEF3QVRhbGRmVlRBS0JnZ3Foa2pPUFFRREFqQ0JsakVMTUFrR0ExVUVCaE1DUkVVeEh6QWRCZ05WQkFvTUZtZGxiV0YwYVdzZ1IyMWlTQ0JPVDFRdFZrRk1TVVF4UlRCREJnTlZCQXNNUEVWc1pXdDBjbTl1YVhOamFHVWdSMlZ6ZFc1a2FHVnBkSE5yWVhKMFpTMURRU0JrWlhJZ1ZHVnNaVzFoZEdscmFXNW1jbUZ6ZEhKMWEzUjFjakVmTUIwR0ExVUVBd3dXUjBWTkxrVkhTeTFEUVRFd0lGUkZVMVF0VDA1TVdUQWVGdzB4T1RBME1EZ3lNakF3TURCYUZ3MHlOREEwTURneU1UVTVOVGxhTUgweEN6QUpCZ05WQkFZVEFrUkZNUkV3RHdZRFZRUUtEQWhCVDBzZ1VHeDFjekVTTUJBR0ExVUVDd3dKTVRBNU5UQXdPVFk1TVJNd0VRWURWUVFMREFwWU1URTBOREk0TlRNd01RNHdEQVlEVlFRRURBVkdkV05vY3pFTk1Bc0dBMVVFS2d3RVNuVnVZVEVUTUJFR0ExVUVBd3dLU25WdVlTQkdkV05vY3pCYU1CUUdCeXFHU000OUFnRUdDU3NrQXdNQ0NBRUJCd05DQUFSMU5kcnJJOG9LTWl2MHh0VVhGNW9zUzd6YkZJS3hHdC9Cd2lzdWtXb0VLNUdzSjFjQ3lHRXBDSDBzczhKdkQ0T0FISlM4SU1tMS9yTTU5amxpUysxT280SHZNSUhzTUIwR0ExVWREZ1FXQkJTY0VaNUgxVXhTTWhQc09jV1poRzhaUWVXaHZUQU1CZ05WSFJNQkFmOEVBakFBTURBR0JTc2tDQU1EQkNjd0pUQWpNQ0V3SHpBZE1CQU1EbFpsY25OcFkyaGxjblJsTHkxeU1Ba0dCeXFDRkFCTUJERXdId1lEVlIwakJCZ3dGb0FVUkxGTUFWaFVIdHpaTjc3a3NqOHFicVJjaVIwd0lBWURWUjBnQkJrd0Z6QUtCZ2dxZ2hRQVRBU0JJekFKQmdjcWdoUUFUQVJHTUE0R0ExVWREd0VCL3dRRUF3SUhnREE0QmdnckJnRUZCUWNCQVFRc01Db3dLQVlJS3dZQkJRVUhNQUdHSEdoMGRIQTZMeTlsYUdOaExtZGxiV0YwYVdzdVpHVXZiMk56Y0M4d0NnWUlLb1pJemowRUF3SURTQUF3UlFJaEFJUEljYkdqSlF4dVVHYkptQlVpbVd2YlVpN20rU3VYWUJjUkdGeVowaklKQWlBbTFJV0lmdi9nTmMvV213NFpPKzczMFE5QzVkY2NGbk1qbXZiSmU3aTc1Zz09Il19.eyJuand0IjoiZXlKaGJHY2lPaUpDVURJMU5sSXhJaXdpZEhsd0lqb2lTbGRVSWl3aWEybGtJam9pY0hWclgybGtjRjl6YVdjaWZRLmV5SnBjM01pT2lKb2RIUndjem92TDJsa2NDNTZaVzUwY21Gc0xtbGtjQzV6Y0d4cGRHUnVjeTUwYVMxa2FXVnVjM1JsTG1SbElpd2ljbVZ6Y0c5dWMyVmZkSGx3WlNJNkltTnZaR1VpTENKemJtTWlPaUp4UTFSbWJVb3dOWGhSU1RWVWMzWnJVV3RKVkV3eFpsSnlVVVJoZG5oQ1ZsUjNWVzFPTUhCQ1FYUjNJaXdpWTI5a1pWOWphR0ZzYkdWdVoyVmZiV1YwYUc5a0lqb2lVekkxTmlJc0luUnZhMlZ1WDNSNWNHVWlPaUpqYUdGc2JHVnVaMlVpTENKdWIyNWpaU0k2SW1sbFFtczRhMUJsVEdad01tSTJjMEZaVGxKaklpd2lZMnhwWlc1MFgybGtJam9pWlZKbGVtVndkRUZ3Y0NJc0luTmpiM0JsSWpvaWIzQmxibWxrSUdVdGNtVjZaWEIwSWl3aWMzUmhkR1VpT2lKbVNVbDJlbW8zZVZadlpGb3diekZNWVRVeFZDSXNJbkpsWkdseVpXTjBYM1Z5YVNJNkltaDBkSEE2THk5eVpXUnBjbVZqZEM1blpXMWhkR2xyTG1SbEwyVnlaWHBsY0hRaUxDSmxlSEFpT2pFMk1UWTBNVFkzTmpZc0ltbGhkQ0k2TVRZeE5qUXhOalU0Tml3aVkyOWtaVjlqYUdGc2JHVnVaMlVpT2lJeU9HUkhNWFJKVG13eU1GaERjWGxMYkhWRGVWSmxlWGRMWVVRd09UVnBlRjlEWWpCSFQzZDVlbVpqSWl3aWFuUnBJam9pWXpVeU5UYzNOMlkyWmpkaE16UTBNeUo5LmpaUzc2V09NeEIwT0swd29QelFNcWp3Zm9FWk1FcEY1MVBhelFscFhpa0NuZW9kUHZKQVNmdkQ4ODhYRkhuVVY3bVFFQkZrZ056N25NMjhkQ0NYeHdBIn0.IbbCIWFrKpE0L25c8Q-X7h2cr_njnNNKSY_RBSbw9k536p0GE2dDwIDdaNHpduX-T_TXy40DeaewLHtnaTTChg"
                .data(using: .utf8)!

        let aesKey = try Data(hex: "D624C6F81B44CE7D26E98841BEB79652E9DEC79DFD8E2E6F6E706A105D37EC87")
        let symmetricKey = SymmetricKey(data: aesKey)
        let jwk = try JWK.from(brainpoolP256r1: ephemeralPublic)
        let encryptionContext = JWE.EncryptionContext(symmetricKey: symmetricKey, ephemeralPublicKey: jwk)
        let jweHeader = JWE.Header(encryptionContext: encryptionContext,
                                   alg: "ECDH-ES",
                                   encryption: .a256gcm,
                                   contentType: "JWT")

        let sut = try JWE.Encryption.a256gcm.encrypt(payload: payload,
                                                     header: jweHeader,
                                                     nonceGenerator: { iv })

        let completeJWE = sut.encoded().utf8string

        XCTAssertEqual(completeJWE, expectedJWE)

        XCTAssertEqual(sut.header, header)
        XCTAssertEqual(sut.wrappedKey, wrappedKey)
        XCTAssertEqual(sut.iv, iv)
        XCTAssertEqual(sut.ciphertext, ciphertext)
        XCTAssertEqual(sut.tag, tag)

        let decrypted = try JWE.Decryption.a256gcm(symmetricKey).decrypt(jwe: sut)

        XCTAssertEqual(decrypted, payload)
    }

    func testDecryption() throws {
        let header =
            try "eyJlbmMiOiJBMjU2R0NNIiwiZXBrIjp7InkiOiJOTC1pQkdLbWRUaTFxbE1PY1g5aFhRbVR6OFJPcDVZWjlkRVlFUTdma2tFIiwieCI6IlFYZ0lpa0pYTnJpUE9tcXl0X2ZtSTR3MHNhVXNWczVCOVRxbUcxOU5tT0UiLCJrdHkiOiJFQyIsImNydiI6IkJQLTI1NiJ9LCJjdHkiOiJKV1QiLCJhbGciOiJFQ0RILUVTIn0"
                .decodeBase64URLEncoded()
        let wrappedKey = try "".decodeBase64URLEncoded()
        let ciphertext =
            try "f9nzQOA6JmZTAN-bRmuHCs_9zdcpmqfPXyJcNWEaFryFwFFhMdEt1Wwkftcy_H6HmxIQUFdYZbJjvSZwo-7umibRKBKcWVfYhnVMEZkz_a__amaQAfsZnNXcU-8FBBZwJe2q83jSofBSTF53zWc6d03INbINZ8lqpfdbu-V6dzAUIUvd7eLT8_n3QtmZX430Rma8PAYJ_qy_UCz9ifXpch7x8Lbq3nYksigUhM2dFXnQxUagvvWpP11pR1Fn2fmcikAgEf3UMji8a0fCRpn4diHFGwko2uty3UDnnG6Ljl37WKYWVyOZmoM5TC5NzupaAkA78V0GarjwsEWlQSWWkYZ2J0H0y-LcQAQwGW57d2liD92w25tc1_IxcO3gxofDrCRqAnj-xuGU8-TjAESBPSofthGFx3w4uWU4bkXB64aId223EmUUHHz2FEuZZ2QMkitZTumhDEGJY0Y_-uhTXR8uxQf26VPTYITqU2zszJd48U6qib9zPdbKDAbYRo-Pfj-Id8awDEj0uvHtBaDlSXQKP6COdGJucX3SdimRuilf30GgFT7Zr6Up7Kac1l8Hg8se7qniZ1M0e890Fc3cZpf3dhv5Qz3DULrsiKrYn6EUo-fPIUXr7NQ1rVuUmhegQNmmBl6kBg1xMDi4p1iuIvYfeWtATCaKuD1IU3OhyvVgvKod8nA6OUh8IDSc1KQh_eJDWkGW2GHzX2zb9Wmi_HJrg9dSHCO2fm_LNchHABHF0DfnufFeKqxShNlQp7hbTutcsMGGWVIcM9ns7iyV07VP20LKQ18X-mFUSGO3om3w0WByghFH6UBlNAsBy9fCboSCUdTTlBiCD3BIa5ZGEr3dHVbcn55yziwkL_4Og6UrDACOM23RMAZr-qz4W8zYr3qGE892i2WJXJMz2-TAd4jOAs_9A2oS8qitLsd3zTYheXSCI_aZrbfsfy5bpiNKSC-wijICe7mgPvDbbwHlnXH6Av1FrdKzn9EkAaYaxWWkl1DStUI5QIUTO6CzjCRTnk5YklkUwHzj_7dO-jcn84Wsr8GCXoU4WaXlMHRTNqYtHbIfhDgRyW7v5zzQKTOgKbCU16gY1sX9bgVgVCIvWxDOpLmhOWnvGy0Pa9gBI7aYSnE9uVoCy3nO3be8FAAph86oKhULzCqBh7-FwzX1NcXCCcqRLdowJGnyuQlf55imkb7eVCvphvMjhAYNJqiVHJ6zfGhaCkq7FD_pLwmKKFSsnWy_0FtA6Nn4op1IBg9UJ6JHAbJQmZsvDfFO7jrOmeCDHfToHb3OCYBBv02Hyz6JOPdYH0AbfqB6JlU8NAo8k0CxK385iZCf8vuTuhv8gLa6Ry-koSG4dWNl-zkxdcdWGg59c9-QPY7EOqDPHNSmNPMDUPlx0bIxWjk_utuFRE7E4c0QnuDIc-9TfC3eySYHTa6CrFkcIj4dvEUi2BxAvJunqNa2sxDWUt62jIHR5CeIuSdOltUNsndo9GKKuqq5sA3lEqrZP6LOnHQxW6qCEVNtDtYBL01mxScEGLEQFklliPSIPODO5EtL7Lf-B-q7XQUUeMY4Ot4Ukq3UhmYxaU1qDwLob8bmT0zjPiCqUtZDOf_IZOLVmwcu_HGA9jV7dkVwNPk4DRMFWakMKNTgqA5HeAZ_jaFHwHbxrqsqcfrmDFTFHtv_zFrA17S5NGOL4b8ge06P4h5Xx-VAwu6Jtn_Uo80bz_5ffwcGfosUJqOSyL1td_xoqGz9l4HJxByaxRBBUBirNgbBnvpaL6KGZICzvFx1CLKy2_aCWFfm29cB8BmLzD1jZe2QPIuCE6KG6XpugYiLyHqcaLxBmbCzi5w_xiKbSzSZ0BJ7XROBTzIvaliAdA_aKymH6DlaL6rVfoHQ2_bMksOX1CLyWDtl6Q9cw6muTnkbMNQoE5hAXuc9cetdVUsxpjAe2TTDJS_pJ3jD9SaQLu-km0mWleB_W_Q9wtfFx114gD6tNTLZzSNsudD-s9hAoDZUQygDhv7DY7ajHgKQmQnmVsXLvsMO3X11rZOiWAI775f0YGQqWlQpBTrJDxLgHcgPR6hFZ8hBwjRZ9mkiP9oHW5OwvCunE4FWrZ10qt6KBZREY9TFewrrOH3YXv3uD8uvecUZysOGZHOoJIX8MS5Fu9OuIN6oUk-GH-JaHC0KznK9UqMhLC2cq2DjHy1abrKds8Km7TxrK9hprjDtJBTgq9TCPWkshh-npsEVKgapSLC-MeObpfjpeP5yNlmHe9c39hRCRSC_bUJuqB34G3Ouf18Eioo5tW9IsWcR4Uh6_9uNFogmPG4jR_rGNkpFVaJPx2hHuMJ2GDTO3NeqfUMSPJ_uOewn8u8ZaE6xvmubt5Wa5s80IpZj-BxXnvoDj4TKW9Ba-H52cPdV_ciWDsLsS0k59cVQNQ0lkvpxRjcSgRgq4MHMJF0vpc5qEg3lZikCmIUZBmcehJjFjB0Uzmi6cVD9IRJuu7ZYbQVMhjr-l8UwXv2u2WrURtJEYnBEwNmOwoMc4j1N8NIb7WSZkOE33Fw9zrBSEFFeW7Rj_-x76nbbaCqZAPB6RBf3jC_J2Bveq0MBx3OdVwY-vvsKu7iQrdLRfLB-YhXtOFbx9oWHSBl1QC1X-6Z0pvt2BBOUnqldTlf-0Ro8SaZAyxJ0iYe577R14esQAP6W2fP_M6awKJAVUCNU8WxEfkbH2OLfbYRxjwewSToTzvVZIKLR_B3gLuDfFc2I0-ONVEq63JIbKlwWIye7hGe3HWUZ-802GFAx3GtThA_5Pe3AoIXaIoVzJA4ozJ5HQ7i4lBXNyCwdx-DmMh2e2t2pa6mV5YeTr7mh5DUw_kB4okp0rwvQ33aN69An83QQFTzcmon13fRiVVBvmKceO6TyikVfZkYuT4gB3l45CWzLKSElPtwg3uIRkEq7ujqT0NbbEnWVZ544BCaANyLN-8gTeE8ZDiiQAU9dsCx54vpFoSQatHVZfS2cZv4Hiy7reR-Ub7x-dJ5mLIx1GHBAByxYJxlEcx-dpg24AaJsbD-qeFd5Pytf8V3lG0e2oby-73jCocoY-SdL_z5KBeZdqUTsZJkY3Q9RSuFnvYkSGGZup5tDG1_o_P1QNKzH_HKsV0YOkEOiaitnHUAKW-VC0BWsR8eaml_tecYXOfu94h_uR0ghEDkcazUb8y0Ci1mblvIZKRR6VuE9bSX9iUMa4-LpQ70WAG5sgTeR1m5uhz6msgO2UuQWaNUf_Ko05RoHXZbil7JaMD8s3X0IL9hNEQJHMp2bFOqzkHwtgk6jmjAXJORduex4fFvzZh4sIhmCdsCcC5JOWxAfEkAfapbs0MCba1-hvl5IdrK9oW-Gx-Rn4a8-uXkZc25xO_GUebEqMjnryY_Z5sfa-9YXCwj_QClauF-wk2dGQ2xA4DLLiLNeMQMh9RcbuEIln8JNQlO8DfEhfqlgNSGAuA"
                .decodeBase64URLEncoded()
        let iv = try "OX_3DCbccZztqyLd".decodeBase64URLEncoded()
        let tag = try "XlbwIN6EJUheoQgxuiMHUQ".decodeBase64URLEncoded()

        // decrypted ciphertext
        let payload =
            "eyJhbGciOiJCUDI1NlIxIiwidHlwIjoiSldUIiwiY3R5IjoiTkpXVCIsIng1YyI6WyJNSUlDK2pDQ0FxQ2dBd0lCQWdJSEF3QVRhbGRmVlRBS0JnZ3Foa2pPUFFRREFqQ0JsakVMTUFrR0ExVUVCaE1DUkVVeEh6QWRCZ05WQkFvTUZtZGxiV0YwYVdzZ1IyMWlTQ0JPVDFRdFZrRk1TVVF4UlRCREJnTlZCQXNNUEVWc1pXdDBjbTl1YVhOamFHVWdSMlZ6ZFc1a2FHVnBkSE5yWVhKMFpTMURRU0JrWlhJZ1ZHVnNaVzFoZEdscmFXNW1jbUZ6ZEhKMWEzUjFjakVmTUIwR0ExVUVBd3dXUjBWTkxrVkhTeTFEUVRFd0lGUkZVMVF0VDA1TVdUQWVGdzB4T1RBME1EZ3lNakF3TURCYUZ3MHlOREEwTURneU1UVTVOVGxhTUgweEN6QUpCZ05WQkFZVEFrUkZNUkV3RHdZRFZRUUtEQWhCVDBzZ1VHeDFjekVTTUJBR0ExVUVDd3dKTVRBNU5UQXdPVFk1TVJNd0VRWURWUVFMREFwWU1URTBOREk0TlRNd01RNHdEQVlEVlFRRURBVkdkV05vY3pFTk1Bc0dBMVVFS2d3RVNuVnVZVEVUTUJFR0ExVUVBd3dLU25WdVlTQkdkV05vY3pCYU1CUUdCeXFHU000OUFnRUdDU3NrQXdNQ0NBRUJCd05DQUFSMU5kcnJJOG9LTWl2MHh0VVhGNW9zUzd6YkZJS3hHdC9Cd2lzdWtXb0VLNUdzSjFjQ3lHRXBDSDBzczhKdkQ0T0FISlM4SU1tMS9yTTU5amxpUysxT280SHZNSUhzTUIwR0ExVWREZ1FXQkJTY0VaNUgxVXhTTWhQc09jV1poRzhaUWVXaHZUQU1CZ05WSFJNQkFmOEVBakFBTURBR0JTc2tDQU1EQkNjd0pUQWpNQ0V3SHpBZE1CQU1EbFpsY25OcFkyaGxjblJsTHkxeU1Ba0dCeXFDRkFCTUJERXdId1lEVlIwakJCZ3dGb0FVUkxGTUFWaFVIdHpaTjc3a3NqOHFicVJjaVIwd0lBWURWUjBnQkJrd0Z6QUtCZ2dxZ2hRQVRBU0JJekFKQmdjcWdoUUFUQVJHTUE0R0ExVWREd0VCL3dRRUF3SUhnREE0QmdnckJnRUZCUWNCQVFRc01Db3dLQVlJS3dZQkJRVUhNQUdHSEdoMGRIQTZMeTlsYUdOaExtZGxiV0YwYVdzdVpHVXZiMk56Y0M4d0NnWUlLb1pJemowRUF3SURTQUF3UlFJaEFJUEljYkdqSlF4dVVHYkptQlVpbVd2YlVpN20rU3VYWUJjUkdGeVowaklKQWlBbTFJV0lmdi9nTmMvV213NFpPKzczMFE5QzVkY2NGbk1qbXZiSmU3aTc1Zz09Il19.eyJuand0IjoiZXlKaGJHY2lPaUpDVURJMU5sSXhJaXdpZEhsd0lqb2lTbGRVSWl3aWEybGtJam9pY0hWclgybGtjRjl6YVdjaWZRLmV5SnBjM01pT2lKb2RIUndjem92TDJsa2NDNTZaVzUwY21Gc0xtbGtjQzV6Y0d4cGRHUnVjeTUwYVMxa2FXVnVjM1JsTG1SbElpd2ljbVZ6Y0c5dWMyVmZkSGx3WlNJNkltTnZaR1VpTENKemJtTWlPaUp4UTFSbWJVb3dOWGhSU1RWVWMzWnJVV3RKVkV3eFpsSnlVVVJoZG5oQ1ZsUjNWVzFPTUhCQ1FYUjNJaXdpWTI5a1pWOWphR0ZzYkdWdVoyVmZiV1YwYUc5a0lqb2lVekkxTmlJc0luUnZhMlZ1WDNSNWNHVWlPaUpqYUdGc2JHVnVaMlVpTENKdWIyNWpaU0k2SW1sbFFtczRhMUJsVEdad01tSTJjMEZaVGxKaklpd2lZMnhwWlc1MFgybGtJam9pWlZKbGVtVndkRUZ3Y0NJc0luTmpiM0JsSWpvaWIzQmxibWxrSUdVdGNtVjZaWEIwSWl3aWMzUmhkR1VpT2lKbVNVbDJlbW8zZVZadlpGb3diekZNWVRVeFZDSXNJbkpsWkdseVpXTjBYM1Z5YVNJNkltaDBkSEE2THk5eVpXUnBjbVZqZEM1blpXMWhkR2xyTG1SbEwyVnlaWHBsY0hRaUxDSmxlSEFpT2pFMk1UWTBNVFkzTmpZc0ltbGhkQ0k2TVRZeE5qUXhOalU0Tml3aVkyOWtaVjlqYUdGc2JHVnVaMlVpT2lJeU9HUkhNWFJKVG13eU1GaERjWGxMYkhWRGVWSmxlWGRMWVVRd09UVnBlRjlEWWpCSFQzZDVlbVpqSWl3aWFuUnBJam9pWXpVeU5UYzNOMlkyWmpkaE16UTBNeUo5LmpaUzc2V09NeEIwT0swd29QelFNcWp3Zm9FWk1FcEY1MVBhelFscFhpa0NuZW9kUHZKQVNmdkQ4ODhYRkhuVVY3bVFFQkZrZ056N25NMjhkQ0NYeHdBIn0.IbbCIWFrKpE0L25c8Q-X7h2cr_njnNNKSY_RBSbw9k536p0GE2dDwIDdaNHpduX-T_TXy40DeaewLHtnaTTChg"
                .data(using: .utf8)!

        let aesKey = try Data(hex: "D624C6F81B44CE7D26E98841BEB79652E9DEC79DFD8E2E6F6E706A105D37EC87")
        let symmetricKey = SymmetricKey(data: aesKey)

        let backing = JWE.Backing(header: header,
                                  wrappedKey: wrappedKey,
                                  iv: iv,
                                  ciphertext: ciphertext,
                                  tag: tag)

        let decrypted = try JWE.Decryption.a256gcm(symmetricKey).decrypt(jwe: backing)

        XCTAssertEqual(decrypted, payload)
    }
}
